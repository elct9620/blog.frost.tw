<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>Aotokitsuruya is learning</title><link>https://blog.frost.tw/en/</link><description>Recent content on Aotokitsuruya is learning</description><generator>Hugo -- gohugo.io</generator><language>en</language><managingEditor>contact@frost.tw (蒼時弦也)</managingEditor><webMaster>contact@frost.tw (蒼時弦也)</webMaster><lastBuildDate>Mon, 11 May 2020 00:19:35 +0800</lastBuildDate><atom:link href="https://blog.frost.tw/en/index.xml" rel="self" type="application/rss+xml"/><item><title>TGONext: Tracing and Technical Debt</title><link>https://blog.frost.tw/en/posts/2020/05/11/TGONext-Tracing-and-Technical-Debt/</link><category>Experiance</category><category>TGONext</category><category>Architecture</category><pubDate>Mon, 11 May 2020 00:19:35 +0800</pubDate><author>contact@frost.tw (蒼時弦也)</author><guid>https://blog.frost.tw/en/posts/2020/05/11/TGONext-Tracing-and-Technical-Debt/</guid><description>&lt;p>We have 4 ~ 5 times meetup in TGONext, and this time is the last meetup in the schedule. In the possible last meetup, we discuss some topic which we are not planning to discuss at first.&lt;/p>
&lt;p>This time we are talking about log tracing and how to deal with technical debt.&lt;/p></description><content:encoded>&lt;p>We have 4 ~ 5 times meetup in TGONext, and this time is the last meetup in the schedule. In the possible last meetup, we discuss some topic which we are not planning to discuss at first.&lt;/p>
&lt;p>This time we are talking about log tracing and how to deal with technical debt.&lt;/p>
&lt;h2 id="log-tracing">Log Tracing&lt;/h2>
&lt;p>Some of the mentees have some questions about the log collection in their work.&lt;/p>
&lt;h3 id="collection">Collection&lt;/h3>
&lt;p>In the common cases is choose to put our logs in the local disk but when the services are growing, this is hard to debug from the logs.&lt;/p>
&lt;p>In my company, we usually put the logs on the local disk because our customers usually have only one server. Or we will let our customers use SaaS to upload to third-party services to save the time to build a logging server. We already have a lot of useful tools that can be chosen, for example, the AWS CloudWatch or &lt;a href="https://www.papertrail.com/">Papertrail&lt;/a> is easier to integrate to Rails.&lt;/p>
&lt;h3 id="open-tracing">Open Tracing&lt;/h3>
&lt;p>When the amount of service is growing, the logging is not enough to trace a whole system and we need more information to know about our system.&lt;/p>
&lt;p>Open Tracing is a standard to define how to trace our service. We can use &lt;a href="https://www.jaegertracing.io/">Jagger&lt;/a> or &lt;a href="https://zipkin.io/">Zipkin&lt;/a> which are support the Open Tracing API.&lt;/p>
&lt;blockquote>
&lt;p>Choose Open Tracing may be a good idea, the most business solution are support Open Tracing API that we can easily switch between them.&lt;/p>
&lt;/blockquote>
&lt;h3 id="application-performance-monitor">Application Performance Monitor&lt;/h3>
&lt;p>This is a part of the Open Tracing, it gives us to trace a function call or API call spend time. In my experience, the business solution like &lt;a href="https://www.datadoghq.com/">Datadog&lt;/a>, &lt;a href="https://newrelic.com/">NewRelic&lt;/a>, &lt;a href="https://scoutapm.com/">ScoutAPM&lt;/a> and others are provided more detail information can help us to determine the performance problem.&lt;/p>
&lt;p>But the OpenSource solution like &lt;a href="https://www.elastic.co/apm">ElasticAPM&lt;/a> is limited and only very simple trace information can be traced.&lt;/p>
&lt;blockquote>
&lt;p>The business solutions are had support memory tracking and helpful to find memory problems, but ElasticAPM is not supporting it but in the roadmap.&lt;/p>
&lt;/blockquote>
&lt;h3 id="time">Time&lt;/h3>
&lt;p>After sharing our experience and tools, the mentor points out a key point in tracing tools.&lt;/p>
&lt;p>When we use these tools to trace our service, it usually related the time. And to prevent the network latency, the agent usually uses local time as timestamp and sends it to the trace server.&lt;/p>
&lt;p>That means if we have two machines but the time is not synchronized, we may get an invalid timeline let us unable to find a correct problem in the dashboard.&lt;/p>
&lt;p>For example, if we have 3 API calls (A =&amp;gt; B =&amp;gt; C) in this trace, one of the API server (B) has invalid local time. We may see the timeline shows the B is early than A, but it doesn&amp;rsquo;t match the actual event time. It will cause us cannot correctly find the problem.&lt;/p>
&lt;h3 id="dashboard">Dashboard&lt;/h3>
&lt;p>Another important part is the dashboard. To find the problem in a short time usually depend on a good design dashboard to help developer trace the problem.&lt;/p>
&lt;p>This is why the business solution is more mature than open-source projects, and we usually choose ElasticSearch as our self-hosting solution.&lt;/p>
&lt;p>Building a powerful dashboard is not easy, but the trace isn&amp;rsquo;t the highest priority in product development.&lt;/p>
&lt;p>This is why we prefer to choose SaaS or an existing open-source project.&lt;/p>
&lt;h2 id="technical-debt">Technical Debt&lt;/h2>
&lt;p>This part we share our experience when we try to decide to refactor or schedule to resolve it.&lt;/p>
&lt;p>I think we are agree to there no correct answers, but we still have some guide can follow.&lt;/p>
&lt;h3 id="the-test">The Test&lt;/h3>
&lt;p>To deal with the technical debt we usually have to refactor our code. To refactor the code, we need the test to ensure we didn&amp;rsquo;t break anything.&lt;/p>
&lt;p>In my experience, the &amp;ldquo;spec&amp;rdquo; is important. If we didn&amp;rsquo;t have a correct spec, the test will focus on incorrect things and we get a useless test.&lt;/p>
&lt;h3 id="the-known-and-unknown-debt">The known and unknown debt&lt;/h3>
&lt;p>In work, we never always have enough time to write an ideal code. That means the event we didn&amp;rsquo;t have technical debt, we still have to make technical debt due to the time limit.&lt;/p>
&lt;p>In this case, we will add a &lt;code>TODO&lt;/code> as a comment to waiting we can refactor it, and in another case, we may write some bad code we didn&amp;rsquo;t know.&lt;/p>
&lt;p>To resolve the known debt, most members agree to take the initiative to resolve it, and the unknown debt we still have to wait for it had appeared for us to fix them.&lt;/p>
&lt;p>But the trace will help us find the hidden issue faster, this is connected to the previous topic we are talking about.&lt;/p>
&lt;blockquote>
&lt;p>And there we have another case cause the technical debt, the programming language is used too old version. The language will be improved after the upgrade and drop some syntax, it will cause we cannot let our old codes continue work in the newer version.&lt;/p>
&lt;/blockquote>
&lt;h3 id="the-communicate">The communicate&lt;/h3>
&lt;p>In the last, our mentor gives us a summary of his experience.&lt;/p>
&lt;p>The reason causes the technical debt usually depends on the product team or marketing team requirement, but it will gain more value for the company.&lt;/p>
&lt;p>If we want to have the time to deal with the technical debt, we have to explain the pros and cons to them.&lt;/p>
&lt;p>And the programmer team usually be rejected, because others cannot figure out the importance of refactoring.&lt;/p>
&lt;p>To resolve it, we had to convert the information to the same unit to compare that other teams can figure out it.&lt;/p>
&lt;p>For example, we can explain the refactoring can improve the 10% in the future promote feature&amp;rsquo;s development time. It will give the marketing team can be faster to push their new product, but we have to spend more 50% time at this time, to refactor it.&lt;/p>
&lt;p>If the marketing team thinks this value is higher than keeping used the same way to add promote the feature, we will get the support to start this refactor.&lt;/p>
&lt;h2 id="conclusion">Conclusion&lt;/h2>
&lt;p>This meetup is shorter than previous meetups, but include other meetups, we almost covered all topics we want to discuss at the first.&lt;/p>
&lt;p>In these meetups, I think I learned two important things. The first one is trying to find the key point or the core target of the architecture we are evaluating. This is important for us to pick a solution best to match our service and avoid the cons brakes it.&lt;/p>
&lt;p>Another one is communication skill, this is a skill I attach importance to my work. But I only do it well with the programmers, but for my customer or non-programmer partners, I didn&amp;rsquo;t work well for them. In most cases, I usually hope the project manager can do it for me. But it still important when I need to explain some technical considerations to them.&lt;/p></content:encoded></item><item><title>Build a Form Helper capable Form Object in Rails</title><link>https://blog.frost.tw/en/posts/2020/05/03/Build-a-Form-Helper-capable-Form-Object-in-Rails/</link><category>Rails</category><category>Ruby</category><category>Ruby on Rails</category><category>Experience</category><pubDate>Sun, 03 May 2020 16:29:36 +0800</pubDate><author>contact@frost.tw (蒼時弦也)</author><guid>https://blog.frost.tw/en/posts/2020/05/03/Build-a-Form-Helper-capable-Form-Object-in-Rails/</guid><description>&lt;p>The Form Object is a common pattern in Rails when our form becomes complex. But the tutorial in network&amp;rsquo;s example usually incapable of Rails&amp;rsquo; form helper.&lt;/p>
&lt;p>And I start thinking about is it possible to support form helpers without too many changes?&lt;/p></description><content:encoded>&lt;p>The Form Object is a common pattern in Rails when our form becomes complex. But the tutorial in network&amp;rsquo;s example usually incapable of Rails&amp;rsquo; form helper.&lt;/p>
&lt;p>And I start thinking about is it possible to support form helpers without too many changes?&lt;/p>
&lt;h2 id="common-form-object-implementation">Common Form Object Implementation&lt;/h2>
&lt;p>To improve our form object, we have to know about the original version we are using.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="k">class&lt;/span> &lt;span class="nc">RegistrationForm&lt;/span>
&lt;span class="kp">include&lt;/span> &lt;span class="no">ActiveModel&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">Model&lt;/span>
&lt;span class="kp">include&lt;/span> &lt;span class="no">ActiveModel&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">Validations&lt;/span>
&lt;span class="kp">attr_accessor&lt;/span> &lt;span class="ss">:email&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">:password&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">:password_confirmation&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">initialize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">params&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{})&lt;/span>
&lt;span class="vi">@user&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">user&lt;/span>
&lt;span class="k">super&lt;/span> &lt;span class="n">params&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="c1"># ...&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">attributes&lt;/span>
&lt;span class="p">{&lt;/span>
&lt;span class="ss">email&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="vi">@email&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="ss">password&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="vi">@password&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">save&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="k">unless&lt;/span> &lt;span class="n">valid?&lt;/span>
&lt;span class="vi">@user&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">assign_attributes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">attributes&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="vi">@user&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">save&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>This is a common form object you can find in the network, it gives us model-like behavior which can use it in the controller without too many changes.&lt;/p>
&lt;p>But in the view, our form helper has to set method and URL at any time.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="o">&amp;lt;%=&lt;/span> &lt;span class="n">form_for&lt;/span> &lt;span class="vi">@form&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">method&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="ss">:post&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">url&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">users_path&lt;/span> &lt;span class="k">do&lt;/span> &lt;span class="o">|&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="o">|&lt;/span> &lt;span class="s">%&amp;gt;
&lt;/span>&lt;span class="s">&amp;lt;% # ... %&amp;gt;&lt;/span>
&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="sx">% end &lt;/span> &lt;span class="o">%&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="the-form-helper">The Form Helper&lt;/h2>
&lt;p>To improve the form object, I starting review the source code of form helper.&lt;/p>
&lt;p>In the &lt;a href="https://github.com/rails/rails/blob/bdc581616b760d1e2be3795c6f0f3ab4b1e125a5/actionview/lib/action_view/helpers/form_helper.rb#L440">action_view/helpers/form_helper.rb#L440&lt;/a>, the ActiveView will try to &lt;code>apply_form_for_options!&lt;/code> if we give a object for it.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="n">apply_form_for_options!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">record&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">object&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">options&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>In the &lt;a href="https://github.com/rails/rails/blob/bdc581616b760d1e2be3795c6f0f3ab4b1e125a5/actionview/lib/action_view/helpers/form_helper.rb#L457-L474">&lt;code>apply_form_for_options!&lt;/code>&lt;/a> method, we can find it set the &lt;code>method&lt;/code> and &lt;code>url&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="n">action&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">method&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">object&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">respond_to?&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">:persisted?&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">object&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">persisted?&lt;/span> &lt;span class="p">?&lt;/span> &lt;span class="o">[&lt;/span>&lt;span class="ss">:edit&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">:patch&lt;/span>&lt;span class="o">]&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="o">[&lt;/span>&lt;span class="ss">:new&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">:post&lt;/span>&lt;span class="o">]&lt;/span>
&lt;span class="c1"># ...&lt;/span>
&lt;span class="n">options&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="ss">:url&lt;/span>&lt;span class="o">]&lt;/span> &lt;span class="o">||=&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">options&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">key?&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">:format&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">polymorphic_path&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">record&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">format&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">options&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">delete&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">:format&lt;/span>&lt;span class="p">))&lt;/span>
&lt;span class="k">else&lt;/span>
&lt;span class="n">polymorphic_path&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">record&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">{})&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>That means if our form object can provide the same interface to the form helper, it will correctly configure the form&amp;rsquo;s method and URL without extra work.&lt;/p>
&lt;h2 id="the-persisted">The persisted?&lt;/h2>
&lt;p>When the form helper decides to use &lt;code>POST&lt;/code> to create a new object or use &lt;code>PUT&lt;/code> to update an existing object. It depends on the model&amp;rsquo;s &lt;code>persisted?&lt;/code> method.&lt;/p>
&lt;p>That means we can add &lt;code>persisted?&lt;/code> method to our form object to make form helper can detect it.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="k">class&lt;/span> &lt;span class="nc">BaseForm&lt;/span>
&lt;span class="c1"># ...&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">initialize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">record&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">params&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{})&lt;/span>
&lt;span class="vi">@record&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">record&lt;/span>
&lt;span class="k">super&lt;/span> &lt;span class="n">params&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">persisted?&lt;/span>
&lt;span class="vi">@record&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="vi">@record&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">persisted?&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>But there has another better way to implement it, we can use &lt;a href="https://api.rubyonrails.org/classes/Module.html#method-i-delegate">&lt;code>delegate&lt;/code>&lt;/a> which provided by ActiveSupport.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="k">class&lt;/span> &lt;span class="nc">BaseForm&lt;/span>
&lt;span class="c1"># ...&lt;/span>
&lt;span class="n">delegate&lt;/span> &lt;span class="ss">:persisted?&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">to&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="ss">:@record&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">allow_nil&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kp">true&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">initialize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">record&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">params&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{})&lt;/span>
&lt;span class="vi">@record&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">record&lt;/span>
&lt;span class="k">super&lt;/span> &lt;span class="n">params&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="the-to_param-and-model_name">The to_param and model_name&lt;/h2>
&lt;p>The URL is generated by &lt;a href="https://api.rubyonrails.org/classes/ActionDispatch/Routing/PolymorphicRoutes.html#method-i-polymorphic_path">&lt;code>polymorphic_path&lt;/code>&lt;/a> and it uses &lt;code>model_name&lt;/code> and &lt;code>to_param&lt;/code> to generate the path.&lt;/p>
&lt;p>We can try it in the Rails console:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">&amp;gt; app.polymorphic_path&lt;span class="o">(&lt;/span>User.new&lt;span class="o">)&lt;/span>
&lt;span class="o">=&lt;/span>&amp;gt; &lt;span class="s2">&amp;#34;/users&amp;#34;&lt;/span>
&amp;gt; app.polymorphic_path&lt;span class="o">(&lt;/span>User.last&lt;span class="o">)&lt;/span>
&lt;span class="o">=&lt;/span>&amp;gt; &lt;span class="s2">&amp;#34;/users/1234&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>And when we add delegate &lt;code>model_name&lt;/code> and &lt;code>to_param&lt;/code> to our form object, we can get the same result.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="n">delegate&lt;/span> &lt;span class="ss">:persisted?&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">:model_name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">:to_param&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">to&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="ss">:@record&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">allow_nil&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kp">true&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>And check it again:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-bash" data-lang="bash">&amp;gt; app.polymorphic_path&lt;span class="o">(&lt;/span>RegistrationForm.new&lt;span class="o">(&lt;/span>User.new&lt;span class="o">))&lt;/span>
&lt;span class="o">=&lt;/span>&amp;gt; &lt;span class="s2">&amp;#34;/users&amp;#34;&lt;/span>
&amp;gt; app.polymorphic_path&lt;span class="o">(&lt;/span>RegistrationForm.new&lt;span class="o">(&lt;/span>User.last&lt;span class="o">))&lt;/span>
&lt;span class="o">=&lt;/span>&amp;gt; &lt;span class="s2">&amp;#34;/users/1234&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>For now, we have the same interface as the model.&lt;/p>
&lt;h2 id="load-attributes">Load Attributes&lt;/h2>
&lt;p>Since we can let form helper work correctly but we still cannot load the data when we edit an existing model.&lt;/p>
&lt;p>To resolve it, we can adjust our initialize method to retrieve the necessary fields.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="k">class&lt;/span> &lt;span class="nc">RegistrationForm&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="no">BaseForm&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">initialize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">record&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">params&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{})&lt;/span>
&lt;span class="n">attributes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">record&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">slice&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">:email&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">:password&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">merge&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">super&lt;/span> &lt;span class="n">record&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">params&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Another way is to use Attribute API to support it, but we have to exactly define each attribute in our form object.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="k">class&lt;/span> &lt;span class="nc">BaseForm&lt;/span>
&lt;span class="c1"># ...&lt;/span>
&lt;span class="kp">include&lt;/span> &lt;span class="no">ActiveModel&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">Attributes&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">initialize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">record&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">params&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{})&lt;/span>
&lt;span class="vi">@record&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">record&lt;/span>
&lt;span class="n">attributes&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">record&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">attributes&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">slice&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*.&lt;/span>&lt;span class="n">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">class&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">attribute_names&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">super&lt;/span> &lt;span class="n">attributes&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">merge&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">params&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="c1"># app/forms/registration_form.rb&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">RegistrationForm&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="no">BaseForm&lt;/span>
&lt;span class="n">attribute&lt;/span> &lt;span class="ss">:email&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">:string&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>But we have to take care the &lt;code>params&lt;/code> hash, the model return attributes is &lt;code>{&amp;quot;name&amp;quot; =&amp;gt; &amp;quot;Joy&amp;quot;}&lt;/code> but we use &lt;code>{name: &amp;quot;Joy&amp;quot;}&lt;/code> we will get the hash mixed string and symbol keys &lt;code>{&amp;quot;name&amp;quot; =&amp;gt; &amp;quot;Joy&amp;quot;, name: &amp;quot;Joy&amp;quot;}&lt;/code> and didn&amp;rsquo;t set the attribute to our form object.&lt;/p>
&lt;/blockquote>
&lt;h2 id="future-improve">Future Improve&lt;/h2>
&lt;p>In the current version, we have to pass the model instance to the form object. Maybe we can add some DSL to auto-create it.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="c1"># Option 1&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">RegistrationForm&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="no">BaseForm&lt;/span>
&lt;span class="n">model_class&lt;/span> &lt;span class="s1">&amp;#39;User&amp;#39;&lt;/span>
&lt;span class="n">attribute&lt;/span> &lt;span class="ss">:name&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="c1"># Option 2&lt;/span>
&lt;span class="k">class&lt;/span> &lt;span class="nc">RegistrationForm&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="no">BaseForm&lt;/span>&lt;span class="o">[&lt;/span>&lt;span class="no">User&lt;/span>&lt;span class="o">]&lt;/span>
&lt;span class="n">attribute&lt;/span> &lt;span class="ss">:name&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>But we also need to consider this way may not a good idea in some complex system.&lt;/p>
&lt;p>For example, we had load the &lt;code>User&lt;/code> from a controller or other object. But we cannot pass it to the form object. That means our form object usually loads the object when we access it.
If we have nested form it will cause the N+1 query in this case.&lt;/p>
&lt;p>This is another topic when we use the form object or service object to refactor our code. We may reduce the duplicate code but cause our system to slow down or new hidden bug we didn&amp;rsquo;t know about it.&lt;/p>
&lt;h2 id="conclusion">Conclusion&lt;/h2>
&lt;p>I didn&amp;rsquo;t have many experiences to use the form object. But I think it is a common case when we build an application.
This version form object still has a lot of limitation and I didn&amp;rsquo;t consider all possible use cases.&lt;/p>
&lt;p>I will try to improve it in my future works and keep it as a simple object if possible. I believe we didn&amp;rsquo;t always need to build a complex behavior and add a gem to resolve some simple things.&lt;/p></content:encoded></item><item><title>Review the Rails' Autoloading and Reloading</title><link>https://blog.frost.tw/en/posts/2020/04/28/Review-the-Rails-Autoloading-and-Reloading/</link><category>Ruby</category><category>Rails</category><category>Autoloading</category><pubDate>Tue, 28 Apr 2020 00:31:53 +0800</pubDate><author>contact@frost.tw (蒼時弦也)</author><guid>https://blog.frost.tw/en/posts/2020/04/28/Review-the-Rails-Autoloading-and-Reloading/</guid><description>&lt;p>A few years ago, I have a post talking about &lt;a href="https://blog.frost.tw/posts/2017/03/06/The-Rails-auto-reload-trap/">Autoloading&lt;/a>. In recent days, my colleague has some problems with Autoloading and Reloading.&lt;/p>
&lt;p>Therefore I decided to review the Autoloading mechanism in Rails 5 and 6.&lt;/p></description><content:encoded>&lt;p>A few years ago, I have a post talking about &lt;a href="https://blog.frost.tw/posts/2017/03/06/The-Rails-auto-reload-trap/">Autoloading&lt;/a>. In recent days, my colleague has some problems with Autoloading and Reloading.&lt;/p>
&lt;p>Therefore I decided to review the Autoloading mechanism in Rails 5 and 6.&lt;/p>
&lt;h2 id="why-autoloading">Why Autoloading?&lt;/h2>
&lt;p>Before we starting to discuss Autoloading or Reloading, I want to spend some time to think about it.&lt;/p>
&lt;p>In the C, C++, or Java which is compiled language. They didn&amp;rsquo;t need to autoload because the compiler will include the necessary parts to the binary. And we usually use &lt;code>#include&lt;/code> or &lt;code>import&lt;/code> to include the related symbols to reference the codes we are required.&lt;/p>
&lt;p>But in the Ruby, PHP, or Node.js which is interpreted in the runtime. That means our code didn&amp;rsquo;t preprocess before we execute it. And our code didn&amp;rsquo;t know other code until we &lt;code>require&lt;/code> or &lt;code>include&lt;/code> them into our main program file.&lt;/p>
&lt;p>These two types of languages are trying to split codes into small files. But for the interpreted language we cannot skip unnecessary files to loaded if we require each file.&lt;/p>
&lt;p>In Ruby, we have a keyword &lt;a href="https://ruby-doc.org/core-2.7.0/Module.html#method-i-autoload-3F">&lt;code>autoload&lt;/code>&lt;/a> that allows us to define &amp;ldquo;when the constant not defined, load the specify file.&amp;rdquo; to implement load required files.&lt;/p>
&lt;p>It may reduce memory usage when we load a large amount of code in our application. But I more believe autoloading is used to help us to find codes in a large application that has many files.&lt;/p>
&lt;h2 id="the-require-method">The require method&lt;/h2>
&lt;p>In my code review, I ask for my colleague to use &lt;code>require 'middleware/domain_rewriter'&lt;/code> instead &lt;code>require_relative '../lib/middleware/domain_rewriter'&lt;/code> to include our extra middleware in Rails in &lt;code>config/application.rb&lt;/code>&lt;/p>
&lt;p>But it doesn&amp;rsquo;t work correctly, we have to use &lt;code>require_relative&lt;/code> in this case.&lt;/p>
&lt;p>The question is &amp;ldquo;why we can use &lt;code>require&lt;/code> in the non-relatives path?&amp;rdquo;&lt;/p>
&lt;p>In Ruby, we have a global variable named &lt;code>$LOAD_PATH&lt;/code> if we use &lt;code>pp&lt;/code> to print it, we can find our Ruby install path is listed inside it. It will let Ruby find files inside these paths when we try to require something.&lt;/p>
&lt;p>If we have the &lt;code>Gemfile&lt;/code> in the project folder, the gems install path will be added to this list. This is why we can require gems only to add them to the Gemfile.&lt;/p>
&lt;p>After we know the &lt;code>$LOAD_PATH&lt;/code> provide &lt;code>require&lt;/code> search paths, the reason why &lt;code>config/application.rb&lt;/code> cannot directly require &lt;code>lib/&lt;/code> is easier to recognize.&lt;/p>
&lt;p>The Rails is a Rack-based application and it usually boots from &lt;code>config.ru&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="c1"># frozen_string_literal: true&lt;/span>
&lt;span class="c1"># This file is used by Rack-based servers to start the application.&lt;/span>
&lt;span class="n">require_relative&lt;/span> &lt;span class="s2">&amp;#34;config/environment&amp;#34;&lt;/span>
&lt;span class="n">run&lt;/span> &lt;span class="no">Rails&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">application&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>This file requires the &lt;code>config/environment.rb&lt;/code> and we can find it require the &lt;code>config/application.rb&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="c1"># frozen_string_literal: true&lt;/span>
&lt;span class="c1"># Load the Rails application.&lt;/span>
&lt;span class="n">require_relative&lt;/span> &lt;span class="s2">&amp;#34;application&amp;#34;&lt;/span>
&lt;span class="c1"># Initialize the Rails application.&lt;/span>
&lt;span class="no">Rails&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">application&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">initialize!&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>It is obvious the Rails didn&amp;rsquo;t add &lt;code>lib/&lt;/code> into the &lt;code>$LOAD_PATH&lt;/code> and we cannot require them directly.&lt;/p>
&lt;h2 id="the-autoloading">The Autoloading&lt;/h2>
&lt;p>Since we can load library elegant by use &lt;code>require&lt;/code> but we still need to require the application code via &lt;code>require_relative&lt;/code> and it makes us feel annoyed when our codebase is growing.&lt;/p>
&lt;p>Since Rails 6, it starts to use the &lt;a href="https://github.com/fxn/zeitwerk">&lt;code>Zeitwerk&lt;/code>&lt;/a> as the code loader, we will use it as an example in this post to reduce complex behaviors behind it.&lt;/p>
&lt;p>According to Zeitwerk&amp;rsquo;s readme, we can know the basic logic is below shows:&lt;/p>
&lt;pre>&lt;code>lib/my_gem.rb -&amp;gt; MyGem
lib/my_gem/foo.rb -&amp;gt; MyGem::Foo
lib/my_gem/bar_baz.rb -&amp;gt; MyGem::BarBaz
lib/my_gem/woo/zoo.rb -&amp;gt; MyGem::Woo::Zoo
&lt;/code>&lt;/pre>&lt;p>It is very similar to we put the files inside &lt;code>app/controller&lt;/code> or &lt;code>app/models&lt;/code> because Rails register these directories for us.&lt;/p>
&lt;blockquote>
&lt;p>This is mean it is not required to use &lt;code>_controller&lt;/code> as postfix in your &lt;code> app/controller&lt;/code> folder, but it will cause other hard to recognize the file usage.&lt;/p>
&lt;/blockquote>
&lt;p>The Zeitwerk uses Ruby&amp;rsquo;s &lt;code>autoload&lt;/code> to load classes when we configure the autoload paths, it will scan all files and add them to the related classes&amp;rsquo; autoload list.&lt;/p>
&lt;blockquote>
&lt;p>In my memory, the older version Rails has its autoloading implementation via override some Kernel methods and rescue NameError to find the actual file path to load it.&lt;/p>
&lt;/blockquote>
&lt;h2 id="the-reloading">The Reloading&lt;/h2>
&lt;p>I think this part is the most Junior developer feeling confuse when they try to &lt;code>require&lt;/code> something but it breaks when they update some code.&lt;/p>
&lt;p>In Zeitwerk we have &lt;code>#enable_reloading&lt;/code> options can grant permission to call the &lt;code>#reload&lt;/code> method. The reloading feature is helpful in the development environment when we change something but not required to restart the server.&lt;/p>
&lt;blockquote>
&lt;p>For the compiled language, it is necessary to recompile and reopen it. But there have other methods can prevent it.&lt;/p>
&lt;/blockquote>
&lt;p>But why we can &lt;code>#unload&lt;/code> the interpreted code? This usually depends on the language feature, in the Ruby the constant variable is changeable and allows to be removed.&lt;/p>
&lt;p>When we call the &lt;code>#reload&lt;/code> method, the Zeitwerk will &lt;a href="https://github.com/fxn/zeitwerk/blob/806795d302840a7e96612b88ff45f231ea4318b0/lib/zeitwerk/loader.rb#L796">&lt;code>#unload&lt;/code>&lt;/a> constants which are loaded. And load all classes again to put the new codes into memory.&lt;/p>
&lt;p>That is means when we have a top-level constant is unloaded, the children will be unloaded together.&lt;/p>
&lt;p>This is a common mistake when we defined a child class in the same file with parent class, but directly use it in other file but didn&amp;rsquo;t load its parent.&lt;/p>
&lt;blockquote>
&lt;p>It may not happen in newer Rails, the loader will try to load its parent before load it.&lt;/p>
&lt;/blockquote>
&lt;p>In the same case, a similar mistake is we define the &lt;code>API&lt;/code> namespace under autoload managed folder (eg. &lt;code>app/&lt;/code>) and define the in the not-managed folder (eg. &lt;code>lib/&lt;/code>), too.&lt;/p>
&lt;p>When we change some files under &lt;code>app/&lt;/code> folder and it will unload the &lt;code>API&lt;/code> namespace, after reload the &lt;code>lib/&lt;/code> defined &lt;code>API&lt;/code> will be unloaded and never go back.&lt;/p>
&lt;p>The reason is the &lt;code>require&lt;/code> recognize the file is loaded, therefore Ruby thinks it didn&amp;rsquo;t load again but it is unloaded for reloading.&lt;/p>
&lt;p>Below codes is an example:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="c1"># frozen_string_literal: true&lt;/span>
&lt;span class="n">require_relative&lt;/span> &lt;span class="s1">&amp;#39;api&amp;#39;&lt;/span>
&lt;span class="n">pp&lt;/span> &lt;span class="n">defined?&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="no">API&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># =&amp;gt; &amp;#34;constant&amp;#34;&lt;/span>
&lt;span class="no">Object&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">send&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">:remove_const&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;API&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">require_relative&lt;/span> &lt;span class="s1">&amp;#39;api&amp;#39;&lt;/span>
&lt;span class="n">pp&lt;/span> &lt;span class="n">defined?&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="no">API&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># =&amp;gt; nil&lt;/span>
&lt;span class="nb">load&lt;/span> &lt;span class="s2">&amp;#34;api.rb&amp;#34;&lt;/span>
&lt;span class="n">pp&lt;/span> &lt;span class="n">defined?&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="no">API&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># =&amp;gt; &amp;#34;constant&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>The &lt;code>require&lt;/code> can prevent we load the same file twice but the &lt;code>load&lt;/code> didn&amp;rsquo;t check for it. The Zeitwerk also overrides the &lt;a href="https://github.com/fxn/zeitwerk/blob/master/lib/zeitwerk/kernel.rb#L24">&lt;code>#require&lt;/code>&lt;/a> method to provide a similar feature which managed by Zeitwerk loader.&lt;/p>
&lt;p>Depends on the above example, we can have an outline of the Rails&amp;rsquo; autoloading and reloading mechanism to help us use them more reasonably.&lt;/p>
&lt;h2 id="conclusion">Conclusion&lt;/h2>
&lt;p>In the end, I have on more thing I want to talk about. The &lt;code>lib/&lt;/code> is managed by Rails, too. But it can be used after Rails is booted, this is the reason we cannot use them in the &lt;code>config/application.rb&lt;/code> before boot.&lt;/p>
&lt;blockquote>
&lt;p>The source is &lt;a href="https://github.com/rails/rails/blob/758e4f8406e680a6cbf21b170749202c537a2576/railties/lib/rails/engine/configuration.rb#L53">here&lt;/a> to defined as load path and &lt;a href="https://github.com/rails/rails/blob/c0d91a4f9da10094ccdb80e34d1be42ce1016c9a/railties/lib/rails/engine.rb#L570-L575">here&lt;/a> to add into load path.&lt;/p>
&lt;/blockquote>
&lt;p>The autoloading and reloading are useful when we develop our application and Zeitwerk allows us to add it to our project easier. If you have projects not based on Rails, I suggest you try to add it and learn more from practice.&lt;/p></content:encoded></item><item><title>TGONext: Database Migration and Architecture Changing</title><link>https://blog.frost.tw/en/posts/2020/04/03/TGONext-Database-Migration-and-Architecture-Changing/</link><category>TGONext</category><category>Architecture</category><category>Database</category><category>Experience</category><pubDate>Fri, 03 Apr 2020 21:14:56 +0800</pubDate><author>contact@frost.tw (蒼時弦也)</author><guid>https://blog.frost.tw/en/posts/2020/04/03/TGONext-Database-Migration-and-Architecture-Changing/</guid><description>&lt;p>Before we starting to discuss architecture, our mentor let us ask some questions.&lt;/p>
&lt;p>Between this meetup and previous meetup, my customer breaks their migration due to some incorrect plan. So I raise a migration question to discuss the zero-downtime migration plan.&lt;/p></description><content:encoded>&lt;p>Before we starting to discuss architecture, our mentor let us ask some questions.&lt;/p>
&lt;p>Between this meetup and previous meetup, my customer breaks their migration due to some incorrect plan. So I raise a migration question to discuss the zero-downtime migration plan.&lt;/p>
&lt;h2 id="migrate-database-without-downtime">Migrate Database without Downtime&lt;/h2>
&lt;p>In my work, most customers are a startup and we can choose to stop our service for a short time and upgrade their server and migrate the database.&lt;/p>
&lt;p>But for a large service, it may not acceptable to shutdown anything when upgrading or migration.&lt;/p>
&lt;blockquote>
&lt;p>Even we can stop service for one region but there are more global service is coming. It may unacceptable to other regions.&lt;/p>
&lt;/blockquote>
&lt;h3 id="the-mentees-experience">The mentee&amp;rsquo;s experience&lt;/h3>
&lt;p>I believe the most programmer include me knows the method to implement it, but there has a lot of concern we didn&amp;rsquo;t expect.&lt;/p>
&lt;p>Other mentees share their experience with:&lt;/p>
&lt;ul>
&lt;li>Don&amp;rsquo;t remove any column&lt;/li>
&lt;li>Prevent migration rollback to drop anything&lt;/li>
&lt;li>Copy and rename the table&lt;/li>
&lt;li>Use trigger to mirror data&lt;/li>
&lt;/ul>
&lt;p>The most common method usually safer for the database is to prevent removing the column, and all of the above solutions I had heard about from the internet.&lt;/p>
&lt;h3 id="does-the-database-has-version-control">Does the Database has version-control?&lt;/h3>
&lt;p>Our mentor points our more detailed information hidden in the discussion. Some mentees describe their method is the database cannot be lost between migration, that&amp;rsquo;s means we decide to prevent remove any column or drop anything when rollback.&lt;/p>
&lt;p>For example the source-code, we can jump to any version and didn&amp;rsquo;t have any side-effects. Because the source-code is stateless, but if we try to change the database&amp;rsquo;s version from &lt;code>2020-03-28&lt;/code> to &lt;code>2020-01-01&lt;/code> and is it possible to let everything back to &lt;code>2020-03-28&lt;/code> after we migrate them again?&lt;/p>
&lt;p>There didn&amp;rsquo;t have a correct answer, it depends on the data is important or not for your service. But when we design a migration, we need to consider it and pick a safer policy.&lt;/p>
&lt;h3 id="the-performance-lost">The Performance Lost&lt;/h3>
&lt;p>Since we decide to didn&amp;rsquo;t remove any column, the database may slow down due to the database have to load a large row when we query something.&lt;/p>
&lt;p>This is a trait of RDBMS, they are the row-based design if we use the NoSQL we may not get this problem because they use column-based design.&lt;/p>
&lt;p>But we also have other choices, for example, use the rename table to prevent become large tables. Create a temporary table to apply changes before we are ready to replace them.&lt;/p>
&lt;p>The GitHub has a tool &lt;a href="https://github.com/github/gh-ost">gh-ost&lt;/a> to let us didn&amp;rsquo;t need to implement the flow by ourselves.&lt;/p>
&lt;blockquote>
&lt;p>Our mentor also reminds us, if our migration progress takes a long time and we want to pause the &lt;code>gh-ost&lt;/code> is not allow it.&lt;/p>
&lt;/blockquote>
&lt;p>Besides the performance problem, we also need to consider the table-lock and other possible problems.&lt;/p>
&lt;blockquote>
&lt;p>I notice in the discussion there are many database behaviors we already know but we usually forget to connect them together and check for the risk when we choose to do it.&lt;/p>
&lt;/blockquote>
&lt;h2 id="the-database-scalability">The Database Scalability&lt;/h2>
&lt;p>This is the extended part of the migration question. Since we know the RDBMS and NoSQL have some different traits. We start to compare MySQL/PostgreSQL and MongoDB&amp;rsquo;s design.&lt;/p>
&lt;p>In the RDBMS we usually use B+ Tree to create the index. Our mentor asks us why MongoDB uses B Tree to create the index.&lt;/p>
&lt;p>To speed up to find data, one of the ways reduces the total rows to find. In the RDBMS we may choose to use Shard or Partition to create a small subset of a table.&lt;/p>
&lt;p>In the B+ Tree, the data node will connect to the next row that means RDBMS can have a fast range scan. But if we want to create a shard to split data to the different databases, it is hard for the database to choose a subtree to split it because the data node may be connected to another subtree&amp;rsquo;s data node.&lt;/p>
&lt;p>But for MongoDB, it uses the B Tree that means it will be very easy to split a subtree because the data node didn&amp;rsquo;t connect to another subtree.&lt;/p>
&lt;p>That means MongoDB can easier to scale but the cons are the range scan become very slow and sharding may use a lot disk I/O to move data.&lt;/p>
&lt;blockquote>
&lt;p>This discussion gives me a inspire for suggest database option. A small design concern will change to behaviors and pros and cons.&lt;/p>
&lt;/blockquote>
&lt;h2 id="the-architecture-changing">The Architecture Changing&lt;/h2>
&lt;p>This is our main plan to discuss in this meetup. Our mentor let us share our idea about a service is unable to handle the requests.&lt;/p>
&lt;p>In summary our idea, we have below chosen:&lt;/p>
&lt;ul>
&lt;li>Scale-up (Ex. Add memory, CPU)&lt;/li>
&lt;li>Scale-out (Add more same type instance)&lt;/li>
&lt;li>Add Cache&lt;/li>
&lt;li>Add Queue&lt;/li>
&lt;li>Add Rate-Limit (or throughput limit)&lt;/li>
&lt;li>Split services from a single instance&lt;/li>
&lt;/ul>
&lt;p>And next, our mentor let us share when we will change it from one type to another one. Our mentor says, there are many companies is sharing their stories, but that is not for our case.&lt;/p>
&lt;p>Same as our every meetup, we start discussing the cons for each choice. For example, the scale-out seems a good idea but when we have over 300 or more machines is it easy to manage it? How long we had to spend on the upgrade?&lt;/p>
&lt;p>We may want to merge them and reduce the total instance we manage. Our mentor also let us to check for the famous company which uses microservices to have how many microservices and is there has an up limit or not.&lt;/p>
&lt;p>We also discuss the above options&amp;rsquo; prop and cons. I will pick some interesting parts to share for you.&lt;/p>
&lt;blockquote>
&lt;p>In the real world, we usually not only use one of them and we usually combine it to use. I feel it is similar to the toy bricks to let us combine or split them to fit our business.&lt;/p>
&lt;/blockquote>
&lt;h2 id="queue">Queue&lt;/h2>
&lt;p>This is the most discuss part of our discussion. At first, we are discussing the timing to use the queue.&lt;/p>
&lt;p>For example, if we have a service is required a realtime result response the queue may not useful in this case. The queue gives us an async capability that means we have the same problem when we use the thread.&lt;/p>
&lt;p>In the real world, we usually need to let our data write into the database in sequence to prevent race-condition. Therefore the Queue usually runs in order.&lt;/p>
&lt;p>On the other hand, the queue usually has a capacity limit if our request is out of the capacity we have to blocking our user.&lt;/p>
&lt;p>That means use the queue we get a buffer to write the database. But it also causes another bottleneck to another service.&lt;/p>
&lt;blockquote>
&lt;p>This is interesting for each option have their cons, it also matches I learned in the previous meetup. We have to consider the cons and carefully to pick one of the solutions.&lt;/p>
&lt;/blockquote>
&lt;h3 id="rabbitmq">RabbitMQ&lt;/h3>
&lt;p>We also discuss some queue service solutions. The RabbitMQ is written in Erlang and the Erlang can recovery from the failed process. That means in the common case our queue needs to have a 2x memory to ensure it can correctly recovery. Because we have another backup in memory to ensure the failed process can be recovered.&lt;/p>
&lt;h3 id="kafka">Kafka&lt;/h3>
&lt;p>Our mentor asks us, the Kafka is written in Java but why it is fast? And why Java is slow?&lt;/p>
&lt;p>One of the reasons is GC will cause some performance problems. But Java has an &lt;code>Off-Heap&lt;/code> to manage the memory by ourselves so it can run faster than the common cases.&lt;/p>
&lt;p>The Kafka focuses on throughput because it is developed by Linkedin and the throughput is more important for Linkedin. The mentor tells us, some compare is useless because they try to compare two similar services but didn&amp;rsquo;t design to resolve the same problem.&lt;/p>
&lt;h2 id="region">Region&lt;/h2>
&lt;p>Another interesting discussion is the region. In the scale-up options which are usually hardest to upgrade? The answer is the network and this is why AWS, GCP, and most large global companies trying to build their submarine cable and data center in the different countries.&lt;/p>
&lt;p>To have high-speed exchange data between two regions, we cannot improve it like buy more CPU, RAM or Disk.&lt;/p>
&lt;p>Another question is when we have high-availability or master-master architecture. When one data center is shut down in an accident, does there have how many problems we have to resolve?&lt;/p>
&lt;p>Maybe we have some data that didn&amp;rsquo;t sync to another data center. If our major data center is recovered, how to keep data is consistent?&lt;/p>
&lt;p>Or when our major data center stop, our stand-by data center already has the same hardware which can handle the requests?&lt;/p>
&lt;h2 id="conclusion">Conclusion&lt;/h2>
&lt;p>This meetup I think we learned more about how to choose a solution. In the past, I am very hard to answer other&amp;rsquo;s why I use PostgreSQL or MySQL or why I choose Ruby.&lt;/p>
&lt;p>At first, I think it is I am not professional enough about one of them. But I think the reason is I never consider their trait or detail behind their feature.&lt;/p>
&lt;p>It is a good chance to practice thinking from the cons to find more detail. I also try to convert my thinking flow but it still hard to change my habit.&lt;/p></content:encoded></item><item><title>TGONext: Choose Architecture By Cons</title><link>https://blog.frost.tw/en/posts/2020/03/15/TGONext-Choose-Architecture-by-Cons/</link><category>Architecture</category><category>Microservice</category><category>Database</category><category>Experience</category><category>TGONext</category><pubDate>Sun, 15 Mar 2020 03:02:32 +0800</pubDate><author>contact@frost.tw (蒼時弦也)</author><guid>https://blog.frost.tw/en/posts/2020/03/15/TGONext-Choose-Architecture-by-Cons/</guid><description>&lt;p>This meetup we review previous discussions and switch to the next topic. Based on the high concurrency we talk about the last meetup, we simulate an architecture and evolution it.&lt;/p></description><content:encoded>&lt;p>This meetup we review previous discussions and switch to the next topic. Based on the high concurrency we talk about the last meetup, we simulate an architecture and evolution it.&lt;/p>
&lt;h2 id="the-trap-inside-the-suggested-way">The trap inside the suggested way&lt;/h2>
&lt;p>At first, we have a monolithic application put web server and database in the same machine.&lt;/p>
&lt;pre>&lt;code>+-----------------------+
|+---------------------+|
|| ||
|| Web Server ||
|| ||
|+---------------------+|
|+---------------------+|
|| ||
|| Database ||
|| ||
|+---------------------+|
+-----------------------+
&lt;/code>&lt;/pre>&lt;p>When the requests are growing, we will split the web server and database to the standalone machine.&lt;/p>
&lt;pre>&lt;code>+---------------------+ +---------------------+
| | | |
| Web Server &amp;lt;----------&amp;gt; Database |
| | | |
+---------------------+ +---------------------+
&lt;/code>&lt;/pre>&lt;p>When we feel it slow down again, we put a &amp;ldquo;cache server&amp;rdquo; to our architecture.
For example, a cache server is added between the web server and database server.&lt;/p>
&lt;pre>&lt;code>+---------------------+ +---------------------+ +---------------------+
| | | | | |
| Web Server &amp;lt;------&amp;gt; Cache Server &amp;lt;------&amp;gt; Database |
| | | | | |
+---------------------+ +---------------------+ +---------------------+
&lt;/code>&lt;/pre>&lt;p>When our cache crashed. The service will recovery after reboot or not?&lt;/p>
&lt;blockquote>
&lt;p>It may unable to recovery because the cache server lost everything when it restarts, and the webserver still sends a large number of requests to the cache server but passthrough to the database.&lt;/p>
&lt;/blockquote>
&lt;p>This is the &amp;ldquo;avalanche effect&amp;rdquo;, one of our servers is failed and cause others to become unstable and finally let all service down.&lt;/p>
&lt;p>Our mentor suggests to didn&amp;rsquo;t add the cache server before our team member knows the pros and cons of the cache server, and know what happens the library or framework they are using.&lt;/p>
&lt;h2 id="will-microservice-rescue-us">Will microservice rescue us?&lt;/h2>
&lt;p>If we want to prevent the &amp;ldquo;avalanche effect&amp;rdquo;, you may associate it to the microservice which is popular in recent years.&lt;/p>
&lt;p>The microservice is designed for &amp;ldquo;decentralize&amp;rdquo; which means each component can redeploy easily and work independently.&lt;/p>
&lt;p>But it is too ideal, our service usually has some dependency on another service. For example, the webserver usually depends on the database.&lt;/p>
&lt;p>This is another point we have to consider when we design an architecture.&lt;/p>
&lt;p>In nowadays, the most popular way is to manage the dependency problem in microservice is to create a &amp;ldquo;sidecar&amp;rdquo; to control all community between components. The sidecar can know other services is alive or ready and report the status of the service which is managed.&lt;/p>
&lt;p>Our mentor tells us an architecture solution usually depends on a problem that is designed to resolve it.&lt;/p>
&lt;p>Another point is to find a problem in a microservice system, we have to know which service caused the issue. That means a microservice system needs a powerful log tracker to track each event inside the system.&lt;/p>
&lt;h2 id="which-is-paid-for-an-architecture-choice">Which is paid for an architecture choice?&lt;/h2>
&lt;p>After we learn some popular terms and the latest architecture design we start to discuss when should we use microservice.&lt;/p>
&lt;p>Our mentor tells us the performance includes three concern:&lt;/p>
&lt;ul>
&lt;li>Throughput&lt;/li>
&lt;li>Latency&lt;/li>
&lt;li>Memory Footprint&lt;/li>
&lt;/ul>
&lt;p>They will inflect each other which means if we choose one of them, the others should be paid for our gain.&lt;/p>
&lt;p>In the microservice, it passes the packet inside the system to redirect it to the target services. That means the latency will be higher than other architecture, but it is decentralized and easier to create more components that we can easier to handle the growing incoming bandwidth.&lt;/p>
&lt;p>The microservice uses latency to exchange more throughput to give us the ability to handle more requests.&lt;/p>
&lt;p>But if our service requirements are low latency, the microservice will be a bad idea for our product.&lt;/p>
&lt;h3 id="domain-driven-design">Domain-Driven Design&lt;/h3>
&lt;p>The DDD is one of our topics, our mentor also let us think about why DDD becomes popular when microservice is becoming popular.&lt;/p>
&lt;p>We can find a similar part is they are both considered by a &amp;ldquo;domain.&amp;rdquo; They try to let each service to focus on one business part. This is very different than the MVC we are using. And that is why the DDD is more close to the microservice&amp;rsquo;s necessary.&lt;/p>
&lt;p>On the other hand, if we want to use the microservice in our company. It depends on your company size and you have some problems to communicate with different departments. The microservice may be a good idea for each department to have its own service.&lt;/p>
&lt;blockquote>
&lt;p>But we have to consider the over design in our department.We may only need to create a monolithic application as the only service in our department or company. The microservice still have a lot of requirement and have too many services in one department may cause more problem.&lt;/p>
&lt;/blockquote>
&lt;h2 id="the-data-consistency">The data consistency&lt;/h2>
&lt;p>Besides the performance, another important part is the data inside our architecture. Each system has its own state and our service needs decide to use a strong consistency or eventual consistency and it should be discussed carefully.&lt;/p>
&lt;p>For example, the bank system should be a strong consistency. You may not expect it shows your money does not exist after you save it into the bank. And after one hour it shows again after the bank finished the consistency check.&lt;/p>
&lt;blockquote>
&lt;p>The distributed system is a data consistency problem too.&lt;/p>
&lt;/blockquote>
&lt;h2 id="the-databases-evolution">The database&amp;rsquo;s evolution&lt;/h2>
&lt;p>In a system, the database is directly related to the data consistency topics. Our mentor let us compare the RDBMS, NoSQL, and NewSQLs&amp;rsquo; different.&lt;/p>
&lt;h3 id="rdbms">RDBMS&lt;/h3>
&lt;p>Before the RDBMS there has an Object-Oriented Database, but we didn&amp;rsquo;t discuss it even the PostgreSQL has the trait of it.&lt;/p>
&lt;blockquote>
&lt;p>This is the first state of evolution and most common for us so we didn&amp;rsquo;t discuss it too many at this time.&lt;/p>
&lt;/blockquote>
&lt;h3 id="nosql">NoSQL&lt;/h3>
&lt;p>In the NoSQL cases, we paid the consistency for throughput. This is why NoSQL has good scalability to let us can scale it very easily.&lt;/p>
&lt;p>But NoSQL had to implement a lot of things in the application layer because the RDBMS does many things for us but NoSQL doesn&amp;rsquo;t do that for us.&lt;/p>
&lt;blockquote>
&lt;p>Another trait is the NoSQL is depended on the SSD trait to change the data store design and give us a super-fast key-value type data access.&lt;/p>
&lt;/blockquote>
&lt;h3 id="newsql">NewSQL&lt;/h3>
&lt;p>The NewSQL is the reflection of NoSQL, people start thinking about NoSQL as a database is not enough. There have many things that should not implement on the application layer and should be done in the database.&lt;/p>
&lt;p>Therefore they are starting to create a NewSQL that has strong consistency similar to RDBMS but has enough scalability capability.&lt;/p>
&lt;blockquote>
&lt;p>Currently, the NewSQL is not popular and didn&amp;rsquo;t have a lot of Open Source solutions.&lt;/p>
&lt;/blockquote>
&lt;h2 id="the-choose-of-database">The choose of database&lt;/h2>
&lt;p>In the previous discussion, the mentor let us share our views about the reason to choose a database.&lt;/p>
&lt;p>There have many cases to let us choose a database:&lt;/p>
&lt;ul>
&lt;li>The Database Feature&lt;/li>
&lt;li>Framework&lt;/li>
&lt;li>Team Member&lt;/li>
&lt;li>Customer&amp;rsquo;s preference&lt;/li>
&lt;/ul>
&lt;p>There is no correct answer, like the above the architecture has many pros and cons in the different designs we discussed.&lt;/p>
&lt;h2 id="conclusion">Conclusion&lt;/h2>
&lt;p>This article lost a lot of detail, but I am out of my memory to write more details.&lt;/p>
&lt;p>After the first meetup, I am worried about our discussion will stop at some calculate and knowledge we didn&amp;rsquo;t know.&lt;/p>
&lt;p>But in this meetup, our mentor gives us a new method or new viewpoint which we can apply to our work.&lt;/p>
&lt;p>The most important thing is &lt;strong>find the cons in your solution&lt;/strong> and review it before you decide to use it.&lt;/p>
&lt;p>The pros usually give us benefits, but when our system has some trouble. The cons are the actual problem we have to face.&lt;/p>
&lt;p>Therefore we have to choose an architecture with minimal damage to our product which means the cons didn&amp;rsquo;t have too many conflicts with our product&amp;rsquo;s requirements.&lt;/p></content:encoded></item><item><title>The Reusable Ansible Role Problem</title><link>https://blog.frost.tw/en/posts/2020/02/29/The-Reusable-Ansible-Role-Problem/</link><category>Ansible</category><category>DevOps</category><category>Experience</category><category>Rails</category><category>Ruby on Rails</category><pubDate>Sat, 29 Feb 2020 17:59:46 +0800</pubDate><author>contact@frost.tw (蒼時弦也)</author><guid>https://blog.frost.tw/en/posts/2020/02/29/The-Reusable-Ansible-Role-Problem/</guid><description>&lt;p>About 1 year ago, I build a &lt;a href="https://www.ansible.com/">Ansible&lt;/a> playbook for the customers of &lt;a href="https://5xruby.tw">5xRuby&lt;/a>.&lt;/p>
&lt;p>When our customers grow it is hard to use the fork feature to maintenance our customer&amp;rsquo;s playbook.&lt;/p>
&lt;p>I have to update the main version and sync the changes to the fork version for each customer. Therefore I decided to split the common parts to a single role repository.&lt;/p></description><content:encoded>&lt;p>About 1 year ago, I build a &lt;a href="https://www.ansible.com/">Ansible&lt;/a> playbook for the customers of &lt;a href="https://5xruby.tw">5xRuby&lt;/a>.&lt;/p>
&lt;p>When our customers grow it is hard to use the fork feature to maintenance our customer&amp;rsquo;s playbook.&lt;/p>
&lt;p>I have to update the main version and sync the changes to the fork version for each customer. Therefore I decided to split the common parts to a single role repository.&lt;/p>
&lt;h2 id="overview">Overview&lt;/h2>
&lt;p>In the current version, we have a playbook like below:&lt;/p>
&lt;pre>&lt;code>├── [1.0K] README.md
├── [ 96] group_vars
│   └── [1.2K] all.yml
├── [ 96] inventories
│   └── [ 309] local
├── [ 480] roles
│   ├── [ 96] 5xruby_user
│   ├── [ 96] application
│   ├── [ 96] compile_env
│   ├── [ 96] deploy_user
│   ├── [ 96] init
│   ├── [ 128] logrotate
│   ├── [ 160] nginx_with_passenger
│   ├── [ 96] node
│   ├── [ 160] postgresql_server
│   ├── [ 96] ruby
│   ├── [ 96] ssh
│   ├── [ 96] sudo
│   └── [ 128] yum_install_commons
└── [ 467] setup.yml
&lt;/code>&lt;/pre>&lt;p>When our customer needs to customize their provision environment, we have to fork it and change the variables and some template.&lt;/p>
&lt;p>But it is hard to update the playbook because it may cause some conflict.&lt;/p>
&lt;h2 id="target">Target&lt;/h2>
&lt;p>The Ansible Galaxy provides the dependencies manage feature to Ansible, it allows us to use &lt;code>roles/requirements.yml&lt;/code> to manage it like below:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-yml" data-lang="yml">- &lt;span class="k">src&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>https&lt;span class="p">:&lt;/span>//github.com/5xruby/ansible-ruby&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">0.1.0&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>- &lt;span class="k">src&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>https&lt;span class="p">:&lt;/span>//github.com/5xruby/ansible-nginx&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">0.1.0&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Before we run the playbook, we can use &lt;code>ansible-galaxy install -r roles/requirements.yml&lt;/code> to automatically install these roles. And it also works well with &lt;a href="https://github.com/ansible/awx">Ansible AWX&lt;/a> (a.k.a Ansible Tower)&lt;/p>
&lt;p>That sounds good, but when I start work on it I got some problems.&lt;/p>
&lt;h2 id="nginx-modules">Nginx Modules&lt;/h2>
&lt;p>For &lt;a href="https://rubyonrails.org/">Rails&lt;/a> project, we have more than one choice of the webserver.&lt;/p>
&lt;p>If we use &lt;a href="https://puma.io/">Puma&lt;/a> we only require to configure Nginx as a reverse proxy.&lt;/p>
&lt;p>But if we decide to use &lt;a href="https://www.phusionpassenger.com/">Passenger&lt;/a> we have to compile it as an Nginx module.&lt;/p>
&lt;p>It means if I want to support Puma and Passenger together, my Nginx role should include the Passenger tasks.&lt;/p>
&lt;p>My first version is to use the &lt;a href="https://docs.ansible.com/ansible/latest/modules/include_tasks_module.html">&lt;code>include_tasks&lt;/code>&lt;/a> to add an extra module config when enabled Passenger.&lt;/p>
&lt;p>But if we want to add more Nginx modules in the future? Our Nginx role will grow and becomes another huge playbook.&lt;/p>
&lt;h2 id="manual-dependencies">Manual Dependencies&lt;/h2>
&lt;p>After many tries, I find an acceptable implement to resolve the problem.&lt;/p>
&lt;ol>
&lt;li>Create a Fact &lt;code>nginx_module_options&lt;/code> as empty array&lt;/li>
&lt;li>Loop &lt;code>nginx_extar_modules&lt;/code> to &lt;code>import_role&lt;/code> to execute module related tasks&lt;/li>
&lt;li>After the module&amp;rsquo;s source code downloaded, append configure options to &lt;code>nginx_module_options&lt;/code>&lt;/li>
&lt;/ol>
&lt;p>In our playbook, we can configure dependencies like below:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>- &lt;span class="k">src&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>https&lt;span class="p">:&lt;/span>//github.com/5xruby/ansible-nginx&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">0.1.0&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>- &lt;span class="k">src&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>https&lt;span class="p">:&lt;/span>//github.com/5xruby/ansible-passenger&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">0.1.0&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>And add Nginx module options to &lt;code>group_vars/all.yml&lt;/code> as a default config to apply to all web hosts.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="k">nginx_extra_modules&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;passenger&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>After resolving the Nginx module problem, another problem is coming.&lt;/p>
&lt;h2 id="the-role-dependencies">The Role Dependencies&lt;/h2>
&lt;p>When I prepare the Nginx, Ruby, Node.js, and others required for deploy Rails. I configure the Rails role&amp;rsquo;s dependencies.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="k">dependencies&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="k">src&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>https&lt;span class="p">:&lt;/span>//github.com/5xruby/ansible-nginx&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="k">src&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>https&lt;span class="p">:&lt;/span>//github.com/5xruby/ansible-ruby&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="k">src&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>https&lt;span class="p">:&lt;/span>//github.com/5xruby/ansible-node&lt;span class="w">
&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="k">src&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>https&lt;span class="p">:&lt;/span>//github.com/5xruby/ansible-passenger&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>When I use my playbook to run &lt;code>rails&lt;/code> role, it starts the task from the &lt;code>nginx&lt;/code> role.&lt;/p>
&lt;p>It seems no problem for us, but we have to configure the &lt;code>nginx.conf&lt;/code> and set the &lt;code>root&lt;/code> to our application&amp;rsquo;s public directory.&lt;/p>
&lt;p>If the &lt;code>nginx&lt;/code> role is run before the &lt;code>rails&lt;/code> role, we will get the Nginx start failed error.&lt;/p>
&lt;blockquote>
&lt;p>The first version Nginx will create the root directory with customized owner and group, but it has some problems in this case. The deploy user is created by the &lt;code>rails&lt;/code> role and it will unable to find the owner user which is not created yet.&lt;/p>
&lt;/blockquote>
&lt;p>But after clarifying the problem, it is a human design mistake.&lt;/p>
&lt;p>&amp;ldquo;The Nginx is the dependencies of Rails?&amp;rdquo;&lt;/p>
&lt;p>If we use the Puma, we can replace Nginx to any reverse proxy server. So we didn&amp;rsquo;t dependent on the Nginx.&lt;/p>
&lt;h2 id="final-produce">Final Produce&lt;/h2>
&lt;p>After about two days of hard work, I have a new playbook almost zero-config to deploy a server for Rails.&lt;/p>
&lt;pre>&lt;code>├── install.yml
├── group_vars
│ └── all.yml
├── inventory
├── playbooks
│ └── install-nginx.yml
│ └── install-postgres.yml
│ └── install-rails.yml
├── roles
│ └── requirements.yml
├── templates
└ ─── nginx.conf.j2
&lt;/code>&lt;/pre>&lt;p>Everything is very simple, usually use &lt;code>import_role: nginx&lt;/code> to add the necessary role.&lt;/p>
&lt;p>If we need more customized we can override the variable (e.g. &lt;code>nginx_config_template&lt;/code>) and put the customize template to &lt;code>templates/nginx.conf.j2&lt;/code>&lt;/p>
&lt;blockquote>
&lt;p>I only put a default Nginx config inside the Nginx role and put the customize &lt;code>nginx.conf&lt;/code> in the playbook to enable the Passenger.&lt;/p>
&lt;/blockquote>
&lt;h2 id="conclusion">Conclusion&lt;/h2>
&lt;p>This is an interesting experience to &amp;ldquo;decouple&amp;rdquo; the provision script. As a programmer, we have a lot of rule can follow to decouple our program. But when you are working on the operation-side, how to create a reusable script and manageable?&lt;/p>
&lt;p>But this work is only the start. I am considering the future upgrade after I finished this stage.&lt;/p>
&lt;ul>
&lt;li>How to clear the old versions?&lt;/li>
&lt;li>If the database has to upgrade, should I create a new server?&lt;/li>
&lt;li>If used for creating a Cloud Image (e.g. AMI) how to clear up?&lt;/li>
&lt;/ul>
&lt;p>The DevOps sounds very easy to put developer and operator together but make the work together still hard, I guess.&lt;/p></content:encoded></item><item><title>TGONext: The plan for high concurrency</title><link>https://blog.frost.tw/en/posts/2020/02/23/TGONext-The-plan-for-high-concurrency/</link><category>Experience</category><category>TGONext</category><category>Architecture</category><pubDate>Sun, 23 Feb 2020 15:54:37 +0800</pubDate><author>contact@frost.tw (蒼時弦也)</author><guid>https://blog.frost.tw/en/posts/2020/02/23/TGONext-The-plan-for-high-concurrency/</guid><description>&lt;p>Yesterday is the first meetup of the &lt;a href="https://next.tgonetworks.org/">TGONext&lt;/a> project, we are learning from Taiwan&amp;rsquo;s high-level technical leaders. After the opening, our mentor &lt;a href="https://blog.gcos.me/">Ant&lt;/a> let our polling for the topic we want to discuss in this half-year project time.&lt;/p>
&lt;p>We decide to pick up 4 topics to discuss and the first topic is &amp;ldquo;high concurrency.&amp;rdquo;&lt;/p></description><content:encoded>&lt;p>Yesterday is the first meetup of the &lt;a href="https://next.tgonetworks.org/">TGONext&lt;/a> project, we are learning from Taiwan&amp;rsquo;s high-level technical leaders. After the opening, our mentor &lt;a href="https://blog.gcos.me/">Ant&lt;/a> let our polling for the topic we want to discuss in this half-year project time.&lt;/p>
&lt;p>We decide to pick up 4 topics to discuss and the first topic is &amp;ldquo;high concurrency.&amp;rdquo;&lt;/p>
&lt;h2 id="what-is-high-concurrency">What is High Concurrency&lt;/h2>
&lt;p>When we start this topic, our mentor gives us a question.&lt;/p>
&lt;blockquote>
&lt;p>How to define the high concurrency?&lt;/p>
&lt;/blockquote>
&lt;p>We know high concurrency is about we have a lot of users to use our service, but we notice we cannot clearly define it.&lt;/p>
&lt;p>But the definition is simple and makes us think deeper.&lt;/p>
&lt;blockquote>
&lt;p>The requests we can handle in a short time, usually in one second.&lt;/p>
&lt;/blockquote>
&lt;p>Based on the above definition, the most important thing is&lt;/p>
&lt;blockquote>
&lt;p>We should have the capability to handle the request otherwise it is useless in our high concurrency plan.&lt;/p>
&lt;/blockquote>
&lt;h2 id="how-to-measure-the-concurrency">How to measure the concurrency&lt;/h2>
&lt;p>To ensure our service to have the capability to handle the large amount request or the target our market team asks for us.&lt;/p>
&lt;p>We have to correctly measure the capability in our system.&lt;/p>
&lt;p>Our mentor let us list the tools we had used or heard about.&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://httpd.apache.org/docs/2.4/programs/ab.html">ab&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/wg/wrk">wrk&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/giltene/wrk2">wrk2&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://jmeter.apache.org/">JMeter&lt;/a>&lt;/li>
&lt;li>SaaS (the cloud service provide similar service)&lt;/li>
&lt;/ul>
&lt;p>The tools are very common, so I didn&amp;rsquo;t direct link them with the measurement tools.&lt;/p>
&lt;p>And then, the mentor asks us &amp;ldquo;the report between tools will different?&amp;rdquo;&lt;/p>
&lt;p>We never consider this small concern, but it is very important when we measure the capability.&lt;/p>
&lt;p>For example, &lt;code>ab&lt;/code> will create threads before sending requests. And send it at the same time. It usually gets a lower score and not fit the real-world&amp;rsquo;s user behavior.&lt;/p>
&lt;blockquote>
&lt;p>To measure the capability, we have to consider the test is fit the real-world&amp;rsquo;s user behavior.&lt;/p>
&lt;/blockquote>
&lt;p>And there have other things we also need to consider when we are testing capability.&lt;/p>
&lt;h3 id="the-test-machines-limit">The test machine&amp;rsquo;s limit&lt;/h3>
&lt;p>If we try to send a high concurrency request in one machine, but the max threads are over the machine&amp;rsquo;s capability. We will get the wrong result, and we need to use a tool can run on multi-machine or implement a tool controller to trigger tool in multiple machines.&lt;/p>
&lt;h3 id="the-network-environment">The network environment&lt;/h3>
&lt;p>If we send the request from LAN the requested amount will larger than the real-world case. At least, we have to put in a different zone and consider the user&amp;rsquo;s location.&lt;/p>
&lt;blockquote>
&lt;p>There has another concern have to be noted, we are testing the &amp;ldquo;capability&amp;rdquo; that means we are not put the &amp;ldquo;pressure&amp;rdquo; to our server, they are the different test type.&lt;/p>
&lt;/blockquote>
&lt;h3 id="the-tools-calculator-method">The tool&amp;rsquo;s calculator method&lt;/h3>
&lt;p>This already talks before this section, but the &lt;code>wrk2&lt;/code> is mentioned by our mentor. Some tools didn&amp;rsquo;t calculate the timespan from request to response and it may not fully fit the real-world case.&lt;/p>
&lt;p>Our mentor tells us the &lt;code>wrk2&lt;/code> use &lt;a href="https://medium.com/@siddontang/the-coordinated-omission-problem-in-the-benchmark-tools-5d9abef79279">Coordinated Omission&lt;/a> algorithm and it is more fit the real-world.&lt;/p>
&lt;h3 id="the-perfect-result">The perfect result&lt;/h3>
&lt;p>If we see a perfect result, we have to look-out our test method and tool. There may have something we are not expected and give us a different result.&lt;/p>
&lt;h2 id="from-mau-to-qps">From MAU to QPS&lt;/h2>
&lt;p>In the real-world, the QPS (query per second) isn&amp;rsquo;t defined by the developer team. It usually depends on the market team&amp;rsquo;s target or the CEO&amp;rsquo;s plan.&lt;/p>
&lt;p>That means we usually get an MAU (monthly active user) instead of QPS.&lt;/p>
&lt;p>For example, if the market team tells us the next month they plan to grow to 1 million monthly active users.&lt;/p>
&lt;p>What is the minimal QPS we have to provide that can reach the market team&amp;rsquo;s requirement?&lt;/p>
&lt;p>After a short discussion and guess, we notice some clues about the requests.&lt;/p>
&lt;ul>
&lt;li>User didn&amp;rsquo;t always online&lt;/li>
&lt;li>One user may have more than one requests to process one action&lt;/li>
&lt;li>The most user only active in the specified time (ex. event)&lt;/li>
&lt;/ul>
&lt;p>For example, we can use the 80-20 rule to assume the 80% user only active in 20% time.&lt;/p>
&lt;p>And to define the max request at the same time per user, the mentor tells us in the experience we usually choose the &amp;ldquo;most active behavior&amp;rdquo; and count the API request behind it.&lt;/p>
&lt;p>And then, we have minimal information to calculate the QPS from MAU.&lt;/p>
&lt;ul>
&lt;li>MAU: 1 million&lt;/li>
&lt;li>Requests per user: 3 API Request per Action&lt;/li>
&lt;li>Active Time: 20% time of one day&lt;/li>
&lt;/ul>
&lt;p>And we can start a calculate:&lt;/p>
&lt;blockquote>
&lt;p>(1 million * 3 API Request) / (30 * 0.2 * 86400) * 0.8 ~= 4.6 QPS&lt;/p>
&lt;/blockquote>
&lt;p>The calculate formula will be:&lt;/p>
&lt;blockquote>
&lt;p>(MAU * Requests) / (30 * 20% Time * 1 Day (in second)) * 80% User ~= QPS&lt;/p>
&lt;/blockquote>
&lt;p>The result is lower than we expect before we know how to calculate it. But it based on the data and reasonable.&lt;/p>
&lt;p>Therefore, our target is to design our architecture to allow it can handle the QPS greater than 4.6.&lt;/p>
&lt;blockquote>
&lt;p>The mentor also tells us the ratio will be different in other cases, but we can use the report which is opened on the network and find the best ratio in your industry.&lt;/p>
&lt;/blockquote>
&lt;h2 id="conclusion">Conclusion&lt;/h2>
&lt;p>This is the first part we discuss, it spends about 1.5 hours but has large information.&lt;/p>
&lt;p>We have the next part to discuss the SLI/SLO/SLA and the availability to break down the QPS, but it uses a short time and we may discuss it online or next meetup. I will summary them after we finish the next topic.&lt;/p>
&lt;p>After about 2 hours discuss with the mentor and other mentees, I still believe the most important thing in TGONext is learning the mentor&amp;rsquo;s viewpoint when they face a question.&lt;/p>
&lt;p>In this high concurrency discussion, we define the &amp;ldquo;high concurrency&amp;rdquo; and focus on the technical part &amp;ldquo;QPS&amp;rdquo; to check the target we have to reach. And connect our experience with other departments to make us can co-work correctly.&lt;/p>
&lt;p>In nowadays, some people say &amp;ldquo;the title is not important&amp;rdquo;. But when you learn from TGONext&amp;rsquo;s CTO or other high-level professional peoples, you will know the actual difference between us is we usually not focus on the correct problem, and we didn&amp;rsquo;t know the correct method to do it.&lt;/p>
&lt;p>Thanks to the &lt;a href="https://tgonetworks.org/">TOGNetworks&lt;/a> provide a good chance to us, give a road-sign to learning high-level skills. Not continue self-satisfaction in the title we have in our company.&lt;/p></content:encoded></item><item><title>Write a suitable RSpec test</title><link>https://blog.frost.tw/en/posts/2020/02/20/Write-a-suitable-RSpec-test/</link><category>Ruby</category><category>RSpec</category><category>Experience</category><category>BDD</category><category>TDD</category><category>Rails</category><pubDate>Thu, 20 Feb 2020 00:26:16 +0000</pubDate><author>contact@frost.tw (蒼時弦也)</author><guid>https://blog.frost.tw/en/posts/2020/02/20/Write-a-suitable-RSpec-test/</guid><description>&lt;p>Include me, write test is many people&amp;rsquo;s nightmare. Many junior programmers feel it is hard to define which should be tested. So, I decided to share my experience after I tech my colleague today.&lt;/p></description><content:encoded>&lt;p>Include me, write test is many people&amp;rsquo;s nightmare. Many junior programmers feel it is hard to define which should be tested. So, I decided to share my experience after I tech my colleague today.&lt;/p>
&lt;p>Before we start talking about how to write a test, let us stop thinking about anything about TDD or BDD or any you may read about it.&lt;/p>
&lt;p>And ask yourself, what is &amp;ldquo;test&amp;rdquo;? Why we need a &amp;ldquo;test&amp;rdquo;?&lt;/p>
&lt;p>The target we add the tests to our project usually to prevent human mistake, that means we try to let compute help us to confirm our code matches the &amp;ldquo;spec&amp;rdquo;.&lt;/p>
&lt;p>But we have to know, the test still is human write code and the spec is human to decide. When you have the wrong spec and wrong way to test, we still get the wrong result.&lt;/p>
&lt;p>So, let us try to keep everything simple, and you will feel happy when writing the test.&lt;/p>
&lt;h2 id="the-pure-ruby-example">The Pure Ruby example&lt;/h2>
&lt;p>In my experience, the test is related to your code. If you have bad code, and you will hard to test it. So, no matter you write the test before implementing anything or after it. The most important thing is the double-check which you want to test and fit your necessities.&lt;/p>
&lt;p>Let&amp;rsquo;s write a &lt;code>Calculator&lt;/code> class, and try to test it.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="k">class&lt;/span> &lt;span class="nc">Calculator&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">initialize&lt;/span>
&lt;span class="vi">@inputs&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">[]&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>At first, we have a &lt;code>Calculator&lt;/code> class with initialized &lt;code>@inputs&lt;/code> array.&lt;/p>
&lt;p>And we can create a simple RSpec skeleton.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="no">RSpec&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">describe&lt;/span> &lt;span class="no">Calculator&lt;/span> &lt;span class="k">do&lt;/span>
&lt;span class="n">let&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">:calculator&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="no">Calculator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>And next, let us add the &lt;code>#add&lt;/code> method to the calculator to allow it to add something.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="k">class&lt;/span> &lt;span class="nc">Calculator&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">initialize&lt;/span>
&lt;span class="vi">@inputs&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">[]&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">number&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="vi">@inputs&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">number&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">perform&lt;/span>
&lt;span class="vi">@inputs&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sum&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>And let&amp;rsquo;s update our test&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="no">RSpec&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">describe&lt;/span> &lt;span class="no">Calculator&lt;/span> &lt;span class="k">do&lt;/span>
&lt;span class="n">let&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">:calculator&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="no">Calculator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="n">describe&lt;/span> &lt;span class="s1">&amp;#39;#add&amp;#39;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;span class="n">let&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">:number&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="n">subject&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="n">calculator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">number&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="n">it&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="n">is_expected&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">to&lt;/span> &lt;span class="kp">include&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">number&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="n">describe&lt;/span> &lt;span class="s1">&amp;#39;#perform&amp;#39;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;span class="n">subject&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="n">calculator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">perform&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="n">before&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="n">calculator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="n">it&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="n">is_expected&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">to&lt;/span> &lt;span class="n">eq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>In my experience, the best case is you can simply define a &lt;code>subject&lt;/code> which is the target you want to test for, and we can use one line to test it. So I usually try to let my code can be tested like the above example.&lt;/p>
&lt;blockquote>
&lt;p>In the real world, it may not usually ideal. But this post we didn&amp;rsquo;t discuss these case, maybe we can discuss in the future.&lt;/p>
&lt;/blockquote>
&lt;h2 id="real-world-example">Real-world example&lt;/h2>
&lt;p>After we have an imagination about the ideal test, let us try to apply it in the real world.&lt;/p>
&lt;p>This morning we are discussing a legacy object which is the order&amp;rsquo;s payment processor with my team member.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="k">class&lt;/span> &lt;span class="nc">PaymentService&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">initialize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">payment&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="vi">@order&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">payment&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">order&lt;/span>
&lt;span class="vi">@payment&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">payment&lt;/span>
&lt;span class="c1"># ...&lt;/span>
&lt;span class="n">setup&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">setup&lt;/span>
&lt;span class="vi">@payment&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">amount&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">amount&lt;/span>
&lt;span class="vi">@payment&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">currency&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="vi">@order&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">currency&lt;/span>
&lt;span class="c1"># ...&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">perform&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kp">false&lt;/span> &lt;span class="k">unless&lt;/span> &lt;span class="vi">@payment&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">valid?&lt;/span>
&lt;span class="no">ActiveRecord&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">Base&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">transaction&lt;/span> &lt;span class="k">do&lt;/span>
&lt;span class="vi">@payment&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">save&lt;/span>
&lt;span class="no">VendorAPI&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">payment&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">amount&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="vi">@payment&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">amount&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># ...&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="kp">private&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">amount&lt;/span>
&lt;span class="vi">@order&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">items&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sum&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="ss">:subtotal&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>When we try to test this class, we notice it is very hard to add any test for it. Because the information is encapsulation inside the &lt;code>@payment&lt;/code> but we cannot access it.&lt;/p>
&lt;p>You may want to expose the &lt;code>@payment&lt;/code> as an attribute like &lt;code>service.payment.amount&lt;/code>&lt;/p>
&lt;p>But if we try to check for the amount is correct, our test code does not make sense.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="n">subject&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="n">service&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">payment&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">amount&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="n">it&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="n">is_expected&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">to&lt;/span> &lt;span class="n">eq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">100&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>We test for the &amp;ldquo;Service Object&amp;rdquo; not the &amp;ldquo;Payment Model&amp;rdquo; inside it. According to this rule, the test should be like below.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="n">subject&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="n">service&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">amount&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="n">it&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="n">is_expected&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">to&lt;/span> &lt;span class="n">eq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">100&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>At this moment, the &amp;ldquo;subject&amp;rdquo; correctly refers to the service&amp;rsquo;s amount.&lt;/p>
&lt;p>Let&amp;rsquo;s refactor the &lt;code>PaymentService&lt;/code> class to fit our expectations.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="k">class&lt;/span> &lt;span class="nc">PaymentService&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">initialize&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">order&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="vi">@order&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">order&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">amount&lt;/span>
&lt;span class="vi">@order&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">items&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sum&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="ss">:subtotal&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">perform&lt;/span>
&lt;span class="n">payment&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">build_payment&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kp">false&lt;/span> &lt;span class="k">unless&lt;/span> &lt;span class="n">payment&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">valid?&lt;/span>
&lt;span class="no">ActiveRecord&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">Base&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">transaction&lt;/span> &lt;span class="k">do&lt;/span>
&lt;span class="n">payment&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">save&lt;/span>
&lt;span class="no">VendorAPI&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">payment&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">amount&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">amount&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="c1"># ...&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="kp">private&lt;/span>
&lt;span class="k">def&lt;/span> &lt;span class="nf">build_payment&lt;/span>
&lt;span class="vi">@order&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">payments&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">build&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="ss">amount&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">amount&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="ss">currency&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="vi">@order&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">currency&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>After refactoring, the &lt;code>PaymentService&lt;/code> is becoming more straight and we can focus tests on the &lt;code>PaymentService&lt;/code>.&lt;/p>
&lt;p>This is my experience when I design an object and I usually follow this rule in my work.&lt;/p>
&lt;h2 id="more-example-of-rails">More example of Rails&lt;/h2>
&lt;p>The Rails is the popular framework in Rubyist, I use it almost every workday. How can we use the above skills in Rails?&lt;/p>
&lt;p>Just keep your class simple, and everything will be easier to test.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="c1"># Model&lt;/span>
&lt;span class="no">RSpec&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">describe&lt;/span> &lt;span class="no">User&lt;/span> &lt;span class="k">do&lt;/span>
&lt;span class="n">it&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="n">should&lt;/span> &lt;span class="n">validate_presence_of&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">:email&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="c1"># ...&lt;/span>
&lt;span class="n">describe&lt;/span> &lt;span class="s2">&amp;#34;#avatar_url&amp;#34;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;span class="n">let&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">:email&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="s2">&amp;#34;example@example.com&amp;#34;&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="n">let&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">:user&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="n">create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">:user&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">email&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">email&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="n">subject&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="n">user&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">avatar_url&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="n">it&lt;/span> &lt;span class="s2">&amp;#34;returns Gravatar URL&amp;#34;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;span class="n">digest&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="no">OpenSSL&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">Digest&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="no">MD5&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">hexdigest&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">email&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="n">should&lt;/span> &lt;span class="n">eq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;https://www.gravatar.com/avatar/&lt;/span>&lt;span class="si">#{&lt;/span>&lt;span class="nb">hash&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>For the model, I usually prevent logic inside it. If your project is small and simple, it is ok to do this. But when your project is complex, we usually have to take several steps to process one thing. And that may be a signal to us to split it into an independent class to focus on this process (we usually call them service object)&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="c1"># Request&lt;/span>
&lt;span class="no">RSpec&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">describe&lt;/span> &lt;span class="s2">&amp;#34;/api/users&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ss">type&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="ss">:request&lt;/span> &lt;span class="k">do&lt;/span>
&lt;span class="n">describe&lt;/span> &lt;span class="s2">&amp;#34;GET /api/users&amp;#34;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;span class="n">let&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">:users&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="n">create_list&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ss">:user&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="n">before&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="n">get&lt;/span> &lt;span class="n">api_users_path&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="n">subject&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="n">response&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">code&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="n">it&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="n">should&lt;/span> &lt;span class="n">eq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;200&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="n">describe&lt;/span> &lt;span class="s2">&amp;#34;body&amp;#34;&lt;/span> &lt;span class="k">do&lt;/span>
&lt;span class="n">subject&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="no">JSON&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">parse&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">body&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="n">it&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="n">should_not&lt;/span> &lt;span class="n">be_empty&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="c1"># ...&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>If it is possible, I usually try to make my test more simple. It will help us to think about how to design our class is more clear and easier to use.&lt;/p>
&lt;p>The above examples only cover very small parts of tests, but I think it is enough to show the suitable test usually depend on your code.&lt;/p>
&lt;p>I still not used to write the test before I start work, and I also skip some tests if I have no time to write it.&lt;/p>
&lt;p>But according to my experience, even you didn&amp;rsquo;t write the test you still need to think about &amp;ldquo;when I try to test my code, which is easier?&amp;rdquo;&lt;/p>
&lt;p>And then, you will notice the best practice we read from the net if we follow it and usually let our code easier to be tested.&lt;/p>
&lt;p>For example, the junior will define a method mix different type return values.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre class="chroma">&lt;code class="language-ruby" data-lang="ruby">&lt;span class="k">def&lt;/span> &lt;span class="nf">sum&lt;/span>
&lt;span class="k">return&lt;/span> &lt;span class="kp">false&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">summable?&lt;/span>
&lt;span class="vi">@items&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sum&lt;/span>
&lt;span class="k">end&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>It will cause it hard to predict which type will be returned, and we need to write more test cases to confirm it.&lt;/p>
&lt;h2 id="conclusion">Conclusion&lt;/h2>
&lt;p>This may not an advanced skill, but I spend a lot of years to learn and try to write a test suitable.&lt;/p>
&lt;p>And I notice my company&amp;rsquo;s junior also has the same problem and feeling confusing when I ask them to try to refactor some legacy code.&lt;/p>
&lt;p>They feel lost their way and didn&amp;rsquo;t know where they can start to refactor the code.&lt;/p>
&lt;p>So, when you feel confusing, just check for your code about:&lt;/p>
&lt;ul>
&lt;li>Is the test can focus on my class without depending on others?&lt;/li>
&lt;li>Is my behavior is focused on one thing? (ex. Read and write, validate value, send an API request)&lt;/li>
&lt;li>Is my method returns is expectable? (ex. the only number, object have the same interface)&lt;/li>
&lt;/ul>
&lt;p>That sounds very simple and you may read about some object-oriented article about SOLID rules. But it still is hard to design it to a suitable state which didn&amp;rsquo;t have too many over design.&lt;/p>
&lt;p>Anyway, hope my article can help you find some inspiration when you try to write some tests.&lt;/p></content:encoded></item></channel></rss>