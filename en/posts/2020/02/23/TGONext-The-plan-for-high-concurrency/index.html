<!doctype html><html lang=en><head><title>TGONext: The plan for high concurrency - Aotokitsuruya is learning</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="Yesterday is the first meetup of the TGONext project, we are learning from Taiwan&amp;rsquo;s high-level technical leaders. After the opening, our mentor Ant let our polling …"><meta name=created content="2020-02-23T00:00:00+0000"><meta name=modified content="2020-02-23T15:54:37+0800"><meta name=author content="蒼時弦也"><meta property="og:site_name" content="Aotokitsuruya is learning"><meta property="og:title" content="TGONext: The plan for high concurrency"><meta property="og:url" content="https://blog.frost.tw/en/posts/2020/02/23/TGONext-The-plan-for-high-concurrency/"><meta property="og:type" content="article"><meta property="og:image" content="https://blog.frost.tw/images/2020-02-23-tgonext-the-plan-for-high-concurrency/thumbnail.jpg"><meta name=theme-color content="#EFEFEF"><link href=https://blog.frost.tw/icon-512.png rel=icon><link rel=canonical href=https://blog.frost.tw/en/posts/2020/02/23/TGONext-The-plan-for-high-concurrency/><link rel=alternate hreflang=zh-tw href=https://blog.frost.tw/posts/2020/02/23/TGONext-The-plan-for-high-concurrency/><script type=application/ld+json>[{"@context":"https://schema.org","@type":"WebPage","headline":"TGONext: The plan for high concurrency ","datePublished":"2020-02-23T15:54:37+08:00","dateModified":"2020-02-23T15:54:37+08:00","url":"https://blog.frost.tw/en/posts/2020/02/23/TGONext-The-plan-for-high-concurrency/","description":"Yesterday is the first meetup of the TGONext project, we are learning from Taiwan\u0026rsquo;s high-level technical leaders. After the opening, our mentor Ant let our polling …\n","keywords":["Experience","TGONext","Architecture"],"image":"https://blog.frost.tw/images/2020-02-23-tgonext-the-plan-for-high-concurrency/thumbnail.jpg","author":{"@type":"Person","name":"蒼時弦也"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.frost.tw/"},"publisher":{"@type":"Organization","name":"Aotokitsuruya is learning","url":"https://blog.frost.tw/"}},{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https://blog.frost.tw/","name":"Aotokitsuruya is learning","image":"http://blog.frost.tw/icon-512.png"}},{"@type":"ListItem","position":2,"item":{"@id":"https://blog.frost.tw/en/posts/2020/02/23/TGONext-The-plan-for-high-concurrency/","name":"TGONext: The plan for high concurrency ","image":"https://blog.frost.tw/images/2020-02-23-tgonext-the-plan-for-high-concurrency/thumbnail.jpg"}}]}]</script><link rel=stylesheet href=/css/styls.css><script async src=/js/turbolinks.min.js></script></head><body><div id=fb-root data-turbolinks-permanent></div><h1 id=sitename><a href=/en class="hide-text logo--icon align-center">Aotokitsuruya is learning</a></h1><aside id=slogan class="slogan align-center text-center"><h2 class=slogan__title>Aotokitsuruya</h2><p class=slogan__description>The Web is attracting me, so I start learning PHP, HTML, CSS and JavaScript. When I know about Ruby, I fall in love with it. Now, I working with my friend to design games using C++ and still learning web about Golang, Ruby and JavaScript. In the other side, I also be a designer, the reason why the web is attracted me.</p></aside><div id=wrapper><article class="post article" role=article><header class=article__header><time datetime=2020-02-23T15:54:37+0800 class=article__time--header role=time>Feb.23</time><h1 class=article__title>TGONext: The plan for high concurrency</h1></header><div class=article__entry><nav class=translation><a class=translation__link href=https://blog.frost.tw/posts/2020/02/23/TGONext-The-plan-for-high-concurrency/>繁體中文</a></nav><aside class=article__toc><header class=article__toc-title><h3>Table of Contents</h3></header><nav role=menuitem><nav id=TableOfContents><ul><li><a href=#what-is-high-concurrency>What is High Concurrency</a></li><li><a href=#how-to-measure-the-concurrency>How to measure the concurrency</a><ul><li><a href=#the-test-machines-limit>The test machine&rsquo;s limit</a></li><li><a href=#the-network-environment>The network environment</a></li><li><a href=#the-tools-calculator-method>The tool&rsquo;s calculator method</a></li><li><a href=#the-perfect-result>The perfect result</a></li></ul></li><li><a href=#from-mau-to-qps>From MAU to QPS</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></nav><hr></aside><p>Yesterday is the first meetup of the <a href=https://next.tgonetworks.org/>TGONext</a> project, we are learning from Taiwan&rsquo;s high-level technical leaders. After the opening, our mentor <a href=https://blog.gcos.me/>Ant</a> let our polling for the topic we want to discuss in this half-year project time.</p><p>We decide to pick up 4 topics to discuss and the first topic is &ldquo;high concurrency.&rdquo;</p><h2 id=what-is-high-concurrency>What is High Concurrency</h2><p>When we start this topic, our mentor gives us a question.</p><blockquote><p>How to define the high concurrency?</p></blockquote><p>We know high concurrency is about we have a lot of users to use our service, but we notice we cannot clearly define it.</p><p>But the definition is simple and makes us think deeper.</p><blockquote><p>The requests we can handle in a short time, usually in one second.</p></blockquote><p>Based on the above definition, the most important thing is</p><blockquote><p>We should have the capability to handle the request otherwise it is useless in our high concurrency plan.</p></blockquote><h2 id=how-to-measure-the-concurrency>How to measure the concurrency</h2><p>To ensure our service to have the capability to handle the large amount request or the target our market team asks for us.</p><p>We have to correctly measure the capability in our system.</p><p>Our mentor let us list the tools we had used or heard about.</p><ul><li><a href=https://httpd.apache.org/docs/2.4/programs/ab.html>ab</a></li><li><a href=https://github.com/wg/wrk>wrk</a></li><li><a href=https://github.com/giltene/wrk2>wrk2</a></li><li><a href=https://jmeter.apache.org/>JMeter</a></li><li>SaaS (the cloud service provide similar service)</li></ul><p>The tools are very common, so I didn&rsquo;t direct link them with the measurement tools.</p><p>And then, the mentor asks us &ldquo;the report between tools will different?&rdquo;</p><p>We never consider this small concern, but it is very important when we measure the capability.</p><p>For example, <code>ab</code> will create threads before sending requests. And send it at the same time. It usually gets a lower score and not fit the real-world&rsquo;s user behavior.</p><blockquote><p>To measure the capability, we have to consider the test is fit the real-world&rsquo;s user behavior.</p></blockquote><p>And there have other things we also need to consider when we are testing capability.</p><h3 id=the-test-machines-limit>The test machine&rsquo;s limit</h3><p>If we try to send a high concurrency request in one machine, but the max threads are over the machine&rsquo;s capability. We will get the wrong result, and we need to use a tool can run on multi-machine or implement a tool controller to trigger tool in multiple machines.</p><h3 id=the-network-environment>The network environment</h3><p>If we send the request from LAN the requested amount will larger than the real-world case. At least, we have to put in a different zone and consider the user&rsquo;s location.</p><blockquote><p>There has another concern have to be noted, we are testing the &ldquo;capability&rdquo; that means we are not put the &ldquo;pressure&rdquo; to our server, they are the different test type.</p></blockquote><h3 id=the-tools-calculator-method>The tool&rsquo;s calculator method</h3><p>This already talks before this section, but the <code>wrk2</code> is mentioned by our mentor. Some tools didn&rsquo;t calculate the timespan from request to response and it may not fully fit the real-world case.</p><p>Our mentor tells us the <code>wrk2</code> use <a href=https://medium.com/@siddontang/the-coordinated-omission-problem-in-the-benchmark-tools-5d9abef79279>Coordinated Omission</a> algorithm and it is more fit the real-world.</p><h3 id=the-perfect-result>The perfect result</h3><p>If we see a perfect result, we have to look-out our test method and tool. There may have something we are not expected and give us a different result.</p><h2 id=from-mau-to-qps>From MAU to QPS</h2><p>In the real-world, the QPS (query per second) isn&rsquo;t defined by the developer team. It usually depends on the market team&rsquo;s target or the CEO&rsquo;s plan.</p><p>That means we usually get an MAU (monthly active user) instead of QPS.</p><p>For example, if the market team tells us the next month they plan to grow to 1 million monthly active users.</p><p>What is the minimal QPS we have to provide that can reach the market team&rsquo;s requirement?</p><p>After a short discussion and guess, we notice some clues about the requests.</p><ul><li>User didn&rsquo;t always online</li><li>One user may have more than one requests to process one action</li><li>The most user only active in the specified time (ex. event)</li></ul><p>For example, we can use the 80-20 rule to assume the 80% user only active in 20% time.</p><p>And to define the max request at the same time per user, the mentor tells us in the experience we usually choose the &ldquo;most active behavior&rdquo; and count the API request behind it.</p><p>And then, we have minimal information to calculate the QPS from MAU.</p><ul><li>MAU: 1 million</li><li>Requests per user: 3 API Request per Action</li><li>Active Time: 20% time of one day</li></ul><p>And we can start a calculate:</p><blockquote><p>(1 million * 3 API Request) / (30 * 0.2 * 86400) * 0.8 ~= 4.6 QPS</p></blockquote><p>The calculate formula will be:</p><blockquote><p>(MAU * Requests) / (30 * 20% Time * 1 Day (in second)) * 80% User ~= QPS</p></blockquote><p>The result is lower than we expect before we know how to calculate it. But it based on the data and reasonable.</p><p>Therefore, our target is to design our architecture to allow it can handle the QPS greater than 4.6.</p><blockquote><p>The mentor also tells us the ratio will be different in other cases, but we can use the report which is opened on the network and find the best ratio in your industry.</p></blockquote><h2 id=conclusion>Conclusion</h2><p>This is the first part we discuss, it spends about 1.5 hours but has large information.</p><p>We have the next part to discuss the SLI/SLO/SLA and the availability to break down the QPS, but it uses a short time and we may discuss it online or next meetup. I will summary them after we finish the next topic.</p><p>After about 2 hours discuss with the mentor and other mentees, I still believe the most important thing in TGONext is learning the mentor&rsquo;s viewpoint when they face a question.</p><p>In this high concurrency discussion, we define the &ldquo;high concurrency&rdquo; and focus on the technical part &ldquo;QPS&rdquo; to check the target we have to reach. And connect our experience with other departments to make us can co-work correctly.</p><p>In nowadays, some people say &ldquo;the title is not important&rdquo;. But when you learn from TGONext&rsquo;s CTO or other high-level professional peoples, you will know the actual difference between us is we usually not focus on the correct problem, and we didn&rsquo;t know the correct method to do it.</p><p>Thanks to the <a href=https://tgonetworks.org/>TOGNetworks</a> provide a good chance to us, give a road-sign to learning high-level skills. Not continue self-satisfaction in the title we have in our company.</p><footer class=article__footer><div class=text-center><div class=fb-share-button data-href="<%- page.permalink %>" data-layout=button_count></div></div><div class="text-center mt-1"><style>.bmc-button img{width:27px!important;margin-bottom:1px!important;box-shadow:none!important;border:none!important;vertical-align:middle!important}.bmc-button{line-height:36px!important;height:37px!important;text-decoration:none!important;display:inline-flex!important;color:#fff!important;background-color:#000!important;border-radius:3px!important;border:1px solid transparent!important;padding:1px 9px!important;font-size:22px!important;letter-spacing:.6px!important;box-shadow:0 1px 2px rgba(190,190,190,.5)!important;-webkit-box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;margin:0 auto!important;font-family:cookie,cursive!important;-webkit-box-sizing:border-box!important;box-sizing:border-box!important;-o-transition:.3s all linear!important;-webkit-transition:.3s all linear!important;-moz-transition:.3s all linear!important;-ms-transition:.3s all linear!important;transition:.3s all linear!important}.bmc-button:hover,.bmc-button:active,.bmc-button:focus{-webkit-box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;text-decoration:none!important;box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;opacity:.85!important;color:#fff!important}</style><link href="https://fonts.googleapis.com/css?family=Cookie" rel=stylesheet><a class=bmc-button target=_blank href=https://www.buymeacoffee.com/aotoki><img src=https://bmc-cdn.nyc3.digitaloceanspaces.com/BMC-button-images/BMC-btn-logo.svg alt="Buy me a Coffee"><span style=margin-left:5px>Buy me a Coffee</span></a></div><iframe scrolling=no frameborder=0 style="display:block;margin:0 auto;height:212px" src="https://button.like.co/in/embed/elct9620/button?referrer=<%- page.permalink %>"></iframe><ul class=article__tag-list><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/en/tags/Experience/>Experience</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/en/tags/TGONext/>TGONext</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/en/tags/Architecture/>Architecture</a></li></ul></footer><aside class=related><header class=related__header><h3 class=related__title>See Also</h3></header><ul><li class=related__item><a class=related__link href=/en/posts/2020/02/20/Write-a-suitable-RSpec-test/>Write a suitable RSpec test</a></li></ul></aside></div></article><div class=adv><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-2844969736316510 data-ad-slot=5530952976 data-ad-format=auto></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div><section id=comment class=comment-box><h1 class=comment-box__title>Comments</h1><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"revo-skill-frost"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></section></div><footer id=footer><div id=copyright>&copy;2020 <a href="https://plus.google.com/117236344655673213049?rel=author" target=_blank rel=noreferrer>蒼時弦也</a>. All right reversed.</div></footer><script src=/js/app.min.4b4fad1b2ae959091673cb811c0b1b88781c8a49c7b1bf1a3a3ff449f4be31ac.js></script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5TQLRN" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-5TQLRN');</script><script>window.fbAsyncInit=function(){FB.init({appId:'178355449110',xfbml:true,version:'v2.12'});FB.AppEvents.logPageView();};(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(d.getElementById(id)){return;}
js=d.createElement(s);js.id=id;js.src="https://connect.facebook.net/zh_TW/sdk.js";js.async=true
js.defer=true
fjs.parentNode.insertBefore(js,fjs);}(document,'script','facebook-jssdk'));</script><div class=loading></div></body></html>