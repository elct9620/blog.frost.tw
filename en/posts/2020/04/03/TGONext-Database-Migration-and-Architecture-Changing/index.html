<!doctype html><html lang=en><head><title>TGONext: Database Migration and Architecture Changing - Aotokitsuruya is learning</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="Before we starting to discuss architecture, our mentor let us ask some questions.
Between this meetup and previous meetup, my customer breaks their migration due to some …"><meta name=created content="2020-04-03T00:00:00+0000"><meta name=modified content="2020-04-03T21:14:56+0800"><meta name=author content="蒼時弦也"><meta property="og:site_name" content="Aotokitsuruya is learning"><meta property="og:title" content="TGONext: Database Migration and Architecture Changing"><meta property="og:url" content="https://blog.frost.tw/en/posts/2020/04/03/TGONext-Database-Migration-and-Architecture-Changing/"><meta property="og:type" content="article"><meta property="og:image" content="https://blog.frost.tw/images/2020-04-03-tgonext-database-migration-and-architecture-changing/thumbnail.jpg"><meta name=theme-color content="#EFEFEF"><link href=https://blog.frost.tw/icon-512.png rel=icon><link rel=canonical href=https://blog.frost.tw/en/posts/2020/04/03/TGONext-Database-Migration-and-Architecture-Changing/><link rel=alternate hreflang=zh-tw href=https://blog.frost.tw/posts/2020/04/03/TGONext-Database-Migration-and-Architecture-Changing/><script type=application/ld+json>[{"@context":"https://schema.org","@type":"WebPage","headline":"TGONext: Database Migration and Architecture Changing","datePublished":"2020-04-03T21:14:56+08:00","dateModified":"2020-04-03T21:14:56+08:00","url":"https://blog.frost.tw/en/posts/2020/04/03/TGONext-Database-Migration-and-Architecture-Changing/","description":"Before we starting to discuss architecture, our mentor let us ask some questions.\nBetween this meetup and previous meetup, my customer breaks their migration due to some …\n","keywords":["TGONext","Architecture","Database","Experience"],"image":"https://blog.frost.tw/images/2020-04-03-tgonext-database-migration-and-architecture-changing/thumbnail.jpg","author":{"@type":"Person","name":"蒼時弦也"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.frost.tw/"},"publisher":{"@type":"Organization","name":"Aotokitsuruya is learning","url":"https://blog.frost.tw/"}},{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https://blog.frost.tw/","name":"Aotokitsuruya is learning","image":"http://blog.frost.tw/icon-512.png"}},{"@type":"ListItem","position":2,"item":{"@id":"https://blog.frost.tw/en/posts/2020/04/03/TGONext-Database-Migration-and-Architecture-Changing/","name":"TGONext: Database Migration and Architecture Changing","image":"https://blog.frost.tw/images/2020-04-03-tgonext-database-migration-and-architecture-changing/thumbnail.jpg"}}]}]</script><script async src=/js/turbolinks.min.js></script></head><body><div id=fb-root data-turbolinks-permanent></div><h1 id=sitename><a href=/en class="hide-text logo--icon align-center">Aotokitsuruya is learning</a></h1><aside id=slogan class="slogan align-center text-center"><h2 class=slogan__title>Aotokitsuruya</h2><p class=slogan__description>The Web is attracting me, so I start learning PHP, HTML, CSS and JavaScript. When I know about Ruby, I fall in love with it. Now, I working with my friend to design games using C++ and still learning web about Golang, Ruby and JavaScript. In the other side, I also be a designer, the reason why the web is attracted me.</p></aside><div id=wrapper><article class="post article" role=article><header class=article__header><time datetime=2020-04-03T21:14:56+0800 class=article__time--header>Apr.03</time><h1 class=article__title>TGONext: Database Migration and Architecture Changing</h1></header><div class=article__entry><nav class=translation><a class=translation__link href=https://blog.frost.tw/posts/2020/04/03/TGONext-Database-Migration-and-Architecture-Changing/>繁體中文</a></nav><aside class=article__toc><header class=article__toc-title><h3>Table of Contents</h3></header><nav class=article__toc-list role=list><nav id=TableOfContents><ul><li><a href=#migrate-database-without-downtime>Migrate Database without Downtime</a><ul><li><a href=#the-mentees-experience>The mentee&rsquo;s experience</a></li><li><a href=#does-the-database-has-version-control>Does the Database has version-control?</a></li><li><a href=#the-performance-lost>The Performance Lost</a></li></ul></li><li><a href=#the-database-scalability>The Database Scalability</a></li><li><a href=#the-architecture-changing>The Architecture Changing</a></li><li><a href=#queue>Queue</a><ul><li><a href=#rabbitmq>RabbitMQ</a></li><li><a href=#kafka>Kafka</a></li></ul></li><li><a href=#region>Region</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></nav><hr></aside><p>Before we starting to discuss architecture, our mentor let us ask some questions.</p><p>Between this meetup and previous meetup, my customer breaks their migration due to some incorrect plan. So I raise a migration question to discuss the zero-downtime migration plan.</p><h2 id=migrate-database-without-downtime>Migrate Database without Downtime</h2><p>In my work, most customers are a startup and we can choose to stop our service for a short time and upgrade their server and migrate the database.</p><p>But for a large service, it may not acceptable to shutdown anything when upgrading or migration.</p><blockquote><p>Even we can stop service for one region but there are more global service is coming. It may unacceptable to other regions.</p></blockquote><h3 id=the-mentees-experience>The mentee&rsquo;s experience</h3><p>I believe the most programmer include me knows the method to implement it, but there has a lot of concern we didn&rsquo;t expect.</p><p>Other mentees share their experience with:</p><ul><li>Don&rsquo;t remove any column</li><li>Prevent migration rollback to drop anything</li><li>Copy and rename the table</li><li>Use trigger to mirror data</li></ul><p>The most common method usually safer for the database is to prevent removing the column, and all of the above solutions I had heard about from the internet.</p><h3 id=does-the-database-has-version-control>Does the Database has version-control?</h3><p>Our mentor points our more detailed information hidden in the discussion. Some mentees describe their method is the database cannot be lost between migration, that&rsquo;s means we decide to prevent remove any column or drop anything when rollback.</p><p>For example the source-code, we can jump to any version and didn&rsquo;t have any side-effects. Because the source-code is stateless, but if we try to change the database&rsquo;s version from <code>2020-03-28</code> to <code>2020-01-01</code> and is it possible to let everything back to <code>2020-03-28</code> after we migrate them again?</p><p>There didn&rsquo;t have a correct answer, it depends on the data is important or not for your service. But when we design a migration, we need to consider it and pick a safer policy.</p><h3 id=the-performance-lost>The Performance Lost</h3><p>Since we decide to didn&rsquo;t remove any column, the database may slow down due to the database have to load a large row when we query something.</p><p>This is a trait of RDBMS, they are the row-based design if we use the NoSQL we may not get this problem because they use column-based design.</p><p>But we also have other choices, for example, use the rename table to prevent become large tables. Create a temporary table to apply changes before we are ready to replace them.</p><p>The GitHub has a tool <a href=https://github.com/github/gh-ost>gh-ost</a> to let us didn&rsquo;t need to implement the flow by ourselves.</p><blockquote><p>Our mentor also reminds us, if our migration progress takes a long time and we want to pause the <code>gh-ost</code> is not allow it.</p></blockquote><p>Besides the performance problem, we also need to consider the table-lock and other possible problems.</p><blockquote><p>I notice in the discussion there are many database behaviors we already know but we usually forget to connect them together and check for the risk when we choose to do it.</p></blockquote><h2 id=the-database-scalability>The Database Scalability</h2><p>This is the extended part of the migration question. Since we know the RDBMS and NoSQL have some different traits. We start to compare MySQL/PostgreSQL and MongoDB&rsquo;s design.</p><p>In the RDBMS we usually use B+ Tree to create the index. Our mentor asks us why MongoDB uses B Tree to create the index.</p><p>To speed up to find data, one of the ways reduces the total rows to find. In the RDBMS we may choose to use Shard or Partition to create a small subset of a table.</p><p>In the B+ Tree, the data node will connect to the next row that means RDBMS can have a fast range scan. But if we want to create a shard to split data to the different databases, it is hard for the database to choose a subtree to split it because the data node may be connected to another subtree&rsquo;s data node.</p><p>But for MongoDB, it uses the B Tree that means it will be very easy to split a subtree because the data node didn&rsquo;t connect to another subtree.</p><p>That means MongoDB can easier to scale but the cons are the range scan become very slow and sharding may use a lot disk I/O to move data.</p><blockquote><p>This discussion gives me a inspire for suggest database option. A small design concern will change to behaviors and pros and cons.</p></blockquote><h2 id=the-architecture-changing>The Architecture Changing</h2><p>This is our main plan to discuss in this meetup. Our mentor let us share our idea about a service is unable to handle the requests.</p><p>In summary our idea, we have below chosen:</p><ul><li>Scale-up (Ex. Add memory, CPU)</li><li>Scale-out (Add more same type instance)</li><li>Add Cache</li><li>Add Queue</li><li>Add Rate-Limit (or throughput limit)</li><li>Split services from a single instance</li></ul><p>And next, our mentor let us share when we will change it from one type to another one. Our mentor says, there are many companies is sharing their stories, but that is not for our case.</p><p>Same as our every meetup, we start discussing the cons for each choice. For example, the scale-out seems a good idea but when we have over 300 or more machines is it easy to manage it? How long we had to spend on the upgrade?</p><p>We may want to merge them and reduce the total instance we manage. Our mentor also let us to check for the famous company which uses microservices to have how many microservices and is there has an up limit or not.</p><p>We also discuss the above options' prop and cons. I will pick some interesting parts to share for you.</p><blockquote><p>In the real world, we usually not only use one of them and we usually combine it to use. I feel it is similar to the toy bricks to let us combine or split them to fit our business.</p></blockquote><h2 id=queue>Queue</h2><p>This is the most discuss part of our discussion. At first, we are discussing the timing to use the queue.</p><p>For example, if we have a service is required a realtime result response the queue may not useful in this case. The queue gives us an async capability that means we have the same problem when we use the thread.</p><p>In the real world, we usually need to let our data write into the database in sequence to prevent race-condition. Therefore the Queue usually runs in order.</p><p>On the other hand, the queue usually has a capacity limit if our request is out of the capacity we have to blocking our user.</p><p>That means use the queue we get a buffer to write the database. But it also causes another bottleneck to another service.</p><blockquote><p>This is interesting for each option have their cons, it also matches I learned in the previous meetup. We have to consider the cons and carefully to pick one of the solutions.</p></blockquote><h3 id=rabbitmq>RabbitMQ</h3><p>We also discuss some queue service solutions. The RabbitMQ is written in Erlang and the Erlang can recovery from the failed process. That means in the common case our queue needs to have a 2x memory to ensure it can correctly recovery. Because we have another backup in memory to ensure the failed process can be recovered.</p><h3 id=kafka>Kafka</h3><p>Our mentor asks us, the Kafka is written in Java but why it is fast? And why Java is slow?</p><p>One of the reasons is GC will cause some performance problems. But Java has an <code>Off-Heap</code> to manage the memory by ourselves so it can run faster than the common cases.</p><p>The Kafka focuses on throughput because it is developed by Linkedin and the throughput is more important for Linkedin. The mentor tells us, some compare is useless because they try to compare two similar services but didn&rsquo;t design to resolve the same problem.</p><h2 id=region>Region</h2><p>Another interesting discussion is the region. In the scale-up options which are usually hardest to upgrade? The answer is the network and this is why AWS, GCP, and most large global companies trying to build their submarine cable and data center in the different countries.</p><p>To have high-speed exchange data between two regions, we cannot improve it like buy more CPU, RAM or Disk.</p><p>Another question is when we have high-availability or master-master architecture. When one data center is shut down in an accident, does there have how many problems we have to resolve?</p><p>Maybe we have some data that didn&rsquo;t sync to another data center. If our major data center is recovered, how to keep data is consistent?</p><p>Or when our major data center stop, our stand-by data center already has the same hardware which can handle the requests?</p><h2 id=conclusion>Conclusion</h2><p>This meetup I think we learned more about how to choose a solution. In the past, I am very hard to answer other&rsquo;s why I use PostgreSQL or MySQL or why I choose Ruby.</p><p>At first, I think it is I am not professional enough about one of them. But I think the reason is I never consider their trait or detail behind their feature.</p><p>It is a good chance to practice thinking from the cons to find more detail. I also try to convert my thinking flow but it still hard to change my habit.</p><footer class=article__footer><div class=text-center><div class=fb-share-button data-href="<%- page.permalink %>" data-layout=button_count></div></div><div class="text-center mt-1"><style>.bmc-button img{width:27px!important;margin-bottom:1px!important;box-shadow:none!important;border:none!important;vertical-align:middle!important}.bmc-button{line-height:36px!important;height:37px!important;text-decoration:none!important;display:inline-flex!important;color:#fff!important;background-color:#000!important;border-radius:3px!important;border:1px solid transparent!important;padding:1px 9px!important;font-size:22px!important;letter-spacing:.6px!important;box-shadow:0 1px 2px rgba(190,190,190,.5)!important;-webkit-box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;margin:0 auto!important;font-family:cookie,cursive!important;-webkit-box-sizing:border-box!important;box-sizing:border-box!important;-o-transition:.3s all linear!important;-webkit-transition:.3s all linear!important;-moz-transition:.3s all linear!important;-ms-transition:.3s all linear!important;transition:.3s all linear!important}.bmc-button:hover,.bmc-button:active,.bmc-button:focus{-webkit-box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;text-decoration:none!important;box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;opacity:.85!important;color:#fff!important}</style><link href="https://fonts.googleapis.com/css?family=Cookie&display=swap" rel=stylesheet><a class=bmc-button target=_blank href=https://www.buymeacoffee.com/aotoki><img src=https://bmc-cdn.nyc3.digitaloceanspaces.com/BMC-button-images/BMC-btn-logo.svg rel=noreferrer alt="Buy me a Coffee"><span style=margin-left:5px>Buy me a Coffee</span></a></div><iframe title=LikeCoin scrolling=no frameborder=0 style="display:block;margin:0 auto;height:212px" src="https://button.like.co/in/embed/elct9620/button?referrer=<%- page.permalink %>"></iframe><ul class=article__tag-list><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/en/tags/TGONext/>TGONext</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/en/tags/Architecture/>Architecture</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/en/tags/Database/>Database</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/en/tags/Experience/>Experience</a></li></ul></footer><aside class=related><header class=related__header><h3 class=related__title>See Also</h3></header><ul><li class=related__item><a class=related__link href=/en/posts/2020/03/15/TGONext-Choose-Architecture-by-Cons/>TGONext: Choose Architecture By Cons</a></li><li class=related__item><a class=related__link href=/en/posts/2020/02/23/TGONext-The-plan-for-high-concurrency/>TGONext: The plan for high concurrency</a></li><li class=related__item><a class=related__link href=/en/posts/2020/02/29/The-Reusable-Ansible-Role-Problem/>The Reusable Ansible Role Problem</a></li><li class=related__item><a class=related__link href=/en/posts/2020/02/20/Write-a-suitable-RSpec-test/>Write a suitable RSpec test</a></li></ul></aside></div></article><div class=subscribe><div id=mc_embed_signup><form action="https://frost.us4.list-manage.com/subscribe/post?u=dd3d68032c0510041f1302539&id=d2a668a8aa" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class=validate target=_blank novalidate><div id=mc_embed_signup_scroll><h1 class=subscribe__title>Newsletter</h2><div class=mc-field-group><input type=email name=EMAIL class="required email subscribe__input" id=mce-EMAIL placeholder=Email></div><div id=mce-responses class=clear><div class=response id=mce-error-response style=display:none></div><div class=response id=mce-success-response style=display:none></div></div><div style=position:absolute;left:-5000px aria-hidden=true><input type=text name=b_dd3d68032c0510041f1302539_d2a668a8aa tabindex=-1></div><div class=clear><input type=submit value=Subscribe name=subscribe id=mc-embedded-subscribe class="button subscribe__button"></div></div></form></div></div><div class=adv><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-2844969736316510 data-ad-slot=5530952976 data-ad-format=auto></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div><section id=comment class=comment-box><h1 class=comment-box__title>Comments</h1><div id=disqus_thread></div></div></section></div><footer id=footer><div id=copyright>&copy;2020 <a href="https://plus.google.com/117236344655673213049?rel=author" target=_blank rel=noreferrer>蒼時弦也</a>. All right reversed.</div></footer><link rel=stylesheet href=/css/styles.css><script src=/js/app.min.6e03bcf752b31ab875459fbdd360c766632ead24687ffe499c4cf1f86e9fe489.js></script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5TQLRN" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-5TQLRN');</script><script>window.fbAsyncInit=function(){FB.init({appId:'178355449110',xfbml:true,version:'v2.12'});FB.AppEvents.logPageView();};(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(d.getElementById(id)){return;}
js=d.createElement(s);js.id=id;js.src="https://connect.facebook.net/zh_TW/sdk.js";js.async=true
js.defer=true
fjs.parentNode.insertBefore(js,fjs);}(document,'script','facebook-jssdk'));</script><div class=loading></div></body></html>