<!DOCTYPE html>
<html lang="zh-TW">
  <head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>製作一個 Hubot 的噗浪 Adapter | 弦而時習之</title>
  <meta name="theme-color" content="#EFEFEF">

  <meta name="author" content="蒼時弦也">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <meta name="description" content="###前言我似乎非常喜歡搞前言這套，所以請大家聽我慢慢說完吧！ 大約是三、四個月前的事情，網友向我邀文，我就告訴他最近 HuBot 更新後，將 Adapter 分離出來，以 Module 的形式載入，我想之後的更新會很棒吧！ 不過，我卻拖到前幾天，我才心血來潮的在一天飆出機器人（原因不明，而且還被很多地方卡到陰） 這就是，故事的開始（好，請不要打我！） （本文以 Deploy 到 Heroku 為">
<meta property="og:type" content="article">
<meta property="og:title" content="製作一個 Hubot 的噗浪 Adapter">
<meta property="og:url" content="https://blog.frost.tw/posts/2012/03/18/create-a-hubot-plurk-adapter/">
<meta property="og:site_name" content="弦而時習之">
<meta property="og:description" content="###前言我似乎非常喜歡搞前言這套，所以請大家聽我慢慢說完吧！ 大約是三、四個月前的事情，網友向我邀文，我就告訴他最近 HuBot 更新後，將 Adapter 分離出來，以 Module 的形式載入，我想之後的更新會很棒吧！ 不過，我卻拖到前幾天，我才心血來潮的在一天飆出機器人（原因不明，而且還被很多地方卡到陰） 這就是，故事的開始（好，請不要打我！） （本文以 Deploy 到 Heroku 為">
<meta property="og:locale" content="zh-TW">
<meta property="og:image" content="http://blog.frost.tw/icon-512.png">
<meta property="og:updated_time" content="2019-06-29T15:43:47.153Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="製作一個 Hubot 的噗浪 Adapter">
<meta name="twitter:description" content="###前言我似乎非常喜歡搞前言這套，所以請大家聽我慢慢說完吧！ 大約是三、四個月前的事情，網友向我邀文，我就告訴他最近 HuBot 更新後，將 Adapter 分離出來，以 Module 的形式載入，我想之後的更新會很棒吧！ 不過，我卻拖到前幾天，我才心血來潮的在一天飆出機器人（原因不明，而且還被很多地方卡到陰） 這就是，故事的開始（好，請不要打我！） （本文以 Deploy 到 Heroku 為">
<meta name="twitter:image" content="http://blog.frost.tw/icon-512.png">
<link rel="publisher" href="https://plus.google.com/117236344655673213049">
<meta property="fb:app_id" content="178355449110">

  <meta property="fb:pages" content="180666522388">
  <script type="application/ld+json">
  [
{
    "@context": "https://schema.org",
    "@type": "Blog",
    "name": "弦而時習之",
    "url": "https://blog.frost.tw",
    "image": "http://blog.frost.tw/icon-512.png",
    "description": "蒼時弦也的個人網誌，專注在前端、後端以及遊戲開發，大多使用 Ruby 和 Ruby on Rails 以及 Golang、JS 和 C 語言。",
    "sameAs": [
      "https://www.facebook.com/frost.tw/"
    ]
},
{
    "@context": "https://schema.org",
    "@type": "Person",
    "name": "蒼時弦也",
    "url": "https://blog.frost.tw",
    "sameAs": [
      "https://www.facebook.com/elct9620",
      "https://www.instagram.com/elct9620/",
      "https://twitter.com/elct9620",
      "https://plus.google.com/+%E8%92%BC%E6%99%82%E5%BC%A6%E4%B9%9F-plus",
      "https://www.linkedin.com/in/elct9620"
    ]
},
{
  "@context":"https://schema.org",
  "@type":"BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.frost.tw/posts/2012/03/18/create-a-hubot-plurk-adapter/"
  },
  "headline":"製作一個 Hubot 的噗浪 Adapter",
  "image": [
    
    "http://blog.frost.tw/icon-512.png"
  ],
  
  "datePublished": "2012-03-18T06:02:00.000Z",
  "dateModified": "2019-06-29T15:43:47.153Z",
  "description":"###前言我似乎非常喜歡搞前言這套，所以請大家聽我慢慢說完吧！大約是三、四個月前的事情，網友向我邀文，我就告訴他最近 HuBot 更新後，將 Adapter 分離出來，以 Module 的形式載入，我想之後的更新會很棒吧！不過，我卻拖到前幾天，我才心血來潮的在一天飆出機器人（原因不明，而且還被很多地方卡到陰）這就是，故事的開始（好，請不要打我！）（本文以 Deploy 到 Heroku 為最終目標）",
  "author": {
    "@type": "Person",
    "name": "蒼時弦也"
  },
  "publisher": {
    "@type": "Organization",
    "name": "蒼時弦也",
    "logo": "https://blog.frost.tw/icon-512.png"
  }
},
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
    "@type": "ListItem",
    "position": 1,
    "item": {
      "@id": "https://blog.frost.tw",
      "name": "弦而時習之 ",
      "image": "http://blog.frost.tw/icon-512.png"
    }
  },{
    "@type": "ListItem",
    "position": 2,
    "item": {
      "@id": "https://blog.frost.tw/posts/2012/03/18/create-a-hubot-plurk-adapter/",
      "name": "製作一個 Hubot 的噗浪 Adapter",
      "image": "http://blog.frost.tw/icon-512.png"
    }
  }]
}
,
{
"@context": "https://schema.org",
  "@type": "Organization",
  "name": "蒼時弦也",
  "url": "https://blog.frost.tw",
  "logo": "https://blog.frost.tw/icon-512.png"
}
]
</script>



  <link rel="canonical" href="https://blog.frost.tw/posts/2012/03/18/create-a-hubot-plurk-adapter/">
  <link href="/icon-512.png" rel="icon">
  <link rel="alternate" href="/feed.xml" title="弦而時習之" type="application/rss+xml">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <script async src="/js/turbolinks.js"></script>
  
  
</head>

  <body>
    <div id="fb-root" data-turbolinks-permanent></div>
    <header id="header">
      
<h1 id="sitename">
  <a href="/" class="hide-text logo--icon align-center">
  弦而時習之
  </a>
</h1>

<aside id="slogan" class="slogan align-center text-center">
  <h2 class="slogan__title">Aotokitsuruya</h2>
  <p class="slogan__description">The Web is attracting  me, so I start learning PHP, HTML, CSS and JavaScript. When I know about Ruby, I fall in love with it. Now, I working with my friend to design games using C++ and still learning web about Golang, Ruby and JavaScript. In the other side, I also be a designer, the reason why the web is attracted me.</p>
</aside>

    </header>
    <div id="wrapper">
      
<article class="post article">
  <header class="article__header">
    <time datetime="2012-03-18T06:02:00.000Z" class="article__time--header">
      Mar.18
    </time>
    
  
    <h1 class="article__title">製作一個 Hubot 的噗浪 Adapter</h1>
  


  </header>
  <div class="article__entry">
    
    <h2 id="前言"><a href="#前言" class="headerlink" title="###前言"></a>###前言</h2><p>我似乎非常喜歡搞前言這套，所以請大家聽我慢慢說完吧！</p>
<p>大約是三、四個月前的事情，網友向我邀文，我就告訴他最近 HuBot 更新後，將 Adapter 分離出來，以 Module 的形式載入，我想之後的更新會很棒吧！</p>
<p>不過，我卻拖到前幾天，我才心血來潮的在一天飆出機器人（原因不明，而且還被很多地方卡到陰）</p>
<p>這就是，故事的開始（好，請不要打我！）</p>
<p>（本文以 Deploy 到 Heroku 為最終目標）</p>
<a id="more"></a> 
<h2 id="有雷，要先防護一下！"><a href="#有雷，要先防護一下！" class="headerlink" title="###有雷，要先防護一下！"></a>###有雷，要先防護一下！</h2><p>根據我的經驗，我被雷炸死超多次了！<br>（把 Adapter 什麼的寫出來一天一定夠，但是除雷讓我用了一半以上的時間 Orz）</p>
<ol>
<li>Hubot 除了內建的兩個 Adapter 之外都要以 Node.js 的 Module 方式才能運作（這代表說你一定得放到 node_modules 才會運作）</li>
<li>Hubot 的 bin/hubot 裡面寫著 npm install 所以不管你怎麼改原始碼也不能改變第一點的狀況</li>
<li>當你 Deploy 到 Heroku 上的時候，不能用 npm link</li>
<li>在 Heroku 上所有 module 都得用 npm 安裝（package.json內設定）</li>
</ol>
<p>其實上述都在討論同一件事情： Node.JS 的模組</p>
<p>而且模組不能設定相對路徑之類的來安裝，一定要透過</p>
<ul>
<li>NPM 官方的檔案</li>
<li>Git</li>
<li>HTTP</li>
</ul>
<p>上述三種方式才能安裝（說實在的 tgz 也是個雷，雖然說可用 tarball 裝，但是用 tar -zcf 壓縮是裝不了的）</p>
<p>被這些雷到可能是我笨（牆角）</p>
<h2 id="建立-Adapter"><a href="#建立-Adapter" class="headerlink" title="###建立 Adapter"></a>###建立 Adapter</h2><p>只需要兩個檔案</p>
<ul>
<li>package.json</li>
<li>plurk.coffee</li>
</ul>
<p>有這兩個就足以變成 Node.JS 的模組了～</p>
<p>在開始 Coding 之前，先來設定一下 package.json 弄好相依</p>
<pre><code>
{
  "name": "hubot-plurk",
  "version": "0.1.1",
  "main": "./plurk",
  "dependencies":{
    "hubot": ">=2.0.5",
    "oauth": "",
    "cron":""
  }
}

</code></pre>

<p>因為那個 Heroku 的 Cron Add-on 會把運算花費算到裡面，那就乾脆用 Node.JS 的 cron 模組就好了！而登入噗浪還需要 OAuth 才行，也裝上 OAuth 這樣</p>
<blockquote>
<p>Hubot 在讀取非內建模組時，會自動在前面加上 hubot- 的前置。</p>
</blockquote>
<h2 id="建立-Robot-跟-API"><a href="#建立-Robot-跟-API" class="headerlink" title="###建立 Robot 跟 API"></a>###建立 Robot 跟 API</h2><p>基本上程式碼都是參考 Twitter 的 Adapter 來製作，但是實際上竟然只有一樣用 OAuth 這一點而已（昏）</p>
<p>Twitter 有 Streaming 可用而 Plurk 則得用 Comet 方式來達到即時讀取。</p>
<figure class="highlight coffeescript"><figcaption><span>plurk.coffee</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Robot = <span class="built_in">require</span>(<span class="string">"hubot"</span>).robot()</span><br><span class="line">Adapter = <span class="built_in">require</span>(<span class="string">"hubto"</span>).adapter()</span><br><span class="line"></span><br><span class="line">EventEmitter = <span class="built_in">require</span>(<span class="string">"events"</span>).EventEmitter</span><br><span class="line"></span><br><span class="line">oauth = <span class="built_in">require</span>(<span class="string">"oauth"</span>)</span><br><span class="line">cronJob = <span class="built_in">require</span>(<span class="string">"cron"</span>).CronJob</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Plurk</span> <span class="title">exntends</span> <span class="title">Adapter</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PlurkStreaming</span> <span class="title">exnteds</span> <span class="title">EventEmitter</span></span></span><br></pre></td></tr></table></figure>
<p>先弄個基本架構，至於為什麼要叫 PlurkStreaming 只是因為參考的是 Twitter 而已（被拖走）</p>
<p>接著先給 Plurk 這個 Class 放進去幾個Method。<br>（基本上只要有 run, send, reply 就夠了，而 run 用來做初始化的部分）</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Plurk</span> <span class="title">entends</span> <span class="title">Adapter</span></span></span><br><span class="line">  send: <span class="function"><span class="params">(plurk_id, strings…)</span> -&gt;</span></span><br><span class="line">  </span><br><span class="line">  reply: <span class="function"><span class="params">(plurk_id, strings…)</span> -&gt;</span></span><br><span class="line">  </span><br><span class="line">  run: <span class="function">-&gt;</span></span><br></pre></td></tr></table></figure>
<p>看起來有點東西，來弄主要的 API 結合部分。</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PlurkStreaming</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span></span></span><br><span class="line">  </span><br><span class="line">  consuctor: <span class="function"><span class="params">(options)</span> -&gt;</span></span><br><span class="line">    </span><br><span class="line">  plurk: <span class="function"><span class="params">(callback)</span> -&gt;</span></span><br><span class="line">    <span class="comment">#觀察河道</span></span><br><span class="line">  getChannel: <span class="function">-&gt;</span></span><br><span class="line">    <span class="comment">#取得 Comet 網址</span></span><br><span class="line">  reply: <span class="function"><span class="params">(plurk_id, message)</span> -&gt;</span></span><br><span class="line">    <span class="comment">#回噗</span></span><br><span class="line">  acceptFriends: <span class="function">-&gt;</span></span><br><span class="line">    <span class="comment">#接受好友</span></span><br><span class="line">  get: <span class="function"><span class="params">(path, callback)</span> -&gt;</span></span><br><span class="line">    <span class="comment">#GET 請求</span></span><br><span class="line">  post: <span class="function"><span class="params">(path, body, callback)</span>-&gt;</span></span><br><span class="line">    <span class="comment">#POST 請求（其實是裝飾）</span></span><br><span class="line">  request: <span class="function"><span class="params">(method, path, body, callback)</span>-&gt;</span></span><br><span class="line">    <span class="comment">#主要的 OAuth 請求</span></span><br><span class="line">  comet: <span class="function"><span class="params">(server, callback)</span>-&gt;</span></span><br><span class="line">    <span class="comment">#噗浪的 Comet 傳回是 JavaScript Callback 要另外處理後才會變成 JSON</span></span><br></pre></td></tr></table></figure>
<p>然後我們先把注意力集中到 constructor 上，先把建構子弄好。</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">constructor: <span class="function"><span class="params">(options)</span> -&gt;</span></span><br><span class="line">  <span class="keyword">super</span>()</span><br><span class="line">  <span class="keyword">if</span> options.key? <span class="keyword">and</span> options.secret? <span class="keyword">and</span> options.token? <span class="keyword">and</span> options.token_secret?</span><br><span class="line">    @key = options.key</span><br><span class="line">    @secret = options.secret</span><br><span class="line">    @token = options.token</span><br><span class="line">    @token_secret = options.token_secret</span><br><span class="line">    <span class="comment">#建立 OAuth 連接</span></span><br><span class="line">    @consumer = <span class="keyword">new</span> oauth.OAuth(</span><br><span class="line">      <span class="string">"https://www.plurk.com/OAuth/request_token"</span>,</span><br><span class="line">      <span class="string">"https://www.plurk.com/OAuth/access_token"</span>,</span><br><span class="line">      @key,</span><br><span class="line">      @secret,</span><br><span class="line">      <span class="string">"1.0"</span>,</span><br><span class="line">      <span class="string">"https://www.plurk.com/OAuth/authorize"</span>.</span><br><span class="line">      <span class="string">"HMAC-SHA1"</span></span><br><span class="line">    )</span><br><span class="line">    @domain = <span class="string">"www.plurk.com"</span></span><br><span class="line">    <span class="comment">#初始化取得Comet網址</span></span><br><span class="line">    <span class="keyword">do</span> @getChannel</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"參數不足，需要 Key, Secret, Token, Token Secret"</span>)</span><br></pre></td></tr></table></figure>
<p>這樣建構子就差不多了！</p>
<p>接著來弄 request 這個 method (comet 很類似，這個寫好複製貼上一下～)</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">request: (method, path, body, callback) -&gt;</span><br><span class="line">  #記錄一下這次的 Request</span><br><span class="line">  console.log(&quot;https://#&#123;@domain&#125;#&#123;path&#125;&quot;)</span><br><span class="line">  </span><br><span class="line">  # Callback 這邊先不丟進去，要用另一種方式處理</span><br><span class="line">  request = @consumer.get(&quot;https://#&#123;@domain&#125;#&#123;path&#125;&quot;, @token, @token_secret, null)</span><br><span class="line">  </span><br><span class="line">  request.on &quot;response&quot;, (res) -&gt;</span><br><span class="line">    res.on &quot;data&quot;, (chunk) -&gt;</span><br><span class="line">      parseResponse(chunk+&apos;&apos;, callback)</span><br><span class="line">    res.on &quot;end&quot;, (data) -&gt;</span><br><span class="line">      console.log &quot;End Request: #&#123;path&#125;&quot;</span><br><span class="line">    res.on &quot;error&quot;, (data) -&gt;</span><br><span class="line">      console.log &quot;Error: &quot; + data</span><br><span class="line">      </span><br><span class="line">  request.end()</span><br><span class="line">  </span><br><span class="line">  #處理資料</span><br><span class="line">  parseResponse = (data, callback) -&gt;</span><br><span class="line">    if data.length &gt; 0</span><br><span class="line">      #用 Try/Catch 避免處理 JSON 出錯導致整個中斷</span><br><span class="line">      try</span><br><span class="line">        callback null, JSON.parse(data)</span><br><span class="line">      catch err</span><br><span class="line">        console.log(&quot;Error Parse JSON:&quot; + data, err)</span><br><span class="line">        #繼續執行</span><br><span class="line">        callback null, data || &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>大致上就是這樣，根據程式碼，其實是無視 POST 的。<br>（如果沒有特殊需求其實也不會用到 POST 方式）</p>
<p>而 Comet 的處理方式類似，不過我們要動用到 EventEmitter 的功能。<br>（避免一個 Request 還未結束又開始新的 Comet, 造成連續讀取兩次相同訊息的問題）</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">comet: (server, callback) -&gt;</span><br><span class="line">  #在 Callback 裡面會找不到自身，所以設定區域變數</span><br><span class="line">  self = @</span><br><span class="line"></span><br><span class="line">  #記錄一下這次的 Request</span><br><span class="line">  console.log(&quot;[Comet] #&#123;server&#125;&quot;)</span><br><span class="line">  </span><br><span class="line">  # Callback 這邊先不丟進去，要用另一種方式處理</span><br><span class="line">  request = @consumer.get(&quot;https://#&#123;@domain&#125;#&#123;path&#125;&quot;, @token, @token_secret, null)</span><br><span class="line">  </span><br><span class="line">  request.on &quot;response&quot;, (res) -&gt;</span><br><span class="line">    res.on &quot;data&quot;, (chunk) -&gt;</span><br><span class="line">      parseResponse(chunk+&apos;&apos;, callback)</span><br><span class="line">    res.on &quot;end&quot;, (data) -&gt;</span><br><span class="line">      console.log &quot;End Request: #&#123;path&#125;&quot;</span><br><span class="line">      #請求結束，發出事件通知可以進行下一次請求</span><br><span class="line">      self.emit &quot;nextPlurk&quot;</span><br><span class="line">    res.on &quot;error&quot;, (data) -&gt;</span><br><span class="line">      console.log &quot;Error: &quot; + data</span><br><span class="line">      </span><br><span class="line">  request.end()    </span><br><span class="line">  </span><br><span class="line">  #處理資料</span><br><span class="line">  parseResponse = (data, callback) -&gt;</span><br><span class="line">    if data.length &gt; 0</span><br><span class="line">      #用 try/catch 避免失敗中斷</span><br><span class="line">      try</span><br><span class="line">        #去掉 JavaScript 的 Callback</span><br><span class="line">        data = data.match(/CometChannel.scriptCallback\((.+)\);\s*/)</span><br><span class="line">        jsonData = &quot;&quot;</span><br><span class="line">        </span><br><span class="line">        if data?</span><br><span class="line">          jsonData = JSON.parse(data[1])</span><br><span class="line">        else</span><br><span class="line">          #如果沒有任何 Match 嘗試直接 parse</span><br><span class="line">          jsonData = JSON.parse(data)</span><br><span class="line">      catch err</span><br><span class="line">        console.log(&quot;[Comet] Error:&quot;, data, err)</span><br><span class="line">        </span><br><span class="line">      #用 Try/Catch 避免處理 JSON 出錯導致整個中斷</span><br><span class="line">      try</span><br><span class="line">        #只傳入 json 的 data 部分</span><br><span class="line">        callback null, jsonData.data</span><br><span class="line">      catch err</span><br><span class="line">        console.log(&quot;[Comet]Error Parse JSON:&quot; + data, err)</span><br><span class="line">        #繼續執行</span><br><span class="line">        callback null, data || &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>至於為什麼要這樣做呢？因為在測試時竟然因為噗浪 Lag 而沒讀到完整的 Comet 資料，然後就炸掉了！<br>（這樣至少不會造成運行中斷，睡覺時就不會碰到一個無法用就炸掉）</p>
<p>後面的 get 跟 post 就簡單多了！</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">get: <span class="function"><span class="params">(path, callback)</span> -&gt;</span></span><br><span class="line">  @request(<span class="string">"GET"</span>, path, <span class="literal">null</span>, callback)</span><br><span class="line">  </span><br><span class="line">post: <span class="function"><span class="params">(path, body, callback)</span> -&gt;</span></span><br><span class="line">  @request(<span class="string">"POST"</span>, path, body, callback)</span><br></pre></td></tr></table></figure>
<p>接著處理取的 Comet 網址的 getChannel</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">getChannel: <span class="function">-&gt;</span></span><br><span class="line">  self = @</span><br><span class="line">  </span><br><span class="line">  @get <span class="string">"/APP/Realtime/getUserChannel"</span>, <span class="function"><span class="params">(error, data)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">if</span> !error</span><br><span class="line">      <span class="comment">#檢查是否有 comet server</span></span><br><span class="line">      <span class="keyword">if</span> data.comet_server?</span><br><span class="line">        self.channel = data.comet_server</span><br><span class="line">        <span class="comment">#如果沒有 Channel Ready 就嘗試連接會失敗</span></span><br><span class="line">        self.emit(<span class="string">'channel_ready'</span>)</span><br></pre></td></tr></table></figure>
<p>接著處理 plurk 這部份</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">plurk: <span class="function"><span class="params">(callback)</span> -&gt;</span></span><br><span class="line">  <span class="comment">#其實官方文件是要設定 offset 的，不過目前沒有想到設定的方法，以及即使沒有設定也能正常運作</span></span><br><span class="line">  @comet @channel, <span class="function"><span class="params">(error, data)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">if</span> data?</span><br><span class="line">      <span class="comment">#將一筆筆的資料一一遞送</span></span><br><span class="line">      <span class="keyword">for</span> plurk <span class="keyword">in</span> data</span><br><span class="line">        callback plurk</span><br></pre></td></tr></table></figure>
<p>最後處理回噗跟接受好友就完成 API 的連接了！<br>（當然，其他部分大家可以自行擴充）</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">reply: <span class="function"><span class="params">(plurk_id, message)</span> -&gt;</span></span><br><span class="line">  <span class="comment">#設定回噗的參數</span></span><br><span class="line">  path = <span class="string">"/APP/Responses/responseAdd?plurk_id=<span class="subst">#&#123;plurk_id&#125;</span>&amp;content="</span> + encodeURIComponent(message) + <span class="string">"&amp;qualifier=says"</span></span><br><span class="line">  @get path, <span class="function"><span class="params">(error, data)</span>-&gt;</span></span><br><span class="line">    <span class="comment">#啥都不做</span></span><br><span class="line">    </span><br><span class="line">acceptFriends: <span class="function">-&gt;</span></span><br><span class="line">  self = @</span><br><span class="line">  <span class="comment">#用 Cron Module 的時候到了！</span></span><br><span class="line">  cronJob <span class="string">"0 0 * * * *"</span>, <span class="function"><span class="params">()</span> -&gt;</span></span><br><span class="line">    self.get <span class="string">"/APP/Alerts/addAllAsFriends"</span>, <span class="function"><span class="params">(error, data)</span> -&gt;</span></span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"接受所有好友邀請："</span>, data)</span><br></pre></td></tr></table></figure>
<p>那麼，先來處理 Plurk Adaper 好處理的部份</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">send: <span class="function"><span class="params">(plruk_id, strings…)</span>-&gt;</span></span><br><span class="line">  <span class="comment">#跟 Reply 一樣，直接交給 reply 做</span></span><br><span class="line">  @reply plurk_id, strings…</span><br><span class="line">  </span><br><span class="line">reply: <span class="function"><span class="params">(plurk_id, strings…)</span> -&gt;</span></span><br><span class="line">  strings.forEach (message) =&gt;</span><br><span class="line">    @bot.reply(plruk_id, message)</span><br></pre></td></tr></table></figure>
<p>接著把 run 處理好就可以上線運作摟！</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">run: <span class="function">-&gt;</span></span><br><span class="line">  self = @</span><br><span class="line">  options =</span><br><span class="line">    key: process.env.HUBOT_PLURK_KEY</span><br><span class="line">    secret: process.env.HUBOT_PLURK_SECRET</span><br><span class="line">    token: process.env.HUBOT_PLURK_TOKEN</span><br><span class="line">    token_secret: process.env.HUBOT_PLURK_TOKEN_SECRET</span><br><span class="line">    </span><br><span class="line">  <span class="comment">#創建剛剛的 API</span></span><br><span class="line">  bot = <span class="keyword">new</span> PlurkStreaming(options) </span><br><span class="line">  </span><br><span class="line">  <span class="comment">#依照 Twitter 的 new Robot.TextMessage 會沒有反應，所以參考 hubot-minecraft 的方式</span></span><br><span class="line">  r = @robot.constructor</span><br><span class="line">  </span><br><span class="line">  <span class="comment">#處理噗浪河道訊息</span></span><br><span class="line">  @doPlurk = <span class="function"><span class="params">(data)</span>-&gt;</span></span><br><span class="line">    <span class="comment">#檢查是否為回噗</span></span><br><span class="line">    <span class="keyword">if</span> data.response?</span><br><span class="line">      data.content_raw = data.response.content_raw</span><br><span class="line">      data.user_id = data.response.user_id</span><br><span class="line">    <span class="comment">#確定有噗浪ID跟訊息</span></span><br><span class="line">    <span class="keyword">if</span> data.plurk_id? <span class="keyword">and</span> data.content_raw</span><br><span class="line">      self.receive <span class="keyword">new</span> r.TextMessage(data.plurk_id, data.content_raw)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">#取得 Comet Server 完成，開始第一次 Comet 連接</span></span><br><span class="line">  bot.<span class="literal">on</span> <span class="string">"channel_ready"</span>, <span class="function"><span class="params">()</span> -&gt;</span></span><br><span class="line">    bot.plurk self.doPlurk</span><br><span class="line">  </span><br><span class="line">  <span class="comment">#上一次 Comet 完成，繼續 Polling</span></span><br><span class="line">  bot.<span class="literal">on</span> <span class="string">"nextPlurk"</span>, <span class="function"><span class="params">()</span>-&gt;</span></span><br><span class="line">    bot.plurk self.doPlurk</span><br><span class="line">  </span><br><span class="line">  <span class="comment">#定時接受好友邀請</span></span><br><span class="line">  <span class="keyword">do</span> bot.acceptFriends</span><br><span class="line">  </span><br><span class="line">  @bot = bot</span><br></pre></td></tr></table></figure>
<p>終於，完成 Adapter！</p>
<p>接下來簡單提醒一下 Deploy 到 Heroku 的注意事項。</p>
<ol>
<li>hubot-plurk 已經被我佔在 npm 上了，如果想丟到 npm 安裝可能不能用這個名字</li>
<li>用 npm pack 就會產生 hubot-plurk-0.x.x.tgz 的檔案，丟到 Dropbox 之類的網站後，在 package.json 相依版本的地方設定這個網址就可以安裝（不用透過 npm ）</li>
<li>Procfile 裡面的 web: 建議改成 worker: 因為用 web dyno 會因為沒有人打開頁面而暫停運作（要持續運作得用 worker 但會犧牲掉 Hubot 內建的網頁功能）</li>
<li>在下載下來的 Hubot 用 make package 指令就可以產生 deploy 用的資料夾</li>
<li>scripts 資料夾內是互動部分，不需要像 Adapter 如此大費周章處理（新增檔案並且設計好對白，之後就會回噗了～）</li>
</ol>
<p>我開發用的機器人在此，大家可以去跟他玩玩<br><br><a href="https://plurk.com/elct9620_bot" rel="external nofollow noopener noreferrer" target="_blank">https://plurk.com/elct9620_bot</a></p>

    
    <footer class="article__footer">
      
        <div class="text-center">
          <div class="fb-share-button" data-href="https://blog.frost.tw/posts/2012/03/18/create-a-hubot-plurk-adapter/" data-layout="button_count">
          </div>
        </div>
        <div class="text-center mt-1">
          <style>.bmc-button img{width: 27px !important;margin-bottom: 1px !important;box-shadow: none !important;border: none !important;vertical-align: middle !important;}.bmc-button{line-height: 36px !important;height:37px !important;text-decoration: none !important;display:inline-flex !important;color:#ffffff !important;background-color:#000000 !important;border-radius: 3px !important;border: 1px solid transparent !important;padding: 1px 9px !important;font-size: 22px !important;letter-spacing:0.6px !important;box-shadow: 0px 1px 2px rgba(190, 190, 190, 0.5) !important;-webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;margin: 0 auto !important;font-family:'Cookie', cursive !important;-webkit-box-sizing: border-box !important;box-sizing: border-box !important;-o-transition: 0.3s all linear !important;-webkit-transition: 0.3s all linear !important;-moz-transition: 0.3s all linear !important;-ms-transition: 0.3s all linear !important;transition: 0.3s all linear !important;}.bmc-button:hover, .bmc-button:active, .bmc-button:focus {-webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;text-decoration: none !important;box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;opacity: 0.85 !important;color:#ffffff !important;}</style><link href="https://fonts.googleapis.com/css?family=Cookie" rel="stylesheet"><a class="bmc-button" target="_blank" href="https://www.buymeacoffee.com/aotoki" rel="external nofollow noopener noreferrer"><img src="https://bmc-cdn.nyc3.digitaloceanspaces.com/BMC-button-images/BMC-btn-logo.svg" alt="Buy me a Coffee"><span style="margin-left:5px">Buy me a Coffee</span></a>
        </div>
        <iframe scrolling="no" frameborder="0" style="display: block; margin: 0 auto; height: 212px;" src="https://button.like.co/in/embed/elct9620/button?referrer=https://blog.frost.tw/posts/2012/03/18/create-a-hubot-plurk-adapter/"></iframe>
        
      
    </footer>
  </div>
</article>


  
    <div class="adv">
      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      <!-- 網誌_文末廣告 (Hexo) -->
      <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2844969736316510" data-ad-slot="5530952976" data-ad-format="auto"></ins>
      <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
  

  
<section id="comment" class="comment-box">
  <h1 class="comment-box__title">留言</h1>

  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a rel="nofollow" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>






    </div>
    <footer id="footer">
      <div id="copyright">
  &copy;2013 <a href="https://plus.google.com/117236344655673213049?rel=author" target="_blank" rel="external nofollow noopener noreferrer">蒼時弦也</a>. All right reversed.
</div>

    </footer>
    

  <script type="text/javascript">
  window.disqus_shortname = 'revo-skill-frost';

  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + window.disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }());
  
  </script>

  
  <!-- Google Tag Manager -->
  <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5TQLRN" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-5TQLRN');</script>
  <!-- End Google Tag Manager -->
  

  <script>
    window.fbAsyncInit = function() {
      FB.init({
        appId      : '178355449110',
        xfbml      : true,
        version    : 'v2.12'
      });

      FB.AppEvents.logPageView();

    };

    (function(d, s, id){
       var js, fjs = d.getElementsByTagName(s)[0];
       if (d.getElementById(id)) {return;}
       js = d.createElement(s); js.id = id;
       js.src = "https://connect.facebook.net/zh_TW/sdk.js";
       js.async = true
       fjs.parentNode.insertBefore(js, fjs);
     }(document, 'script', 'facebook-jssdk'));
  </script>

  <script src="/js/app.js"></script>


    <div class="loading"></div>
  </body>
</html>
