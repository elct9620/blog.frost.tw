<!doctype html><html lang=zh-tw><head><title>製作一個 Hubot 的噗浪 Adapter - 弦而時習之</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="###前言 我似乎非常喜歡搞前言這套，所以請大家聽我慢慢說完吧！
大約是三、四個月前的事情，網友向我邀文，我就告訴他最近 HuBot 更新後，將 Adapter 分離出來，以 Module 的形式載入，我想之後的更新會很棒吧！
不過，我卻拖到前幾天，我才心血來潮的在一天飆出機器人（原因不明，而且還被很多地方卡到陰）
這就是，故事的開始（ …"><meta name=created content="2012-03-18T00:00:00+0000"><meta name=modified content="0001-01-01T00:00:00+0000"><meta name=author content="蒼時弦也"><meta property="og:site_name" content="弦而時習之"><meta property="og:title" content="製作一個 Hubot 的噗浪 Adapter"><meta property="og:url" content="https://blog.frost.tw/posts/2012/03/18/create-a-hubot-plurk-adapter/"><meta property="og:type" content="article"><meta name=theme-color content="#EFEFEF"><link href=https://blog.frost.tw/icon-512.png rel=icon><link rel=canonical href=https://blog.frost.tw/posts/2012/03/18/create-a-hubot-plurk-adapter/><script type=application/ld+json>[{"@context":"https://schema.org","@type":"WebPage","headline":"製作一個 Hubot 的噗浪 Adapter","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","url":"https://blog.frost.tw/posts/2012/03/18/create-a-hubot-plurk-adapter/","description":"###前言 我似乎非常喜歡搞前言這套，所以請大家聽我慢慢說完吧！\n大約是三、四個月前的事情，網友向我邀文，我就告訴他最近 HuBot 更新後，將 Adapter 分離出來，以 Module 的形式載入，我想之後的更新會很棒吧！\n不過，我卻拖到前幾天，我才心血來潮的在一天飆出機器人（原因不明，而且還被很多地方卡到陰）\n這就是，故事的開始（ …\n","author":{"@type":"Person","name":"蒼時弦也"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.frost.tw/"},"publisher":{"@type":"Organization","name":"弦而時習之","url":"https://blog.frost.tw/"}},{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https://blog.frost.tw/","name":"弦而時習之","image":"http://blog.frost.tw/icon-512.png"}},{"@type":"ListItem","position":2,"item":{"@id":"https://blog.frost.tw/posts/2012/03/18/create-a-hubot-plurk-adapter/","name":"製作一個 Hubot 的噗浪 Adapter"}}]}]</script><link rel=stylesheet href=/css/styls.css><script async src=/js/turbolinks.min.js></script></head><body><div id=fb-root data-turbolinks-permanent></div><h1 id=sitename><a href=/ class="hide-text logo--icon align-center">弦而時習之</a></h1><aside id=slogan class="slogan align-center text-center"><h2 class=slogan__title>Aotokitsuruya</h2><p class=slogan__description>The Web is attracting me, so I start learning PHP, HTML, CSS and JavaScript. When I know about Ruby, I fall in love with it. Now, I working with my friend to design games using C++ and still learning web about Golang, Ruby and JavaScript. In the other side, I also be a designer, the reason why the web is attracted me.</p></aside><div id=wrapper><article class="post article" role=article><header class=article__header><time datetime=0001-01-01T00:00:00+0000 class=article__time--header role=time>Feb.18</time><h1 class=article__title>製作一個 Hubot 的噗浪 Adapter</h1></header><div class=article__entry><nav class=translation></nav><h2 id=前言>###前言</h2><p>我似乎非常喜歡搞前言這套，所以請大家聽我慢慢說完吧！</p><p>大約是三、四個月前的事情，網友向我邀文，我就告訴他最近 HuBot 更新後，將 Adapter 分離出來，以 Module 的形式載入，我想之後的更新會很棒吧！</p><p>不過，我卻拖到前幾天，我才心血來潮的在一天飆出機器人（原因不明，而且還被很多地方卡到陰）</p><p>這就是，故事的開始（好，請不要打我！）</p><p>（本文以 Deploy 到 Heroku 為最終目標）</p><h2 id=有雷要先防護一下>###有雷，要先防護一下！</h2><p>根據我的經驗，我被雷炸死超多次了！
（把 Adapter 什麼的寫出來一天一定夠，但是除雷讓我用了一半以上的時間 Orz）</p><ol><li>Hubot 除了內建的兩個 Adapter 之外都要以 Node.js 的 Module 方式才能運作（這代表說你一定得放到 node_modules 才會運作）</li><li>Hubot 的 bin/hubot 裡面寫著 npm install 所以不管你怎麼改原始碼也不能改變第一點的狀況</li><li>當你 Deploy 到 Heroku 上的時候，不能用 npm link</li><li>在 Heroku 上所有 module 都得用 npm 安裝（package.json內設定）</li></ol><p>其實上述都在討論同一件事情： Node.JS 的模組</p><p>而且模組不能設定相對路徑之類的來安裝，一定要透過</p><ul><li>NPM 官方的檔案</li><li>Git</li><li>HTTP</li></ul><p>上述三種方式才能安裝（說實在的 tgz 也是個雷，雖然說可用 tarball 裝，但是用 tar -zcf 壓縮是裝不了的）</p><p>被這些雷到可能是我笨（牆角）</p><h2 id=建立-adapter>###建立 Adapter</h2><p>只需要兩個檔案</p><ul><li>package.json</li><li>plurk.coffee</li></ul><p>有這兩個就足以變成 Node.JS 的模組了～</p><p>在開始 Coding 之前，先來設定一下 package.json 弄好相依</p><p>因為那個 Heroku 的 Cron Add-on 會把運算花費算到裡面，那就乾脆用 Node.JS 的 cron 模組就好了！而登入噗浪還需要 OAuth 才行，也裝上 OAuth 這樣</p><blockquote><p>Hubot 在讀取非內建模組時，會自動在前面加上 hubot- 的前置。</p></blockquote><h2 id=建立-robot-跟-api>###建立 Robot 跟 API</h2><p>基本上程式碼都是參考 Twitter 的 Adapter 來製作，但是實際上竟然只有一樣用 OAuth 這一點而已（昏）</p><p>Twitter 有 Streaming 可用而 Plurk 則得用 Comet 方式來達到即時讀取。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-coffeescript data-lang=coffeescript>
<span class=nv>Robot = </span><span class=nx>require</span><span class=p>(</span><span class=s>&#34;hubot&#34;</span><span class=p>).</span><span class=nx>robot</span><span class=p>()</span>
<span class=nv>Adapter = </span><span class=nx>require</span><span class=p>(</span><span class=s>&#34;hubto&#34;</span><span class=p>).</span><span class=nx>adapter</span><span class=p>()</span>

<span class=nv>EventEmitter = </span><span class=nx>require</span><span class=p>(</span><span class=s>&#34;events&#34;</span><span class=p>).</span><span class=nx>EventEmitter</span>

<span class=nv>oauth = </span><span class=nx>require</span><span class=p>(</span><span class=s>&#34;oauth&#34;</span><span class=p>)</span>
<span class=nv>cronJob = </span><span class=nx>require</span><span class=p>(</span><span class=s>&#34;cron&#34;</span><span class=p>).</span><span class=nx>CronJob</span>

<span class=k>class</span> <span class=nx>Plurk</span> <span class=nx>exntends</span> <span class=nx>Adapter</span>

<span class=k>class</span> <span class=nx>PlurkStreaming</span> <span class=nx>exnteds</span> <span class=nx>EventEmitter</span>


</code></pre></td></tr></table></div></div><p>先弄個基本架構，至於為什麼要叫 PlurkStreaming 只是因為參考的是 Twitter 而已（被拖走）</p><p>接著先給 Plurk 這個 Class 放進去幾個Method。
（基本上只要有 run, send, reply 就夠了，而 run 用來做初始化的部分）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-coffeescript data-lang=coffeescript>
<span class=k>class</span> <span class=nx>Plurk</span> <span class=nx>entends</span> <span class=nx>Adapter</span>
  <span class=nv>send: </span><span class=nf>(plurk_id, strings…) -&gt;</span>
  
  <span class=nv>reply: </span><span class=nf>(plurk_id, strings…) -&gt;</span>
  
  <span class=nv>run: </span><span class=nf>-&gt;</span>
  

</code></pre></td></tr></table></div></div><p>看起來有點東西，來弄主要的 API 結合部分。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-coffeescript data-lang=coffeescript>
<span class=k>class</span> <span class=nx>PlurkStreaming</span> <span class=k>extends</span> <span class=nx>EventEmitter</span>
  
  <span class=nv>consuctor: </span><span class=nf>(options) -&gt;</span>
    
  <span class=nv>plurk: </span><span class=nf>(callback) -&gt;</span>
    <span class=c1>#觀察河道
</span><span class=c1></span>  <span class=nv>getChannel: </span><span class=nf>-&gt;</span>
    <span class=c1>#取得 Comet 網址
</span><span class=c1></span>  <span class=nv>reply: </span><span class=nf>(plurk_id, message) -&gt;</span>
    <span class=c1>#回噗
</span><span class=c1></span>  <span class=nv>acceptFriends: </span><span class=nf>-&gt;</span>
    <span class=c1>#接受好友
</span><span class=c1></span>  <span class=nv>get: </span><span class=nf>(path, callback) -&gt;</span>
    <span class=c1>#GET 請求
</span><span class=c1></span>  <span class=nv>post: </span><span class=nf>(path, body, callback)-&gt;</span>
    <span class=c1>#POST 請求（其實是裝飾）
</span><span class=c1></span>  <span class=nv>request: </span><span class=nf>(method, path, body, callback)-&gt;</span>
    <span class=c1>#主要的 OAuth 請求
</span><span class=c1></span>  <span class=nv>comet: </span><span class=nf>(server, callback)-&gt;</span>
    <span class=c1>#噗浪的 Comet 傳回是 JavaScript Callback 要另外處理後才會變成 JSON
</span><span class=c1></span>

</code></pre></td></tr></table></div></div><p>然後我們先把注意力集中到 constructor 上，先把建構子弄好。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-coffeescript data-lang=coffeescript>
  <span class=nv>constructor: </span><span class=nf>(options) -&gt;</span>
    <span class=k>super</span><span class=p>()</span>
    <span class=k>if</span> <span class=nx>options</span><span class=p>.</span><span class=nx>key</span><span class=o>?</span> <span class=o>and</span> <span class=nx>options</span><span class=p>.</span><span class=nx>secret</span><span class=o>?</span> <span class=o>and</span> <span class=nx>options</span><span class=p>.</span><span class=nx>token</span><span class=o>?</span> <span class=o>and</span> <span class=nx>options</span><span class=p>.</span><span class=nx>token_secret</span><span class=o>?</span>
      <span class=vi>@key = </span><span class=nx>options</span><span class=p>.</span><span class=nx>key</span>
      <span class=vi>@secret = </span><span class=nx>options</span><span class=p>.</span><span class=nx>secret</span>
      <span class=vi>@token = </span><span class=nx>options</span><span class=p>.</span><span class=nx>token</span>
      <span class=vi>@token_secret = </span><span class=nx>options</span><span class=p>.</span><span class=nx>token_secret</span>
      <span class=c1>#建立 OAuth 連接
</span><span class=c1></span>      <span class=vi>@consumer = </span><span class=k>new</span> <span class=nx>oauth</span><span class=p>.</span><span class=nx>OAuth</span><span class=p>(</span>
        <span class=s>&#34;https://www.plurk.com/OAuth/request_token&#34;</span><span class=p>,</span>
        <span class=s>&#34;https://www.plurk.com/OAuth/access_token&#34;</span><span class=p>,</span>
        <span class=nx>@key</span><span class=p>,</span>
        <span class=nx>@secret</span><span class=p>,</span>
        <span class=s>&#34;1.0&#34;</span><span class=p>,</span>
        <span class=s>&#34;https://www.plurk.com/OAuth/authorize&#34;</span><span class=p>.</span>
        <span class=s>&#34;HMAC-SHA1&#34;</span>
      <span class=p>)</span>
      <span class=vi>@domain = </span><span class=s>&#34;www.plurk.com&#34;</span>
      <span class=c1>#初始化取得Comet網址
</span><span class=c1></span>      <span class=nx>do</span> <span class=nx>@getChannel</span>
    <span class=k>else</span>
      <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=s>&#34;參數不足，需要 Key, Secret, Token, Token Secret&#34;</span><span class=p>)</span>

</code></pre></td></tr></table></div></div><p>這樣建構子就差不多了！</p><p>接著來弄 request 這個 method (comet 很類似，這個寫好複製貼上一下～)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-coffeescript data-lang=coffeescript>
  <span class=nv>request: </span><span class=nf>(method, path, body, callback) -&gt;</span>
    <span class=c1>#記錄一下這次的 Request
</span><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s>&#34;https://</span><span class=si>#{</span><span class=nx>@domain</span><span class=si>}#{</span><span class=nx>path</span><span class=si>}</span><span class=s>&#34;</span><span class=p>)</span>
    
    <span class=c1># Callback 這邊先不丟進去，要用另一種方式處理
</span><span class=c1></span>    <span class=nv>request = </span><span class=nx>@consumer</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s>&#34;https://</span><span class=si>#{</span><span class=nx>@domain</span><span class=si>}#{</span><span class=nx>path</span><span class=si>}</span><span class=s>&#34;</span><span class=p>,</span> <span class=nx>@token</span><span class=p>,</span> <span class=nx>@token_secret</span><span class=p>,</span> <span class=kc>null</span><span class=p>)</span>
    
    <span class=nx>request</span><span class=p>.</span><span class=nx>on</span> <span class=s>&#34;response&#34;</span><span class=p>,</span> <span class=nf>(res) -&gt;</span>
      <span class=nx>res</span><span class=p>.</span><span class=nx>on</span> <span class=s>&#34;data&#34;</span><span class=p>,</span> <span class=nf>(chunk) -&gt;</span>
        <span class=nx>parseResponse</span><span class=p>(</span><span class=nx>chunk</span><span class=o>+</span><span class=s>&#39;&#39;</span><span class=p>,</span> <span class=nx>callback</span><span class=p>)</span>
      <span class=nx>res</span><span class=p>.</span><span class=nx>on</span> <span class=s>&#34;end&#34;</span><span class=p>,</span> <span class=nf>(data) -&gt;</span>
        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span> <span class=s>&#34;End Request: </span><span class=si>#{</span><span class=nx>path</span><span class=si>}</span><span class=s>&#34;</span>
      <span class=nx>res</span><span class=p>.</span><span class=nx>on</span> <span class=s>&#34;error&#34;</span><span class=p>,</span> <span class=nf>(data) -&gt;</span>
        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span> <span class=s>&#34;Error: &#34;</span> <span class=o>+</span> <span class=nx>data</span>
        
    <span class=nx>request</span><span class=p>.</span><span class=nx>end</span><span class=p>()</span>
    
    <span class=c1>#處理資料
</span><span class=c1></span>    <span class=nv>parseResponse = </span><span class=nf>(data, callback) -&gt;</span>
      <span class=k>if</span> <span class=nx>data</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span>
        <span class=c1>#用 Try/Catch 避免處理 JSON 出錯導致整個中斷
</span><span class=c1></span>        <span class=k>try</span>
          <span class=nx>callback</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span>
        <span class=k>catch</span> <span class=nx>err</span>
          <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s>&#34;Error Parse JSON:&#34;</span> <span class=o>+</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
          <span class=c1>#繼續執行
</span><span class=c1></span>          <span class=nx>callback</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>data</span> <span class=o>||</span> <span class=p>{}</span>

</code></pre></td></tr></table></div></div><p>大致上就是這樣，根據程式碼，其實是無視 POST 的。
（如果沒有特殊需求其實也不會用到 POST 方式）</p><p>而 Comet 的處理方式類似，不過我們要動用到 EventEmitter 的功能。
（避免一個 Request 還未結束又開始新的 Comet, 造成連續讀取兩次相同訊息的問題）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-coffeescript data-lang=coffeescript>
  <span class=nv>comet: </span><span class=nf>(server, callback) -&gt;</span>
    <span class=c1>#在 Callback 裡面會找不到自身，所以設定區域變數
</span><span class=c1></span>    <span class=nv>self = </span><span class=nx>@</span>
  
    <span class=c1>#記錄一下這次的 Request
</span><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s>&#34;[Comet] </span><span class=si>#{</span><span class=nx>server</span><span class=si>}</span><span class=s>&#34;</span><span class=p>)</span>
    
    <span class=c1># Callback 這邊先不丟進去，要用另一種方式處理
</span><span class=c1></span>    <span class=nv>request = </span><span class=nx>@consumer</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s>&#34;https://</span><span class=si>#{</span><span class=nx>@domain</span><span class=si>}#{</span><span class=nx>path</span><span class=si>}</span><span class=s>&#34;</span><span class=p>,</span> <span class=nx>@token</span><span class=p>,</span> <span class=nx>@token_secret</span><span class=p>,</span> <span class=kc>null</span><span class=p>)</span>
    
    <span class=nx>request</span><span class=p>.</span><span class=nx>on</span> <span class=s>&#34;response&#34;</span><span class=p>,</span> <span class=nf>(res) -&gt;</span>
      <span class=nx>res</span><span class=p>.</span><span class=nx>on</span> <span class=s>&#34;data&#34;</span><span class=p>,</span> <span class=nf>(chunk) -&gt;</span>
        <span class=nx>parseResponse</span><span class=p>(</span><span class=nx>chunk</span><span class=o>+</span><span class=s>&#39;&#39;</span><span class=p>,</span> <span class=nx>callback</span><span class=p>)</span>
      <span class=nx>res</span><span class=p>.</span><span class=nx>on</span> <span class=s>&#34;end&#34;</span><span class=p>,</span> <span class=nf>(data) -&gt;</span>
        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span> <span class=s>&#34;End Request: </span><span class=si>#{</span><span class=nx>path</span><span class=si>}</span><span class=s>&#34;</span>
        <span class=c1>#請求結束，發出事件通知可以進行下一次請求
</span><span class=c1></span>        <span class=nx>self</span><span class=p>.</span><span class=nx>emit</span> <span class=s>&#34;nextPlurk&#34;</span>
      <span class=nx>res</span><span class=p>.</span><span class=nx>on</span> <span class=s>&#34;error&#34;</span><span class=p>,</span> <span class=nf>(data) -&gt;</span>
        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span> <span class=s>&#34;Error: &#34;</span> <span class=o>+</span> <span class=nx>data</span>
        
    <span class=nx>request</span><span class=p>.</span><span class=nx>end</span><span class=p>()</span>    
    
    <span class=c1>#處理資料
</span><span class=c1></span>    <span class=nv>parseResponse = </span><span class=nf>(data, callback) -&gt;</span>
      <span class=k>if</span> <span class=nx>data</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span>
        <span class=c1>#用 try/catch 避免失敗中斷
</span><span class=c1></span>        <span class=k>try</span>
          <span class=c1>#去掉 JavaScript 的 Callback
</span><span class=c1></span>          <span class=nv>data = </span><span class=nx>data</span><span class=p>.</span><span class=nx>match</span><span class=p>(</span><span class=sr>/CometChannel.scriptCallback\((.+)\);\s*/</span><span class=p>)</span>
          <span class=nv>jsonData = </span><span class=s>&#34;&#34;</span>
          
          <span class=k>if</span> <span class=nx>data</span><span class=o>?</span>
            <span class=nv>jsonData = </span><span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
          <span class=k>else</span>
            <span class=c1>#如果沒有任何 Match 嘗試直接 parse
</span><span class=c1></span>            <span class=nv>jsonData = </span><span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span>
        <span class=k>catch</span> <span class=nx>err</span>
          <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s>&#34;[Comet] Error:&#34;</span><span class=p>,</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
          
        <span class=c1>#用 Try/Catch 避免處理 JSON 出錯導致整個中斷
</span><span class=c1></span>        <span class=k>try</span>
          <span class=c1>#只傳入 json 的 data 部分
</span><span class=c1></span>          <span class=nx>callback</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>jsonData</span><span class=p>.</span><span class=nx>data</span>
        <span class=k>catch</span> <span class=nx>err</span>
          <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s>&#34;[Comet]Error Parse JSON:&#34;</span> <span class=o>+</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
          <span class=c1>#繼續執行
</span><span class=c1></span>          <span class=nx>callback</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>data</span> <span class=o>||</span> <span class=p>{}</span>
</code></pre></td></tr></table></div></div><p>至於為什麼要這樣做呢？因為在測試時竟然因為噗浪 Lag 而沒讀到完整的 Comet 資料，然後就炸掉了！
（這樣至少不會造成運行中斷，睡覺時就不會碰到一個無法用就炸掉）</p><p>後面的 get 跟 post 就簡單多了！</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-coffeescript data-lang=coffeescript>
  <span class=nv>get: </span><span class=nf>(path, callback) -&gt;</span>
    <span class=nx>@request</span><span class=p>(</span><span class=s>&#34;GET&#34;</span><span class=p>,</span> <span class=nx>path</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>callback</span><span class=p>)</span>
    
  <span class=nv>post: </span><span class=nf>(path, body, callback) -&gt;</span>
    <span class=nx>@request</span><span class=p>(</span><span class=s>&#34;POST&#34;</span><span class=p>,</span> <span class=nx>path</span><span class=p>,</span> <span class=nx>body</span><span class=p>,</span> <span class=nx>callback</span><span class=p>)</span>
    
</code></pre></td></tr></table></div></div><p>接著處理取的 Comet 網址的 getChannel</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-coffeescript data-lang=coffeescript>
  <span class=nv>getChannel: </span><span class=nf>-&gt;</span>
    <span class=nv>self = </span><span class=nx>@</span>
    
    <span class=nx>@get</span> <span class=s>&#34;/APP/Realtime/getUserChannel&#34;</span><span class=p>,</span> <span class=nf>(error, data) -&gt;</span>
      <span class=k>if</span> <span class=o>!</span><span class=nx>error</span>
        <span class=c1>#檢查是否有 comet server
</span><span class=c1></span>        <span class=k>if</span> <span class=nx>data</span><span class=p>.</span><span class=nx>comet_server</span><span class=o>?</span>
          <span class=nv>self.channel = </span><span class=nx>data</span><span class=p>.</span><span class=nx>comet_server</span>
          <span class=c1>#如果沒有 Channel Ready 就嘗試連接會失敗
</span><span class=c1></span>          <span class=nx>self</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=s>&#39;channel_ready&#39;</span><span class=p>)</span>

</code></pre></td></tr></table></div></div><p>接著處理 plurk 這部份</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-coffeescript data-lang=coffeescript>  
  <span class=nv>plurk: </span><span class=nf>(callback) -&gt;</span>
    <span class=c1>#其實官方文件是要設定 offset 的，不過目前沒有想到設定的方法，以及即使沒有設定也能正常運作
</span><span class=c1></span>    <span class=nx>@comet</span> <span class=nx>@channel</span><span class=p>,</span> <span class=nf>(error, data) -&gt;</span>
      <span class=k>if</span> <span class=nx>data</span><span class=o>?</span>
        <span class=c1>#將一筆筆的資料一一遞送
</span><span class=c1></span>        <span class=k>for</span> <span class=nx>plurk</span> <span class=k>in</span> <span class=nx>data</span>
          <span class=nx>callback</span> <span class=nx>plurk</span>

</code></pre></td></tr></table></div></div><p>最後處理回噗跟接受好友就完成 API 的連接了！
（當然，其他部分大家可以自行擴充）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-coffeescript data-lang=coffeescript>
  <span class=nv>reply: </span><span class=nf>(plurk_id, message) -&gt;</span>
    <span class=c1>#設定回噗的參數
</span><span class=c1></span>    <span class=nv>path = </span><span class=s>&#34;/APP/Responses/responseAdd?plurk_id=</span><span class=si>#{</span><span class=nx>plurk_id</span><span class=si>}</span><span class=s>&amp;content=&#34;</span> <span class=o>+</span> <span class=nb>encodeURIComponent</span><span class=p>(</span><span class=nx>message</span><span class=p>)</span> <span class=o>+</span> <span class=s>&#34;&amp;qualifier=says&#34;</span>
    <span class=nx>@get</span> <span class=nx>path</span><span class=p>,</span> <span class=nf>(error, data)-&gt;</span>
      <span class=c1>#啥都不做
</span><span class=c1></span>      
  <span class=nv>acceptFriends: </span><span class=nf>-&gt;</span>
    <span class=nv>self = </span><span class=nx>@</span>
    <span class=c1>#用 Cron Module 的時候到了！
</span><span class=c1></span>    <span class=nx>cronJob</span> <span class=s>&#34;0 0 * * * *&#34;</span><span class=p>,</span> <span class=nf>() -&gt;</span>
      <span class=nx>self</span><span class=p>.</span><span class=nx>get</span> <span class=s>&#34;/APP/Alerts/addAllAsFriends&#34;</span><span class=p>,</span> <span class=nf>(error, data) -&gt;</span>
        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s>&#34;接受所有好友邀請：&#34;</span><span class=p>,</span> <span class=nx>data</span><span class=p>)</span>
    
</code></pre></td></tr></table></div></div><p>那麼，先來處理 Plurk Adaper 好處理的部份</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-coffeescript data-lang=coffeescript>
  <span class=nv>send: </span><span class=nf>(plruk_id, strings…)-&gt;</span>
    <span class=c1>#跟 Reply 一樣，直接交給 reply 做
</span><span class=c1></span>    <span class=nx>@reply</span> <span class=nx>plurk_id</span><span class=p>,</span> <span class=nx>strings</span><span class=err>…</span>
    
  <span class=nv>reply: </span><span class=nf>(plurk_id, strings…) -&gt;</span>
    <span class=nx>strings</span><span class=p>.</span><span class=nx>forEach</span> <span class=nf>(message) =&gt;</span>
      <span class=nx>@bot</span><span class=p>.</span><span class=nx>reply</span><span class=p>(</span><span class=nx>plruk_id</span><span class=p>,</span> <span class=nx>message</span><span class=p>)</span>

</code></pre></td></tr></table></div></div><p>接著把 run 處理好就可以上線運作摟！</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-coffeescript data-lang=coffeescript>
  <span class=nv>run: </span><span class=nf>-&gt;</span>
    <span class=nv>self = </span><span class=nx>@</span>
    <span class=nv>options =
</span><span class=nv></span>      <span class=nv>key: </span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>HUBOT_PLURK_KEY</span>
      <span class=nv>secret: </span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>HUBOT_PLURK_SECRET</span>
      <span class=nv>token: </span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>HUBOT_PLURK_TOKEN</span>
      <span class=nv>token_secret: </span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>HUBOT_PLURK_TOKEN_SECRET</span>
      
    <span class=c1>#創建剛剛的 API
</span><span class=c1></span>    <span class=nv>bot = </span><span class=k>new</span> <span class=nx>PlurkStreaming</span><span class=p>(</span><span class=nx>options</span><span class=p>)</span> 
    
    <span class=c1>#依照 Twitter 的 new Robot.TextMessage 會沒有反應，所以參考 hubot-minecraft 的方式
</span><span class=c1></span>    <span class=nv>r = </span><span class=nx>@robot</span><span class=p>.</span><span class=nx>constructor</span>
    
    <span class=c1>#處理噗浪河道訊息
</span><span class=c1></span>    <span class=vi>@doPlurk = </span><span class=nf>(data)-&gt;</span>
      <span class=c1>#檢查是否為回噗
</span><span class=c1></span>      <span class=k>if</span> <span class=nx>data</span><span class=p>.</span><span class=nx>response</span><span class=o>?</span>
        <span class=nv>data.content_raw = </span><span class=nx>data</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>content_raw</span>
        <span class=nv>data.user_id = </span><span class=nx>data</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>user_id</span>
      <span class=c1>#確定有噗浪ID跟訊息
</span><span class=c1></span>      <span class=k>if</span> <span class=nx>data</span><span class=p>.</span><span class=nx>plurk_id</span><span class=o>?</span> <span class=o>and</span> <span class=nx>data</span><span class=p>.</span><span class=nx>content_raw</span>
        <span class=nx>self</span><span class=p>.</span><span class=nx>receive</span> <span class=k>new</span> <span class=nx>r</span><span class=p>.</span><span class=nx>TextMessage</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>plurk_id</span><span class=p>,</span> <span class=nx>data</span><span class=p>.</span><span class=nx>content_raw</span><span class=p>)</span>
    
    <span class=c1>#取得 Comet Server 完成，開始第一次 Comet 連接
</span><span class=c1></span>    <span class=nx>bot</span><span class=p>.</span><span class=nx>on</span> <span class=s>&#34;channel_ready&#34;</span><span class=p>,</span> <span class=nf>() -&gt;</span>
      <span class=nx>bot</span><span class=p>.</span><span class=nx>plurk</span> <span class=nx>self</span><span class=p>.</span><span class=nx>doPlurk</span>
    
    <span class=c1>#上一次 Comet 完成，繼續 Polling
</span><span class=c1></span>    <span class=nx>bot</span><span class=p>.</span><span class=nx>on</span> <span class=s>&#34;nextPlurk&#34;</span><span class=p>,</span> <span class=nf>()-&gt;</span>
      <span class=nx>bot</span><span class=p>.</span><span class=nx>plurk</span> <span class=nx>self</span><span class=p>.</span><span class=nx>doPlurk</span>
    
    <span class=c1>#定時接受好友邀請
</span><span class=c1></span>    <span class=nx>do</span> <span class=nx>bot</span><span class=p>.</span><span class=nx>acceptFriends</span>
    
    <span class=vi>@bot = </span><span class=nx>bot</span>
</code></pre></td></tr></table></div></div><p>終於，完成 Adapter！</p><p>接下來簡單提醒一下 Deploy 到 Heroku 的注意事項。</p><ol><li>hubot-plurk 已經被我佔在 npm 上了，如果想丟到 npm 安裝可能不能用這個名字</li><li>用 npm pack 就會產生 hubot-plurk-0.x.x.tgz 的檔案，丟到 Dropbox 之類的網站後，在 package.json 相依版本的地方設定這個網址就可以安裝（不用透過 npm ）</li><li>Procfile 裡面的 web: 建議改成 worker: 因為用 web dyno 會因為沒有人打開頁面而暫停運作（要持續運作得用 worker 但會犧牲掉 Hubot 內建的網頁功能）</li><li>在下載下來的 Hubot 用 make package 指令就可以產生 deploy 用的資料夾</li><li>scripts 資料夾內是互動部分，不需要像 Adapter 如此大費周章處理（新增檔案並且設計好對白，之後就會回噗了～）</li></ol><p>我開發用的機器人在此，大家可以去跟他玩玩
<a href=https://plurk.com/elct9620_bot>https://plurk.com/elct9620_bot</a></p><footer class=article__footer><div class=text-center><div class=fb-share-button data-href="<%- page.permalink %>" data-layout=button_count></div></div><div class="text-center mt-1"><style>.bmc-button img{width:27px!important;margin-bottom:1px!important;box-shadow:none!important;border:none!important;vertical-align:middle!important}.bmc-button{line-height:36px!important;height:37px!important;text-decoration:none!important;display:inline-flex!important;color:#fff!important;background-color:#000!important;border-radius:3px!important;border:1px solid transparent!important;padding:1px 9px!important;font-size:22px!important;letter-spacing:.6px!important;box-shadow:0 1px 2px rgba(190,190,190,.5)!important;-webkit-box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;margin:0 auto!important;font-family:cookie,cursive!important;-webkit-box-sizing:border-box!important;box-sizing:border-box!important;-o-transition:.3s all linear!important;-webkit-transition:.3s all linear!important;-moz-transition:.3s all linear!important;-ms-transition:.3s all linear!important;transition:.3s all linear!important}.bmc-button:hover,.bmc-button:active,.bmc-button:focus{-webkit-box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;text-decoration:none!important;box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;opacity:.85!important;color:#fff!important}</style><link href="https://fonts.googleapis.com/css?family=Cookie" rel=stylesheet><a class=bmc-button target=_blank href=https://www.buymeacoffee.com/aotoki><img src=https://bmc-cdn.nyc3.digitaloceanspaces.com/BMC-button-images/BMC-btn-logo.svg alt="Buy me a Coffee"><span style=margin-left:5px>Buy me a Coffee</span></a></div><iframe scrolling=no frameborder=0 style="display:block;margin:0 auto;height:212px" src="https://button.like.co/in/embed/elct9620/button?referrer=<%- page.permalink %>"></iframe></footer></div></article><div class=adv><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-2844969736316510 data-ad-slot=5530952976 data-ad-format=auto></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div><section id=comment class=comment-box><h1 class=comment-box__title>留言</h1><div id=disqus_thread></div></div></section></div><footer id=footer><div id=copyright>&copy;2020 <a href="https://plus.google.com/117236344655673213049?rel=author" target=_blank rel=noreferrer>蒼時弦也</a>. All right reversed.</div></footer><script src=/js/app.min.6e03bcf752b31ab875459fbdd360c766632ead24687ffe499c4cf1f86e9fe489.js></script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5TQLRN" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-5TQLRN');</script><script>window.fbAsyncInit=function(){FB.init({appId:'178355449110',xfbml:true,version:'v2.12'});FB.AppEvents.logPageView();};(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(d.getElementById(id)){return;}
js=d.createElement(s);js.id=id;js.src="https://connect.facebook.net/zh_TW/sdk.js";js.async=true
js.defer=true
fjs.parentNode.insertBefore(js,fjs);}(document,'script','facebook-jssdk'));</script><div class=loading></div></body></html>