<!DOCTYPE html><html lang="zh-TW"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><title>Heroku Buildpacks - 客制化你的 Heroku 環境 | 弦而時習之</title><meta name="theme-color" content="#EFEFEF"><meta name="author" content="蒼時弦也"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="PHPConf 結束後，就很想寫點程式阿（掩面 雖然這次是志工，不過運氣很好聽到了不少很棒的演講。其中我還是對於像是 PhalconPHP 和 Composer 在雲端環境上的使用。 先排除一般虛擬主機支援可能性，再來就到了 PaaS 上的問題。因為 PaaS 相對於 IaaS 使用上簡單，也不需要額外的去做設定，很多時候 Deploy 網站還是會先以 PaaS 為主（而且很多 PaaS 有提供免"><meta property="og:type" content="article"><meta property="og:title" content="Heroku Buildpacks - 客制化你的 Heroku 環境"><meta property="og:url" content="https://blog.frost.tw/posts/2012/11/04/heroku-buildpacks-customize-your-heroku-enviroment/"><meta property="og:site_name" content="弦而時習之"><meta property="og:description" content="PHPConf 結束後，就很想寫點程式阿（掩面 雖然這次是志工，不過運氣很好聽到了不少很棒的演講。其中我還是對於像是 PhalconPHP 和 Composer 在雲端環境上的使用。 先排除一般虛擬主機支援可能性，再來就到了 PaaS 上的問題。因為 PaaS 相對於 IaaS 使用上簡單，也不需要額外的去做設定，很多時候 Deploy 網站還是會先以 PaaS 為主（而且很多 PaaS 有提供免"><meta property="og:locale" content="zh-TW"><meta property="og:image" content="http://blog.frost.tw/icon-512.png"><meta property="og:updated_time" content="2019-06-22T02:47:31.527Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Heroku Buildpacks - 客制化你的 Heroku 環境"><meta name="twitter:description" content="PHPConf 結束後，就很想寫點程式阿（掩面 雖然這次是志工，不過運氣很好聽到了不少很棒的演講。其中我還是對於像是 PhalconPHP 和 Composer 在雲端環境上的使用。 先排除一般虛擬主機支援可能性，再來就到了 PaaS 上的問題。因為 PaaS 相對於 IaaS 使用上簡單，也不需要額外的去做設定，很多時候 Deploy 網站還是會先以 PaaS 為主（而且很多 PaaS 有提供免"><meta name="twitter:image" content="http://blog.frost.tw/icon-512.png"><link rel="publisher" href="https://plus.google.com/117236344655673213049"><meta property="fb:app_id" content="178355449110"><meta property="fb:pages" content="180666522388"><script type="application/ld+json">[
{
    "@context": "http://schema.org",
    "@type": "Blog",
    "name": "弦而時習之",
    "url": "https://blog.frost.tw",
    "image": "http://blog.frost.tw/icon-512.png",
    "description": "蒼時弦也的個人網誌，專注在前端、後端以及遊戲開發，大多使用 Ruby 和 Ruby on Rails 以及 Golang、JS 和 C 語言。",
    "sameAs": [
      "https://www.facebook.com/frost.tw/"
    ]
},
{
    "@context": "http://schema.org",
    "@type": "Person",
    "name": "蒼時弦也",
    "url": "https://blog.frost.tw",
    "sameAs": [
      "https://www.facebook.com/elct9620",
      "https://www.instagram.com/elct9620/",
      "https://twitter.com/elct9620",
      "https://plus.google.com/+%E8%92%BC%E6%99%82%E5%BC%A6%E4%B9%9F-plus",
      "https://www.linkedin.com/in/elct9620"
    ]
},
{
  "@context":"http://schema.org",
  "@type":"BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.frost.tw/posts/2012/11/04/heroku-buildpacks-customize-your-heroku-enviroment/"
  },
  "headline":"Heroku Buildpacks - 客制化你的 Heroku 環境",
  "image": [
    
    "http://blog.frost.tw/icon-512.png"
  ],
  
  "datePublished": "2012-11-04T12:51:00.000Z",
  "dateModified": "2019-06-22T02:47:31.527Z",
  "description":"PHPConf 結束後，就很想寫點程式阿（掩面雖然這次是志工，不過運氣很好聽到了不少很棒的演講。其中我還是對於像是 PhalconPHP 和 Composer 在雲端環境上的使用。先排除一般虛擬主機支援可能性，再來就到了 PaaS 上的問題。因為 PaaS 相對於 IaaS 使用上簡單，也不需要額外的去做設定，很多時候 Deploy 網站還是會先以 PaaS 為主（而且很多 PaaS 有提供免費額度）我先針對幾個個人比較關注支援 PHP 環境的 PaaS 進行搜集資料，再繼續確認支援情況。AppFog, Heroku, PagodaBox 三個是我主要的確認項目，其中 AppFog 沒辦法找到什麼可靠的資訊，而 PagodaBox 在印象中討論區曾經有討論過關於 Composer 方面的問題，最後是 Heroku 今天的主角，也是讓我「大吃一驚」的 PaaS 服務。",
  "author": {
    "@type": "Person",
    "name": "蒼時弦也"
  },
  "publisher": {
    "@type": "Organization",
    "name": "蒼時弦也",
    "logo": {
      "@type": "ImageObject",
      "url": "http://blog.forst.tw/logo-wide.png"
    }
  }
},
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
    "@type": "ListItem",
    "position": 1,
    "item": {
      "@id": "https://blog.frost.tw",
      "name": "弦而時習之 ",
      "image": "http://blog.frost.tw/icon-512.png"
    }
  },{
    "@type": "ListItem",
    "position": 2,
    "item": {
      "@id": "https://blog.frost.tw/posts/2012/11/04/heroku-buildpacks-customize-your-heroku-enviroment/",
      "name": "Heroku Buildpacks - 客制化你的 Heroku 環境",
      "image": "http://blog.frost.tw/icon-512.png"
    }
  }]
}

]</script><link rel="canonical" href="https://blog.frost.tw/posts/2012/11/04/heroku-buildpacks-customize-your-heroku-enviroment/"><link href="/icon-512.png" rel="icon"><link rel="alternate" href="/feed.xml" title="弦而時習之" type="application/rss+xml"><!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--><link rel="stylesheet" href="/css/style.css" media="screen" type="text/css"><script async src="/js/turbolinks.js"></script></head><body><div id="fb-root" data-turbolinks-permanent></div><header id="header"><h1 id="sitename"><a href="/" class="hide-text logo--icon align-center">弦而時習之</a></h1><aside id="slogan" class="slogan align-center text-center"><h2 class="slogan__title">Aotokitsuruya</h2><p class="slogan__description">The Web is attracting me, so I start learning PHP, HTML, CSS and JavaScript. When I know about Ruby, I fall in love with it. Now, I working with my friend to design games using C++ and still learning web about Golang, Ruby and JavaScript. In the other side, I also be a designer, the reason why the web is attracted me.</p></aside></header><div id="wrapper"><article class="post article"><header class="article__header"><time datetime="2012-11-04T12:51:00.000Z" class="article__time--header">Nov.04</time><h1 class="article__title">Heroku Buildpacks - 客制化你的 Heroku 環境</h1></header><div class="article__entry"><p>PHPConf 結束後，就很想寫點程式阿（掩面</p><p>雖然這次是志工，不過運氣很好聽到了不少很棒的演講。其中我還是對於像是 PhalconPHP 和 Composer 在雲端環境上的使用。</p><p>先排除一般虛擬主機支援可能性，再來就到了 PaaS 上的問題。因為 PaaS 相對於 IaaS 使用上簡單，也不需要額外的去做設定，很多時候 Deploy 網站還是會先以 PaaS 為主（而且很多 PaaS 有提供免費額度）</p><p>我先針對幾個個人比較關注支援 PHP 環境的 PaaS 進行搜集資料，再繼續確認支援情況。</p><p>AppFog, Heroku, PagodaBox 三個是我主要的確認項目，其中 AppFog 沒辦法找到什麼可靠的資訊，而 PagodaBox 在印象中討論區曾經有討論過關於 Composer 方面的問題，最後是 Heroku 今天的主角，也是讓我「大吃一驚」的 PaaS 服務。</p><a id="more"></a><p>其實 Heroku 算是個很早期的服務，也很早就有提供免費額度。在加上很多方面他都有這不錯的支援，個人認為是個很棒的 PaaS 提供商。</p><p>先來討論 PhalconPHP 在 Heroku 上的支援好了⋯⋯</p><p>在過去的經驗，要在 Heroku 上的 PHP 使用 Mongo 是需要額外修改的，而且非常簡單。<br><br>在 Github 上的這個 Gits 說明了方法：<a href="https://gist.Github.com/1288447" target="_blank" rel="external nofollow noopener noreferrer">Sample PHP+Mongo app on Heroku</a></p><p>其實只要把編譯好的 PhalconPHP 的 Extension 上傳上去就好了，非常簡單。</p><p><strong>不過本機與遠端的環境不一樣怎麼辦？</strong></p><p>因此，接下來透過 Composer 的自動配置與手動編譯環境，就可以解決這個問題。</p><p>在 Heroku 上提供了名為 <a href="https://devcenter.Heroku.com/categories/buildpacks" target="_blank" rel="external nofollow noopener noreferrer">Buildpacks</a> 的功能，讓我們可以自定義 Dyno (Instance) 的配置。</p><p>其中 Vulcan 是 Heroku 提供給使用者在 Heroku 上編譯環境的工具。<br>（他會建立一個新的 Application 並且透過 vulcan build 將原始碼上傳後編譯，然後打包下載回本地）</p><p>透過 Buildpacks 以及 Vulcan 我們就可以替 PHP 加上所需的 Extension 以及配置自己的環境。</p><h3 id="Buildpacks-API"><a href="#Buildpacks-API" class="headerlink" title="Buildpacks API"></a>Buildpacks API</h3><hr><p>其實可以把它當作 Git Pre Commit Hook 來看待（基本上這部分跑起來有問題你的 git push 會被打槍）</p><p>基本上，在 Heroku 上會坐三個動作 Detect, Compild, Release</p><h4 id="Detect"><a href="#Detect" class="headerlink" title="Detect"></a>Detect</h4><p>簡單來說就是偵測，他負責檢查是否有這個「環境」所需的檔案。</p><figure class="highlight bash"><figcaption><span>bin/detect</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># this pack is valid for apps with a hello.txt in the root</span></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="variable">$1</span>/hello.txt ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"HelloFramework"</span></span><br><span class="line">  <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>從官網範例來看，他會檢查使用者 push 上來的檔案中是否含有 hello.txt 這個檔案，如果有那就回傳他的環境形態（這可以自己取拉～～）反之則離開。</p><p>關於這部分 0 就是驗證成功，反之 1 就是失敗。</p><h4 id="Compile"><a href="#Compile" class="headerlink" title="Compile"></a>Compile</h4><p>再來是編譯，大致上是最主要的部分。其實就是安裝環境、放置檔案之類的動作拉～～</p><figure class="highlight bash"><figcaption><span>bin/compile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">indent</span></span>() &#123;</span><br><span class="line">  sed -u <span class="string">'s/^/       /'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"-----&gt; Found a hello.txt"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if hello.txt has contents, display them (indented to align)</span></span><br><span class="line"><span class="comment"># otherwise error</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -s <span class="variable">$1</span>/hello.txt ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"hello.txt was empty"</span></span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"hello.txt is not empty, here are the contents"</span> | indent</span><br><span class="line">  cat <span class="variable">$1</span>/hello.txt</span><br><span class="line"><span class="keyword">fi</span> | indent</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">接下來會進入 Compile 部分，我們會在這邊下載&amp;解壓縮必要的檔案 Ex. Apache, PHP 並且移動目錄等動作。</span><br><span class="line"></span><br><span class="line">這部分可以參考一下 Heroku 的官方環境範例：&lt;a href=<span class="string">"https://Github.com/Heroku/heroku-buildpack-PHP/blob/master/bin/compile"</span> target=<span class="string">"_blank"</span>&gt;Heroku Buildpacks PHP&lt;/a&gt;</span><br><span class="line"></span><br><span class="line">（至於為什麼沒有出現在官方文件列表，我也不知道⋯⋯）</span><br><span class="line"></span><br><span class="line">註：看官方範例就知道有時候他跑一段時間其實是下載檔案，但是你看不到所以⋯⋯</span><br><span class="line"></span><br><span class="line"><span class="comment">#### Release</span></span><br><span class="line"></span><br><span class="line">至於這部分，其實就是設定一些預設的 Add-on, 環境變數 等等</span><br><span class="line"></span><br><span class="line">```bash bin/release</span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF</span><br><span class="line">---</span><br><span class="line">addons:</span><br><span class="line">  - shared-database:5mb</span><br><span class="line">config_vars:</span><br><span class="line">  NODE_ENV:production</span><br><span class="line">default_process_types:</span><br><span class="line">  web: bin/node server.js</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>當以上都完成後，客制化的環境建制就完成了！</p><p>不過，如果我們需要 Apache, PHP 等預先編譯好的檔案呢？</p><p>此時就要 Vulcan 出場摟！</p><h3 id="Vulcan"><a href="#Vulcan" class="headerlink" title="Vulcan"></a>Vulcan</h3><hr><blockquote><p>gem install vulcan</p></blockquote><p>沒錯，安裝就是如此簡單！</p><p>完成後馬上建制自己專用的 Vulcan Application （其實就是個 Heroku Application）</p><blockquote><p>vulcan create APP_NAME</p></blockquote><p>當然，輸入什麼 vulcan 或者與現存 App 重複的名稱是會被打槍的⋯⋯</p><p>再來，就是進行編譯的動作。</p><p>官方的範例就是⋯⋯</p><ol><li>下載 Source Code</li><li>解壓縮</li><li>進入目錄</li><li>vulcan build</li></ol><p>沒錯，就這樣⋯⋯結束了！</p><p>不過，當我下載 PHP-5.4.8 之後，立馬被打槍⋯⋯</p><p>實際上，需要 ./configure 的只需要改成如下：</p><blockquote><p>vulcan build -v -c “./configure –prefix=/app/PHP –with-config-file-path=/app/PHP” -p /app/php</p></blockquote><p>就可以了！</p><p>（註：當編譯完成的路徑非當下目錄時，得額外設定 -p 告訴 vulcan 去哪裡打包壓縮）</p><p>至於 -v 是顯示記錄，可以在 Debug 時使用。</p><p>不過大家又會有疑問了⋯⋯</p><p>編譯 Apache + PHP 相依問題怎麼解決？</p><ol><li>用 -c “./amp.sh” 丟個 Shell Script 上去跑</li><li>-d=預先編譯好的Apache網址</li></ol><p>不過第一個方法我沒成功過（牆角</p><p>註：這個網址可以透過 Vulcan 編譯完畢後吐給你的網址 Ex. <a href="https://vulcan-aotoki.Herokuapp.com/output/4a669895-5308-4846-8a72-28d78d46a999" target="_blank" rel="external nofollow noopener noreferrer">https://vulcan-aotoki.Herokuapp.com/output/4a669895-5308-4846-8a72-28d78d46a999</a> 來代替（超神奇噢！？</p><p>至於實際上邊議會有什麼地雷我都不知道啊！</p><p>因此請大家永遠長是踩地雷吧！（遭毆</p><p>至於 Compile 的 Shell Script 其實可以用</p><blockquote><p>curl –location “<a href="https://vulcan-aotoki.Herokuapp.com/output/4a669895-5308-4846-8a72-28d78d46a999&quot;" target="_blank" rel="external nofollow noopener noreferrer">https://vulcan-aotoki.Herokuapp.com/output/4a669895-5308-4846-8a72-28d78d46a999&quot;</a> | tar zx</p></blockquote><p>這樣的方式來替代將下載下來的 tgz 又放到其他地方，然後再 Download 下來。<br>（不過這些 Output 會被保留到何時並沒有人知道⋯⋯）</p><p>後面好像有點敷衍？不管了 XDD</p><footer class="article__footer"><div class="text-center"><div class="fb-share-button" data-href="https://blog.frost.tw/posts/2012/11/04/heroku-buildpacks-customize-your-heroku-enviroment/" data-layout="button_count"></div></div><p align="center"><a href="https://ko-fi.com/J3J78093" target="_blank" rel="external nofollow noopener noreferrer"><img height="36" style="border:0;height:36px" src="https://az743702.vo.msecnd.net/cdn/kofi5.png?v=0" border="0" alt="Buy Me a Coffee at ko-fi.com"></a></p><iframe scrolling="no" frameborder="0" style="display:block;margin:0 auto;height:212px" src="https://button.like.co/in/embed/elct9620/button?referrer=https://blog.frost.tw/posts/2012/11/04/heroku-buildpacks-customize-your-heroku-enviroment/"></iframe></footer></div></article><div class="adv"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2844969736316510" data-ad-slot="5530952976" data-ad-format="auto"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><section id="comment" class="comment-box"><h1 class="comment-box__title">留言</h1><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a rel="nofollow" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></div><footer id="footer"><div id="copyright">&copy;2013 <a href="https://plus.google.com/117236344655673213049?rel=author" target="_blank" rel="external nofollow noopener noreferrer">蒼時弦也</a>. All right reversed.</div></footer><script type="text/javascript">window.disqus_shortname="revo-skill-frost",function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+window.disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5TQLRN" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><script>!function(e,t,a,n,g){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var m=t.getElementsByTagName(a)[0],r=t.createElement(a);r.async=!0,r.src="//www.googletagmanager.com/gtm.js?id=GTM-5TQLRN",m.parentNode.insertBefore(r,m)}(window,document,"script","dataLayer")</script><script>window.fbAsyncInit=function(){FB.init({appId:"178355449110",xfbml:!0,version:"v2.12"}),FB.AppEvents.logPageView()},function(e,n,t){var o,s=e.getElementsByTagName(n)[0];e.getElementById(t)||((o=e.createElement(n)).id=t,o.src="https://connect.facebook.net/zh_TW/sdk.js",o.async=!0,s.parentNode.insertBefore(o,s))}(document,"script","facebook-jssdk")</script><script src="/js/app.js"></script><div class="loading"></div></body></html>