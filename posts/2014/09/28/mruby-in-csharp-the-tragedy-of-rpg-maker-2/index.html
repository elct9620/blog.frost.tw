<!doctype html><html lang=zh-tw><head><title>MRuby in C# - 因 RPG Maker 的慘劇（二） - 弦而時習之</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="前一篇文章討論了關於 C# 執行一段 Ruby 程式碼並且取得執行結果（字串）的做法。 不過，光是這樣在 C# 使用 MRuby 的意義並不大，我們需要結合 Ruby 的 DSL 特性，讓自製的 RPG Maker 可以更加簡單的被用於製作遊戲（最終目的）
也因此，我們需要能夠讓 C# 中的一些 API 可以在 Ruby 中被呼叫以及使 …"><meta name=created content="2014-09-28T00:00:00+0000"><meta name=modified content="0001-01-01T00:00:00+0000"><meta name=author content="蒼時弦也"><meta property="og:site_name" content="弦而時習之"><meta property="og:title" content="MRuby in C# - 因 RPG Maker 的慘劇（二）"><meta property="og:url" content="https://blog.frost.tw/posts/2014/09/28/mruby-in-csharp-the-tragedy-of-rpg-maker-2/"><meta property="og:type" content="article"><meta name=theme-color content="#EFEFEF"><link href=https://blog.frost.tw/icon-512.png rel=icon><link rel=canonical href=https://blog.frost.tw/posts/2014/09/28/mruby-in-csharp-the-tragedy-of-rpg-maker-2/><script type=application/ld+json>[{"@context":"https://schema.org","@type":"WebPage","headline":"MRuby in C# - 因 RPG Maker 的慘劇（二）","datePublished":"2014-09-28T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","url":"https://blog.frost.tw/posts/2014/09/28/mruby-in-csharp-the-tragedy-of-rpg-maker-2/","description":"前一篇文章討論了關於 C# 執行一段 Ruby 程式碼並且取得執行結果（字串）的做法。 不過，光是這樣在 C# 使用 MRuby 的意義並不大，我們需要結合 Ruby 的 DSL 特性，讓自製的 RPG Maker 可以更加簡單的被用於製作遊戲（最終目的）\n也因此，我們需要能夠讓 C# 中的一些 API 可以在 Ruby 中被呼叫以及使 …\n","keywords":["Ruby","C#","心得","筆記"],"author":{"@type":"Person","name":"蒼時弦也"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.frost.tw/"},"publisher":{"@type":"Organization","name":"弦而時習之","url":"https://blog.frost.tw/"}},{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/blog.frost.tw\/","name":"弦而時習之","image":"http:\/\/blog.frost.tw\/icon-512.png"}},{"@type":"ListItem","position":2,"item":{"@id":"https:\/\/blog.frost.tw\/posts\/2014\/09\/28\/mruby-in-csharp-the-tragedy-of-rpg-maker-2\/","name":"MRuby in C# - 因 RPG Maker 的慘劇（二）"}}]}]</script><link rel=stylesheet href=/css/styls.css><script async src=/js/turbolinks.min.js></script></head><body><div id=fb-root data-turbolinks-permanent></div><h1 id=sitename><a href=/ class="hide-text logo--icon align-center">弦而時習之</a></h1><aside id=slogan class="slogan align-center text-center"><h2 class=slogan__title>Aotokitsuruya</h2><p class=slogan__description>The Web is attracting me, so I start learning PHP, HTML, CSS and JavaScript. When I know about Ruby, I fall in love with it. Now, I working with my friend to design games using C++ and still learning web about Golang, Ruby and JavaScript. In the other side, I also be a designer, the reason why the web is attracted me.</p></aside><div id=wrapper><article class="post article"><header class=article__header><time datetime=0001-01-01T00:00:00+0000 class=article__time--header>Feb.28</time><h1 class=article__title>MRuby in C# - 因 RPG Maker 的慘劇（二）</h1></header><div class=article__entry><nav class=translation></nav><p>前一篇文章討論了關於 C# 執行一段 Ruby 程式碼並且取得執行結果（字串）的做法。
不過，光是這樣在 C# 使用 MRuby 的意義並不大，我們需要結合 Ruby 的 DSL 特性，讓自製的 RPG Maker 可以更加簡單的被用於製作遊戲（最終目的）</p><p>也因此，我們需要能夠讓 C# 中的一些 API 可以在 Ruby 中被呼叫以及使用。
那麼，能夠從 C# 定義 Ruby 的 Module / Class 和 Method 就非常的重要，因為如果無法這樣做，那麼就無法讓 Ruby 執行 C# 的程式碼。</p><h4 id=mono-vs-qt>Mono v.s. Qt</h4><p>在開始之前，先來談談一個被我遺忘的跨平台工具 <strong>Qt</strong>。要說的話，其實 Qt 看起來會比 Mono 有更好的相容性在 MRuby 上（使用 C++ 就不會有 C# 的 P/Invoke 和 Marshal 要複製一份記憶體資料的問題）</p><p>於是我就去安裝了一下 Qt5 來測試，不過很不幸的是預設的範例專案有不少問題，讓我花了一個多小時才勉強啟動，體驗比我在去年使用的時候更差，讓我難以想像之後的開發是否會順利。</p><ul><li>問題大致上有 SDK 版本設定還停留在 10.8 沒有跟進 10.9 需要自行修改設定（卻沒有編輯器選項可以用）</li><li>有偵測到 Debugger 卻沒辦法讓 Mac / iOS 的預設運行設定使用（造成要 Debug 卻開不起來）</li><li>手動設定好 Deubgger 後卻開啟非常久，超過人類可忍耐的時間⋯⋯</li><li>預設的 <code>.pro</code> 設定檔在範例是空的，連需要的 Qt Library 都沒有預先寫好要讀取，造成編譯失敗</li><li>預設的 UI 編輯界面的 Header 檔案沒有自動產生，造成第一次使用無法順利編譯</li></ul><p>大致上碰到的問題就是上述這些，但是足以消磨一個人使用的耐心。雖然是社群維護的專案，不過有一些細節還是不太足夠（雖我也覺得 Mono 的編譯設定可改項目太少，但至少我可以順利使用⋯⋯）</p><p>就目前情況來說，我會以 Mono 為主要的開發工具，至少目前使用起來還算穩定並且也沒有太多的問題。</p><h4 id=實作-define-module>實作 Define Module</h4><p>在 Ruby 中除了直接定義方法之外，也可以將方法附加在 Module 或者 Class 上，這篇文章會介紹 Module 的做法，而 Class 基本上做法類似，之後有機會再做討論。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Runtime.InteropServices</span><span class=p>;</span>

<span class=k>namespace</span> <span class=nn>MRuby</span>
<span class=p>{</span>
	<span class=k>public</span> <span class=k>class</span> <span class=nc>Module</span>
	<span class=p>{</span>
		<span class=k>private</span> <span class=n>IntPtr</span> <span class=n>state</span><span class=p>;</span>
		<span class=k>private</span> <span class=n>IntPtr</span> <span class=n>klass</span><span class=p>;</span>
<span class=na>    
</span><span class=na>		[DllImport(Program.LIBMRUBY, EntryPoint=&#34;mrb_define_module&#34;)]</span> <span class=k>static</span> <span class=k>extern</span> <span class=n>IntPtr</span> <span class=n>MrbDefineModule</span><span class=p>(</span><span class=n>IntPtr</span> <span class=n>state</span><span class=p>,</span> <span class=kt>string</span> <span class=n>name</span><span class=p>)</span><span class=p>;</span>
		<span class=k>public</span> <span class=n>Module</span> <span class=p>(</span><span class=n>IntPtr</span> <span class=n>state</span><span class=p>,</span> <span class=kt>string</span> <span class=n>name</span><span class=p>)</span>
		<span class=p>{</span>
			<span class=k>this</span><span class=p>.</span><span class=n>state</span> <span class=p>=</span> <span class=n>state</span><span class=p>;</span>
			<span class=n>klass</span> <span class=p>=</span> <span class=n>MrbDefineModule</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>name</span><span class=p>)</span><span class=p>;</span>
		<span class=p>}</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>在 MRuby 中，要定義一個 Module 的方法會需要該 Module 的指標，以及整個 MRuby 的 State 指標，如果是分散的方式撰寫，會變得方長不方便，所以就包裝成一個 Class 來簡化這個過程。</p><p>基本上，只要完成這個步驟，就可以得到一個能在 Ruby 中使用的 Module 了！</p><blockquote><p>有很趣的地方在於 Ruby 中是不允許非英文字母、數字的 Module/Class 名稱，但是用 <code>mrb_define_module</code> 的時候，卻可以順利定義，但是為了避免錯誤，還是盡可能不要用這個做法會比較好。</p></blockquote><h4 id=實作-define-method>實作 Define Method</h4><p>在實作 Define Method 之前，我們需要先做好一個叫做 Aspec 的資料結構。
這個資料的用途在於指定 Method 的參數數量，雖然在 Ruby 可以接受不固定數量的參數，而在 C# 實作的時候這個設定值也不會影響到實作（主要是因為我們只有 <code>MrbValue</code> 一種型別的實作，沒辦法直接在定義方法的時候指定接受的參數，因此不會受到影響。）</p><blockquote><p>這部分還在驗證，不過目前推測是因為取出參數的做法關係造成的。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Runtime.InteropServices</span><span class=p>;</span>

<span class=k>namespace</span> <span class=nn>MRuby</span>
<span class=p>{</span>
<span class=na>	[StructLayout(LayoutKind.Sequential)]</span>
	<span class=k>public</span> <span class=k>struct</span> <span class=nc>Args</span>
	<span class=p>{</span>

		<span class=k>public</span> <span class=n>Args</span><span class=p>(</span><span class=n>UInt32</span> <span class=k>value</span><span class=p>)</span>
		<span class=p>{</span>
			<span class=k>this</span><span class=p>.</span><span class=k>value</span> <span class=p>=</span> <span class=k>value</span><span class=p>;</span>
		<span class=p>}</span>

		<span class=k>public</span> <span class=n>UInt32</span> <span class=k>value</span><span class=p>;</span>

		<span class=k>public</span> <span class=k>static</span> <span class=n>Args</span> <span class=n>NONE</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
			<span class=k>return</span> <span class=k>new</span> <span class=n>Args</span><span class=p>(</span><span class=m>0</span><span class=p>)</span><span class=p>;</span>
		<span class=p>}</span>

		<span class=k>public</span> <span class=k>static</span> <span class=n>Args</span> <span class=n>ANY</span><span class=p>(</span><span class=p>)</span> <span class=p>{</span>
			<span class=k>return</span> <span class=k>new</span> <span class=n>Args</span> <span class=p>(</span><span class=m>1</span> <span class=p>&lt;</span><span class=p>&lt;</span> <span class=m>1</span><span class=m>2</span><span class=p>)</span><span class=p>;</span>
		<span class=p>}</span>

		<span class=k>public</span> <span class=k>static</span> <span class=n>Args</span> <span class=n>REQ</span><span class=p>(</span><span class=kt>uint</span> <span class=n>n</span><span class=p>)</span> <span class=p>{</span>
			<span class=k>return</span> <span class=k>new</span> <span class=n>Args</span> <span class=p>(</span> <span class=p>(</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=p>&amp;</span> <span class=m>0</span><span class=n>x1f</span><span class=p>)</span> <span class=p>&lt;</span><span class=p>&lt;</span> <span class=m>1</span><span class=m>8</span> <span class=p>)</span><span class=p>;</span>
		<span class=p>}</span>

		<span class=k>public</span> <span class=k>static</span> <span class=n>Args</span> <span class=n>OPT</span><span class=p>(</span><span class=kt>uint</span> <span class=n>n</span><span class=p>)</span> <span class=p>{</span>
			<span class=k>return</span> <span class=k>new</span> <span class=n>Args</span> <span class=p>(</span> <span class=p>(</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=p>&amp;</span> <span class=m>0</span><span class=n>x1f</span><span class=p>)</span> <span class=p>&lt;</span><span class=p>&lt;</span> <span class=m>1</span><span class=m>3</span> <span class=p>)</span><span class=p>;</span>
		<span class=p>}</span>

		<span class=k>public</span> <span class=k>static</span> <span class=n>Args</span> <span class=n>ARGS</span><span class=p>(</span><span class=kt>uint</span> <span class=n>req</span><span class=p>,</span> <span class=kt>uint</span> <span class=n>opt</span><span class=p>)</span>
		<span class=p>{</span>
			<span class=k>return</span> <span class=n>Args</span><span class=p>.</span><span class=n>REQ</span> <span class=p>(</span><span class=n>req</span><span class=p>)</span> <span class=p>|</span> <span class=n>Args</span><span class=p>.</span><span class=n>OPT</span> <span class=p>(</span><span class=n>opt</span><span class=p>)</span><span class=p>;</span>
		<span class=p>}</span>

		<span class=k>public</span> <span class=k>static</span> <span class=n>Args</span> <span class=n>BLOCK</span><span class=p>(</span><span class=p>)</span>
		<span class=p>{</span>
			<span class=k>return</span> <span class=k>new</span> <span class=n>Args</span> <span class=p>(</span><span class=m>1</span><span class=p>)</span><span class=p>;</span>
		<span class=p>}</span>

		<span class=k>public</span> <span class=k>static</span> <span class=n>Args</span> <span class=k>operator</span> <span class=p>|</span><span class=p>(</span><span class=n>Args</span> <span class=n>args1</span><span class=p>,</span> <span class=n>Args</span> <span class=n>args2</span><span class=p>)</span>
		<span class=p>{</span>
			<span class=k>return</span> <span class=k>new</span> <span class=n>Args</span> <span class=p>(</span><span class=n>args1</span><span class=p>.</span><span class=k>value</span> <span class=p>|</span> <span class=n>args2</span><span class=p>.</span><span class=k>value</span><span class=p>)</span><span class=p>;</span>
		<span class=p>}</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>上述的結構是參照 MRuby 中的 Marco（巨集）所改寫成的，效果跟巨集執行後是相同的，只是讓它可以用 C# 的形式呈現。
（在 MRuby 中有不少操作是用 Marco 所做的，像是空的 <code>MrbValue</code> 生成，這時候就必須靠我們自己擴充 Shared Library 來讓 C# 能夠獲取相同的數值，這也會是之後開發的重要課題。）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Runtime.InteropServices</span><span class=p>;</span>

<span class=k>namespace</span> <span class=nn>MRuby</span>
<span class=p>{</span>
	<span class=k>public</span> <span class=k>class</span> <span class=nc>Module</span>
	<span class=p>{</span>
		<span class=k>private</span> <span class=n>IntPtr</span> <span class=n>state</span><span class=p>;</span>
		<span class=k>private</span> <span class=n>IntPtr</span> <span class=n>klass</span><span class=p>;</span>
    
    <span class=k>public</span> <span class=k>delegate</span> <span class=n>MrbValue</span> <span class=n>Func</span><span class=p>(</span><span class=n>IntPtr</span> <span class=n>state</span><span class=p>,</span> <span class=n>MrbValue</span> <span class=n>instance</span><span class=p>)</span><span class=p>;</span>
<span class=na>    
</span><span class=na>		[DllImport(Program.LIBMRUBY, EntryPoint=&#34;mrb_define_module&#34;)]</span> <span class=k>static</span> <span class=k>extern</span> <span class=n>IntPtr</span> <span class=n>MrbDefineModule</span><span class=p>(</span><span class=n>IntPtr</span> <span class=n>state</span><span class=p>,</span> <span class=kt>string</span> <span class=n>name</span><span class=p>)</span><span class=p>;</span>
		<span class=k>public</span> <span class=n>Module</span> <span class=p>(</span><span class=n>IntPtr</span> <span class=n>state</span><span class=p>,</span> <span class=kt>string</span> <span class=n>name</span><span class=p>)</span>
		<span class=p>{</span>
			<span class=k>this</span><span class=p>.</span><span class=n>state</span> <span class=p>=</span> <span class=n>state</span><span class=p>;</span>
			<span class=n>klass</span> <span class=p>=</span> <span class=n>MrbDefineModule</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>name</span><span class=p>)</span><span class=p>;</span>
		<span class=p>}</span>
<span class=na>    
</span><span class=na>    [DllImport(Program.LIBMRUBY, EntryPoint=&#34;mrb_define_module_function&#34;)]</span> <span class=k>static</span> <span class=k>extern</span> <span class=k>void</span> <span class=n>MrbDefineMethod</span><span class=p>(</span><span class=n>IntPtr</span> <span class=n>state</span><span class=p>,</span> <span class=n>IntPtr</span> <span class=n>klass</span><span class=p>,</span> <span class=kt>string</span> <span class=n>name</span><span class=p>,</span> <span class=n>Func</span> <span class=n>func</span><span class=p>,</span> <span class=n>Args</span> <span class=n>aspec</span><span class=p>)</span><span class=p>;</span>
		<span class=k>public</span> <span class=k>void</span> <span class=n>DefineMethod</span><span class=p>(</span><span class=kt>string</span> <span class=n>name</span><span class=p>,</span> <span class=n>Func</span> <span class=n>receiver</span><span class=p>,</span> <span class=n>Args</span> <span class=n>aspec</span><span class=p>)</span>
		<span class=p>{</span>
			<span class=n>MrbDefineMethod</span> <span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>klass</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>receiver</span><span class=p>,</span> <span class=n>aspec</span><span class=p>)</span><span class=p>;</span>
		<span class=p>}</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>在 MRuby 中，會使用 Function Pointer 的方式儲存方法，若要在 C# 中實做一個 Function Pointer 可以利用 <code>delegate</code> 來實做，要說的話概念上是類似的東西。
（參考資料：<a href=https://www.cnblogs.com/oomusou/archive/2007/05/02/734290.html>https://www.cnblogs.com/oomusou/archive/2007/05/02/734290.html</a>）</p><p>使用 <code>delegate</code> 功能需要指定方法的傳回值、接收的參數。不過在 MRuby 中都是固定傳回 <code>MrbValue</code> 並且把 <code>MrbState</code> 以及代表該物件實體的 <code>MrbValue</code> 存取進來。（到這邊應該很習慣了，不管是什麼數值都可以用 <code>MrbValue</code> 儲存）</p><h4 id=mruby-的方法呼叫>MRuby 的方法呼叫</h4><p>到此，我們可以定義 MRuby 的方法，那麼前面提到在 C# 中只能存取 <code>MrbValue</code> 的問題又是為什麼呢？</p><p>這就要談起 MRuby 的 <code>mrb_get_args</code> (<a href=https://github.com/mruby/mruby/blob/master/src/class.c#L441>https://Github.com/mRuby/mruby/blob/master/src/class.c#L441</a>) 這個方法，可以透過傳入 <code>MrbState</code> 以及 Format（參數格式）來存取資料。</p><p>從原始碼的定義來看，會發現它是一個接受「不定長度參數」的方法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=n>mrb_get_args</span><span class=p>(</span><span class=n>mrb_state</span> <span class=o>*</span><span class=n>mrb</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>format</span><span class=p>,</span> <span class=p>.</span><span class=p>.</span><span class=p>.</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>也就是說，用法類似於 <code>mrb_get_args(state, "ii", &intValue1, &intValue2)</code> 這樣子。</p><p>在 C# 中，要實作不定長度的參數，除了可以用 <code>params</code> 關鍵字，但是卻只能接受「單一型別」的陣列，不過從原始碼中的 Format Table 來看，情況似乎不是這麼簡單。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=cm>/*
</span><span class=cm>  retrieve arguments from mrb_state.
</span><span class=cm>
</span><span class=cm>  mrb_get_args(mrb, format, ...)
</span><span class=cm>
</span><span class=cm>  returns number of arguments parsed.
</span><span class=cm>
</span><span class=cm>  format specifiers:
</span><span class=cm>
</span><span class=cm>    string  mRuby type     C type                 note
</span><span class=cm>    ----------------------------------------------------------------------------------------------
</span><span class=cm>    o:      Object         [mrb_value]
</span><span class=cm>    C:      class/module   [mrb_value]
</span><span class=cm>    S:      String         [mrb_value]
</span><span class=cm>    A:      Array          [mrb_value]
</span><span class=cm>    H:      Hash           [mrb_value]
</span><span class=cm>    s:      String         [char*,mrb_int]        Receive two arguments.
</span><span class=cm>    z:      String         [char*]                NUL terminated string.
</span><span class=cm>    a:      Array          [mrb_value*,mrb_int]   Receive two arguments.
</span><span class=cm>    f:      Float          [mrb_float]
</span><span class=cm>    i:      Integer        [mrb_int]
</span><span class=cm>    b:      Boolean        [mrb_bool]
</span><span class=cm>    n:      Symbol         [mrb_sym]
</span><span class=cm>    d:      Data           [void*,mrb_data_type const] 2nd argument will be used to check data type so it won&#39;t be modified
</span><span class=cm>    &amp;:      Block          [mrb_value]
</span><span class=cm>    *:      rest argument  [mrb_value*,mrb_int]   Receive the rest of the arguments as an array.
</span><span class=cm>    |:      optional                              Next argument of &#39;|&#39; and later are optional.
</span><span class=cm>    ?:      optional given [mrb_bool]             true if preceding argument (optional) is given.
</span><span class=cm> */</span>
</code></pre></td></tr></table></div></div><p>如果指定的是 <code>i</code> 那麼拿到的會是一個 <code>mrb_int</code> 的型別，而且對我們的 C# 來說是一個未知型別。而使用 <code>params</code> 參數的話，這也會讓我們無法正確的接收數值。</p><p>不過，在 C# 提供了一個叫做 <code>__arglist</code> 的做法，也很幸運的這個方法就如同 C 語言的 <code>...</code> 用法，不過在 Mono 中，因為實作困難並沒有被完整、正確的支援。</p><p>也就是做，我們需要用一點小技巧來存取 MRuby 的參數。
（這個方法是從 <a href=https://Github.com/mitchellh/go-mruby>go-mRuby</a> 所學的，就是單純的用 <code>*&</code> 這個 Format 來讀取參數，並且自行處理需要的部分。）</p><h4 id=實作-getargs-helper>實作 GetArgs Helper</h4><p>因為目前只有 Module Class 會用到，所以就直接在 Module Class 裏面實作，實際上應該放在外面會更好些。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Runtime.InteropServices</span><span class=p>;</span>

<span class=k>namespace</span> <span class=nn>MRuby</span>
<span class=p>{</span>
	<span class=k>public</span> <span class=k>class</span> <span class=nc>Module</span>
	<span class=p>{</span>
		<span class=c1>// 略
</span><span class=c1></span><span class=na>    [DllImport(RubyContext.LIBMRUBY, EntryPoint=&#34;mrb_get_args&#34;)]</span> <span class=k>static</span> <span class=k>extern</span> <span class=k>void</span> <span class=n>MrbGetArguments</span><span class=p>(</span><span class=n>IntPtr</span> <span class=n>state</span><span class=p>,</span> <span class=kt>string</span> <span class=n>format</span><span class=p>,</span> <span class=k>out</span> <span class=n>IntPtr</span> <span class=n>argv</span><span class=p>,</span> <span class=k>out</span> <span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=k>out</span> <span class=n>MrbValue</span> <span class=n>block</span><span class=p>)</span><span class=p>;</span>
		<span class=k>public</span> <span class=k>static</span> <span class=n>Value</span><span class=p>[</span><span class=p>]</span> <span class=n>GetArgs</span><span class=p>(</span><span class=n>IntPtr</span> <span class=n>state</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>withBlock</span> <span class=p>=</span> <span class=k>false</span><span class=p>)</span>
		<span class=p>{</span>
			<span class=n>Value</span><span class=p>[</span><span class=p>]</span> <span class=n>values</span><span class=p>;</span>
			<span class=n>IntPtr</span> <span class=n>argvPointer</span><span class=p>;</span>
			<span class=n>MrbValue</span> <span class=k>value</span><span class=p>;</span>
			<span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=n>argc</span><span class=p>,</span> <span class=n>size</span><span class=p>;</span>
			<span class=n>MrbValue</span> <span class=n>block</span><span class=p>;</span>

			<span class=n>MrbGetArguments</span> <span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=s>&#34;*&amp;&#34;</span><span class=p>,</span> <span class=k>out</span> <span class=n>argvPointer</span><span class=p>,</span> <span class=k>out</span> <span class=n>argc</span><span class=p>,</span> <span class=k>out</span> <span class=n>block</span><span class=p>)</span><span class=p>;</span>

			<span class=kt>int</span> <span class=n>valueCount</span> <span class=p>=</span> <span class=n>argc</span><span class=p>;</span>
			<span class=k>if</span><span class=p>(</span><span class=n>withBlock</span><span class=p>)</span> <span class=p>{</span> <span class=n>valueCount</span><span class=p>+</span><span class=p>+</span><span class=p>;</span> <span class=p>}</span>

			<span class=n>values</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Value</span><span class=p>[</span><span class=n>valueCount</span><span class=p>]</span><span class=p>;</span> <span class=c1>// Include Block
</span><span class=c1></span>			<span class=n>size</span> <span class=p>=</span> <span class=n>Marshal</span><span class=p>.</span><span class=n>SizeOf</span> <span class=p>(</span><span class=k>typeof</span><span class=p>(</span><span class=n>MrbValue</span><span class=p>)</span><span class=p>)</span><span class=p>;</span>
			<span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>argc</span><span class=p>;</span> <span class=n>i</span><span class=p>+</span><span class=p>+</span><span class=p>)</span> <span class=p>{</span>
				<span class=k>value</span> <span class=p>=</span> <span class=p>(</span><span class=n>MrbValue</span><span class=p>)</span> <span class=n>Marshal</span><span class=p>.</span><span class=n>PtrToStructure</span> <span class=p>(</span><span class=n>argvPointer</span> <span class=p>+</span> <span class=p>(</span><span class=n>i</span> <span class=p>*</span> <span class=n>size</span><span class=p>)</span><span class=p>,</span> <span class=k>typeof</span><span class=p>(</span><span class=n>MrbValue</span><span class=p>)</span><span class=p>)</span><span class=p>;</span>
				<span class=n>values</span> <span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Value</span> <span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=k>value</span><span class=p>)</span><span class=p>;</span>
			<span class=p>}</span>

			<span class=k>if</span> <span class=p>(</span><span class=n>withBlock</span><span class=p>)</span> <span class=p>{</span>
				<span class=n>values</span> <span class=p>[</span><span class=n>argc</span><span class=p>]</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Value</span> <span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>block</span><span class=p>)</span><span class=p>;</span>
			<span class=p>}</span>

			<span class=k>return</span> <span class=n>values</span><span class=p>;</span>
		<span class=p>}</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>如此一來，就可以非常確定要使用的參數數目，並且可以正常的存取。</p><p>比較特別一點的就是 Ruby 的 Code Block 特性，所以會使用 <code>&</code> 來把這個 Blog 一起存出來，但是是否要使用又是另外一回事。</p><p>其中在存取的時候，會看到 <code>out</code> 這個修飾詞，基本上跟 <code>params</code> 和 <code>ref</code> 是經常被放在一起討論了。
在 C 語言中，其實就很單純的是 <code>&value</code> 這樣的做法（主要是在 C# 因為在非 Unsafe 模式是不允許這種記憶體操作，所以用這個方式代替。）</p><p><code>out</code> 和 <code>ref</code> 的差別在於，使用 <code>out</code> 不需要初始化變數，他會在被使用的時候自動處理。但是 <code>ref</code> 就不同了，他需要先用 <code>int value = 1;</code> 的方式做過初始化，才能夠正常使用（不然會發生錯誤）</p><blockquote><p>參數只會給第一個參數的指標，所以需要用迴圈把一整個記憶體區段掃過一遍取出每一個變數。</p></blockquote><p>另一方面，為了讓 <code>MrbValue</code> 可以更簡單的在 C# 中使用，所以我對他做了一些封裝讓他可以自動轉型成 C# 原生的型別。
（<code>Value</code> 結構，裡面時做的是 <code>MrbValue</code> 的一些自動轉型）</p><p>原始碼如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>System.Runtime.InteropServices</span><span class=p>;</span>

<span class=k>namespace</span> <span class=nn>OpenTKGame.Ruby</span>
<span class=p>{</span>
	<span class=cm>/**
</span><span class=cm>	 *  MrbValue Wrapper
</span><span class=cm>	 * 
</span><span class=cm>	 *  Create Helper to convert MrbValue to C# value types
</span><span class=cm>	 */</span>
	<span class=k>public</span> <span class=k>struct</span> <span class=nc>Value</span>
	<span class=p>{</span>
		<span class=k>public</span> <span class=n>IntPtr</span> <span class=n>state</span><span class=p>;</span>
		<span class=k>public</span> <span class=n>MrbValue</span> <span class=k>value</span><span class=p>;</span>

		<span class=k>public</span> <span class=n>Value</span><span class=p>(</span><span class=n>IntPtr</span> <span class=n>state</span><span class=p>,</span> <span class=n>MrbValue</span> <span class=k>value</span><span class=p>)</span>
		<span class=p>{</span>
			<span class=k>this</span><span class=p>.</span><span class=n>state</span> <span class=p>=</span> <span class=n>state</span><span class=p>;</span>
			<span class=k>this</span><span class=p>.</span><span class=k>value</span> <span class=p>=</span> <span class=k>value</span><span class=p>;</span>
		<span class=p>}</span>
<span class=na>
</span><span class=na>		[DllImportAttribute(RubyContext.LIBMRUBY, EntryPoint=&#34;mrb_obj_as_string&#34;)]</span> <span class=k>static</span> <span class=k>extern</span> <span class=n>MrbValue</span> <span class=n>MrbObjectToString</span><span class=p>(</span><span class=n>IntPtr</span> <span class=n>state</span><span class=p>,</span> <span class=n>MrbValue</span> <span class=n>obj</span><span class=p>)</span><span class=p>;</span>
<span class=na>		[DllImportAttribute(RubyContext.LIBMRUBY, EntryPoint=&#34;mrb_string_value_ptr&#34;)]</span> <span class=k>static</span> <span class=k>extern</span> <span class=n>IntPtr</span> <span class=n>MrbStringPointer</span><span class=p>(</span><span class=n>IntPtr</span> <span class=n>state</span><span class=p>,</span> <span class=n>MrbValue</span> <span class=n>obj</span><span class=p>)</span><span class=p>;</span>
		<span class=k>public</span> <span class=k>override</span> <span class=kt>string</span> <span class=n>ToString</span><span class=p>(</span><span class=p>)</span>
		<span class=p>{</span>
			<span class=n>IntPtr</span> <span class=n>stringPtr</span> <span class=p>=</span> <span class=n>IntPtr</span><span class=p>.</span><span class=n>Zero</span><span class=p>;</span>

			<span class=k>if</span> <span class=p>(</span><span class=k>value</span><span class=p>.</span><span class=n>type</span> <span class=p>=</span><span class=p>=</span> <span class=n>Type</span><span class=p>.</span><span class=n>MRB_STRING</span><span class=p>)</span> <span class=p>{</span>
				<span class=n>stringPtr</span> <span class=p>=</span> <span class=n>MrbStringPointer</span> <span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=k>value</span><span class=p>)</span><span class=p>;</span>
			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
				<span class=n>stringPtr</span> <span class=p>=</span> <span class=n>MrbStringPointer</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>MrbObjectToString</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=k>value</span><span class=p>)</span><span class=p>)</span><span class=p>;</span>
			<span class=p>}</span>
			<span class=k>return</span> <span class=n>Marshal</span><span class=p>.</span><span class=n>PtrToStringAuto</span> <span class=p>(</span><span class=n>stringPtr</span><span class=p>)</span><span class=p>;</span>
		<span class=p>}</span>
			
		<span class=k>static</span> <span class=k>public</span> <span class=k>implicit</span> <span class=k>operator</span> <span class=kt>string</span> <span class=p>(</span><span class=n>Value</span> <span class=k>value</span><span class=p>)</span>
		<span class=p>{</span>
			<span class=n>IntPtr</span> <span class=n>stringPtr</span> <span class=p>=</span> <span class=n>IntPtr</span><span class=p>.</span><span class=n>Zero</span><span class=p>;</span>

			<span class=k>if</span> <span class=p>(</span><span class=k>value</span><span class=p>.</span><span class=k>value</span><span class=p>.</span><span class=n>type</span> <span class=p>=</span><span class=p>=</span> <span class=n>Type</span><span class=p>.</span><span class=n>MRB_STRING</span><span class=p>)</span> <span class=p>{</span>
				<span class=n>stringPtr</span> <span class=p>=</span> <span class=n>MrbStringPointer</span> <span class=p>(</span><span class=k>value</span><span class=p>.</span><span class=n>state</span><span class=p>,</span> <span class=k>value</span><span class=p>.</span><span class=k>value</span><span class=p>)</span><span class=p>;</span>
			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
				<span class=n>stringPtr</span> <span class=p>=</span> <span class=n>MrbStringPointer</span><span class=p>(</span><span class=k>value</span><span class=p>.</span><span class=n>state</span><span class=p>,</span> <span class=n>MrbObjectToString</span><span class=p>(</span><span class=k>value</span><span class=p>.</span><span class=n>state</span><span class=p>,</span> <span class=k>value</span><span class=p>.</span><span class=k>value</span><span class=p>)</span><span class=p>)</span><span class=p>;</span>
			<span class=p>}</span>
			<span class=k>return</span> <span class=n>Marshal</span><span class=p>.</span><span class=n>PtrToStringAuto</span> <span class=p>(</span><span class=n>stringPtr</span><span class=p>)</span><span class=p>;</span>
		<span class=p>}</span>

		<span class=k>static</span> <span class=k>public</span> <span class=k>implicit</span> <span class=k>operator</span> <span class=kt>int</span><span class=p>(</span><span class=n>Value</span> <span class=k>value</span><span class=p>)</span>
		<span class=p>{</span>
			<span class=k>if</span> <span class=p>(</span><span class=k>value</span><span class=p>.</span><span class=k>value</span><span class=p>.</span><span class=n>type</span> <span class=p>=</span><span class=p>=</span> <span class=n>Type</span><span class=p>.</span><span class=n>MRB_FIXNUM</span><span class=p>)</span> <span class=p>{</span>
				<span class=k>return</span> <span class=k>value</span><span class=p>.</span><span class=k>value</span><span class=p>.</span><span class=k>value</span><span class=p>.</span><span class=n>i</span><span class=p>;</span>
			<span class=p>}</span>
			<span class=k>if</span> <span class=p>(</span><span class=k>value</span><span class=p>.</span><span class=k>value</span><span class=p>.</span><span class=n>type</span> <span class=p>=</span><span class=p>=</span> <span class=n>Type</span><span class=p>.</span><span class=n>MRB_FLOAT</span><span class=p>)</span> <span class=p>{</span>
				<span class=k>return</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=k>value</span><span class=p>.</span><span class=k>value</span><span class=p>.</span><span class=k>value</span><span class=p>.</span><span class=n>f</span><span class=p>;</span>
			<span class=p>}</span>
			<span class=k>return</span> <span class=m>0</span><span class=p>;</span>
		<span class=p>}</span>

		<span class=k>static</span> <span class=k>public</span> <span class=k>implicit</span> <span class=k>operator</span> <span class=kt>double</span><span class=p>(</span><span class=n>Value</span> <span class=k>value</span><span class=p>)</span>
		<span class=p>{</span>
			<span class=k>if</span> <span class=p>(</span><span class=k>value</span><span class=p>.</span><span class=k>value</span><span class=p>.</span><span class=n>type</span> <span class=p>=</span><span class=p>=</span> <span class=n>Type</span><span class=p>.</span><span class=n>MRB_FLOAT</span><span class=p>)</span> <span class=p>{</span>
				<span class=k>return</span> <span class=k>value</span><span class=p>.</span><span class=k>value</span><span class=p>.</span><span class=k>value</span><span class=p>.</span><span class=n>f</span><span class=p>;</span>
			<span class=p>}</span> 
			<span class=k>if</span> <span class=p>(</span><span class=k>value</span><span class=p>.</span><span class=k>value</span><span class=p>.</span><span class=n>type</span> <span class=p>=</span><span class=p>=</span> <span class=n>Type</span><span class=p>.</span><span class=n>MRB_FIXNUM</span><span class=p>)</span> <span class=p>{</span>
				<span class=k>return</span> <span class=p>(</span><span class=kt>double</span><span class=p>)</span><span class=k>value</span><span class=p>.</span><span class=k>value</span><span class=p>.</span><span class=k>value</span><span class=p>.</span><span class=n>i</span><span class=p>;</span>
			<span class=p>}</span>
			<span class=k>return</span> <span class=m>0f</span><span class=p>;</span>
		<span class=p>}</span>

		<span class=k>static</span> <span class=k>public</span> <span class=k>implicit</span> <span class=k>operator</span> <span class=kt>bool</span><span class=p>(</span><span class=n>Value</span> <span class=k>value</span><span class=p>)</span>
		<span class=p>{</span>
			<span class=k>switch</span> <span class=p>(</span><span class=k>value</span><span class=p>.</span><span class=k>value</span><span class=p>.</span><span class=n>type</span><span class=p>)</span> <span class=p>{</span>
			<span class=k>case</span> <span class=n>Type</span><span class=p>.</span><span class=n>MRB_FALSE</span><span class=p>:</span>
			<span class=k>case</span> <span class=n>Type</span><span class=p>.</span><span class=n>MRB_EXCEPTION</span><span class=p>:</span>
			<span class=k>case</span> <span class=n>Type</span><span class=p>.</span><span class=n>MRB_UNDEF</span><span class=p>:</span>
				<span class=k>return</span> <span class=k>false</span><span class=p>;</span>
			<span class=p>}</span>
			<span class=k>return</span> <span class=k>true</span><span class=p>;</span>
		<span class=p>}</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>我實作了像是 <code>string</code> 還有 <code>int</code> <code>double</code> <code>bool</code> 等常用型別。
（不過 <code>ToString</code> 和 <code>string</code> 似乎只需要其中一個就可以了⋯⋯）</p><h4 id=實作自定-module-和-method>實作自定 Module 和 Method</h4><p>先實作一個在 Ruby 可以被呼叫的方法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>public</span> <span class=k>static</span> <span class=n>MrbValue</span> <span class=n>ConsoleWrite</span><span class=p>(</span><span class=n>IntPtr</span> <span class=n>state</span><span class=p>,</span> <span class=n>MrbValue</span> <span class=n>self</span><span class=p>)</span>
<span class=p>{</span>
	<span class=kt>int</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span>
	<span class=n>Value</span><span class=p>[</span><span class=p>]</span> <span class=n>values</span> <span class=p>=</span> <span class=n>Module</span><span class=p>.</span><span class=n>GetArgs</span> <span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=k>false</span><span class=p>)</span><span class=p>;</span>

	<span class=k>for</span><span class=p>(</span><span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>values</span><span class=p>.</span><span class=n>Length</span><span class=p>;</span> <span class=n>i</span><span class=p>+</span><span class=p>+</span><span class=p>)</span> <span class=p>{</span>
  	<span class=n>Console</span><span class=p>.</span><span class=n>WriteLine</span> <span class=p>(</span><span class=s>&#34;Receive Params: {0}&#34;</span><span class=p>,</span> <span class=n>values</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=p>.</span><span class=n>ToString</span><span class=p>(</span><span class=p>)</span><span class=p>)</span><span class=p>;</span>
	<span class=p>}</span>
      
	<span class=k>return</span> <span class=n>values</span><span class=p>[</span><span class=m>0</span><span class=p>]</span><span class=p>.</span><span class=k>value</span><span class=p>;</span> <span class=c1>// Simple return first value
</span><span class=c1></span><span class=p>}</span>
</code></pre></td></tr></table></div></div><p>接著定義模組。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=n>Value</span> <span class=k>value</span><span class=p>;</span>
<span class=n>RubyContext</span> <span class=n>context</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Ruby</span><span class=p>.</span><span class=n>RubyContext</span> <span class=p>(</span><span class=p>)</span><span class=p>;</span>

<span class=c1>// Define Module and Method
</span><span class=c1></span><span class=n>Module</span> <span class=n>module</span> <span class=p>=</span> <span class=n>context</span><span class=p>.</span><span class=n>DefineModule</span> <span class=p>(</span><span class=s>&#34;Example&#34;</span><span class=p>)</span><span class=p>;</span>
<span class=n>module</span><span class=p>.</span><span class=n>DefineMethod</span> <span class=p>(</span><span class=s>&#34;args&#34;</span><span class=p>,</span> <span class=n>ConsoleWrite</span><span class=p>,</span> <span class=n>Args</span><span class=p>.</span><span class=n>ANY</span><span class=p>(</span><span class=p>)</span><span class=p>)</span><span class=p>;</span>
      
<span class=c1>// Run Ruby code
</span><span class=c1></span><span class=n>context</span><span class=p>.</span><span class=n>LoadString</span> <span class=p>(</span><span class=s>&#34;Example.args(1, &#39;hello&#39;, &#39;world&#39;)&#34;</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>這樣一來，就可以看到剛剛的成果了～</p><blockquote><p>前面忘記提到 context 的 DefineModule 實作，其實就是做了 <code>new Module(state, name)</code> 這件事情而已。</p></blockquote><hr><p>最近已經開學了，而且還在做畢業製作。我想能夠花心思在這個部分上面的時間會越來越少，下一階段我會更加完善這個架構，必且開始正是的專案（我會放在 Githu 上面，初期目標是像 KrKr 那類 AVG 系統一樣單可用）</p><p>之後暫定的 Roadmap：</p><ul><li><code>rb</code> to <code>mrb</code> 的封裝</li><li>OpenGL 的實作（Based on OpenTK）</li><li>更完整的 MRuby Library for C#</li><li>完善專案建構（大概會要把好幾個專案組合才能順利開發完整的系統吧 XD）</li><li>簡易的 AVG 功能</li></ul><blockquote><p>這系列文章因為評估 Mono 的搭配過於複雜，因此停止更新、研究</p></blockquote><footer class=article__footer><div class=text-center><div class=fb-share-button data-href="<%- page.permalink %>" data-layout=button_count></div></div><div class="text-center mt-1"><style>.bmc-button img{width:27px!important;margin-bottom:1px!important;box-shadow:none!important;border:none!important;vertical-align:middle!important}.bmc-button{line-height:36px!important;height:37px!important;text-decoration:none!important;display:inline-flex!important;color:#fff!important;background-color:#000!important;border-radius:3px!important;border:1px solid transparent!important;padding:1px 9px!important;font-size:22px!important;letter-spacing:.6px!important;box-shadow:0 1px 2px rgba(190,190,190,.5)!important;-webkit-box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;margin:0 auto!important;font-family:cookie,cursive!important;-webkit-box-sizing:border-box!important;box-sizing:border-box!important;-o-transition:.3s all linear!important;-webkit-transition:.3s all linear!important;-moz-transition:.3s all linear!important;-ms-transition:.3s all linear!important;transition:.3s all linear!important}.bmc-button:hover,.bmc-button:active,.bmc-button:focus{-webkit-box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;text-decoration:none!important;box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;opacity:.85!important;color:#fff!important}</style><link href="https://fonts.googleapis.com/css?family=Cookie" rel=stylesheet><a class=bmc-button target=_blank href=https://www.buymeacoffee.com/aotoki><img src=https://bmc-cdn.nyc3.digitaloceanspaces.com/BMC-button-images/BMC-btn-logo.svg alt="Buy me a Coffee"><span style=margin-left:5px>Buy me a Coffee</span></a></div><iframe scrolling=no frameborder=0 style="display:block;margin:0 auto;height:212px" src="https://button.like.co/in/embed/elct9620/button?referrer=<%- page.permalink %>"></iframe><ul class=article__tag-list><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/Ruby/>Ruby</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/C#/>C#</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/%E5%BF%83%E5%BE%97/>心得</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/%E7%AD%86%E8%A8%98/>筆記</a></li></ul></footer></div></article><div class=adv><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-2844969736316510 data-ad-slot=5530952976 data-ad-format=auto></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div><section id=comment class=comment-box><h1 class=comment-box__title>留言</h1><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"revo-skill-frost"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></section></div><footer id=footer><div id=copyright>&copy;2020 <a href="https://plus.google.com/117236344655673213049?rel=author" target=_blank>蒼時弦也</a>. All right reversed.</div></footer><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5TQLRN" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-5TQLRN');</script><script>window.fbAsyncInit=function(){FB.init({appId:'178355449110',xfbml:true,version:'v2.12'});FB.AppEvents.logPageView();};(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(d.getElementById(id)){return;}
js=d.createElement(s);js.id=id;js.src="https://connect.facebook.net/zh_TW/sdk.js";js.async=true
fjs.parentNode.insertBefore(js,fjs);}(document,'script','facebook-jssdk'));</script><script src=/js/app.min.e979702d4c2a76dd5e32acda7647b733e4959a8621df075338d00d2c6837e87a.js></script><div class=loading></div></body></html>