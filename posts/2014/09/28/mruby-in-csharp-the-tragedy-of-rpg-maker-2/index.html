<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  
  <title>MRuby in C# - 因 RPG Maker 的慘劇（二） | 弦而時習之</title>
  <meta name="theme-color" content="#EFEFEF">

  <meta name="author" content="蒼時弦也">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1">

  <meta name="description" content="前一篇文章討論了關於 C# 執行一段 Ruby 程式碼並且取得執行結果（字串）的做法。不過，光是這樣在 C# 使用 MRuby 的意義並不大，我們需要結合 Ruby 的 DSL 特性，讓自製的 RPG Maker 可以更加簡單的被用於製作遊戲（最終目的） 也因此，我們需要能夠讓 C# 中的一些 API 可以在 Ruby 中被呼叫以及使用。那麼，能夠從 C# 定義 Ruby 的 Module / C">
<meta name="keywords" content="心得,Ruby,筆記,C#">
<meta property="og:type" content="article">
<meta property="og:title" content="MRuby in C# - 因 RPG Maker 的慘劇（二）">
<meta property="og:url" content="https://blog.frost.tw/posts/2014/09/28/mruby-in-csharp-the-tragedy-of-rpg-maker-2/">
<meta property="og:site_name" content="弦而時習之">
<meta property="og:description" content="前一篇文章討論了關於 C# 執行一段 Ruby 程式碼並且取得執行結果（字串）的做法。不過，光是這樣在 C# 使用 MRuby 的意義並不大，我們需要結合 Ruby 的 DSL 特性，讓自製的 RPG Maker 可以更加簡單的被用於製作遊戲（最終目的） 也因此，我們需要能夠讓 C# 中的一些 API 可以在 Ruby 中被呼叫以及使用。那麼，能夠從 C# 定義 Ruby 的 Module / C">
<meta property="og:locale" content="zh-TW">
<meta property="og:image" content="http://blog.frost.tw/icon-512.png">
<meta property="og:updated_time" content="2017-07-02T17:07:07.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MRuby in C# - 因 RPG Maker 的慘劇（二）">
<meta name="twitter:description" content="前一篇文章討論了關於 C# 執行一段 Ruby 程式碼並且取得執行結果（字串）的做法。不過，光是這樣在 C# 使用 MRuby 的意義並不大，我們需要結合 Ruby 的 DSL 特性，讓自製的 RPG Maker 可以更加簡單的被用於製作遊戲（最終目的） 也因此，我們需要能夠讓 C# 中的一些 API 可以在 Ruby 中被呼叫以及使用。那麼，能夠從 C# 定義 Ruby 的 Module / C">
<meta name="twitter:image" content="http://blog.frost.tw/icon-512.png">
<link rel="publisher" href="https://plus.google.com/117236344655673213049">
<meta property="fb:app_id" content="178355449110">

  <meta property="fb:pages" content="180666522388" />
  <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Blog",
    "name": "弦而時習之",
    "url": "https://blog.frost.tw",
    "image": "http://blog.frost.tw/icon-512.png",
    "description": "蒼時弦也的個人網誌，專注在前端、後端以及遊戲開發，大多使用 Ruby 和 Ruby on Rails 以及 Golang、JS 和 C 語言。",
    "sameAs": [
      "https://www.facebook.com/frost.tw/"
    ]
}
</script>
<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Person",
    "name": "蒼時弦也",
    "url": "https://blog.frost.tw",
    "sameAs": [
      "https://www.facebook.com/elct9620",
      "https://www.instagram.com/elct9620/",
      "https://twitter.com/elct9620",
      "https://plus.google.com/+%E8%92%BC%E6%99%82%E5%BC%A6%E4%B9%9F-plus",
      "https://www.linkedin.com/in/elct9620"
    ]
}
</script>


<script type="application/ld+json">
{
  "@context":"http://schema.org",
  "@type":"Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.frost.tw/posts/2014/09/28/mruby-in-csharp-the-tragedy-of-rpg-maker-2/"
  },
  "headline":"MRuby in C# - 因 RPG Maker 的慘劇（二）",
  "image": [
    
    "http://blog.frost.tw/icon-512.png"
  ],
  "datePublished": "2014-09-27T20:15:00.000Z",
  "dateModified": "2017-07-02T17:07:07.000Z",
  "description":"前一篇文章討論了關於 C# 執行一段 Ruby 程式碼並且取得執行結果（字串）的做法。不過，光是這樣在 C# 使用 MRuby 的意義並不大，我們需要結合 Ruby 的 DSL 特性，讓自製的 RPG Maker 可以更加簡單的被用於製作遊戲（最終目的）也因此，我們需要能夠讓 C# 中的一些 API 可以在 Ruby 中被呼叫以及使用。那麼，能夠從 C# 定義 Ruby 的 Module / Class 和 Method 就非常的重要，因為如果無法這樣做，那麼就無法讓 Ruby 執行 C# 的程式碼。",
  "author": {
    "@type": "Person",
    "name": "蒼時弦也"
  },
  "publisher": {
    "@type": "Organization",
    "name": "蒼時弦也",
    "logo": {
      "@type": "ImageObject",
      "url": "http://blog.forst.tw/logo-wide.png"
    }
  }
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
    "@type": "ListItem",
    "position": 1,
    "item": {
      "@id": "https://blog.frost.tw",
      "name": "弦而時習之 ",
      "image": "http://blog.frost.tw/icon-512.png"
    }
  },{
    "@type": "ListItem",
    "position": 2,
    "item": {
      "@id": "https://blog.frost.tw/posts/2014/09/28/mruby-in-csharp-the-tragedy-of-rpg-maker-2/",
      "name": "MRuby in C# - 因 RPG Maker 的慘劇（二）",
      "image": "http://blog.frost.tw/icon-512.png"
    }
  }]
}
</script>




  
  <link rel="canonical" href="https://blog.frost.tw/posts/2014/09/28/mruby-in-csharp-the-tragedy-of-rpg-maker-2/" />
  
  <link href="/icon-512.png" rel="icon">
  <link rel="alternate" href="/feed.xml" title="弦而時習之" type="application/rss+xml">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <script async src="/js/turbolinks.js"></script>
</head>

  <body>
    <div id="fb-root" data-turbolinks-permanent></div>
    <header id="header">
      
<h1 id="sitename">
  <a href="/" class="hide-text logo--icon align-center">
  弦而時習之
  </a>
</h1>

<aside id="slogan" class="slogan align-center text-center">
  <h2 class="slogan__title">Aotokitsuruya</h2>
  <p class="slogan__description">The Web is attracting  me, so I start learning PHP, HTML, CSS and JavaScript. When I know about Ruby, I fall in love with it. Now, I working with my friend to design games using C++ and still learning web about Golang, Ruby and JavaScript. In the other side, I also be a designer, the reason why the web is attracted me.</p>
</aside>

    </header>
    <div id="wrapper">
      
<article class="post article">
  <header class="article__header">
    <time datetime="2014-09-27T20:15:00.000Z" class="article__time--header">
      Sep.28
    </time>
    
  
    <h1 class="article__title">MRuby in C# - 因 RPG Maker 的慘劇（二）</h1>
  


  </header>
  <div class="article__entry">
    
    <p>前一篇文章討論了關於 C# 執行一段 Ruby 程式碼並且取得執行結果（字串）的做法。<br>不過，光是這樣在 C# 使用 MRuby 的意義並不大，我們需要結合 Ruby 的 DSL 特性，讓自製的 RPG Maker 可以更加簡單的被用於製作遊戲（最終目的）</p>
<p>也因此，我們需要能夠讓 C# 中的一些 API 可以在 Ruby 中被呼叫以及使用。<br>那麼，能夠從 C# 定義 Ruby 的 Module / Class 和 Method 就非常的重要，因為如果無法這樣做，那麼就無法讓 Ruby 執行 C# 的程式碼。</p>
<a id="more"></a>
<h4 id="Mono-v-s-Qt"><a href="#Mono-v-s-Qt" class="headerlink" title="Mono v.s. Qt"></a>Mono v.s. Qt</h4><p>在開始之前，先來談談一個被我遺忘的跨平台工具 <strong>Qt</strong>。要說的話，其實 Qt 看起來會比 Mono 有更好的相容性在 MRuby 上（使用 C++ 就不會有 C# 的 P/Invoke 和 Marshal 要複製一份記憶體資料的問題）</p>
<p>於是我就去安裝了一下 Qt5 來測試，不過很不幸的是預設的範例專案有不少問題，讓我花了一個多小時才勉強啟動，體驗比我在去年使用的時候更差，讓我難以想像之後的開發是否會順利。</p>
<ul>
<li>問題大致上有 SDK 版本設定還停留在 10.8 沒有跟進 10.9 需要自行修改設定（卻沒有編輯器選項可以用）</li>
<li>有偵測到 Debugger 卻沒辦法讓 Mac / iOS 的預設運行設定使用（造成要 Debug 卻開不起來）</li>
<li>手動設定好 Deubgger 後卻開啟非常久，超過人類可忍耐的時間⋯⋯</li>
<li>預設的 <code>.pro</code> 設定檔在範例是空的，連需要的 Qt Library 都沒有預先寫好要讀取，造成編譯失敗</li>
<li>預設的 UI 編輯界面的 Header 檔案沒有自動產生，造成第一次使用無法順利編譯</li>
</ul>
<p>大致上碰到的問題就是上述這些，但是足以消磨一個人使用的耐心。雖然是社群維護的專案，不過有一些細節還是不太足夠（雖我也覺得 Mono 的編譯設定可改項目太少，但至少我可以順利使用⋯⋯）</p>
<p>就目前情況來說，我會以 Mono 為主要的開發工具，至少目前使用起來還算穩定並且也沒有太多的問題。</p>
<h4 id="實作-Define-Module"><a href="#實作-Define-Module" class="headerlink" title="實作 Define Module"></a>實作 Define Module</h4><p>在 Ruby 中除了直接定義方法之外，也可以將方法附加在 Module 或者 Class 上，這篇文章會介紹 Module 的做法，而 Class 基本上做法類似，之後有機會再做討論。</p>
<figure class="highlight cs"><figcaption><span>Module.cs</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">MRuby</span></div><div class="line">&#123;</div><div class="line">true<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Module</span></div><div class="line">true&#123;</div><div class="line">truetrue<span class="keyword">private</span> IntPtr state;</div><div class="line">truetrue<span class="keyword">private</span> IntPtr klass;</div><div class="line">    </div><div class="line">truetrue[<span class="meta">DllImport(Program.LIBMRUBY, EntryPoint=<span class="meta-string">"mrb_define_module"</span>)</span>] <span class="function"><span class="keyword">static</span> <span class="keyword">extern</span> IntPtr <span class="title">MrbDefineModule</span>(<span class="params">IntPtr state, <span class="keyword">string</span> name</span>)</span>;</div><div class="line">truetrue<span class="function"><span class="keyword">public</span> <span class="title">Module</span> (<span class="params">IntPtr state, <span class="keyword">string</span> name</span>)</span></div><div class="line">truetrue&#123;</div><div class="line">truetruetrue<span class="keyword">this</span>.state = state;</div><div class="line">truetruetrueklass = MrbDefineModule(state, name);</div><div class="line">truetrue&#125;</div><div class="line">true&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 MRuby 中，要定義一個 Module 的方法會需要該 Module 的指標，以及整個 MRuby 的 State 指標，如果是分散的方式撰寫，會變得方長不方便，所以就包裝成一個 Class 來簡化這個過程。</p>
<p>基本上，只要完成這個步驟，就可以得到一個能在 Ruby 中使用的 Module 了！</p>
<blockquote>
<p>有很趣的地方在於 Ruby 中是不允許非英文字母、數字的 Module/Class 名稱，但是用 <code>mrb_define_module</code> 的時候，卻可以順利定義，但是為了避免錯誤，還是盡可能不要用這個做法會比較好。</p>
</blockquote>
<h4 id="實作-Define-Method"><a href="#實作-Define-Method" class="headerlink" title="實作 Define Method"></a>實作 Define Method</h4><p>在實作 Define Method 之前，我們需要先做好一個叫做 Aspec 的資料結構。<br>這個資料的用途在於指定 Method 的參數數量，雖然在 Ruby 可以接受不固定數量的參數，而在 C# 實作的時候這個設定值也不會影響到實作（主要是因為我們只有 <code>MrbValue</code> 一種型別的實作，沒辦法直接在定義方法的時候指定接受的參數，因此不會受到影響。）</p>
<blockquote>
<p>這部分還在驗證，不過目前推測是因為取出參數的做法關係造成的。</p>
</blockquote>
<figure class="highlight cs"><figcaption><span>Args.cs</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">MRuby</span></div><div class="line">&#123;</div><div class="line">true[<span class="meta">StructLayout(LayoutKind.Sequential)</span>]</div><div class="line">true<span class="keyword">public</span> <span class="keyword">struct</span> Args</div><div class="line">true&#123;</div><div class="line"></div><div class="line">truetrue<span class="function"><span class="keyword">public</span> <span class="title">Args</span>(<span class="params">UInt32 <span class="keyword">value</span></span>)</span></div><div class="line">truetrue&#123;</div><div class="line">truetruetrue<span class="keyword">this</span>.<span class="keyword">value</span> = <span class="keyword">value</span>;</div><div class="line">truetrue&#125;</div><div class="line"></div><div class="line">truetrue<span class="keyword">public</span> UInt32 <span class="keyword">value</span>;</div><div class="line"></div><div class="line">truetrue<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Args <span class="title">NONE</span>(<span class="params"></span>) </span>&#123;</div><div class="line">truetruetrue<span class="keyword">return</span> <span class="keyword">new</span> Args(<span class="number">0</span>);</div><div class="line">truetrue&#125;</div><div class="line"></div><div class="line">truetrue<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Args <span class="title">ANY</span>(<span class="params"></span>) </span>&#123;</div><div class="line">truetruetrue<span class="keyword">return</span> <span class="keyword">new</span> Args (<span class="number">1</span> &lt;&lt; <span class="number">12</span>);</div><div class="line">truetrue&#125;</div><div class="line"></div><div class="line">truetrue<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Args <span class="title">REQ</span>(<span class="params"><span class="keyword">uint</span> n</span>) </span>&#123;</div><div class="line">truetruetrue<span class="keyword">return</span> <span class="keyword">new</span> Args ( ((n) &amp; <span class="number">0x1f</span>) &lt;&lt; <span class="number">18</span> );</div><div class="line">truetrue&#125;</div><div class="line"></div><div class="line">truetrue<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Args <span class="title">OPT</span>(<span class="params"><span class="keyword">uint</span> n</span>) </span>&#123;</div><div class="line">truetruetrue<span class="keyword">return</span> <span class="keyword">new</span> Args ( ((n) &amp; <span class="number">0x1f</span>) &lt;&lt; <span class="number">13</span> );</div><div class="line">truetrue&#125;</div><div class="line"></div><div class="line">truetrue<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Args <span class="title">ARGS</span>(<span class="params"><span class="keyword">uint</span> req, <span class="keyword">uint</span> opt</span>)</span></div><div class="line">truetrue&#123;</div><div class="line">truetruetrue<span class="keyword">return</span> Args.REQ (req) | Args.OPT (opt);</div><div class="line">truetrue&#125;</div><div class="line"></div><div class="line">truetrue<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Args <span class="title">BLOCK</span>(<span class="params"></span>)</span></div><div class="line">truetrue&#123;</div><div class="line">truetruetrue<span class="keyword">return</span> <span class="keyword">new</span> Args (<span class="number">1</span>);</div><div class="line">truetrue&#125;</div><div class="line"></div><div class="line">truetrue<span class="keyword">public</span> <span class="keyword">static</span> Args <span class="keyword">operator</span> |(Args args1, Args args2)</div><div class="line">truetrue&#123;</div><div class="line">truetruetrue<span class="keyword">return</span> <span class="keyword">new</span> Args (args1.<span class="keyword">value</span> | args2.<span class="keyword">value</span>);</div><div class="line">truetrue&#125;</div><div class="line">true&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述的結構是參照 MRuby 中的 Marco（巨集）所改寫成的，效果跟巨集執行後是相同的，只是讓它可以用 C# 的形式呈現。<br>（在 MRuby 中有不少操作是用 Marco 所做的，像是空的 <code>MrbValue</code> 生成，這時候就必須靠我們自己擴充 Shared Library 來讓 C# 能夠獲取相同的數值，這也會是之後開發的重要課題。）</p>
<figure class="highlight cs"><figcaption><span>Module.cs</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">MRuby</span></div><div class="line">&#123;</div><div class="line">true<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Module</span></div><div class="line">true&#123;</div><div class="line">truetrue<span class="keyword">private</span> IntPtr state;</div><div class="line">truetrue<span class="keyword">private</span> IntPtr klass;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">delegate</span> MrbValue <span class="title">Func</span>(<span class="params">IntPtr state, MrbValue instance</span>)</span>;</div><div class="line">    </div><div class="line">truetrue[<span class="meta">DllImport(Program.LIBMRUBY, EntryPoint=<span class="meta-string">"mrb_define_module"</span>)</span>] <span class="function"><span class="keyword">static</span> <span class="keyword">extern</span> IntPtr <span class="title">MrbDefineModule</span>(<span class="params">IntPtr state, <span class="keyword">string</span> name</span>)</span>;</div><div class="line">truetrue<span class="function"><span class="keyword">public</span> <span class="title">Module</span> (<span class="params">IntPtr state, <span class="keyword">string</span> name</span>)</span></div><div class="line">truetrue&#123;</div><div class="line">truetruetrue<span class="keyword">this</span>.state = state;</div><div class="line">truetruetrueklass = MrbDefineModule(state, name);</div><div class="line">truetrue&#125;</div><div class="line">    </div><div class="line">    [<span class="meta">DllImport(Program.LIBMRUBY, EntryPoint=<span class="meta-string">"mrb_define_module_function"</span>)</span>] <span class="function"><span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">MrbDefineMethod</span>(<span class="params">IntPtr state, IntPtr klass, <span class="keyword">string</span> name, Func func, Args aspec</span>)</span>;</div><div class="line">truetrue<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DefineMethod</span>(<span class="params"><span class="keyword">string</span> name, Func receiver, Args aspec</span>)</span></div><div class="line">truetrue&#123;</div><div class="line">truetruetrueMrbDefineMethod (state, klass, name, receiver, aspec);</div><div class="line">truetrue&#125;</div><div class="line">true&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 MRuby 中，會使用 Function Pointer 的方式儲存方法，若要在 C# 中實做一個 Function Pointer 可以利用 <code>delegate</code> 來實做，要說的話概念上是類似的東西。<br>（參考資料：<a href="http://www.cnblogs.com/oomusou/archive/2007/05/02/734290.html" target="_blank" rel="noopener">http://www.cnblogs.com/oomusou/archive/2007/05/02/734290.html</a>）</p>
<p>使用 <code>delegate</code> 功能需要指定方法的傳回值、接收的參數。不過在 MRuby 中都是固定傳回 <code>MrbValue</code> 並且把 <code>MrbState</code> 以及代表該物件實體的 <code>MrbValue</code> 存取進來。（到這邊應該很習慣了，不管是什麼數值都可以用 <code>MrbValue</code> 儲存）</p>
<h4 id="MRuby-的方法呼叫"><a href="#MRuby-的方法呼叫" class="headerlink" title="MRuby 的方法呼叫"></a>MRuby 的方法呼叫</h4><p>到此，我們可以定義 MRuby 的方法，那麼前面提到在 C# 中只能存取 <code>MrbValue</code> 的問題又是為什麼呢？</p>
<p>這就要談起 MRuby 的 <code>mrb_get_args</code> (<a href="https://github.com/mruby/mruby/blob/master/src/class.c#L441" target="_blank" rel="noopener">https://Github.com/mRuby/mruby/blob/master/src/class.c#L441</a>) 這個方法，可以透過傳入 <code>MrbState</code> 以及 Format（參數格式）來存取資料。</p>
<p>從原始碼的定義來看，會發現它是一個接受「不定長度參數」的方法。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mrb_get_args(mrb_state *mrb, <span class="keyword">const</span> <span class="keyword">char</span> *format, ...)</div></pre></td></tr></table></figure>
<p>也就是說，用法類似於 <code>mrb_get_args(state, &quot;ii&quot;, &amp;intValue1, &amp;intValue2)</code> 這樣子。</p>
<p>在 C# 中，要實作不定長度的參數，除了可以用 <code>params</code> 關鍵字，但是卻只能接受「單一型別」的陣列，不過從原始碼中的 Format Table 來看，情況似乎不是這麼簡單。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">  retrieve arguments from mrb_state.</div><div class="line"></div><div class="line">  mrb_get_args(mrb, format, ...)</div><div class="line"></div><div class="line">  returns number of arguments parsed.</div><div class="line"></div><div class="line">  format specifiers:</div><div class="line"></div><div class="line">    string  mRuby type     C type                 note</div><div class="line">    ----------------------------------------------------------------------------------------------</div><div class="line">    o:      Object         [mrb_value]</div><div class="line">    C:      class/module   [mrb_value]</div><div class="line">    S:      String         [mrb_value]</div><div class="line">    A:      Array          [mrb_value]</div><div class="line">    H:      Hash           [mrb_value]</div><div class="line">    s:      String         [char*,mrb_int]        Receive two arguments.</div><div class="line">    z:      String         [char*]                NUL terminated string.</div><div class="line">    a:      Array          [mrb_value*,mrb_int]   Receive two arguments.</div><div class="line">    f:      Float          [mrb_float]</div><div class="line">    i:      Integer        [mrb_int]</div><div class="line">    b:      Boolean        [mrb_bool]</div><div class="line">    n:      Symbol         [mrb_sym]</div><div class="line">    d:      Data           [void*,mrb_data_type const] 2nd argument will be used to check data type so it won't be modified</div><div class="line">    &amp;:      Block          [mrb_value]</div><div class="line">    *:      rest argument  [mrb_value*,mrb_int]   Receive the rest of the arguments as an array.</div><div class="line">    |:      optional                              Next argument of '|' and later are optional.</div><div class="line">    ?:      optional given [mrb_bool]             true if preceding argument (optional) is given.</div><div class="line"> */</div></pre></td></tr></table></figure>
<p>如果指定的是 <code>i</code> 那麼拿到的會是一個 <code>mrb_int</code> 的型別，而且對我們的 C# 來說是一個未知型別。而使用 <code>params</code> 參數的話，這也會讓我們無法正確的接收數值。</p>
<p>不過，在 C# 提供了一個叫做 <code>__arglist</code> 的做法，也很幸運的這個方法就如同 C 語言的 <code>...</code> 用法，不過在 Mono 中，因為實作困難並沒有被完整、正確的支援。</p>
<p>也就是做，我們需要用一點小技巧來存取 MRuby 的參數。<br>（這個方法是從 <a href="https://Github.com/mitchellh/go-mruby" target="_blank" rel="noopener">go-mRuby</a> 所學的，就是單純的用 <code>*&amp;</code> 這個 Format 來讀取參數，並且自行處理需要的部分。）</p>
<h4 id="實作-GetArgs-Helper"><a href="#實作-GetArgs-Helper" class="headerlink" title="實作 GetArgs Helper"></a>實作 GetArgs Helper</h4><p>因為目前只有 Module Class 會用到，所以就直接在 Module Class 裏面實作，實際上應該放在外面會更好些。</p>
<figure class="highlight cs"><figcaption><span>Module.cs</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">MRuby</span></div><div class="line">&#123;</div><div class="line">true<span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Module</span></div><div class="line">true&#123;</div><div class="line">truetrue<span class="comment">// 略</span></div><div class="line">    [<span class="meta">DllImport(RubyContext.LIBMRUBY, EntryPoint=<span class="meta-string">"mrb_get_args"</span>)</span>] <span class="function"><span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">MrbGetArguments</span>(<span class="params">IntPtr state, <span class="keyword">string</span> format, <span class="keyword">out</span> IntPtr argv, <span class="keyword">out</span> <span class="keyword">int</span> argc, <span class="keyword">out</span> MrbValue block</span>)</span>;</div><div class="line">truetrue<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Value[] <span class="title">GetArgs</span>(<span class="params">IntPtr state, <span class="keyword">bool</span> withBlock = <span class="literal">false</span></span>)</span></div><div class="line">truetrue&#123;</div><div class="line">truetruetrueValue[] values;</div><div class="line">truetruetrueIntPtr argvPointer;</div><div class="line">truetruetrueMrbValue <span class="keyword">value</span>;</div><div class="line">truetruetrue<span class="keyword">int</span> i, argc, size;</div><div class="line">truetruetrueMrbValue block;</div><div class="line"></div><div class="line">truetruetrueMrbGetArguments (state, <span class="string">"*&amp;"</span>, <span class="keyword">out</span> argvPointer, <span class="keyword">out</span> argc, <span class="keyword">out</span> block);</div><div class="line"></div><div class="line">truetruetrue<span class="keyword">int</span> valueCount = argc;</div><div class="line">truetruetrue<span class="keyword">if</span>(withBlock) &#123; valueCount++; &#125;</div><div class="line"></div><div class="line">truetruetruevalues = <span class="keyword">new</span> Value[valueCount]; <span class="comment">// Include Block</span></div><div class="line">truetruetruesize = Marshal.SizeOf (<span class="keyword">typeof</span>(MrbValue));</div><div class="line">truetruetrue<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; argc; i++) &#123;</div><div class="line">truetruetruetrue<span class="keyword">value</span> = (MrbValue) Marshal.PtrToStructure (argvPointer + (i * size), <span class="keyword">typeof</span>(MrbValue));</div><div class="line">truetruetruetruevalues [i] = <span class="keyword">new</span> Value (state, <span class="keyword">value</span>);</div><div class="line">truetruetrue&#125;</div><div class="line"></div><div class="line">truetruetrue<span class="keyword">if</span> (withBlock) &#123;</div><div class="line">truetruetruetruevalues [argc] = <span class="keyword">new</span> Value (state, block);</div><div class="line">truetruetrue&#125;</div><div class="line"></div><div class="line">truetruetrue<span class="keyword">return</span> values;</div><div class="line">truetrue&#125;</div><div class="line">true&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如此一來，就可以非常確定要使用的參數數目，並且可以正常的存取。</p>
<p>比較特別一點的就是 Ruby 的 Code Block 特性，所以會使用 <code>&amp;</code> 來把這個 Blog 一起存出來，但是是否要使用又是另外一回事。</p>
<p>其中在存取的時候，會看到 <code>out</code> 這個修飾詞，基本上跟 <code>params</code> 和 <code>ref</code> 是經常被放在一起討論了。<br>在 C 語言中，其實就很單純的是 <code>&amp;value</code> 這樣的做法（主要是在 C# 因為在非 Unsafe 模式是不允許這種記憶體操作，所以用這個方式代替。）</p>
<p><code>out</code> 和 <code>ref</code> 的差別在於，使用 <code>out</code> 不需要初始化變數，他會在被使用的時候自動處理。但是 <code>ref</code> 就不同了，他需要先用 <code>int value = 1;</code> 的方式做過初始化，才能夠正常使用（不然會發生錯誤）</p>
<blockquote>
<p>參數只會給第一個參數的指標，所以需要用迴圈把一整個記憶體區段掃過一遍取出每一個變數。</p>
</blockquote>
<p>另一方面，為了讓 <code>MrbValue</code> 可以更簡單的在 C# 中使用，所以我對他做了一些封裝讓他可以自動轉型成 C# 原生的型別。<br>（<code>Value</code> 結構，裡面時做的是 <code>MrbValue</code> 的一些自動轉型）</p>
<p>原始碼如下：<br><figure class="highlight cs"><figcaption><span>Value.cs</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> System;</div><div class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">OpenTKGame.Ruby</span></div><div class="line">&#123;</div><div class="line">true<span class="comment">/**</span></div><div class="line">true *  MrbValue Wrapper</div><div class="line">true * </div><div class="line">true *  Create Helper to convert MrbValue to C# value types</div><div class="line">true */</div><div class="line">true<span class="keyword">public</span> <span class="keyword">struct</span> Value</div><div class="line">true&#123;</div><div class="line">truetrue<span class="keyword">public</span> IntPtr state;</div><div class="line">truetrue<span class="keyword">public</span> MrbValue <span class="keyword">value</span>;</div><div class="line"></div><div class="line">truetrue<span class="function"><span class="keyword">public</span> <span class="title">Value</span>(<span class="params">IntPtr state, MrbValue <span class="keyword">value</span></span>)</span></div><div class="line">truetrue&#123;</div><div class="line">truetruetrue<span class="keyword">this</span>.state = state;</div><div class="line">truetruetrue<span class="keyword">this</span>.<span class="keyword">value</span> = <span class="keyword">value</span>;</div><div class="line">truetrue&#125;</div><div class="line"></div><div class="line">truetrue[<span class="meta">DllImportAttribute(RubyContext.LIBMRUBY, EntryPoint=<span class="meta-string">"mrb_obj_as_string"</span>)</span>] <span class="function"><span class="keyword">static</span> <span class="keyword">extern</span> MrbValue <span class="title">MrbObjectToString</span>(<span class="params">IntPtr state, MrbValue obj</span>)</span>;</div><div class="line">truetrue[<span class="meta">DllImportAttribute(RubyContext.LIBMRUBY, EntryPoint=<span class="meta-string">"mrb_string_value_ptr"</span>)</span>] <span class="function"><span class="keyword">static</span> <span class="keyword">extern</span> IntPtr <span class="title">MrbStringPointer</span>(<span class="params">IntPtr state, MrbValue obj</span>)</span>;</div><div class="line">truetrue<span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">string</span> <span class="title">ToString</span>(<span class="params"></span>)</span></div><div class="line">truetrue&#123;</div><div class="line">truetruetrueIntPtr stringPtr = IntPtr.Zero;</div><div class="line"></div><div class="line">truetruetrue<span class="keyword">if</span> (<span class="keyword">value</span>.type == Type.MRB_STRING) &#123;</div><div class="line">truetruetruetruestringPtr = MrbStringPointer (state, <span class="keyword">value</span>);</div><div class="line">truetruetrue&#125; <span class="keyword">else</span> &#123;</div><div class="line">truetruetruetruestringPtr = MrbStringPointer(state, MrbObjectToString(state, <span class="keyword">value</span>));</div><div class="line">truetruetrue&#125;</div><div class="line">truetruetrue<span class="keyword">return</span> Marshal.PtrToStringAuto (stringPtr);</div><div class="line">truetrue&#125;</div><div class="line">truetruetrue</div><div class="line">truetrue<span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">implicit</span> <span class="keyword">operator</span> <span class="title">string</span> (<span class="params">Value <span class="keyword">value</span></span>)</span></div><div class="line">truetrue&#123;</div><div class="line">truetruetrueIntPtr stringPtr = IntPtr.Zero;</div><div class="line"></div><div class="line">truetruetrue<span class="keyword">if</span> (<span class="keyword">value</span>.<span class="keyword">value</span>.type == Type.MRB_STRING) &#123;</div><div class="line">truetruetruetruestringPtr = MrbStringPointer (<span class="keyword">value</span>.state, <span class="keyword">value</span>.<span class="keyword">value</span>);</div><div class="line">truetruetrue&#125; <span class="keyword">else</span> &#123;</div><div class="line">truetruetruetruestringPtr = MrbStringPointer(<span class="keyword">value</span>.state, MrbObjectToString(<span class="keyword">value</span>.state, <span class="keyword">value</span>.<span class="keyword">value</span>));</div><div class="line">truetruetrue&#125;</div><div class="line">truetruetrue<span class="keyword">return</span> Marshal.PtrToStringAuto (stringPtr);</div><div class="line">truetrue&#125;</div><div class="line"></div><div class="line">truetrue<span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">implicit</span> <span class="keyword">operator</span> <span class="title">int</span>(<span class="params">Value <span class="keyword">value</span></span>)</span></div><div class="line">truetrue&#123;</div><div class="line">truetruetrue<span class="keyword">if</span> (<span class="keyword">value</span>.<span class="keyword">value</span>.type == Type.MRB_FIXNUM) &#123;</div><div class="line">truetruetruetrue<span class="keyword">return</span> <span class="keyword">value</span>.<span class="keyword">value</span>.<span class="keyword">value</span>.i;</div><div class="line">truetruetrue&#125;</div><div class="line">truetruetrue<span class="keyword">if</span> (<span class="keyword">value</span>.<span class="keyword">value</span>.type == Type.MRB_FLOAT) &#123;</div><div class="line">truetruetruetrue<span class="keyword">return</span> (<span class="keyword">int</span>)<span class="keyword">value</span>.<span class="keyword">value</span>.<span class="keyword">value</span>.f;</div><div class="line">truetruetrue&#125;</div><div class="line">truetruetrue<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">truetrue&#125;</div><div class="line"></div><div class="line">truetrue<span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">implicit</span> <span class="keyword">operator</span> <span class="title">double</span>(<span class="params">Value <span class="keyword">value</span></span>)</span></div><div class="line">truetrue&#123;</div><div class="line">truetruetrue<span class="keyword">if</span> (<span class="keyword">value</span>.<span class="keyword">value</span>.type == Type.MRB_FLOAT) &#123;</div><div class="line">truetruetruetrue<span class="keyword">return</span> <span class="keyword">value</span>.<span class="keyword">value</span>.<span class="keyword">value</span>.f;</div><div class="line">truetruetrue&#125; </div><div class="line">truetruetrue<span class="keyword">if</span> (<span class="keyword">value</span>.<span class="keyword">value</span>.type == Type.MRB_FIXNUM) &#123;</div><div class="line">truetruetruetrue<span class="keyword">return</span> (<span class="keyword">double</span>)<span class="keyword">value</span>.<span class="keyword">value</span>.<span class="keyword">value</span>.i;</div><div class="line">truetruetrue&#125;</div><div class="line">truetruetrue<span class="keyword">return</span> <span class="number">0</span>f;</div><div class="line">truetrue&#125;</div><div class="line"></div><div class="line">truetrue<span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">implicit</span> <span class="keyword">operator</span> <span class="title">bool</span>(<span class="params">Value <span class="keyword">value</span></span>)</span></div><div class="line">truetrue&#123;</div><div class="line">truetruetrue<span class="keyword">switch</span> (<span class="keyword">value</span>.<span class="keyword">value</span>.type) &#123;</div><div class="line">truetruetrue<span class="keyword">case</span> Type.MRB_FALSE:</div><div class="line">truetruetrue<span class="keyword">case</span> Type.MRB_EXCEPTION:</div><div class="line">truetruetrue<span class="keyword">case</span> Type.MRB_UNDEF:</div><div class="line">truetruetruetrue<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">truetruetrue&#125;</div><div class="line">truetruetrue<span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">truetrue&#125;</div><div class="line">true&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我實作了像是 <code>string</code> 還有 <code>int</code> <code>double</code> <code>bool</code> 等常用型別。<br>（不過 <code>ToString</code> 和 <code>string</code> 似乎只需要其中一個就可以了⋯⋯）</p>
<h4 id="實作自定-Module-和-Method"><a href="#實作自定-Module-和-Method" class="headerlink" title="實作自定 Module 和 Method"></a>實作自定 Module 和 Method</h4><p>先實作一個在 Ruby 可以被呼叫的方法。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MrbValue <span class="title">ConsoleWrite</span>(<span class="params">IntPtr state, MrbValue self</span>)</span></div><div class="line">&#123;</div><div class="line">true<span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">trueValue[] values = Module.GetArgs (state, <span class="literal">false</span>);</div><div class="line"></div><div class="line">true<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; values.Length; i++) &#123;</div><div class="line">  	Console.WriteLine (<span class="string">"Receive Params: &#123;0&#125;"</span>, values[i].ToString());</div><div class="line">true&#125;</div><div class="line">      </div><div class="line">true<span class="keyword">return</span> values[<span class="number">0</span>].<span class="keyword">value</span>; <span class="comment">// Simple return first value</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接著定義模組。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Value <span class="keyword">value</span>;</div><div class="line">RubyContext context = <span class="keyword">new</span> Ruby.RubyContext ();</div><div class="line"></div><div class="line"><span class="comment">// Define Module and Method</span></div><div class="line">Module module = context.DefineModule (<span class="string">"Example"</span>);</div><div class="line">module.DefineMethod (<span class="string">"args"</span>, ConsoleWrite, Args.ANY());</div><div class="line">      </div><div class="line"><span class="comment">// Run Ruby code</span></div><div class="line">context.LoadString (<span class="string">"Example.args(1, 'hello', 'world')"</span>)</div></pre></td></tr></table></figure>
<p>這樣一來，就可以看到剛剛的成果了～</p>
<blockquote>
<p>前面忘記提到 context 的 DefineModule 實作，其實就是做了 <code>new Module(state, name)</code> 這件事情而已。</p>
</blockquote>
<hr>
<p>最近已經開學了，而且還在做畢業製作。我想能夠花心思在這個部分上面的時間會越來越少，下一階段我會更加完善這個架構，必且開始正是的專案（我會放在 Githu 上面，初期目標是像 KrKr 那類 AVG 系統一樣單可用）</p>
<p>之後暫定的 Roadmap：</p>
<ul>
<li><code>rb</code> to <code>mrb</code> 的封裝</li>
<li>OpenGL 的實作（Based on OpenTK）</li>
<li>更完整的 MRuby Library for C#</li>
<li>完善專案建構（大概會要把好幾個專案組合才能順利開發完整的系統吧 XD）</li>
<li>簡易的 AVG 功能</li>
</ul>
<blockquote>
<p>這系列文章因為評估 Mono 的搭配過於複雜，因此停止更新、研究</p>
</blockquote>

    
    <footer class="article__footer">
      
        <div class="text-center">
          <div class="fb-share-button"
               data-href="https://blog.frost.tw/posts/2014/09/28/mruby-in-csharp-the-tragedy-of-rpg-maker-2/"
               data-layout="button_count">
          </div>
        </div>
        <p align="center">
          <a href='https://ko-fi.com/J3J78093' target='_blank'>
            <img height='36' style='border:0px;height:36px;' src='https://az743702.vo.msecnd.net/cdn/kofi5.png?v=0' border='0' alt='Buy Me a Coffee at ko-fi.com' />
          </a>
        </p>
        <iframe scrolling="no" frameborder="0" style="display: block; margin: 0 auto; height: 212px;" src="https://button.like.co/in/embed/elct9620/button?referrer=https://blog.frost.tw/posts/2014/09/28/mruby-in-csharp-the-tragedy-of-rpg-maker-2/"></iframe>
        
          <ul class="article__tag-list"><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/C/">C#</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/Ruby/">Ruby</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/心得/">心得</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/筆記/">筆記</a></li></ul>
        
      
    </footer>
  </div>
</article>


  
    <div class="adv">
      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      <!-- 網誌_文末廣告 (Hexo) -->
      <ins class="adsbygoogle"
      style="display:block"
      data-ad-client="ca-pub-2844969736316510"
      data-ad-slot="5530952976"
      data-ad-format="auto"></ins>
      <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
  

  
<section id="comment" class="comment-box">
  <h1 class="comment-box__title">留言</h1>

  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></noscript>
  </div>
</section>






    </div>
    <footer id="footer">
      <div id="copyright">
  &copy;2013 <a href="https://plus.google.com/117236344655673213049?rel=author" target="_blank">蒼時弦也</a>. All right reversed.
</div>

    </footer>
    

  
  <script type="text/javascript">
  var disqus_shortname = 'revo-skill-frost';

  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }());
  </script>
  

  
  <!-- Google Tag Manager -->
  <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5TQLRN"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-5TQLRN');</script>
  <!-- End Google Tag Manager -->
  

  <script>
    window.fbAsyncInit = function() {
      FB.init({
        appId      : '178355449110',
        xfbml      : true,
        version    : 'v2.12'
      });

      FB.AppEvents.logPageView();

    };

    (function(d, s, id){
       var js, fjs = d.getElementsByTagName(s)[0];
       if (d.getElementById(id)) {return;}
       js = d.createElement(s); js.id = id;
       js.src = "https://connect.facebook.net/zh_TW/sdk.js";
       fjs.parentNode.insertBefore(js, fjs);
     }(document, 'script', 'facebook-jssdk'));
  </script>

  <script src="/js/app.js"></script>


    <div class="loading"></div>
  </body>
</html>
