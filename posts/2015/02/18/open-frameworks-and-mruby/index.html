<!DOCTYPE html><html lang="zh-TW"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><title>Open Frameworks 與 MRuby | 弦而時習之</title><meta name="theme-color" content="#EFEFEF"><meta name="author" content="蒼時弦也"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="蒼時弦也的個人網誌，專注在前端、後端以及遊戲開發，大多使用 Ruby 和 Ruby on Rails 以及 Golang、JS 和 C 語言。"><meta name="keywords" content="心得,筆記,MRuby,C++,OpenFrameworks"><meta property="og:type" content="article"><meta property="og:title" content="Open Frameworks 與 MRuby"><meta property="og:url" content="https://blog.frost.tw/posts/2015/02/18/open-frameworks-and-mruby/"><meta property="og:site_name" content="弦而時習之"><meta property="og:description" content="蒼時弦也的個人網誌，專注在前端、後端以及遊戲開發，大多使用 Ruby 和 Ruby on Rails 以及 Golang、JS 和 C 語言。"><meta property="og:locale" content="zh-TW"><meta property="og:image" content="https://user-image.logdown.io/user/52/blog/52/post/255651/B3wRMPrVSoqEcOuFq9ug_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202015-02-18%20%E4%B8%8B%E5%8D%887.26.02.png"><meta property="og:updated_time" content="2019-06-25T10:37:30.967Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Open Frameworks 與 MRuby"><meta name="twitter:description" content="蒼時弦也的個人網誌，專注在前端、後端以及遊戲開發，大多使用 Ruby 和 Ruby on Rails 以及 Golang、JS 和 C 語言。"><meta name="twitter:image" content="https://user-image.logdown.io/user/52/blog/52/post/255651/B3wRMPrVSoqEcOuFq9ug_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202015-02-18%20%E4%B8%8B%E5%8D%887.26.02.png"><link rel="publisher" href="https://plus.google.com/117236344655673213049"><meta property="fb:app_id" content="178355449110"><meta property="fb:pages" content="180666522388"><script type="application/ld+json">[
{
    "@context": "http://schema.org",
    "@type": "Blog",
    "name": "弦而時習之",
    "url": "https://blog.frost.tw",
    "image": "http://blog.frost.tw/icon-512.png",
    "description": "蒼時弦也的個人網誌，專注在前端、後端以及遊戲開發，大多使用 Ruby 和 Ruby on Rails 以及 Golang、JS 和 C 語言。",
    "sameAs": [
      "https://www.facebook.com/frost.tw/"
    ]
},
{
    "@context": "http://schema.org",
    "@type": "Person",
    "name": "蒼時弦也",
    "url": "https://blog.frost.tw",
    "sameAs": [
      "https://www.facebook.com/elct9620",
      "https://www.instagram.com/elct9620/",
      "https://twitter.com/elct9620",
      "https://plus.google.com/+%E8%92%BC%E6%99%82%E5%BC%A6%E4%B9%9F-plus",
      "https://www.linkedin.com/in/elct9620"
    ]
},
{
  "@context":"http://schema.org",
  "@type":"BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.frost.tw/posts/2015/02/18/open-frameworks-and-mruby/"
  },
  "headline":"Open Frameworks 與 MRuby",
  "image": [
    
    "https://user-image.logdown.io/user/52/blog/52/post/255651/B3wRMPrVSoqEcOuFq9ug_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202015-02-18%20%E4%B8%8B%E5%8D%887.26.02.png",
    
    "http://blog.frost.tw/icon-512.png"
  ],
  "thumbnailUrl": "https://user-image.logdown.io/user/52/blog/52/post/255651/B3wRMPrVSoqEcOuFq9ug_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202015-02-18%20%E4%B8%8B%E5%8D%887.26.02.png", 
  "datePublished": "2015-02-18T03:15:00.000Z",
  "dateModified": "2019-06-25T10:37:30.967Z",
  "description":"自從畢製開始與同學開發遊戲後，我就開始喜歡嘗試運用一些工具如 HTML5、Mono、Processing 等來製作一些屬於自己的「遊戲框架」自從上次嘗試使用 Mono 與 MRuby 結合後，這次在與朋友的閒聊中回想起了 Open Frameworks 這套工具。Open Frameworks 基本上被稱為是 C++ 版本的 Processing 就各方面來說比 Processing 改進不少，至少就我這幾天的體驗來看，以我目前的實力已經可以純熟運用了！過去曾有一段時間嘗試玩過，但是因為沒有 Project Generator 輔助建構專案，再加上與 C++ 其實不是那麼的熟悉，因而放棄。這次透過 Unreal Engine 的經驗，以及上次 MRuby 的整合讓我順利的開始使用 Open Frameworks。這篇文章主要會分享我使用 Open Frameworks 開啟一個 Ruby 檔案，並且執行裡面的方法在介面中繪製圖像的做法。目前我認為這個方法其實還不太完善，不過作為初次的嘗試可以算是一個不錯的成果。",
  "author": {
    "@type": "Person",
    "name": "蒼時弦也"
  },
  "publisher": {
    "@type": "Organization",
    "name": "蒼時弦也",
    "logo": {
      "@type": "ImageObject",
      "url": "http://blog.forst.tw/logo-wide.png"
    }
  }
},
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
    "@type": "ListItem",
    "position": 1,
    "item": {
      "@id": "https://blog.frost.tw",
      "name": "弦而時習之 ",
      "image": "http://blog.frost.tw/icon-512.png"
    }
  },{
    "@type": "ListItem",
    "position": 2,
    "item": {
      "@id": "https://blog.frost.tw/posts/2015/02/18/open-frameworks-and-mruby/",
      "name": "Open Frameworks 與 MRuby",
      "image": "https://user-image.logdown.io/user/52/blog/52/post/255651/B3wRMPrVSoqEcOuFq9ug_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202015-02-18%20%E4%B8%8B%E5%8D%887.26.02.png"
    }
  }]
}

]</script><link rel="canonical" href="https://blog.frost.tw/posts/2015/02/18/open-frameworks-and-mruby/"><link href="/icon-512.png" rel="icon"><link rel="alternate" href="/feed.xml" title="弦而時習之" type="application/rss+xml"><!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--><link rel="stylesheet" href="/css/style.css" media="screen" type="text/css"><script async src="/js/turbolinks.js"></script></head><body><div id="fb-root" data-turbolinks-permanent></div><header id="header"><h1 id="sitename"><a href="/" class="hide-text logo--icon align-center">弦而時習之</a></h1><aside id="slogan" class="slogan align-center text-center"><h2 class="slogan__title">Aotokitsuruya</h2><p class="slogan__description">The Web is attracting me, so I start learning PHP, HTML, CSS and JavaScript. When I know about Ruby, I fall in love with it. Now, I working with my friend to design games using C++ and still learning web about Golang, Ruby and JavaScript. In the other side, I also be a designer, the reason why the web is attracted me.</p></aside></header><div id="wrapper"><article class="post article"><header class="article__header"><time datetime="2015-02-18T03:15:00.000Z" class="article__time--header">Feb.18</time><h1 class="article__title">Open Frameworks 與 MRuby</h1></header><div class="article__entry"><p>自從畢製開始與同學開發遊戲後，我就開始喜歡嘗試運用一些工具如 HTML5、Mono、Processing 等來製作一些屬於自己的「遊戲框架」</p><p>自從上次嘗試使用 Mono 與 MRuby 結合後，這次在與朋友的閒聊中回想起了 Open Frameworks 這套工具。<br>Open Frameworks 基本上被稱為是 C++ 版本的 Processing 就各方面來說比 Processing 改進不少，至少就我這幾天的體驗來看，以我目前的實力已經可以純熟運用了！</p><blockquote><p>過去曾有一段時間嘗試玩過，但是因為沒有 Project Generator 輔助建構專案，再加上與 C++ 其實不是那麼的熟悉，因而放棄。這次透過 Unreal Engine 的經驗，以及上次 MRuby 的整合讓我順利的開始使用 Open Frameworks。</p></blockquote><p>這篇文章主要會分享我使用 Open Frameworks 開啟一個 Ruby 檔案，並且執行裡面的方法在介面中繪製圖像的做法。<br>目前我認為這個方法其實還不太完善，不過作為初次的嘗試可以算是一個不錯的成果。</p><a id="more"></a><p>首先，要使用 MRuby 必須先有 MRuby 才行，關於這部分請直接參考「<a href="https://blog.frost.tw/posts/2014/09/04/mruby-in-csharp-the-tragedy-of-rpg-maker-1/">MRuby in C# 因 RPG Maker的慘劇（一）</a>」這篇文章，裡面會詳細說明建構 Static Library 的方法。</p><blockquote><p>Open Frameworks 目前建置出來的是 32bit 的版本，因此跟 Mono 的情境一樣需要開啟 32bit 的編譯選項</p></blockquote><h3 id="配置-XCode-專案"><a href="#配置-XCode-專案" class="headerlink" title="配置 XCode 專案"></a>配置 XCode 專案</h3><p>在 Open Frameworks 0.8 之後已經支援 Retina 顯示，關於這部分可以直接 Google 相關資料就不多做解釋了（作法也很簡單，在 .plist 加入選項即可，雖然整體使用上還不夠理想⋯⋯）</p><p>為了要使用 MRuby 的套件，我們需要在專案面板中手動加入函式庫。</p><p><img src="https://user-image.logdown.io/user/52/blog/52/post/255651/B3wRMPrVSoqEcOuFq9ug_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202015-02-18%20%E4%B8%8B%E5%8D%887.26.02.png" alt="螢幕快照 2015-02-18 下午7.26.02.png"></p><p>做法不難，在 Linked Frameworks and Libraries 新增剛剛編譯好的 <code>libmRuby.a</code> 跟 <code>libmruby_core.a</code> 即可。</p><blockquote><p>libmRuby_core.a 是選用的，裡面實作了一些 Ruby 基本的功能建議加入（不然只會拿到幾乎是什麼都沒有的 Ruby 環境）</p></blockquote><p>另一方面我們需要增加 Header 的設置。</p><p><img src="https://user-image.logdown.io/user/52/blog/52/post/255651/F4WuHoSSou9LuXvCYfZr_%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%202015-02-18%20%E4%B8%8B%E5%8D%887.29.11.png" alt="螢幕快照 2015-02-18 下午7.29.11.png"></p><p>在 Build Settings 的 Tab 裡面找到「Header Search Path」並且加入即可。</p><blockquote><p>也許會找不到，可以把左上角的「Basic」換成「All」就能看到了！</p></blockquote><blockquote><p>裡面的路徑我寫了 $(HEADER_MRUBY) 是因為 Open Frameworks 有一個 xcconfig 的設定檔，基於實驗精神我做了測試，這邊可以直接寫上路徑（相對、絕對路徑都可以）</p></blockquote><p>這樣基本上就配置好了開發環境，不過我想是有更乾淨的配置方式。<br>不過基於我使用 XCode 也不過幾個月，這也是第一次用 XCode 引用外部的函式庫，就先這樣解決吧！</p><h3 id="MRuby-運行環境"><a href="#MRuby-運行環境" class="headerlink" title="MRuby 運行環境"></a>MRuby 運行環境</h3><p>在 MRuby 的 API 中我們可以透過 <code>mrb_open()</code> 以及 <code>mrb_close()</code> 來開啟跟關閉一個 <code>mrb_state</code> （也許稱作 context 會更好）總之，我們可以產生多個運行的環境，為了方便起見包裝成一個 Class 來呼叫。</p><figure class="highlight cpp"><figcaption><span>Ruby.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mRuby.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mRuby/compile.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 string.h 是因為 Open Framrworks 大部份都是傳回 string 而非 const char *</span></span><br><span class="line"><span class="comment">// 我們會需要使用 mRuby/compile.h 裡面含有從檔案讀取等處理，若要直接執行 .rb 檔案則需要引用</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ruby</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  Ruby();</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">load_file</span><span class="params">(<span class="built_in">string</span> fileName)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">call</span><span class="params">(<span class="built_in">string</span> methodName)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  mrb_state* mrb;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><figcaption><span>Ruby.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"Ruby.h"</span></span></span><br><span class="line"></span><br><span class="line">Ruby::Ruby() &#123;</span><br><span class="line">  mrb = mrb_open();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 這邊之後會加入 ofImage 的 Binding 程式</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Ruby::close() &#123;</span><br><span class="line">  mrb_close(mrb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Ruby::load_file(<span class="built_in">string</span> fileName) &#123;</span><br><span class="line">  FILE* file = fopen(fileName.c_str(), <span class="string">"r"</span>);</span><br><span class="line">  mrb_load_file(mrb, file); <span class="comment">// 實際上回傳回 mrb_value 不過我們不需要</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  if(mrb-&gt;exc) &#123;</span></span><br><span class="line"><span class="comment">   // 如果發生錯誤（Error）可以在這邊做對應處理，因為這個範例功能簡單所以就不多做討論</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  fclose(mrb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Ruby::call(<span class="built_in">string</span> methodName) &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    mrb_funcall() 的 API 如下</span></span><br><span class="line"><span class="comment">    mrb_state* -&gt; 運行的 Ruby Context</span></span><br><span class="line"><span class="comment">    RClass* -&gt; 呼叫方法的物件，使用 mrb_top_self(mrb) 可以直接呼叫非物件的方法（這與 Ruby 語言設計有關）</span></span><br><span class="line"><span class="comment">    const char * -&gt; 呼叫的方法</span></span><br><span class="line"><span class="comment">    int -&gt; 方法的參數</span></span><br><span class="line"><span class="comment">    * -&gt; 一次傳入各種 Ruby 參數（由前面的參數決定傳入數）</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  mrb_funcall(mrb, mrb_top_self(mrb), methodName.c_str(), <span class="number">0</span>); <span class="comment">// 因為只要單純的呼叫，所以不多處理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如此一來，我們就可以利用類似下面的程式碼來執行某個 Ruby 檔案：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Ruby* Ruby = new Ruby;</span><br><span class="line">Ruby-&gt;load_file(&quot;app.rb&quot;);</span><br><span class="line">Ruby-&gt;call(&quot;hello_world&quot;);</span><br><span class="line">Ruby-&gt;close();</span><br></pre></td></tr></table></figure><h3 id="ofImage-的-Binding"><a href="#ofImage-的-Binding" class="headerlink" title="ofImage 的 Binding"></a>ofImage 的 Binding</h3><p>我的目標只有兩個，所以後續的實作也會基於這兩個實作：</p><ol><li>讀取圖片</li><li>繪製在畫面上的某個位置</li></ol><figure class="highlight cpp"><figcaption><span>Ruby/Image.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ofMain.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mRuby.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mRuby/string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mRuby/data.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mRuby/class.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> Ruby &#123;</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Image</span> &#123;</span></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">(mrb_state* mrb)</span></span>;</span><br><span class="line">  <span class="keyword">protected</span>:</span><br><span class="line">    <span class="comment">// MRuby 的 Method 都是傳回 mrb_value 並且接收 mrb_state 與 mrb_value （物件本身） 作為參數</span></span><br><span class="line">    <span class="comment">// 這邊實作 initialize() 方法是因為我們的物件需要儲存 ofImage 的參照讓我們可以在同一個物件實例中對其操作</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> struct mrb_value <span class="title">initialize</span><span class="params">(mrb_state* mrb, mrb_value self)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> struct mrb_value <span class="title">loadImage</span><span class="params">(mrb_state* mrb, mrb_value self)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> struct mrb_value <span class="title">drawImage</span><span class="params">(mrb_state* mrb, mrb_value self)</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>這個檔案會是目前最多程式碼的部分，裡面有一些其實應該移出來放到新的檔案。<br>不過為了撰寫方便，所以寫在這個檔案中。</p><figure class="highlight cpp"><figcaption><span>Ruby/Image.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"Image.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Ruby;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定義 Image Class 的資料結構</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mrb_of_image</span> &#123;</span></span><br><span class="line">  ofImage* instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定義釋放記憶體的方法</span></span><br><span class="line"><span class="comment">// 因為後面會使用 malloc 產生 mrb_of_image 這筆資料，而 Ruby 本身也有 GC （垃圾回收）的機制</span></span><br><span class="line"><span class="comment">// 因此推測是用於 GC 時能夠順利清除這筆記憶體</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mrb_of_image_free</span><span class="params">(mrb_state* mrb, <span class="keyword">void</span> *ptr)</span> </span>&#123;</span><br><span class="line">  mrb_free(mrb, ptr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定義配置記憶體的方法</span></span><br><span class="line"><span class="comment">// 因為如果直接在某個方法中儲存 ofImage 參照會被清除，因此使用 malloc 保持（而回收則交給 Ruby 的 GC 機制）</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct mrb_of_image* <span class="title">mrb_of_image_alloc</span><span class="params">(mrb_state* mrb)</span> </span>&#123;</span><br><span class="line">  mrb_of_image* image;</span><br><span class="line">  image = (struct mrb_of_image*) mrb_malloc(mrb, <span class="keyword">sizeof</span>(struct mrb_of_image));</span><br><span class="line">  <span class="comment">// 這邊可以視情況做各種初始化</span></span><br><span class="line">  image-&gt;instance = <span class="keyword">new</span> ofImage; <span class="comment">// 這裏預先初始化了 ofImage 物件</span></span><br><span class="line">  <span class="keyword">return</span> image;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定義 MRuby 中的資料類型（Data Type）</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">mrb_data_type</span> <span class="title">mrb_of_image_type</span> = &#123;</span> <span class="string">"Image"</span>, mrb_of_image_free &#125;</span><br><span class="line"></span><br><span class="line">Image::setup(mrb_state* mrb) &#123;</span><br><span class="line">  <span class="comment">// mrb_define_class 回傳回一個 RClass 參照，而第三個參數是「繼承」自哪個物件，這邊從 Ruby 的 Object 繼承（Ruby 預設）</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">RClass</span>* <span class="title">klass</span> = <span class="title">mrb_define_class</span>(<span class="title">mrb</span>, "<span class="title">Image</span>", <span class="title">mrb</span>-&gt;<span class="title">object_class</span>);</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 定義 Image Class 的方法</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// API 中會有 mrb_define_class_method() 和 mrb_define_method() 兩個方法，而且會讓人覺得疑惑</span></span><br><span class="line">  <span class="comment">// 實際上，使用 define_class_method 的時候，產生的是「靜態方法」 Ex. Image.loadImage()</span></span><br><span class="line">  <span class="comment">// 而使用 define_method() 則是「實例的方法」 Ex. image.loadImage() // image = Image.new</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// MRuby 中有預先定義好的巨集 ARGS_* 可以輔助我們指定傳入參數的條件</span></span><br><span class="line">  mrb_define_method(mrb, klass, <span class="string">"initialize"</span>, Image::initialize, ARGS_NONE());</span><br><span class="line">  mrb_define_method(mrb, klass, <span class="string">"load_image"</span>, Image::loadImage, ARGS_REQ(<span class="number">1</span>));</span><br><span class="line">  mrb_define_method(mrb, klass, <span class="string">"draw"</span>, Image::drawImage, ARGS_REQ(<span class="number">2</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 實作 Image Class 方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line">mrb_value Image::initialize(mrb_state* mrb, mrb_value self) &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">mrb_of_image</span> *<span class="title">image</span>;</span></span><br><span class="line">  image = (struct mrb_of_image*) DATA_PTR(self); <span class="comment">// DATA_PTR 可以取出儲存於物件中的 Data 資訊</span></span><br><span class="line">  <span class="keyword">if</span>(image) &#123;</span><br><span class="line">    mrb_of_image_free(mrb, image); <span class="comment">// 清除（這個記憶體位置中的資料不會被使用，因此需要被釋放掉）</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  DATA_TYPE(self) = &amp;mrb_of_image_type; <span class="comment">// 確保物件的 Data Type 被辨識為自定義的 mrb_of_image_type</span></span><br><span class="line">  DATA_PTR(self) = <span class="literal">NULL</span>; <span class="comment">// 清空物件中的 Data</span></span><br><span class="line">  </span><br><span class="line">  image = mrb_of_image_alloc(mrb); <span class="comment">// 重新初始化 </span></span><br><span class="line">  </span><br><span class="line">  DATA_PTR(self) = image; <span class="comment">// 將正確的 Data 設定上去</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> self; <span class="comment">// 沒有特殊需求就傳回自己，也讓 Ruby 的呼叫擁有可以 Chian 的性質</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mrb_value Image::initialize(mrb_state* mrb, mrb_value self) &#123;</span><br><span class="line"></span><br><span class="line">  mrb_value mrbFilePath; <span class="comment">// 儲存於 Ruby 中的路徑資訊</span></span><br><span class="line">  mrb_get_args(mrb, <span class="string">"S"</span>, &amp;mrbFilePath); <span class="comment">// 將 Method 傳述的參數解析出來（在 MRuby 是利用這種方法讀取的）</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> * filePath = mrb_string_value_ptr(mrb, mrbFilePath); <span class="comment">// 將 mrb_value 轉為 char 陣列</span></span><br><span class="line">  </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">mrb_of_image</span>* <span class="title">image</span> = (<span class="title">struct</span> <span class="title">mrb_of_image</span>*) <span class="title">DATA_PRT</span>(<span class="title">self</span>);</span> <span class="comment">// 取出物件中的 Data 資訊</span></span><br><span class="line">  <span class="comment">// 呼叫 ofImage 的 loadImage 進行讀取圖片</span></span><br><span class="line">  <span class="comment">// ofToDataPath() 可以將路徑轉為正確的 data/ 目錄路徑（像是 OSX 的 App 會被包在裡面，預設會讀錯位置）</span></span><br><span class="line">  <span class="comment">// 因為接受的是 string 參數，因此直接將 char 陣列轉為 string</span></span><br><span class="line">  image-&gt;instance-&gt;loadImage(ofToDataPath(<span class="built_in">string</span>(filePath)));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mrb_value Image::initialize(mrb_state* mrb, mrb_value self) &#123;</span><br><span class="line"></span><br><span class="line">  mrb_float x, y; <span class="comment">// mrb_float 可以看作 float 的別名，可以直接當作 float 使用（ MRuby 會看情況選用 float / double ）</span></span><br><span class="line">  mrb_get_args(mrb, <span class="string">"ff"</span>, &amp;x, &amp;y); <span class="comment">// 取出參數（這次是 float 類型）</span></span><br><span class="line">  </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">mrb_of_image</span>* <span class="title">image</span> = (<span class="title">struct</span> <span class="title">mrb_of_image</span>*) <span class="title">DATA_PRT</span>(<span class="title">self</span>);</span></span><br><span class="line">  image-&gt;instance-&gt;draw(x, y); </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> self;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>到此為止，我們就算是完成 ofImage 的 loadImage / draw 的 Binding 了！</p><h3 id="從-Open-Frameworks-運行-Ruby"><a href="#從-Open-Frameworks-運行-Ruby" class="headerlink" title="從 Open Frameworks 運行 Ruby"></a>從 Open Frameworks 運行 Ruby</h3><p>接下來在 <code>ofApp.cpp</code> 中做一些處置就可以執行我們要的 Ruby 檔案了！</p><figure class="highlight cpp"><figcaption><span>ofApp.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 略</span></span><br><span class="line"><span class="comment">// Header 中應該要已經寫好 Ruby* Ruby; 的設定</span></span><br><span class="line"><span class="keyword">void</span> ofApp::setup() &#123;</span><br><span class="line">  Ruby = <span class="keyword">new</span> Ruby;</span><br><span class="line">  Ruby-&gt;load_file(ofToDataPath(<span class="string">"load_image.rb"</span>));</span><br><span class="line">  Ruby-&gt;call(<span class="string">"setup"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> ofApp::update() &#123;</span><br><span class="line">  Ruby-&gt;call(<span class="string">"update"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> ofApp::draw() &#123;</span><br><span class="line">  Ruby-&gt;call(<span class="string">"draw"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> ofApp::<span class="built_in">exit</span>() &#123;</span><br><span class="line">  Ruby-&gt;close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 略</span></span><br></pre></td></tr></table></figure><p>這樣我們就會去讀取 <code>data</code> 目錄下的 <code>load_image.rb</code> 這個檔案。</p><p>接著在 <code>data</code> 目錄新增 <code>load_image.rb</code> 然後運行看看吧！</p><figure class="highlight rb"><figcaption><span>load_image.rb</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$image = Image.new</span><br><span class="line">$imageX = <span class="number">0</span></span><br><span class="line">$counter = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setup</span></span></span><br><span class="line">  $image.load_image <span class="string">"images/logo.png"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span> </span></span><br><span class="line">  $counter += <span class="number">1</span></span><br><span class="line">  $imageX = $counter % <span class="number">500</span></span><br><span class="line">  $counter = <span class="number">0</span> <span class="keyword">if</span> $imageX === <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">draw</span></span></span><br><span class="line">  $image.draw $imageX, $imageX</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>雖然 Ruby 的部分會用到全域變數之類的看起來不太習慣，不過至少可以讓 C++ 跟 MRuby 互相溝通了！</p><blockquote><p>這次學到不少新的用法，我想很快就會忘記所以就趕緊寫篇筆記記錄下來。</p></blockquote><p>參考資料：</p><ul><li><a href="https://www.dzeta.jp/~junjis/code_reading/index.PHP?mruby%2FC%B9%BD%C2%A4%C2%CE%C1%C8%A4%DF%B9%FE%A4%DF%A4%F2%C6%C9%A4%E0" target="_blank" rel="external nofollow noopener noreferrer">mRuby/C構造体組み込みを読む</a></li><li><a href="https://Github.com/tomykaira/hpc-mruby/blob/master/mrbgems/mruby-time/src/time.c" target="_blank" rel="external nofollow noopener noreferrer">hpc-mRuby</a> - 上面的 Wiki 解說的 time.c 就是這個檔案（搭配閱讀會比較好懂）</li><li><a href="https://d.hatena.ne.jp/urekat/20120428/1335602756" target="_blank" rel="external nofollow noopener noreferrer">mRubyのexamples</a></li></ul><footer class="article__footer"><div class="text-center"><div class="fb-share-button" data-href="https://blog.frost.tw/posts/2015/02/18/open-frameworks-and-mruby/" data-layout="button_count"></div></div><p align="center"><a href="https://ko-fi.com/J3J78093" target="_blank" rel="external nofollow noopener noreferrer"><img height="36" style="border:0;height:36px" src="https://az743702.vo.msecnd.net/cdn/kofi5.png?v=0" border="0" alt="Buy Me a Coffee at ko-fi.com"></a></p><iframe scrolling="no" frameborder="0" style="display:block;margin:0 auto;height:212px" src="https://button.like.co/in/embed/elct9620/button?referrer=https://blog.frost.tw/posts/2015/02/18/open-frameworks-and-mruby/"></iframe><ul class="article__tag-list"><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/C/">C++</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/MRuby/">MRuby</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/OpenFrameworks/">OpenFrameworks</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/心得/">心得</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/筆記/">筆記</a></li></ul></footer></div></article><div class="adv"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2844969736316510" data-ad-slot="5530952976" data-ad-format="auto"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><section id="comment" class="comment-box"><h1 class="comment-box__title">留言</h1><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a rel="nofollow" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></div><footer id="footer"><div id="copyright">&copy;2013 <a href="https://plus.google.com/117236344655673213049?rel=author" target="_blank" rel="external nofollow noopener noreferrer">蒼時弦也</a>. All right reversed.</div></footer><script type="text/javascript">window.disqus_shortname="revo-skill-frost",function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+window.disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5TQLRN" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><script>!function(e,t,a,n,g){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var m=t.getElementsByTagName(a)[0],r=t.createElement(a);r.async=!0,r.src="//www.googletagmanager.com/gtm.js?id=GTM-5TQLRN",m.parentNode.insertBefore(r,m)}(window,document,"script","dataLayer")</script><script>window.fbAsyncInit=function(){FB.init({appId:"178355449110",xfbml:!0,version:"v2.12"}),FB.AppEvents.logPageView()},function(e,n,t){var o,s=e.getElementsByTagName(n)[0];e.getElementById(t)||((o=e.createElement(n)).id=t,o.src="https://connect.facebook.net/zh_TW/sdk.js",o.async=!0,s.parentNode.insertBefore(o,s))}(document,"script","facebook-jssdk")</script><script src="/js/app.js"></script><div class="loading"></div></body></html>