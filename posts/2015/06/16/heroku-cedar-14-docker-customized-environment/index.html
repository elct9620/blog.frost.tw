<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  
  <title>Heroku Cedar 14 - 用 Docker 客製化環境 | 弦而時習之</title>
  <meta name="theme-color" content="#EFEFEF">

  <meta name="author" content="蒼時弦也">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1">

  <meta name="description" content="最近 Heroku 推出了 Docker 支援，也因此我馬上就去試玩了這個功能。 這篇文章會簡單介紹 Heroku Docker 的運作，以及可以運用的方式。 文章大致上會涵蓋這些內容：  Heroku Docker Plugin 的運作 建構客製化環境的 Dockerfile 利用 Docker 製作 Buildpacks">
<meta name="keywords" content="筆記,Heroku,Docker">
<meta property="og:type" content="article">
<meta property="og:title" content="Heroku Cedar 14 - 用 Docker 客製化環境">
<meta property="og:url" content="https://blog.frost.tw/posts/2015/06/16/heroku-cedar-14-docker-customized-environment/">
<meta property="og:site_name" content="弦而時習之">
<meta property="og:description" content="最近 Heroku 推出了 Docker 支援，也因此我馬上就去試玩了這個功能。 這篇文章會簡單介紹 Heroku Docker 的運作，以及可以運用的方式。 文章大致上會涵蓋這些內容：  Heroku Docker Plugin 的運作 建構客製化環境的 Dockerfile 利用 Docker 製作 Buildpacks">
<meta property="og:locale" content="zh-TW">
<meta property="og:image" content="http://blog.frost.tw/icon-512.png">
<meta property="og:updated_time" content="2017-07-02T17:07:07.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Heroku Cedar 14 - 用 Docker 客製化環境">
<meta name="twitter:description" content="最近 Heroku 推出了 Docker 支援，也因此我馬上就去試玩了這個功能。 這篇文章會簡單介紹 Heroku Docker 的運作，以及可以運用的方式。 文章大致上會涵蓋這些內容：  Heroku Docker Plugin 的運作 建構客製化環境的 Dockerfile 利用 Docker 製作 Buildpacks">
<meta name="twitter:image" content="http://blog.frost.tw/icon-512.png">
<link rel="publisher" href="https://plus.google.com/117236344655673213049">
<meta property="fb:app_id" content="178355449110">

  <meta property="fb:pages" content="180666522388" />
  <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Blog",
    "name": "弦而時習之",
    "url": "https://blog.frost.tw",
    "image": "http://blog.frost.tw/icon-512.png",
    "description": "蒼時弦也的個人網誌，專注在前端、後端以及遊戲開發，大多使用 Ruby 和 Ruby on Rails 以及 Golang、JS 和 C 語言。",
    "sameAs": [
      "https://www.facebook.com/frost.tw/"
    ]
}
</script>
<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Person",
    "name": "蒼時弦也",
    "url": "https://blog.frost.tw",
    "sameAs": [
      "https://www.facebook.com/elct9620",
      "https://www.instagram.com/elct9620/",
      "https://twitter.com/elct9620",
      "https://plus.google.com/+%E8%92%BC%E6%99%82%E5%BC%A6%E4%B9%9F-plus",
      "https://www.linkedin.com/in/elct9620"
    ]
}
</script>

<script type="application/ld+json">
{
  "@context":"http://schema.org",
  "@type":"Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.frost.tw/posts/2015/06/16/heroku-cedar-14-docker-customized-environment/"
  },
  "headline":"Heroku Cedar 14 - 用 Docker 客製化環境",
  "image": [
    
    "http://blog.frost.tw/icon-512.png"
  ],
  "datePublished": "2015-06-15T22:12:00.000Z",
  "dateModified": "2017-07-02T17:07:07.000Z",
  "description":"最近 Heroku 推出了 Docker 支援，也因此我馬上就去試玩了這個功能。這篇文章會簡單介紹 Heroku Docker 的運作，以及可以運用的方式。文章大致上會涵蓋這些內容：Heroku Docker Plugin 的運作建構客製化環境的 Dockerfile利用 Docker 製作 Buildpacks",
  "author": {
    "@type": "Person",
    "name": "蒼時弦也"
  },
  "publisher": {
    "@type": "Organization",
    "name": "蒼時弦也",
    "logo": {
      "@type": "ImageObject",
      "url": "http://blog.forst.tw/logo-wide.png"
    }
  }
}
</script>




  
  <link rel="canonical" href="https://blog.frost.tw/posts/2015/06/16/heroku-cedar-14-docker-customized-environment/" />
  
  <link href="/icon-512.png" rel="icon">
  <link rel="alternate" href="/feed.xml" title="弦而時習之" type="application/rss+xml">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <script async src="/js/turbolinks.js"></script>
</head>

  <body>
    <div id="fb-root" data-turbolinks-permanent></div>
    <header id="header">
      
<h1 id="sitename">
  <a href="/" class="hide-text logo--icon align-center">
  弦而時習之
  </a>
</h1>

<aside id="slogan" class="slogan align-center text-center">
  <h2 class="slogan__title">Aotokitsuruya</h2>
  <p class="slogan__description">The Web is attracting  me, so I start learning PHP, HTML, CSS and JavaScript. When I know about Ruby, I fall in love with it. Now, I working with my friend to design games using C++ and still learning web about Golang, Ruby and JavaScript. In the other side, I also be a designer, the reason why the web is attracted me.</p>
</aside>

    </header>
    <div id="wrapper">
      
<article class="post article">
  <header class="article__header">
    <time datetime="2015-06-15T22:12:00.000Z" class="article__time--header">
      Jun.16
    </time>
    
  
    <h1 class="article__title">Heroku Cedar 14 - 用 Docker 客製化環境</h1>
  


  </header>
  <div class="article__entry">
    
    <p>最近 Heroku 推出了 <a href="https://blog.Heroku.com/archives/2015/5/5/introducing_heroku_Docker_release_build_deploy_heroku_apps_with_docker" target="_blank" rel="noopener">Docker 支援</a>，也因此我馬上就去試玩了這個功能。</p>
<p>這篇文章會簡單介紹 Heroku Docker 的運作，以及可以運用的方式。</p>
<p>文章大致上會涵蓋這些內容：</p>
<ul>
<li>Heroku Docker Plugin 的運作</li>
<li>建構客製化環境的 Dockerfile</li>
<li>利用 Docker 製作 Buildpacks</li>
</ul>
<a id="more"></a>
<h3 id="Docker-Plugin"><a href="#Docker-Plugin" class="headerlink" title="Docker Plugin"></a>Docker Plugin</h3><p>這是一個 Open Source 的專案，放在 Heroku 官方的 <a href="https://Github.com/Heroku/heroku-Docker" target="_blank" rel="noopener">Github</a> 上面，任何人都可以進行 Pull Request 對其新增語言支援。</p>
<p>目前支援的語言只有 Scala, Ruby, Node.js, Python 這幾種，細看 Dockerfile 的撰寫其實就可以推測出大多是不相依於 Apache/Nginx 的類型。</p>
<blockquote>
<p>因為我自己在維護 PHP 的 Phalcon Buildpacks 這篇文章正好是我支援 Docker 後才寫的，在撰寫 Dockerfile 時就碰到了「設定檔」問題</p>
</blockquote>
<p>基本使用很簡單，使用下面的指令安裝 Heroku Command Line Tool 的擴出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Heroku plugins:install heroku-Docker</div></pre></td></tr></table></figure>
<p>之後就可以使用 <code>Heroku Docker:[action]</code> 去做一些應用。</p>
<h4 id="init"><a href="#init" class="headerlink" title="init"></a>init</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Heroku Docker:init</div></pre></td></tr></table></figure>
<p>一開始要對自己原本的專案加上 Docker 支援，只要運行這個指令就可以了！<br>他會自動產生一個 Dockerfile 並且在裡面配置好「所需」的環境（其實就是把 Buildpacks 複製進去）</p>
<p>這邊簡單把 Heroku Docker 跟 Buildpacks 的流程做比較：</p>
<table>
<thead>
<tr>
<th></th>
<th>Docker</th>
<th>Buildpacks</th>
</tr>
</thead>
<tbody>
<tr>
<td>偵測環境</td>
<td>Docker:init</td>
<td>bin/detect</td>
</tr>
<tr>
<td>建構環境</td>
<td>Dockerfile 運行</td>
<td>bin/compile</td>
</tr>
<tr>
<td>執行應用</td>
<td>Procfile 定義（必要）</td>
<td>Procfile (建構時有預設值)</td>
</tr>
</tbody>
</table>
<p>其實會發現基本上就是把 Buildpacks 的任務本地化而已。</p>
<blockquote>
<p><code>bin/detech</code> 是 Shell Script 用來檢查有沒有必要的檔案，而 <code>Docker:init</code> 則是掃描目錄有沒有對應的檔案 Ex. Gemfile<br><code>bin/compile</code> 跟 Dockerfile 在建構 Ruby 環境都是下載相同的檔案解壓縮（這是為了加速，直接寫入編譯程式也是可以的）</p>
</blockquote>
<p>唯一的不同點在於 Docker 版本預設不會自動生成 Procfile 所以必須自行指定像是 <code>Rails server</code> 之類的指令。</p>
<blockquote>
<p>原始碼中有指出： Procfile 必要，並且要有一個 web node 存在</p>
</blockquote>
<h4 id="exec"><a href="#exec" class="headerlink" title="exec"></a>exec</h4><p>用途跟 <code>Heroku run</code> 一樣，不過要注意的是 Dockerfile 裡面所寫的 <code>ONBUILD</code> 是不會執行的。</p>
<blockquote>
<p>他是直接跑你的 image 而不是產生新的 image 去執行（下一段的 <code>start</code> 會提到）</p>
</blockquote>
<h4 id="start"><a href="#start" class="headerlink" title="start"></a>start</h4><p>可以在本機測試 Deploy 後的情況，相對過去要 Deploy 到 Heroku 上測試比起來，真的好太多了！</p>
<blockquote>
<p>執行的時候可以看一下目錄，會發現多出一個 <code>Dockerfile-(一段應該是 SHA1 的字串)</code> 的檔案，內容就是 <code>FROM 剛剛的 Image</code> 也因此會觸發 <code>ONBUILD</code> 去設定環境</p>
</blockquote>
<p>這樣做的原因大概可以推測是為了避免在跑 <code>exec</code> 的時候還要先裝完相依這些執行時用不到的檔案吧 XD</p>
<h4 id="release"><a href="#release" class="headerlink" title="release"></a>release</h4><p>跟 <code>git push Heroku master</code> 差不多的意思，他會把剛剛的環境壓縮成一個 Gzip 檔然後上傳到 Heroku。<br>這個 Gzip 檔就是過去用 Buildpacks 跑完後產生的 <code>slug</code> 也就是說，如果專案加上相依有 100MB 那就得上傳 100MB 的相依上去。</p>
<blockquote>
<p>我自己維護的 PHP + Phalcon 專案壓縮後就有 49MB 非常的大，這也是我後來沒有改用 Docker 的原因。</p>
</blockquote>
<h3 id="clean"><a href="#clean" class="headerlink" title="clean"></a>clean</h3><p>這個指令會把產生的 image 跟 container 清除，以確保環境是乾淨的（超貼心 XD）</p>
<hr>
<p>那麼這有什麼用呢？大致上可以歸類為以下幾點：</p>
<ol>
<li>私有的 Source Code 需要 Compile 後 Deploy</li>
<li>高度客製化的環境（而且無法製成 Buildpacks）或者不希望其他人使用這個環境</li>
<li>需要自行安裝 Heroku 的 <code>cedar</code> 不支援的相依</li>
<li>用來輔助本地測試</li>
<li>用來製作 Buildpacks</li>
</ol>
<h3 id="Dockerfile-的撰寫"><a href="#Dockerfile-的撰寫" class="headerlink" title="Dockerfile 的撰寫"></a>Dockerfile 的撰寫</h3><p>假設我需要編譯一些檔案好 Deploy 到 Heroku 上面，只要改寫 Dockerfile 就可以了！</p>
<p>這邊就以我自己維護的 Buildpacks 所用的 Dockerfile 作為範例來講解。</p>
<blockquote>
<p>在撰寫 Dockerfile 的時候以方便為主，不需要優化 Docker Image 的大小（我寫完 Buildpacks 才發現）<br>主要是 Heroku 不會跑任何 Dockerfile 所以壓縮的再小也沒有意義，也不會節省任何時間。</p>
</blockquote>
<p>首先要引用 Heroku 預先準備好的 <code>cedar</code> image 來當作基底（跟 Heroku 實際環境一樣，不用再猜了 XD）<br><figure class="highlight docker"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> Heroku/cedar:<span class="number">14</span></div></pre></td></tr></table></figure></p>
<p>之後就是很淡定的開始跑各種指令拉（節錄部分 Dockerfile）<br><figure class="highlight dockerfile"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">RUN</span><span class="bash"> useradd -d /app -m app</span></div><div class="line"><span class="keyword">USER</span> app</div><div class="line"><span class="keyword">RUN</span><span class="bash"> mkdir /app/build</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> mkdir /app/src</span></div><div class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app/src</span></div><div class="line"></div><div class="line"><span class="comment"># Environment</span></div><div class="line"><span class="keyword">ENV</span> HOME /app</div><div class="line"><span class="keyword">ENV</span> BUILD_HOME /app/build</div><div class="line"><span class="keyword">ENV</span> APACHE_ROOT $&#123;HOME&#125;/apache</div><div class="line"><span class="keyword">ENV</span> PCRE_ROOT $&#123;HOME&#125;/libs/pcre</div><div class="line"></div><div class="line"><span class="keyword">ENV</span> APACHE_VERSION <span class="number">2.4</span>.<span class="number">12</span></div><div class="line"><span class="keyword">ENV</span> APR_VERSION <span class="number">1.5</span>.<span class="number">2</span></div><div class="line"><span class="keyword">ENV</span> APR_UTIL_VERSION <span class="number">1.5</span>.<span class="number">4</span></div><div class="line"><span class="keyword">ENV</span> LIBPCRE_VERSION <span class="number">8.37</span></div><div class="line"></div><div class="line"><span class="keyword">ENV</span> APACHE_URL http://www.us.apache.org/dist/httpd/httpd-$&#123;APACHE_VERSION&#125;.tar.gz</div><div class="line"><span class="keyword">ENV</span> APR_URL http://www.us.apache.org/dist/apr/apr-$&#123;APR_VERSION&#125;.tar.gz</div><div class="line"><span class="keyword">ENV</span> APR_UTIL_URL http://www.us.apache.org/dist/apr/apr-util-$&#123;APR_UTIL_VERSION&#125;.tar.gz</div><div class="line"><span class="keyword">ENV</span> PCRE_URL ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-$&#123;LIBPCRE_VERSION&#125;.tar.gz</div><div class="line"></div><div class="line"><span class="keyword">ENV</span> APACHE_DIR httpd-$&#123;APACHE_VERSION&#125;</div><div class="line"><span class="keyword">ENV</span> APR_DIR apr-$&#123;APR_VERSION&#125;</div><div class="line"><span class="keyword">ENV</span> APR_UTIL_DIR apr-util-$&#123;APR_UTIL_VERSION&#125;</div><div class="line"><span class="keyword">ENV</span> PCRE_DIR pcre-$&#123;LIBPCRE_VERSION&#125;</div><div class="line"></div><div class="line"><span class="keyword">ENV</span> CURL_FLAGS --location --silent</div><div class="line"></div><div class="line"><span class="comment"># Compile</span></div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> <span class="variable">$BUILD_HOME</span> &amp;&amp; \</span></div><div class="line">truetruetrue curl <span class="variable">$CURL_FLAGS</span> <span class="string">"<span class="variable">$APACHE_URL</span>"</span> | tar zx &amp;&amp; \</div><div class="line">       curl <span class="variable">$CURL_FLAGS</span> <span class="string">"<span class="variable">$APR_URL</span>"</span> | tar zx &amp;&amp; \</div><div class="line">       curl <span class="variable">$CURL_FLAGS</span> <span class="string">"<span class="variable">$APR_UTIL_URL</span>"</span> | tar zx &amp;&amp; \</div><div class="line">       curl <span class="variable">$CURL_FLAGS</span> <span class="string">"<span class="variable">$PCRE_URL</span>"</span> | tar zx</div><div class="line">       </div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> <span class="variable">$BUILD_HOME</span>/<span class="variable">$PCRE_DIR</span> &amp;&amp; \</span></div><div class="line">    ./configure --prefix=<span class="variable">$PCRE_ROOT</span> &amp;&amp; \</div><div class="line">    make &amp;&amp; make install</div><div class="line">    </div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> <span class="variable">$BUILD_HOME</span> &amp;&amp; \</span></div><div class="line">truetruemv <span class="variable">$APR_DIR</span> <span class="variable">$APACHE_DIR</span>/srclib/apr &amp;&amp; \</div><div class="line">    mv <span class="variable">$APR_UTIL_DIR</span> <span class="variable">$APACHE_DIR</span>/srclib/apr-util &amp;&amp; \</div><div class="line">    <span class="built_in">cd</span> <span class="variable">$APACHE_DIR</span> &amp;&amp; \</div><div class="line">    ./configure --prefix=<span class="variable">$APACHE_ROOT</span> --with-pcre=<span class="variable">$PCRE_ROOT</span> --<span class="built_in">enable</span>-rewrite &amp;&amp; \</div><div class="line">    make &amp;&amp; make install</div></pre></td></tr></table></figure></p>
<p>這邊很重要的訣竅就是 Compile 的時候可以分開為單獨的 <code>RUN</code> 因為 Docker 在 Build 的時候會把一個指令當成一個 <code>layer</code> 也就是說，中間如果失敗（寫 Script 總是會失誤）就不用整個重新 Compile 過，而是只需要重新跑部分的指令而已。</p>
<blockquote>
<p>這會節省非常多時間，我自己的 Macbook Pro Retina 15” 就要花上十幾分鐘完整編譯。<br>這邊最重要的是自行編譯的檔案都要放到 <code>/app</code> 目錄，因為包成 Slug 的時候是不會壓縮這個目錄以外的檔案。</p>
</blockquote>
<p>至於設定檔的部分，我則是這樣設定的（利用 <code>sed</code> 去置換預設的設定檔）</p>
<figure class="highlight dockerfile"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Configure</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> sed -ire <span class="string">'s/^Listen.*$/Listen \$&#123;PORT&#125;/g'</span> <span class="variable">$APACHE_ROOT</span>/conf/httpd.conf &amp;&amp; \</span></div><div class="line">    sed -ire <span class="string">'s/^DocumentRoot.*$/DocumentRoot\ "\/app\/src"/g'</span> <span class="variable">$APACHE_ROOT</span>/conf/httpd.conf &amp;&amp; \</div><div class="line">    sed -ire <span class="string">'s/&lt;Directory "\/app\/apache\/htdocs"&gt;/&lt;Directory "\/app\/src"&gt;/g'</span> <span class="variable">$APACHE_ROOT</span>/conf/httpd.conf &amp;&amp; \</div><div class="line">    sed -ire <span class="string">'s/AllowOverride\ None/AllowOverride\ All/g'</span> <span class="variable">$APACHE_ROOT</span>/conf/httpd.conf</div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"&lt;IfModule dir_module&gt;\nDirectoryIndex index.html index.PHP\n&lt;/IfModule&gt;"</span> &gt;&gt; <span class="variable">$APACHE_ROOT</span>/conf/httpd.conf &amp;&amp; \</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"&lt;FilesMatch \.PHP$&gt;\nSetHandler application/x-httpd-PHP\n&lt;/FilesMatch&gt;"</span> &gt;&gt; <span class="variable">$APACHE_ROOT</span>/conf/httpd.conf</div><div class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"zend_extension=opcache.so"</span> &gt;&gt; <span class="variable">$PHP_ROOT</span>/PHP.ini &amp;&amp; \</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"extension=phalcon.so"</span> &gt;&gt; <span class="variable">$PHP_ROOT</span>/PHP.ini &amp;&amp; \</div><div class="line">    <span class="built_in">echo</span> <span class="string">"extension=mongo.so"</span> &gt;&gt; <span class="variable">$PHP_ROOT</span>/PHP.ini &amp;&amp; \</div><div class="line">    <span class="built_in">echo</span> <span class="string">"extension=redis.so"</span> &gt;&gt; <span class="variable">$PHP_ROOT</span>/PHP.ini</div></pre></td></tr></table></figure>
<p>這樣做的原因是如果未來要相容在 Docker Plugin 時，就可以省去問題（Plugin 只會把 Template 丟出來，並不支援 ADD 之類的增加檔案）</p>
<blockquote>
<p>不過後來想想，包個 Buildpacks 給 Plugin 下載比較實在 XD</p>
</blockquote>
<p>最後是 Deploy 的時候會用到的 <code>ONBUILD</code> 部分（其實就是把 Source Code 複製進去而已）</p>
<figure class="highlight dockerfile"><figcaption><span>Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Copy SourceCode</span></div><div class="line"><span class="keyword">ONBUILD</span> <span class="keyword">COPY</span><span class="bash"> . /app/src</span></div><div class="line"><span class="keyword">ONBUILD</span> <span class="keyword">USER</span> root</div><div class="line"><span class="keyword">ONBUILD</span> <span class="keyword">RUN</span><span class="bash"> chown -R app /app</span></div><div class="line"><span class="keyword">ONBUILD</span> <span class="keyword">USER</span> app</div><div class="line"></div><div class="line"><span class="comment"># Setup Dependency</span></div><div class="line"><span class="keyword">ONBUILD</span> <span class="keyword">RUN</span><span class="bash"> <span class="keyword">if</span> [ -f /app/src/composer.json ]; <span class="keyword">then</span> \</span></div><div class="line">            curl --silent --max-time 60 --location <span class="string">"<span class="variable">$COMPOSER_URL</span>"</span> &gt; <span class="variable">$HOME</span>/src/composer.phar; \</div><div class="line">            PHP <span class="variable">$HOME</span>/src/composer.phar install --prefer-dist; \</div><div class="line">            rm <span class="variable">$HOME</span>/src/composer.phar; \</div><div class="line">            <span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="comment"># Configure Profile</span></div><div class="line"><span class="keyword">ONBUILD</span> <span class="keyword">USER</span> app</div><div class="line"><span class="keyword">ONBUILD</span> <span class="keyword">RUN</span><span class="bash"> mkdir -p /app/.profile.d</span></div><div class="line"><span class="keyword">ONBUILD</span> <span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"export PATH=\"<span class="variable">$PATH</span>:<span class="variable">$PHP_ROOT</span>/bin:<span class="variable">$APACHE_ROOT</span>/bin\""</span> &gt; /app/.profile.d/PHP.sh</span></div><div class="line"><span class="keyword">ONBUILD</span> <span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"cd /app/src"</span> &gt;&gt; /app/.profile.d/PHP.sh</span></div><div class="line"></div><div class="line"><span class="keyword">ONBUILD</span> <span class="keyword">EXPOSE</span> <span class="number">3000</span></div></pre></td></tr></table></figure>
<p>裡面跑了 <code>composer install</code> 至於需不需要跑就看專案摟～<br>（像是 PHP/Node.js 的相依都會被一起複製到，其實也不用這麼在意拉⋯⋯）</p>
<p>至於 Port 一律都是 3000 所以 <code>EXPOSE</code> 到 3000 就沒問題了。</p>
<h3 id="輔助-Buildpacks-製作"><a href="#輔助-Buildpacks-製作" class="headerlink" title="輔助 Buildpacks 製作"></a>輔助 Buildpacks 製作</h3><p>稍微修改一下 Dockerfile 放點輔助的 Script 進去就可以了。</p>
<p>我是寫了一個叫做 <code>package.sh</code> 的 Shell Script 幫我把 <code>/app</code> 的環境包出來。</p>
<figure class="highlight sh"><figcaption><span>package.sh</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">mkdir /tmp/package</div><div class="line"><span class="built_in">cd</span> /app</div><div class="line">tar cfvz /tmp/package/libs.tar.gz libs</div><div class="line">tar cfvz /tmp/package/PHP.tar.gz PHP</div><div class="line">tar cfvz /tmp/package/apache.tar.gz apache</div><div class="line"></div><div class="line"><span class="built_in">cd</span> /tmp/package</div><div class="line">tar cvfz /tmp/slug.tar.gz libs.tar.gz PHP.tar.gz apache.tar.gz</div></pre></td></tr></table></figure>
<p>做了些什麼呢？其實就是包 <code>slug</code> 但是跳過原始碼部分。</p>
<p>另外因為 Docker Plugin 不能幫我做把包好的 <code>slug</code> 拉出來，所以我另外寫了 <code>build_Docker.sh</code> 幫我複製出來。</p>
<figure class="highlight sh"><figcaption><span>build_Docker.sh</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> [ -f slug.tar.gz ]; <span class="keyword">then</span></div><div class="line">  rm slug.tar.gz</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="comment"># Build Image</span></div><div class="line">Docker build -t PHP-with-phalcon .  <span class="comment"># Run docker</span></div><div class="line">CONTAINER_ID=$(Docker run -d PHP-with-phalcon /app/package.sh)</div><div class="line">Docker <span class="built_in">wait</span> <span class="variable">$CONTAINER_ID</span></div><div class="line">Docker cp <span class="variable">$CONTAINER_ID</span>:/tmp/slug.tar.gz .</div><div class="line">Docker rm -f <span class="variable">$CONTAINER_ID</span></div><div class="line"></div><div class="line"><span class="comment"># Remove image</span></div><div class="line">Docker rmi PHP-with-phalcon</div></pre></td></tr></table></figure>
<p>因為會產生額外的 Image 跟 Container 所以在執行玩的時候都清理掉，確保乾淨。</p>
<blockquote>
<p>不過目前還在想該怎麼解決 Image Tag 的問題（怕重複到）</p>
</blockquote>
<p>這個 Buildpacks 的原始碼在 <a href="https://Github.com/elct9620/Heroku-buildpacks-PHP-with-phalcon" target="_blank" rel="noopener">Github</a> 上面，歡迎大家協助改進跟維護。</p>
<blockquote>
<p>我有預裝好 Mongodb / Redis Extension 但是 Memcached 因為相依的 <code>libmemcached</code> 放在 Ubuntu 的版本管理系統上，卻很難判斷原始碼下載網址，因此我放棄了⋯⋯</p>
</blockquote>

    
    <footer class="article__footer">
      
        <div class="text-center">
          <div class="fb-share-button"
               data-href="https://blog.frost.tw/posts/2015/06/16/heroku-cedar-14-docker-customized-environment/"
               data-layout="button_count">
          </div>
        </div>
        <p align="center">
          <a href='https://ko-fi.com/J3J78093' target='_blank'>
            <img height='36' style='border:0px;height:36px;' src='https://az743702.vo.msecnd.net/cdn/kofi5.png?v=0' border='0' alt='Buy Me a Coffee at ko-fi.com' />
          </a>
        </p>
        
          <ul class="article__tag-list"><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/Docker/">Docker</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/Heroku/">Heroku</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/筆記/">筆記</a></li></ul>
        
      
    </footer>
  </div>
</article>


  
    <div class="adv">
      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      <!-- 網誌_文末廣告 (Hexo) -->
      <ins class="adsbygoogle"
      style="display:block"
      data-ad-client="ca-pub-2844969736316510"
      data-ad-slot="5530952976"
      data-ad-format="auto"></ins>
      <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
  

  
<section id="comment" class="comment-box">
  <h1 class="comment-box__title">留言</h1>

  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></noscript>
  </div>
</section>






    </div>
    <footer id="footer">
      <div id="copyright">
  &copy;2013 <a href="https://plus.google.com/117236344655673213049?rel=author" target="_blank">蒼時弦也</a>. All right reversed.
</div>

    </footer>
    

  
  <script type="text/javascript">
  var disqus_shortname = 'revo-skill-frost';

  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }());
  </script>
  

  
  <!-- Google Tag Manager -->
  <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5TQLRN"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-5TQLRN');</script>
  <!-- End Google Tag Manager -->
  

  <script>
    window.fbAsyncInit = function() {
      FB.init({
        appId      : '178355449110',
        xfbml      : true,
        version    : 'v2.12'
      });

      FB.AppEvents.logPageView();

    };

    (function(d, s, id){
       var js, fjs = d.getElementsByTagName(s)[0];
       if (d.getElementById(id)) {return;}
       js = d.createElement(s); js.id = id;
       js.src = "https://connect.facebook.net/zh_TW/sdk.js";
       fjs.parentNode.insertBefore(js, fjs);
     }(document, 'script', 'facebook-jssdk'));
  </script>

  <script src="/js/app.js"></script>


    <div class="loading"></div>
  </body>
</html>
