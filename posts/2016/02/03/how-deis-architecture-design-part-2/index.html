<!DOCTYPE html><html lang="zh-TW"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><title>Deis 架構分析（二） | 弦而時習之</title><meta name="theme-color" content="#EFEFEF"><meta name="author" content="蒼時弦也"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="延續上一篇的內容，這篇文章要先來討論比較好懂的 Router 部分。首先，在 Deis 的設計裡面，基本上所有的服務都是包成一個 Image 作為 Continaer 在 CoreOS 運行的。就這點來看，其實是非常符合 Mircoservice 架構的設計。同時我們也可以很輕鬆地將這些服務獨立出來使用，這篇文章討論的 Router 除了原本的用途外，也很適合用來學習透過 etcd 部署自動化更新"><meta name="keywords" content="雲端,筆記,PaaS,CoreOS,Deis"><meta property="og:type" content="article"><meta property="og:title" content="Deis 架構分析（二）"><meta property="og:url" content="https://blog.frost.tw/posts/2016/02/03/how-deis-architecture-design-part-2/"><meta property="og:site_name" content="弦而時習之"><meta property="og:description" content="延續上一篇的內容，這篇文章要先來討論比較好懂的 Router 部分。首先，在 Deis 的設計裡面，基本上所有的服務都是包成一個 Image 作為 Continaer 在 CoreOS 運行的。就這點來看，其實是非常符合 Mircoservice 架構的設計。同時我們也可以很輕鬆地將這些服務獨立出來使用，這篇文章討論的 Router 除了原本的用途外，也很適合用來學習透過 etcd 部署自動化更新"><meta property="og:locale" content="zh-TW"><meta property="og:image" content="http://blog.frost.tw/icon-512.png"><meta property="og:updated_time" content="2019-06-29T07:53:37.227Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Deis 架構分析（二）"><meta name="twitter:description" content="延續上一篇的內容，這篇文章要先來討論比較好懂的 Router 部分。首先，在 Deis 的設計裡面，基本上所有的服務都是包成一個 Image 作為 Continaer 在 CoreOS 運行的。就這點來看，其實是非常符合 Mircoservice 架構的設計。同時我們也可以很輕鬆地將這些服務獨立出來使用，這篇文章討論的 Router 除了原本的用途外，也很適合用來學習透過 etcd 部署自動化更新"><meta name="twitter:image" content="http://blog.frost.tw/icon-512.png"><link rel="publisher" href="https://plus.google.com/117236344655673213049"><meta property="fb:app_id" content="178355449110"><meta property="fb:pages" content="180666522388"><script type="application/ld+json">[
{
    "@context": "http://schema.org",
    "@type": "Blog",
    "name": "弦而時習之",
    "url": "https://blog.frost.tw",
    "image": "http://blog.frost.tw/icon-512.png",
    "description": "蒼時弦也的個人網誌，專注在前端、後端以及遊戲開發，大多使用 Ruby 和 Ruby on Rails 以及 Golang、JS 和 C 語言。",
    "sameAs": [
      "https://www.facebook.com/frost.tw/"
    ]
},
{
    "@context": "http://schema.org",
    "@type": "Person",
    "name": "蒼時弦也",
    "url": "https://blog.frost.tw",
    "sameAs": [
      "https://www.facebook.com/elct9620",
      "https://www.instagram.com/elct9620/",
      "https://twitter.com/elct9620",
      "https://plus.google.com/+%E8%92%BC%E6%99%82%E5%BC%A6%E4%B9%9F-plus",
      "https://www.linkedin.com/in/elct9620"
    ]
},
{
  "@context":"http://schema.org",
  "@type":"BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.frost.tw/posts/2016/02/03/how-deis-architecture-design-part-2/"
  },
  "headline":"Deis 架構分析（二）",
  "image": [
    
    "http://blog.frost.tw/icon-512.png"
  ],
  
  "datePublished": "2016-02-03T07:54:00.000Z",
  "dateModified": "2019-06-29T07:53:37.227Z",
  "description":"延續上一篇的內容，這篇文章要先來討論比較好懂的 Router 部分。首先，在 Deis 的設計裡面，基本上所有的服務都是包成一個 Image 作為 Continaer 在 CoreOS 運行的。就這點來看，其實是非常符合 Mircoservice 架構的設計。同時我們也可以很輕鬆地將這些服務獨立出來使用，這篇文章討論的 Router 除了原本的用途外，也很適合用來學習透過 etcd 部署自動化更新設定檔的環境。Deis 的原始碼都放在一起，其中 Router 部分是裡面的一個子目錄，那麼就讓我們開始了解運行的架構吧！",
  "author": {
    "@type": "Person",
    "name": "蒼時弦也"
  },
  "publisher": {
    "@type": "Organization",
    "name": "蒼時弦也",
    "logo": {
      "@type": "ImageObject",
      "url": "http://blog.forst.tw/logo-wide.png"
    }
  }
},
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
    "@type": "ListItem",
    "position": 1,
    "item": {
      "@id": "https://blog.frost.tw",
      "name": "弦而時習之 ",
      "image": "http://blog.frost.tw/icon-512.png"
    }
  },{
    "@type": "ListItem",
    "position": 2,
    "item": {
      "@id": "https://blog.frost.tw/posts/2016/02/03/how-deis-architecture-design-part-2/",
      "name": "Deis 架構分析（二）",
      "image": "http://blog.frost.tw/icon-512.png"
    }
  }]
}

]</script><link rel="canonical" href="https://blog.frost.tw/posts/2016/02/03/how-deis-architecture-design-part-2/"><link href="/icon-512.png" rel="icon"><link rel="alternate" href="/feed.xml" title="弦而時習之" type="application/rss+xml"><!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--><link rel="stylesheet" href="/css/style.css" media="screen" type="text/css"><script async src="/js/turbolinks.js"></script></head><body><div id="fb-root" data-turbolinks-permanent></div><header id="header"><h1 id="sitename"><a href="/" class="hide-text logo--icon align-center">弦而時習之</a></h1><aside id="slogan" class="slogan align-center text-center"><h2 class="slogan__title">Aotokitsuruya</h2><p class="slogan__description">The Web is attracting me, so I start learning PHP, HTML, CSS and JavaScript. When I know about Ruby, I fall in love with it. Now, I working with my friend to design games using C++ and still learning web about Golang, Ruby and JavaScript. In the other side, I also be a designer, the reason why the web is attracted me.</p></aside></header><div id="wrapper"><article class="post article"><header class="article__header"><time datetime="2016-02-03T07:54:00.000Z" class="article__time--header">Feb.03</time><h1 class="article__title">Deis 架構分析（二）</h1></header><div class="article__entry"><p>延續<a href="https://blog.frost.tw/posts/2016/01/31/how-deis-architecture-design-part-1">上一篇</a>的內容，這篇文章要先來討論比較好懂的 <code>Router</code> 部分。</p><p>首先，在 Deis 的設計裡面，基本上所有的服務都是包成一個 Image 作為 Continaer 在 CoreOS 運行的。就這點來看，其實是非常符合 Mircoservice 架構的設計。同時我們也可以很輕鬆地將這些服務獨立出來使用，這篇文章討論的 <code>Router</code> 除了原本的用途外，也很適合用來學習透過 etcd 部署自動化更新設定檔的環境。</p><p>Deis 的原始碼都放在一起，其中 <a href="https://github.com/deis/deis/tree/master/router" rel="external nofollow noopener noreferrer" target="_blank">Router</a> 部分是裡面的一個子目錄，那麼就讓我們開始了解運行的架構吧！</p><a id="more"></a><h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine:<span class="number">3.2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># install common packages</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apk add --update-cache \</span></span><br><span class="line"><span class="bash">  bash \</span></span><br><span class="line"><span class="bash">  curl \</span></span><br><span class="line"><span class="bash">  geoip \</span></span><br><span class="line"><span class="bash">  libssl1.0 \</span></span><br><span class="line"><span class="bash">  openssl \</span></span><br><span class="line"><span class="bash">  pcre \</span></span><br><span class="line"><span class="bash">  sudo \</span></span><br><span class="line"><span class="bash">  &amp;&amp; rm -rf /var/cache/apk/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># install confd</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> curl -sSL -o /usr/<span class="built_in">local</span>/bin/confd https://s3-us-west-2.amazonaws.com/opdemand/confd-git-73f7489 \</span></span><br><span class="line"><span class="bash">  &amp;&amp; chmod +x /usr/<span class="built_in">local</span>/bin/confd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># add nginx user</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> addgroup -S nginx &amp;&amp; \</span></span><br><span class="line"><span class="bash">  adduser -S -G nginx -H -h /opt/nginx -s /sbin/nologin -D nginx</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> rootfs /</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># compile nginx from source</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> build</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"boot"</span>]</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span> <span class="number">2222</span> <span class="number">9090</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> DEIS_RELEASE <span class="number">1.13</span>.<span class="number">0</span>-dev</span><br></pre></td></tr></table></figure><p>透過 Dockerfile 可以簡單了解到這個服務是怎麼啟動的，整體上來說非常簡單，除了安裝 confd 之外。就是把名為 <code>rootfs</code> 的目錄加進去，並且編譯客製化的 Nginx 接著啟動伺服器。</p><blockquote><p>這邊比較特別的地方是客製化編譯 Nginx 的部份，主要是因為 Deis 除了基本的 Nginx 功能外，也增加了防火牆模組（<a href="https://github.com/nbs-system/naxsi" rel="external nofollow noopener noreferrer" target="_blank">NAXSI</a>）跟一些模組在裡面，有興趣的可以自行閱讀 <code>rootfs/bin/build</code> 這個檔案的內容。</p></blockquote><h3 id="boot"><a href="#boot" class="headerlink" title="boot"></a>boot</h3><p>我想大家會覺得奇怪，為什麼不是直接執行 Nginx 而是執行一個名為 <code>boot</code> 的指令呢？<br>這是因為 Deis 除了啟動 Nginx 之外，還要將像是 confd 之類的服務也一併啟動。</p><blockquote><p>這邊比較有趣的是，一般會用 Shell Script 來處理。但是 Deis 使用 Golang 來做處理。</p></blockquote><p>從 Makefile 可以看出 <code>boot</code> 這個檔案是透過 Golang 的 Cross-compile 功能所編譯後，再構出 Docker 的 Image 來使用。</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">build: check-docker</span></span><br><span class="line">  GOOS=linux GOARCH=amd64 CGO_ENABLED=0 godep go build -a -installsuffix -v -ldflags '-s' -o <span class="variable">$(BINARY_DEST_DIR)</span>/boot cmd/boot/boot.go || exit 1</span><br><span class="line">  @<span class="variable">$(<span class="built_in">call</span> check-static-binary,rootfs/bin/boot)</span></span><br><span class="line">  docker build -t <span class="variable">$(IMAGE)</span> .</span><br><span class="line">  rm rootfs/bin/boot</span><br></pre></td></tr></table></figure><blockquote><p>所以如果要自己封裝，記得要用 <code>make build</code> 的指令，而不是直接 <code>docker build</code> 否則是會包出無法執行的 Image。</p></blockquote><p>從 <code>cmd/boot/boot.go</code> 可以發現引用了 <code>logger/stdout_formatter.go</code> 這個檔案，基本上就是統一格式化 Deis 輸出的紀錄檔訊息，因此這邊就不多做討論。</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="comment">// 略</span></span><br><span class="line"></span><br><span class="line">  log.Debug(<span class="string">"reading environment variables..."</span>)</span><br><span class="line">  host := getopt(<span class="string">"HOST"</span>, <span class="string">"127.0.0.1"</span>)</span><br><span class="line"></span><br><span class="line">  etcdPort := getopt(<span class="string">"ETCD_PORT"</span>, <span class="string">"4001"</span>)</span><br><span class="line"></span><br><span class="line">  etcdPath := getopt(<span class="string">"ETCD_PATH"</span>, <span class="string">"/deis/router"</span>)</span><br><span class="line"></span><br><span class="line">  hostEtcdPath := getopt(<span class="string">"HOST_ETCD_PATH"</span>, <span class="string">"/deis/router/hosts/"</span>+host)</span><br><span class="line"></span><br><span class="line">  externalPort := getopt(<span class="string">"EXTERNAL_PORT"</span>, <span class="string">"80"</span>)</span><br><span class="line"></span><br><span class="line">  client := etcd.NewClient([]<span class="keyword">string</span>&#123;<span class="string">"https://"</span> + host + <span class="string">":"</span> + etcdPort&#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// wait until etcd has discarded potentially stale values</span></span><br><span class="line">  time.Sleep(timeout + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">  log.Debug(<span class="string">"creating required defaults in etcd..."</span>)</span><br><span class="line">  mkdirEtcd(client, <span class="string">"/deis/config"</span>)</span><br><span class="line">  mkdirEtcd(client, <span class="string">"/deis/controller"</span>)</span><br><span class="line">  mkdirEtcd(client, <span class="string">"/deis/services"</span>)</span><br><span class="line">  mkdirEtcd(client, <span class="string">"/deis/domains"</span>)</span><br><span class="line">  mkdirEtcd(client, <span class="string">"/deis/builder"</span>)</span><br><span class="line">  mkdirEtcd(client, <span class="string">"/deis/certs"</span>)</span><br><span class="line">  mkdirEtcd(client, <span class="string">"/deis/router/hosts"</span>)</span><br><span class="line">  mkdirEtcd(client, <span class="string">"/deis/router/hsts"</span>)</span><br><span class="line"></span><br><span class="line">  setDefaultEtcd(client, etcdPath+<span class="string">"/gzip"</span>, <span class="string">"on"</span>)</span><br><span class="line"></span><br><span class="line">  log.Info(<span class="string">"Starting Nginx..."</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">go</span> tailFile(nginxAccessLog)</span><br><span class="line">  <span class="keyword">go</span> tailFile(nginxErrorLog)</span><br><span class="line"></span><br><span class="line">  nginxChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span><br><span class="line">  <span class="keyword">go</span> launchNginx(nginxChan)</span><br><span class="line">  &lt;-nginxChan</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">FIXME:</span> have to launch cron first so generate-certs will generate the files nginx requires</span></span><br><span class="line">  <span class="keyword">go</span> launchCron()</span><br><span class="line"></span><br><span class="line">  waitForInitialConfd(host+<span class="string">":"</span>+etcdPort, timeout)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">go</span> launchConfd(host + <span class="string">":"</span> + etcdPort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">go</span> publishService(client, hostEtcdPath, host, externalPort, <span class="keyword">uint64</span>(ttl.Seconds()))</span><br><span class="line"></span><br><span class="line">  log.Info(<span class="string">"deis-router running..."</span>)</span><br><span class="line"></span><br><span class="line">  exitChan := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">2</span>)</span><br><span class="line">  signal.Notify(exitChan, syscall.SIGTERM, syscall.SIGINT)</span><br><span class="line">  &lt;-exitChan</span><br><span class="line">  tail.Cleanup()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>基本上，整個 <code>main()</code> 分為兩個部分。</p><p>第一個部分是讀取環境變數的部份（透過 <code>getopt()</code> 方法），第二個部分則是啟動各項服務的部份。這邊比較特別的是利用 Golang 的 Channel 功能，做出依序啟動服務的效果。</p><blockquote><p>Golang 的 Channel 在做 <code>receive</code> 動作時，會阻止程式繼續運作。</p></blockquote><p>最後的 <code>signal.Notify</code> 可以設定當接收到一些 Signal 時要做出什麼對應的處理。</p><blockquote><p>這邊接受的是常見的中斷訊號，一般就是 Ctrl + C 會送過去的訊號。</p></blockquote><p>另外，這邊透過 <a href="https://github.com/hpcloud/tail" rel="external nofollow noopener noreferrer" target="_blank">tail</a> 這個函式庫將 Nginx 的記錄檔讀取出來，並且格式化後輸出到 stdout 顯示。</p><blockquote><p>使用 Docker 的好習慣就是要將當前運行的程式輸出一律導向 stdout / stderr 讓 Docker 來幫忙做記錄，否則所有的 Log 都會被存在 Container 裡面反而難以除錯。</p></blockquote><h3 id="confd"><a href="#confd" class="headerlink" title="confd"></a>confd</h3><p>confd 會監聽 etcd 的 key-value 變動情況，然後動態的執行一些指令。</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[template]</span></span><br><span class="line"><span class="attr">src</span>   = <span class="string">"nginx.conf"</span></span><br><span class="line"><span class="attr">dest</span>  = <span class="string">"/opt/nginx/conf/nginx.conf"</span></span><br><span class="line"><span class="attr">uid</span> = <span class="number">0</span></span><br><span class="line"><span class="attr">gid</span> = <span class="number">0</span></span><br><span class="line"><span class="attr">mode</span>  = <span class="string">"0644"</span></span><br><span class="line"><span class="attr">keys</span> = [</span><br><span class="line">   "/deis/config",</span><br><span class="line">   "/deis/services",</span><br><span class="line">   "/deis/router",</span><br><span class="line">   "/deis/domains",</span><br><span class="line">   "/deis/controller",</span><br><span class="line">   "/deis/builder",</span><br><span class="line">   "/deis/store/gateway",</span><br><span class="line">   "/deis/certs",</span><br><span class="line">]</span><br><span class="line"><span class="attr">check_cmd</span>  = <span class="string">"check &#123;&#123; .src &#125;&#125;"</span></span><br><span class="line"><span class="attr">reload_cmd</span> = <span class="string">"/opt/nginx/sbin/nginx -s reload"</span></span><br></pre></td></tr></table></figure><p>以 Nginx 的重起來說，當上述指定的 Key （如 <code>/deis/domains</code>）有更動，那麼就會先從樣板檔案產生新的設定檔，並且重新啟動 Nginx。</p><p>有興趣的話可以去看看 <code>rootfs/etc/confd</code> 的設定檔是如何撰寫的。</p><p>比較有趣的是 <code>/bin/generate-certs</code> 這個指令，他也是透過 confd 去產生的。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create or truncate the file</span></span><br><span class="line">&gt; /etc/ssl/deis_certs</span><br><span class="line"></span><br><span class="line">&#123;&#123; range <span class="variable">$cert</span> := ls <span class="string">"/deis/certs"</span> &#125;&#125;</span><br><span class="line"><span class="built_in">echo</span> &#123;&#123; <span class="variable">$cert</span> &#125;&#125; &gt;&gt; /etc/ssl/deis_certs</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br><span class="line"></span><br><span class="line">CERT_PATH=/etc/ssl/deis/certs</span><br><span class="line">KEY_PATH=/etc/ssl/deis/keys</span><br><span class="line"></span><br><span class="line"><span class="comment"># clean up all certs</span></span><br><span class="line">rm -rf <span class="variable">$CERT_PATH</span></span><br><span class="line">rm -rf <span class="variable">$KEY_PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ...then re-create the paths</span></span><br><span class="line">mkdir -p <span class="variable">$CERT_PATH</span></span><br><span class="line">mkdir -p <span class="variable">$KEY_PATH</span></span><br><span class="line"></span><br><span class="line">&#123;&#123; <span class="keyword">if</span> gt (len (lsdir <span class="string">"/deis/certs"</span>)) 0 &#125;&#125;</span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> etcd_path; <span class="keyword">do</span></span><br><span class="line">   &#123;&#123; range <span class="variable">$cert</span> := ls <span class="string">"/deis/certs"</span> &#125;&#125;</span><br><span class="line">   <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$etcd_path</span>"</span> == <span class="string">"&#123;&#123; <span class="variable">$cert</span> &#125;&#125;"</span> ]]; <span class="keyword">then</span></span><br><span class="line">     cat &lt;&lt; EOF &gt; <span class="string">"<span class="variable">$CERT_PATH</span>/<span class="variable">$etcd_path</span>.cert"</span></span><br><span class="line">&#123;&#123; getv (<span class="built_in">printf</span> <span class="string">"/deis/certs/%s/cert"</span> <span class="variable">$cert</span>) &#125;&#125;</span><br><span class="line">EOF</span><br><span class="line">     cat &lt;&lt; EOF &gt; <span class="string">"<span class="variable">$KEY_PATH</span>/<span class="variable">$etcd_path</span>.key"</span></span><br><span class="line">&#123;&#123; getv (<span class="built_in">printf</span> <span class="string">"/deis/certs/%s/key"</span> <span class="variable">$cert</span>) &#125;&#125;</span><br><span class="line">EOF</span><br><span class="line">   <span class="keyword">fi</span>&#123;&#123; end &#125;&#125;</span><br><span class="line"><span class="keyword">done</span> &lt; /etc/ssl/deis_certs</span><br><span class="line">&#123;&#123; <span class="keyword">else</span> &#125;&#125;</span><br><span class="line"><span class="comment"># there is no certificates to generate</span></span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure><p>這邊很有趣的是，他會從 etcd 裡面讀取每一組 SSL 的 Private Key / Certificates 並且依照 Key 產生一組檔案來寫入檔案。</p><blockquote><p>如此一來每一個不同 Domain 所需的 SSL 設定就可以透過 etcd 來做管理。不過其實另一方面來看，這個檔案其實會不斷地增長⋯⋯<br>在 <code>/bin/boot</code> 中，初次執行會設定一個 Cron Job 去執行這個指令，理由還不清楚不過應該是為了修正檔案沒有順利產生之類的問題吧（就註解來看是一個修正）</p></blockquote><hr><p>到此為止，基本上一個簡單的 Router 就算是設定完成了。<br>如果對防火牆設定有興趣的話，可以參考 <code>rootfs/opt/nginx</code> 裡面的設定是如何撰寫的。</p><p>大致上剩下的都是設定檔的部份，稍微詳讀之後就可以瞭解其背後運作的原理。<br>若要建構自己的簡易 Router 參考這樣的方式設計，其實也沒有想像中的困難。</p><footer class="article__footer"><div class="text-center"><div class="fb-share-button" data-href="https://blog.frost.tw/posts/2016/02/03/how-deis-architecture-design-part-2/" data-layout="button_count"></div></div><p align="center"><a href="https://ko-fi.com/J3J78093" target="_blank" rel="external nofollow noopener noreferrer"><img height="36" style="border:0;height:36px" src="https://az743702.vo.msecnd.net/cdn/kofi5.png?v=0" border="0" alt="Buy Me a Coffee at ko-fi.com"></a></p><iframe scrolling="no" frameborder="0" style="display:block;margin:0 auto;height:212px" src="https://button.like.co/in/embed/elct9620/button?referrer=https://blog.frost.tw/posts/2016/02/03/how-deis-architecture-design-part-2/"></iframe><ul class="article__tag-list"><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/CoreOS/">CoreOS</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/Deis/">Deis</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/PaaS/">PaaS</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/筆記/">筆記</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/雲端/">雲端</a></li></ul></footer></div></article><div class="adv"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2844969736316510" data-ad-slot="5530952976" data-ad-format="auto"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><section id="comment" class="comment-box"><h1 class="comment-box__title">留言</h1><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a rel="nofollow" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></div><footer id="footer"><div id="copyright">&copy;2013 <a href="https://plus.google.com/117236344655673213049?rel=author" target="_blank" rel="external nofollow noopener noreferrer">蒼時弦也</a>. All right reversed.</div></footer><script type="text/javascript">window.disqus_shortname="revo-skill-frost",function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+window.disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5TQLRN" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><script>!function(e,t,a,n,g){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var m=t.getElementsByTagName(a)[0],r=t.createElement(a);r.async=!0,r.src="//www.googletagmanager.com/gtm.js?id=GTM-5TQLRN",m.parentNode.insertBefore(r,m)}(window,document,"script","dataLayer")</script><script>window.fbAsyncInit=function(){FB.init({appId:"178355449110",xfbml:!0,version:"v2.12"}),FB.AppEvents.logPageView()},function(e,n,t){var o,s=e.getElementsByTagName(n)[0];e.getElementById(t)||((o=e.createElement(n)).id=t,o.src="https://connect.facebook.net/zh_TW/sdk.js",o.async=!0,s.parentNode.insertBefore(o,s))}(document,"script","facebook-jssdk")</script><script src="/js/app.js"></script><div class="loading"></div></body></html>