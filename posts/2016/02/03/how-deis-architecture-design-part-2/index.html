<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  
  <title>Deis 架構分析（二） | 弦而時習之</title>
  <meta name="theme-color" content="#EFEFEF">

  <meta name="author" content="蒼時弦也">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1">

  <meta name="description" content="延續上一篇的內容，這篇文章要先來討論比較好懂的 Router 部分。 首先，在 Deis 的設計裡面，基本上所有的服務都是包成一個 Image 作為 Continaer 在 CoreOS 運行的。就這點來看，其實是非常符合 Mircoservice 架構的設計。同時我們也可以很輕鬆地將這些服務獨立出來使用，這篇文章討論的 Router 除了原本的用途外，也很適合用來學習透過 etcd 部署自動化更">
<meta name="keywords" content="雲端,筆記,CoreOS,Deis,paas">
<meta property="og:type" content="article">
<meta property="og:title" content="Deis 架構分析（二）">
<meta property="og:url" content="https://blog.frost.tw/posts/2016/02/03/how-deis-architecture-design-part-2/">
<meta property="og:site_name" content="弦而時習之">
<meta property="og:description" content="延續上一篇的內容，這篇文章要先來討論比較好懂的 Router 部分。 首先，在 Deis 的設計裡面，基本上所有的服務都是包成一個 Image 作為 Continaer 在 CoreOS 運行的。就這點來看，其實是非常符合 Mircoservice 架構的設計。同時我們也可以很輕鬆地將這些服務獨立出來使用，這篇文章討論的 Router 除了原本的用途外，也很適合用來學習透過 etcd 部署自動化更">
<meta property="og:locale" content="zh-TW">
<meta property="og:image" content="http://blog.frost.tw/icon-512.png">
<meta property="og:updated_time" content="2017-07-02T17:07:07.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Deis 架構分析（二）">
<meta name="twitter:description" content="延續上一篇的內容，這篇文章要先來討論比較好懂的 Router 部分。 首先，在 Deis 的設計裡面，基本上所有的服務都是包成一個 Image 作為 Continaer 在 CoreOS 運行的。就這點來看，其實是非常符合 Mircoservice 架構的設計。同時我們也可以很輕鬆地將這些服務獨立出來使用，這篇文章討論的 Router 除了原本的用途外，也很適合用來學習透過 etcd 部署自動化更">
<meta name="twitter:image" content="http://blog.frost.tw/icon-512.png">
<link rel="publisher" href="https://plus.google.com/117236344655673213049">
<meta property="fb:app_id" content="178355449110">

  <meta property="fb:pages" content="180666522388" />
  <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Blog",
    "name": "弦而時習之",
    "url": "https://blog.frost.tw",
    "image": "http://blog.frost.tw/icon-512.png",
    "description": "蒼時弦也的個人網誌，專注在前端、後端以及遊戲開發，大多使用 Ruby 和 Ruby on Rails 以及 Golang、JS 和 C 語言。",
    "sameAs": [
      "https://www.facebook.com/frost.tw/"
    ]
}
</script>
<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Person",
    "name": "蒼時弦也",
    "url": "https://blog.frost.tw",
    "sameAs": [
      "https://www.facebook.com/elct9620",
      "https://www.instagram.com/elct9620/",
      "https://twitter.com/elct9620",
      "https://plus.google.com/+%E8%92%BC%E6%99%82%E5%BC%A6%E4%B9%9F-plus",
      "https://www.linkedin.com/in/elct9620"
    ]
}
</script>

<script type="application/ld+json">
{
  "@context":"http://schema.org",
  "@type":"Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.frost.tw/posts/2016/02/03/how-deis-architecture-design-part-2/"
  },
  "headline":"Deis 架構分析（二）",
  "image": [
    
    "http://blog.frost.tw/icon-512.png"
  ],
  "datePublished": "2016-02-03T07:54:00.000Z",
  "dateModified": "2017-07-02T17:07:07.000Z",
  "description":"延續上一篇的內容，這篇文章要先來討論比較好懂的 Router 部分。首先，在 Deis 的設計裡面，基本上所有的服務都是包成一個 Image 作為 Continaer 在 CoreOS 運行的。就這點來看，其實是非常符合 Mircoservice 架構的設計。同時我們也可以很輕鬆地將這些服務獨立出來使用，這篇文章討論的 Router 除了原本的用途外，也很適合用來學習透過 etcd 部署自動化更新設定檔的環境。Deis 的原始碼都放在一起，其中 Router 部分是裡面的一個子目錄，那麼就讓我們開始了解運行的架構吧！",
  "author": {
    "@type": "Person",
    "name": "蒼時弦也"
  },
  "publisher": {
    "@type": "Organization",
    "name": "蒼時弦也",
    "logo": {
      "@type": "ImageObject",
      "url": "http://blog.forst.tw/logo-wide.png"
    }
  }
}
</script>




  
  <link rel="canonical" href="https://blog.frost.tw/posts/2016/02/03/how-deis-architecture-design-part-2/" />
  
  <link href="/icon-512.png" rel="icon">
  <link rel="alternate" href="/feed.xml" title="弦而時習之" type="application/rss+xml">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <script async src="/js/turbolinks.js"></script>
</head>

  <body>
    <div id="fb-root" data-turbolinks-permanent></div>
    <header id="header">
      
<h1 id="sitename">
  <a href="/" class="hide-text logo--icon align-center">
  弦而時習之
  </a>
</h1>

<aside id="slogan" class="slogan align-center text-center">
  <h2 class="slogan__title">Aotokitsuruya</h2>
  <p class="slogan__description">The Web is attracting  me, so I start learning PHP, HTML, CSS and JavaScript. When I know about Ruby, I fall in love with it. Now, I working with my friend to design games using C++ and still learning web about Golang, Ruby and JavaScript. In the other side, I also be a designer, the reason why the web is attracted me.</p>
</aside>

    </header>
    <div id="wrapper">
      
<article class="post article">
  <header class="article__header">
    <time datetime="2016-02-03T07:54:00.000Z" class="article__time--header">
      Feb.03
    </time>
    
  
    <h1 class="article__title">Deis 架構分析（二）</h1>
  


  </header>
  <div class="article__entry">
    
    <p>延續<a href="http://blog.frost.tw/posts/2016/01/31/how-deis-architecture-design-part-1">上一篇</a>的內容，這篇文章要先來討論比較好懂的 <code>Router</code> 部分。</p>
<p>首先，在 Deis 的設計裡面，基本上所有的服務都是包成一個 Image 作為 Continaer 在 CoreOS 運行的。就這點來看，其實是非常符合 Mircoservice 架構的設計。同時我們也可以很輕鬆地將這些服務獨立出來使用，這篇文章討論的 <code>Router</code> 除了原本的用途外，也很適合用來學習透過 etcd 部署自動化更新設定檔的環境。</p>
<p>Deis 的原始碼都放在一起，其中 <a href="https://github.com/deis/deis/tree/master/router" target="_blank" rel="noopener">Router</a> 部分是裡面的一個子目錄，那麼就讓我們開始了解運行的架構吧！</p>
<a id="more"></a>
<h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> alpine:<span class="number">3.2</span></div><div class="line"></div><div class="line"><span class="comment"># install common packages</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apk add --update-cache \</span></div><div class="line">  bash \</div><div class="line">  curl \</div><div class="line">  geoip \</div><div class="line">  libssl1.0 \</div><div class="line">  openssl \</div><div class="line">  pcre \</div><div class="line">  sudo \</div><div class="line">  &amp;&amp; rm -rf /var/cache/apk/*</div><div class="line"></div><div class="line"><span class="comment"># install confd</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> curl -sSL -o /usr/<span class="built_in">local</span>/bin/confd https://s3-us-west-2.amazonaws.com/opdemand/confd-git-73f7489 \</span></div><div class="line">  &amp;&amp; chmod +x /usr/<span class="built_in">local</span>/bin/confd</div><div class="line"></div><div class="line"><span class="comment"># add nginx user</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> addgroup -S nginx &amp;&amp; \</span></div><div class="line">  adduser -S -G nginx -H -h /opt/nginx -s /sbin/nologin -D nginx</div><div class="line"></div><div class="line"><span class="keyword">COPY</span><span class="bash"> rootfs /</span></div><div class="line"></div><div class="line"><span class="comment"># compile nginx from source</span></div><div class="line"><span class="keyword">RUN</span><span class="bash"> build</span></div><div class="line"></div><div class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"boot"</span>]</span></div><div class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span> <span class="number">2222</span> <span class="number">9090</span></div><div class="line"></div><div class="line"><span class="keyword">ENV</span> DEIS_RELEASE <span class="number">1.13</span>.<span class="number">0</span>-dev</div></pre></td></tr></table></figure>
<p>透過 Dockerfile 可以簡單了解到這個服務是怎麼啟動的，整體上來說非常簡單，除了安裝 confd 之外。就是把名為 <code>rootfs</code> 的目錄加進去，並且編譯客製化的 Nginx 接著啟動伺服器。</p>
<blockquote>
<p>這邊比較特別的地方是客製化編譯 Nginx 的部份，主要是因為 Deis 除了基本的 Nginx 功能外，也增加了防火牆模組（<a href="https://github.com/nbs-system/naxsi" target="_blank" rel="noopener">NAXSI</a>）跟一些模組在裡面，有興趣的可以自行閱讀 <code>rootfs/bin/build</code> 這個檔案的內容。</p>
</blockquote>
<h3 id="boot"><a href="#boot" class="headerlink" title="boot"></a>boot</h3><p>我想大家會覺得奇怪，為什麼不是直接執行 Nginx 而是執行一個名為 <code>boot</code> 的指令呢？<br>這是因為 Deis 除了啟動 Nginx 之外，還要將像是 confd 之類的服務也一併啟動。</p>
<blockquote>
<p>這邊比較有趣的是，一般會用 Shell Script 來處理。但是 Deis 使用 Golang 來做處理。</p>
</blockquote>
<p>從 Makefile 可以看出 <code>boot</code> 這個檔案是透過 Golang 的 Cross-compile 功能所編譯後，再構出 Docker 的 Image 來使用。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="section">build: check-docker</span></div><div class="line">  GOOS=linux GOARCH=amd64 CGO_ENABLED=0 godep go build -a -installsuffix -v -ldflags '-s' -o <span class="variable">$(BINARY_DEST_DIR)</span>/boot cmd/boot/boot.go || exit 1</div><div class="line">  @<span class="variable">$(<span class="built_in">call</span> check-static-binary,rootfs/bin/boot)</span></div><div class="line">  docker build -t <span class="variable">$(IMAGE)</span> .</div><div class="line">  rm rootfs/bin/boot</div></pre></td></tr></table></figure>
<blockquote>
<p>所以如果要自己封裝，記得要用 <code>make build</code> 的指令，而不是直接 <code>docker build</code> 否則是會包出無法執行的 Image。</p>
</blockquote>
<p>從 <code>cmd/boot/boot.go</code> 可以發現引用了 <code>logger/stdout_formatter.go</code> 這個檔案，基本上就是統一格式化 Deis 輸出的紀錄檔訊息，因此這邊就不多做討論。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="comment">// 略</span></div><div class="line"></div><div class="line">  log.Debug(<span class="string">"reading environment variables..."</span>)</div><div class="line">  host := getopt(<span class="string">"HOST"</span>, <span class="string">"127.0.0.1"</span>)</div><div class="line"></div><div class="line">  etcdPort := getopt(<span class="string">"ETCD_PORT"</span>, <span class="string">"4001"</span>)</div><div class="line"></div><div class="line">  etcdPath := getopt(<span class="string">"ETCD_PATH"</span>, <span class="string">"/deis/router"</span>)</div><div class="line"></div><div class="line">  hostEtcdPath := getopt(<span class="string">"HOST_ETCD_PATH"</span>, <span class="string">"/deis/router/hosts/"</span>+host)</div><div class="line"></div><div class="line">  externalPort := getopt(<span class="string">"EXTERNAL_PORT"</span>, <span class="string">"80"</span>)</div><div class="line"></div><div class="line">  client := etcd.NewClient([]<span class="keyword">string</span>&#123;<span class="string">"http://"</span> + host + <span class="string">":"</span> + etcdPort&#125;)</div><div class="line"></div><div class="line">  <span class="comment">// wait until etcd has discarded potentially stale values</span></div><div class="line">  time.Sleep(timeout + <span class="number">1</span>)</div><div class="line"></div><div class="line">  log.Debug(<span class="string">"creating required defaults in etcd..."</span>)</div><div class="line">  mkdirEtcd(client, <span class="string">"/deis/config"</span>)</div><div class="line">  mkdirEtcd(client, <span class="string">"/deis/controller"</span>)</div><div class="line">  mkdirEtcd(client, <span class="string">"/deis/services"</span>)</div><div class="line">  mkdirEtcd(client, <span class="string">"/deis/domains"</span>)</div><div class="line">  mkdirEtcd(client, <span class="string">"/deis/builder"</span>)</div><div class="line">  mkdirEtcd(client, <span class="string">"/deis/certs"</span>)</div><div class="line">  mkdirEtcd(client, <span class="string">"/deis/router/hosts"</span>)</div><div class="line">  mkdirEtcd(client, <span class="string">"/deis/router/hsts"</span>)</div><div class="line"></div><div class="line">  setDefaultEtcd(client, etcdPath+<span class="string">"/gzip"</span>, <span class="string">"on"</span>)</div><div class="line"></div><div class="line">  log.Info(<span class="string">"Starting Nginx..."</span>)</div><div class="line"></div><div class="line">  <span class="keyword">go</span> tailFile(nginxAccessLog)</div><div class="line">  <span class="keyword">go</span> tailFile(nginxErrorLog)</div><div class="line"></div><div class="line">  nginxChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</div><div class="line">  <span class="keyword">go</span> launchNginx(nginxChan)</div><div class="line">  &lt;-nginxChan</div><div class="line"></div><div class="line">  <span class="comment">// <span class="doctag">FIXME:</span> have to launch cron first so generate-certs will generate the files nginx requires</span></div><div class="line">  <span class="keyword">go</span> launchCron()</div><div class="line"></div><div class="line">  waitForInitialConfd(host+<span class="string">":"</span>+etcdPort, timeout)</div><div class="line"></div><div class="line">  <span class="keyword">go</span> launchConfd(host + <span class="string">":"</span> + etcdPort)</div><div class="line"></div><div class="line">  <span class="keyword">go</span> publishService(client, hostEtcdPath, host, externalPort, <span class="keyword">uint64</span>(ttl.Seconds()))</div><div class="line"></div><div class="line">  log.Info(<span class="string">"deis-router running..."</span>)</div><div class="line"></div><div class="line">  exitChan := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">2</span>)</div><div class="line">  signal.Notify(exitChan, syscall.SIGTERM, syscall.SIGINT)</div><div class="line">  &lt;-exitChan</div><div class="line">  tail.Cleanup()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>基本上，整個 <code>main()</code> 分為兩個部分。</p>
<p>第一個部分是讀取環境變數的部份（透過 <code>getopt()</code> 方法），第二個部分則是啟動各項服務的部份。這邊比較特別的是利用 Golang 的 Channel 功能，做出依序啟動服務的效果。</p>
<blockquote>
<p>Golang 的 Channel 在做 <code>receive</code> 動作時，會阻止程式繼續運作。</p>
</blockquote>
<p>最後的 <code>signal.Notify</code> 可以設定當接收到一些 Signal 時要做出什麼對應的處理。</p>
<blockquote>
<p>這邊接受的是常見的中斷訊號，一般就是 Ctrl + C 會送過去的訊號。</p>
</blockquote>
<p>另外，這邊透過 <a href="https://github.com/hpcloud/tail" target="_blank" rel="noopener">tail</a> 這個函式庫將 Nginx 的記錄檔讀取出來，並且格式化後輸出到 stdout 顯示。</p>
<blockquote>
<p>使用 Docker 的好習慣就是要將當前運行的程式輸出一律導向 stdout / stderr 讓 Docker 來幫忙做記錄，否則所有的 Log 都會被存在 Container 裡面反而難以除錯。</p>
</blockquote>
<h3 id="confd"><a href="#confd" class="headerlink" title="confd"></a>confd</h3><p>confd 會監聽 etcd 的 key-value 變動情況，然後動態的執行一些指令。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[template]</div><div class="line">src   = "nginx.conf"</div><div class="line">dest  = "/opt/nginx/conf/nginx.conf"</div><div class="line">uid = 0</div><div class="line">gid = 0</div><div class="line">mode  = "0644"</div><div class="line">keys = [</div><div class="line">   "/deis/config",</div><div class="line">   "/deis/services",</div><div class="line">   "/deis/router",</div><div class="line">   "/deis/domains",</div><div class="line">   "/deis/controller",</div><div class="line">   "/deis/builder",</div><div class="line">   "/deis/store/gateway",</div><div class="line">   "/deis/certs",</div><div class="line">]</div><div class="line">check_cmd  = "check &#123;&#123; .src &#125;&#125;"</div><div class="line">reload_cmd = "/opt/nginx/sbin/nginx -s reload"</div></pre></td></tr></table></figure>
<p>以 Nginx 的重起來說，當上述指定的 Key （如 <code>/deis/domains</code>）有更動，那麼就會先從樣板檔案產生新的設定檔，並且重新啟動 Nginx。</p>
<p>有興趣的話可以去看看 <code>rootfs/etc/confd</code> 的設定檔是如何撰寫的。</p>
<p>比較有趣的是 <code>/bin/generate-certs</code> 這個指令，他也是透過 confd 去產生的。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/usr/bin/env bash</span></div><div class="line"></div><div class="line"><span class="comment"># create or truncate the file</span></div><div class="line">&gt; /etc/ssl/deis_certs</div><div class="line"></div><div class="line">&#123;&#123; range <span class="variable">$cert</span> := ls <span class="string">"/deis/certs"</span> &#125;&#125;</div><div class="line"><span class="built_in">echo</span> &#123;&#123; <span class="variable">$cert</span> &#125;&#125; &gt;&gt; /etc/ssl/deis_certs</div><div class="line">&#123;&#123; end &#125;&#125;</div><div class="line"></div><div class="line">CERT_PATH=/etc/ssl/deis/certs</div><div class="line">KEY_PATH=/etc/ssl/deis/keys</div><div class="line"></div><div class="line"><span class="comment"># clean up all certs</span></div><div class="line">rm -rf <span class="variable">$CERT_PATH</span></div><div class="line">rm -rf <span class="variable">$KEY_PATH</span></div><div class="line"></div><div class="line"><span class="comment"># ...then re-create the paths</span></div><div class="line">mkdir -p <span class="variable">$CERT_PATH</span></div><div class="line">mkdir -p <span class="variable">$KEY_PATH</span></div><div class="line"></div><div class="line">&#123;&#123; <span class="keyword">if</span> gt (len (lsdir <span class="string">"/deis/certs"</span>)) 0 &#125;&#125;</div><div class="line"><span class="keyword">while</span> <span class="built_in">read</span> etcd_path; <span class="keyword">do</span></div><div class="line">   &#123;&#123; range <span class="variable">$cert</span> := ls <span class="string">"/deis/certs"</span> &#125;&#125;</div><div class="line">   <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$etcd_path</span>"</span> == <span class="string">"&#123;&#123; <span class="variable">$cert</span> &#125;&#125;"</span> ]]; <span class="keyword">then</span></div><div class="line">     cat &lt;&lt; EOF &gt; <span class="string">"<span class="variable">$CERT_PATH</span>/<span class="variable">$etcd_path</span>.cert"</span></div><div class="line">&#123;&#123; getv (<span class="built_in">printf</span> <span class="string">"/deis/certs/%s/cert"</span> <span class="variable">$cert</span>) &#125;&#125;</div><div class="line">EOF</div><div class="line">     cat &lt;&lt; EOF &gt; <span class="string">"<span class="variable">$KEY_PATH</span>/<span class="variable">$etcd_path</span>.key"</span></div><div class="line">&#123;&#123; getv (<span class="built_in">printf</span> <span class="string">"/deis/certs/%s/key"</span> <span class="variable">$cert</span>) &#125;&#125;</div><div class="line">EOF</div><div class="line">   <span class="keyword">fi</span>&#123;&#123; end &#125;&#125;</div><div class="line"><span class="keyword">done</span> &lt; /etc/ssl/deis_certs</div><div class="line">&#123;&#123; <span class="keyword">else</span> &#125;&#125;</div><div class="line"><span class="comment"># there is no certificates to generate</span></div><div class="line">&#123;&#123; end &#125;&#125;</div></pre></td></tr></table></figure>
<p>這邊很有趣的是，他會從 etcd 裡面讀取每一組 SSL 的 Private Key / Certificates 並且依照 Key 產生一組檔案來寫入檔案。</p>
<blockquote>
<p>如此一來每一個不同 Domain 所需的 SSL 設定就可以透過 etcd 來做管理。不過其實另一方面來看，這個檔案其實會不斷地增長⋯⋯<br>在 <code>/bin/boot</code> 中，初次執行會設定一個 Cron Job 去執行這個指令，理由還不清楚不過應該是為了修正檔案沒有順利產生之類的問題吧（就註解來看是一個修正）</p>
</blockquote>
<hr>
<p>到此為止，基本上一個簡單的 Router 就算是設定完成了。<br>如果對防火牆設定有興趣的話，可以參考 <code>rootfs/opt/nginx</code> 裡面的設定是如何撰寫的。</p>
<p>大致上剩下的都是設定檔的部份，稍微詳讀之後就可以瞭解其背後運作的原理。<br>若要建構自己的簡易 Router 參考這樣的方式設計，其實也沒有想像中的困難。</p>

    
    <footer class="article__footer">
      
        <div class="text-center">
          <div class="fb-share-button"
               data-href="https://blog.frost.tw/posts/2016/02/03/how-deis-architecture-design-part-2/"
               data-layout="button_count">
          </div>
        </div>
        <p align="center">
          <a href='https://ko-fi.com/J3J78093' target='_blank'>
            <img height='36' style='border:0px;height:36px;' src='https://az743702.vo.msecnd.net/cdn/kofi5.png?v=0' border='0' alt='Buy Me a Coffee at ko-fi.com' />
          </a>
        </p>
        
          <ul class="article__tag-list"><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/CoreOS/">CoreOS</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/Deis/">Deis</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/paas/">paas</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/筆記/">筆記</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/雲端/">雲端</a></li></ul>
        
      
    </footer>
  </div>
</article>


  
    <div class="adv">
      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      <!-- 網誌_文末廣告 (Hexo) -->
      <ins class="adsbygoogle"
      style="display:block"
      data-ad-client="ca-pub-2844969736316510"
      data-ad-slot="5530952976"
      data-ad-format="auto"></ins>
      <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
  

  
<section id="comment" class="comment-box">
  <h1 class="comment-box__title">留言</h1>

  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></noscript>
  </div>
</section>






    </div>
    <footer id="footer">
      <div id="copyright">
  &copy;2013 <a href="https://plus.google.com/117236344655673213049?rel=author" target="_blank">蒼時弦也</a>. All right reversed.
</div>

    </footer>
    

  
  <script type="text/javascript">
  var disqus_shortname = 'revo-skill-frost';

  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }());
  </script>
  

  
  <!-- Google Tag Manager -->
  <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5TQLRN"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-5TQLRN');</script>
  <!-- End Google Tag Manager -->
  

  <script>
    window.fbAsyncInit = function() {
      FB.init({
        appId      : '178355449110',
        xfbml      : true,
        version    : 'v2.12'
      });

      FB.AppEvents.logPageView();

    };

    (function(d, s, id){
       var js, fjs = d.getElementsByTagName(s)[0];
       if (d.getElementById(id)) {return;}
       js = d.createElement(s); js.id = id;
       js.src = "https://connect.facebook.net/zh_TW/sdk.js";
       fjs.parentNode.insertBefore(js, fjs);
     }(document, 'script', 'facebook-jssdk'));
  </script>

  <script src="/js/app.js"></script>


    <div class="loading"></div>
  </body>
</html>
