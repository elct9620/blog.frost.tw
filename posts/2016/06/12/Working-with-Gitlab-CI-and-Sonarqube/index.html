<!DOCTYPE html><html lang="zh-TW"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><title>使用 Gitlab CI 整合 SonarQube | 弦而時習之</title><meta name="theme-color" content="#EFEFEF"><meta name="author" content="蒼時弦也"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="蒼時弦也的個人網誌，專注在前端、後端以及遊戲開發，大多使用 Ruby 和 Ruby on Rails 以及 Golang、JS 和 C 語言。"><meta name="keywords" content="心得,Gitlab,Android"><meta property="og:type" content="article"><meta property="og:title" content="使用 Gitlab CI 整合 SonarQube"><meta property="og:url" content="https://blog.frost.tw/posts/2016/06/12/Working-with-Gitlab-CI-and-Sonarqube/"><meta property="og:site_name" content="弦而時習之"><meta property="og:description" content="蒼時弦也的個人網誌，專注在前端、後端以及遊戲開發，大多使用 Ruby 和 Ruby on Rails 以及 Golang、JS 和 C 語言。"><meta property="og:locale" content="zh-TW"><meta property="og:image" content="https://blog.frost.tw/images/working-gitlab-ci-with-sonarqube/rancher.png"><meta property="og:updated_time" content="2019-06-22T02:47:31.569Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="使用 Gitlab CI 整合 SonarQube"><meta name="twitter:description" content="蒼時弦也的個人網誌，專注在前端、後端以及遊戲開發，大多使用 Ruby 和 Ruby on Rails 以及 Golang、JS 和 C 語言。"><meta name="twitter:image" content="https://blog.frost.tw/images/working-gitlab-ci-with-sonarqube/rancher.png"><link rel="publisher" href="https://plus.google.com/117236344655673213049"><meta property="fb:app_id" content="178355449110"><meta property="fb:pages" content="180666522388"><script type="application/ld+json">[
{
    "@context": "http://schema.org",
    "@type": "Blog",
    "name": "弦而時習之",
    "url": "https://blog.frost.tw",
    "image": "http://blog.frost.tw/icon-512.png",
    "description": "蒼時弦也的個人網誌，專注在前端、後端以及遊戲開發，大多使用 Ruby 和 Ruby on Rails 以及 Golang、JS 和 C 語言。",
    "sameAs": [
      "https://www.facebook.com/frost.tw/"
    ]
},
{
    "@context": "http://schema.org",
    "@type": "Person",
    "name": "蒼時弦也",
    "url": "https://blog.frost.tw",
    "sameAs": [
      "https://www.facebook.com/elct9620",
      "https://www.instagram.com/elct9620/",
      "https://twitter.com/elct9620",
      "https://plus.google.com/+%E8%92%BC%E6%99%82%E5%BC%A6%E4%B9%9F-plus",
      "https://www.linkedin.com/in/elct9620"
    ]
},
{
  "@context":"http://schema.org",
  "@type":"BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.frost.tw/posts/2016/06/12/Working-with-Gitlab-CI-and-Sonarqube/"
  },
  "headline":"使用 Gitlab CI 整合 SonarQube",
  "image": [
    
    "/images/working-gitlab-ci-with-sonarqube/rancher.png",
    
    "http://blog.frost.tw/icon-512.png"
  ],
  "thumbnailUrl": "/images/working-gitlab-ci-with-sonarqube/rancher.png", 
  "datePublished": "2016-06-12T07:12:10.000Z",
  "dateModified": "2019-06-22T02:47:31.569Z",
  "description":"之前都在偷懶沒有寫網誌，剛好這次端午連假比較長。所以想做測試跟實驗的部分都做完了，就來寫一篇關於 Gitlab CI 整合的經驗分享。文章中大致上會涵蓋這些部分：Gitlab CI 基本使用Rancher建置環境SonarQube 基本使用Gitlab CI 整合環境文章會以我在建構 CI 環境的過程中來講解，一些安裝跟配置的部分會直接跳過。",
  "author": {
    "@type": "Person",
    "name": "蒼時弦也"
  },
  "publisher": {
    "@type": "Organization",
    "name": "蒼時弦也",
    "logo": {
      "@type": "ImageObject",
      "url": "http://blog.forst.tw/logo-wide.png"
    }
  }
},
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
    "@type": "ListItem",
    "position": 1,
    "item": {
      "@id": "https://blog.frost.tw",
      "name": "弦而時習之 ",
      "image": "http://blog.frost.tw/icon-512.png"
    }
  },{
    "@type": "ListItem",
    "position": 2,
    "item": {
      "@id": "https://blog.frost.tw/posts/2016/06/12/Working-with-Gitlab-CI-and-Sonarqube/",
      "name": "使用 Gitlab CI 整合 SonarQube",
      "image": "/images/working-gitlab-ci-with-sonarqube/rancher.png"
    }
  }]
}

]</script><link rel="canonical" href="https://blog.frost.tw/posts/2016/06/12/Working-with-Gitlab-CI-and-Sonarqube/"><link href="/icon-512.png" rel="icon"><link rel="alternate" href="/feed.xml" title="弦而時習之" type="application/rss+xml"><!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--><link rel="stylesheet" href="/css/style.css" media="screen" type="text/css"><script async src="/js/turbolinks.js"></script></head><body><div id="fb-root" data-turbolinks-permanent></div><header id="header"><h1 id="sitename"><a href="/" class="hide-text logo--icon align-center">弦而時習之</a></h1><aside id="slogan" class="slogan align-center text-center"><h2 class="slogan__title">Aotokitsuruya</h2><p class="slogan__description">The Web is attracting me, so I start learning PHP, HTML, CSS and JavaScript. When I know about Ruby, I fall in love with it. Now, I working with my friend to design games using C++ and still learning web about Golang, Ruby and JavaScript. In the other side, I also be a designer, the reason why the web is attracted me.</p></aside></header><div id="wrapper"><article class="post article"><header class="article__header"><time datetime="2016-06-12T07:12:10.000Z" class="article__time--header">Jun.12</time><h1 class="article__title">使用 Gitlab CI 整合 SonarQube</h1></header><div class="article__entry"><p>之前都在偷懶沒有寫網誌，剛好這次端午連假比較長。<br>所以想做測試跟實驗的部分都做完了，就來寫一篇關於 Gitlab CI 整合的經驗分享。</p><p>文章中大致上會涵蓋這些部分：</p><ul><li>Gitlab CI 基本使用</li><li>Rancher建置環境</li><li>SonarQube 基本使用</li><li>Gitlab CI 整合環境</li></ul><p>文章會以我在建構 CI 環境的過程中來講解，一些安裝跟配置的部分會直接跳過。</p><a id="more"></a><h3 id="硬體環境"><a href="#硬體環境" class="headerlink" title="硬體環境"></a>硬體環境</h3><p>因為我主要是幫老爸公司建構這個環境的，所以這些配置是基於一個很小的開發團隊（不足十人）的情況去設置的，如果團隊比較大或者有其他需求，不一定會適用。</p><p>這個環境會出現兩台機器，不過實際上使用的只有一台。</p><ul><li>Synology DS1512+</li><li>Server 等級 :: i7-3820 3.6GHz / 8G RAM</li></ul><p>目前裡面只有使用這兩台 Server 下面那台是自行組的，放在一個小機櫃這樣 XD</p><blockquote><p>內部網路環境用的是 1Gbps 的 Switch 這樣</p></blockquote><p>伺服器因為組了也有三四年，裡面用的是單顆 SSD 原本是 96GB 的前陣子換成 256GB 的 SSD，不過為了避免容量爆炸所以透過 NAS 設定了 ISCSI 給 Server 用，容量是 1TB 這樣。</p><blockquote><p>不過體驗到了 Docker Pull 的慢速，所以 ISCSI 只用在 Container 本身的資料保存。</p></blockquote><h3 id="軟體環境"><a href="#軟體環境" class="headerlink" title="軟體環境"></a>軟體環境</h3><p>伺服器上用的是 Ubuntu 14.04 版本，裡面只安裝以下三個套件。</p><ul><li>Nginx - 做反向代理</li><li>Docker</li><li>Rancher - Container 管理</li></ul><p>所有的服務都是透過 Docker 架設，對外的 Web 介面則用 Nginx 導出。</p><blockquote><p>Production 不能這樣玩，像是 Database 會有效能貧頸等等問題。</p></blockquote><h3 id="開發環境"><a href="#開發環境" class="headerlink" title="開發環境"></a>開發環境</h3><p>一張圖解釋 XD</p><p><img src="/images/working-gitlab-ci-with-sonarqube/rancher.png" alt="Rancher 配置"></p><p>Fluentd 是拿來玩的，至於配置的話都是使用 <code>docker-compose.yml</code> 上傳設定來處理的。</p><figure class="highlight yaml"><figcaption><span>gitlab.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">postgresql:</span></span><br><span class="line"><span class="attr">  restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">sameersbn/postgresql:9.4-18</span></span><br><span class="line"><span class="attr">  environment:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">DB_USER=gitlab</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">DB_PASS=[hidden]</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">DB_NAME=gitlabhq_production</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">DB_EXTENSION=pg_trgm</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/gitlab/postgresql:/var/lib/postgresql</span></span><br><span class="line"><span class="attr">gitlab:</span></span><br><span class="line"><span class="attr">  restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">sameersbn/gitlab:8.6.4</span></span><br><span class="line"><span class="attr">  links:</span></span><br><span class="line"><span class="attr">    - redis:</span><span class="string">redisio</span></span><br><span class="line"><span class="attr">    - postgresql:</span><span class="string">postgresql</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"10080:80"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"10022:22"</span></span><br><span class="line"><span class="attr">  environment:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">DEBUG=false</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">TZ=Asia/Taipei</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">GITLAB_TIMEZONE=Taipei</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">    -</span> <span class="string">GITLAB_SECRETS_DB_KEY_BASE=[hidden]</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">    -</span> <span class="string">GITLAB_HOST=localhost</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">GITLAB_PORT=10080</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">GITLAB_SSH_PORT=10022</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">GITLAB_RELATIVE_URL_ROOT=</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">    -</span> <span class="string">GITLAB_NOTIFY_ON_BROKEN_BUILDS=true</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">GITLAB_NOTIFY_PUSHER=false</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">    -</span> <span class="string">GITLAB_EMAIL=notifications@moho.com.tw</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">GITLAB_EMAIL_REPLY_TO=noreply@moho.com.tw</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">GITLAB_INCOMING_EMAIL_ADDRESS=gitlab@moho.com.tw</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">    -</span> <span class="string">GITLAB_BACKUP_SCHEDULE=daily</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">GITLAB_BACKUP_TIME=01:00</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">    -</span> <span class="string">SMTP_ENABLED=true</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">SMTP_DOMAIN=moho.com.tw</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">SMTP_HOST=192.168.100.230</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">SMTP_PORT=587</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">SMTP_USER=gitlab</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">SMTP_PASS=[hidden]</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">SMTP_STARTTLS=true</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">SMTP_AUTHENTICATION=login</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">    -</span> <span class="string">IMAP_ENABLED=true</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">IMAP_HOST=192.168.100.230</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">IMAP_PORT=993</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">IMAP_USER=gitlab</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">IMAP_PASS=[hidden]</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">IMAP_SSL=true</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">IMAP_STARTTLS=false</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/gitlab/gitlab:/home/git/data</span></span><br><span class="line"><span class="attr">redis:</span></span><br><span class="line"><span class="attr">  restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">sameersbn/redis:latest</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/gitlab/redis:/var/lib/redis</span></span><br></pre></td></tr></table></figure><p>基本上沒什麼特別，就是照 Docker Image 的範例修改環境變數跟設定而已。</p><blockquote><p>用 Rancher 的好處是之後升級可以用 Upgrade 修改 Image 的版本 Tag 就能夠升級了～</p></blockquote><p>SonarQube 的部分也一樣</p><figure class="highlight yaml"><figcaption><span>sonarqube.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">postgresql:</span></span><br><span class="line"><span class="attr">  restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">sameersbn/postgresql:9.4-18</span></span><br><span class="line"><span class="attr">  environment:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">DB_USER=sonar</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">DB_PASS=[hidden]</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">DB_NAME=sonar</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">DB_EXTENSION=pg_trgm</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/sonarqube/postgresql:/var/lib/postgresql</span></span><br><span class="line"><span class="attr">sonarqube:</span></span><br><span class="line"><span class="attr">  restart:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">sonarqube</span></span><br><span class="line"><span class="attr">  links:</span></span><br><span class="line"><span class="attr">    - postgresql:</span><span class="string">postgresql</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"10081:9000"</span></span><br><span class="line"><span class="attr">  environment:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">SONARQUBE_JDBC_URL=jdbc:postgresql://postgresql:5432/sonar</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">SONARQUBE_JDBC_PASSWORD=[hidden]</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/srv/sonarqube/extensions:/opt/sonarqube/extensions</span></span><br></pre></td></tr></table></figure><p>這樣一來就能跑起來了，至於像是 Nginx 的反向代理我就不另外敘述摟～～</p><h3 id="Gitlab-CI-入門"><a href="#Gitlab-CI-入門" class="headerlink" title="Gitlab CI 入門"></a>Gitlab CI 入門</h3><p>安裝部分就參考官方的<a href="https://gitlab.com/gitlab-org/gitlab-ci-multi-runner" target="_blank" rel="external nofollow noopener noreferrer">文件</a>來安裝，基本上不難。<br>之後就是把它 Register 到 Gitlab 上面，有趣的是他可以登記到多個 Gitlab 而不限一個，我自己是開一個 Container 去跑，然後給權限讓他能在 Host 上面開新的 Container (Runner) 這樣。</p><p>那麼，先來講幾個關鍵的點吧 XD</p><h4 id="NAT-問題"><a href="#NAT-問題" class="headerlink" title="NAT 問題"></a>NAT 問題</h4><p>因為路由器設定的問題，所以在 Runner 去 Clone 專案的時候會有些障礙。</p><p>假設我的 Gitlab Host 是 <code>gitlab.xxx.com.tw</code> 那麼網路設定大概是這樣。</p><p>LAN —-&gt; NAT —–&gt; WAN</p><p>不過 LAN 裡面又有不同的機器，而老爸公司用的是固定 IP （五組）所以我就透過 IP 去分要導去哪台。</p><p>59.x.x.49 —&gt; NAS<br>59.x.x.50 —&gt; Server</p><p>這是透過 Public IP 設定的，但是在 Server 裡面會變成</p><p>LAN IP —-&gt; NAT —–&gt; Server</p><p>結果 NAT 就不覺得 Server 裡面是走 59.x.x.50 進來的（崩潰）</p><p>所以只好對 Gitlab Runner 動手腳 XD</p><blockquote><p>Gitlab CI 的 Runner 有一個全域的設定檔，我們給他改造一下</p></blockquote><figure class="highlight"><figcaption><span>/etc/gitlab-runner/config.tmol</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[[runners]]</span></span><br><span class="line">  name = "ruby-2.1-docker"</span><br><span class="line">  url = "https://CI/"</span><br><span class="line">  token = "TOKEN"</span><br><span class="line">  limit = 0</span><br><span class="line">  executor = "docker"</span><br><span class="line">  builds_dir = ""</span><br><span class="line">  shell = ""</span><br><span class="line">  environment = ["ENV=value", "LC_ALL=en_US.UTF-8"]</span><br><span class="line">  disable_verbose = false</span><br></pre></td></tr></table></figure><p>上面是設定為 Docker 模式的 Runner，我們現在要讓 Host 的 <code>gitlab.xxx.com.tw</code> 直接用 Host IP 而不是 Public IP 讓他跳過 NAT 的解析。</p><figure class="highlight"><figcaption><span>/etc/gitlab-runner/config.tmol</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[runners.docker]</span></span><br><span class="line">  // 略</span><br><span class="line">  extra_hosts = ["gitlab.xxx.com.tw:127.10.0.1"]</span><br></pre></td></tr></table></figure><p>在 <code>runners.docker</code> 的部分，可以直接告訴他 <code>/etc/hosts</code> 要新增哪幾筆資料。</p><h4 id="設定檔"><a href="#設定檔" class="headerlink" title="設定檔"></a>設定檔</h4><p>接下來就是學 <code>.gitlab-ci.yml</code> 怎麼寫了，如果用過 Travis CI 之類的服務應該都是可以駕輕就熟拉 XD</p><figure class="highlight yaml"><figcaption><span>.gitlab-ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">before_script:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">export</span> <span class="string">GRADLE_USER_HOME=`pwd`/.gradle</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">mkdir</span> <span class="bullet">-p</span> <span class="string">$GRADLE_USER_HOME</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">echo</span> <span class="string">"org.gradle.daemon=true"</span> <span class="string">&gt;&gt;</span> <span class="string">$GRADLE_USER_HOME/gradle.properties</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">echo</span> <span class="string">"org.gradle.jvmargs=-Xmx2048m -XX:MaxPermSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8"</span> <span class="string">&gt;&gt;</span> <span class="string">$GRADLE_USER_HOME/gradle.properties</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">echo</span> <span class="string">"org.gradle.parallel=true"</span> <span class="string">&gt;&gt;</span> <span class="string">$GRADLE_USER_HOME/gradle.properties</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">echo</span> <span class="string">"org.gradle.configureondemand=true"</span> <span class="string">&gt;&gt;</span> <span class="string">$GRADLE_USER_HOME/gradle.properties</span></span><br><span class="line"></span><br><span class="line"><span class="attr">cache:</span></span><br><span class="line"><span class="attr">  paths:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">.gradle/caches</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">.gradle/wrapper</span></span><br><span class="line"></span><br><span class="line"><span class="attr">junit:</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">elct9620/gitlab-android-junit</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">./gradlew</span> <span class="string">test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">sonar:</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">elct9620/gitlab-sonar-scanner</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"/bin/true"</span></span><br></pre></td></tr></table></figure><p>先看一下我目前用的 Gitlab CI 設定檔。</p><p>基本上分為兩種</p><ul><li>Job</li><li>Config</li></ul><p>如果是關鍵字，就會被分類成 Config 像是 <code>cache</code> <code>before_script</code> 這種，如果寫在 Job 外面就是 Global 的，寫在裡面就只對某個 Job 生效。</p><blockquote><p>因為這是 Java 專案，所以我讓所有的 Task 都支援 Gradle 的設定（SonarQube 怎麼上 Cache 還沒找到⋯⋯）</p></blockquote><p>至於該怎麼寫，大致上就是這樣的格式：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">job:</span></span><br><span class="line"><span class="attr">  config:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">xxx</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">xxx</span></span><br></pre></td></tr></table></figure><p>例如我要用 ruby-2.3 然後跑 rspec 並且快取 <code>cache</code> 目錄</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rspec:</span> <span class="comment"># 新增 RSpec 任務</span></span><br><span class="line"><span class="attr">  image:</span> <span class="attr">ruby:2.3</span> <span class="comment"># 設定 Docker Image 沒有則用預設值</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">bundle</span> <span class="string">exec</span> <span class="string">rspec</span> <span class="comment"># 執行指令</span></span><br><span class="line"><span class="attr">  cache:</span></span><br><span class="line"><span class="attr">    paths:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">cache</span> <span class="comment"># 快取目錄</span></span><br></pre></td></tr></table></figure><p>這邊基本上不難，但是要注意幾點</p><ul><li>Working Directory 是在 Gitlab 設定的目錄</li><li>Script 跟 Entrypoint 不相容，他是真實一段 Shell Script 注入你的 Script</li><li>Cache 只在 Working Directory 中可以運作</li></ul><blockquote><p>關於 Cache 官方的 Issue 上面有人說如果是 <code>/root</code> 的形式，可以運作。但是 <code>/root/gradle</code> 就不行。</p></blockquote><hr><p>其他部分看文件就好了，最基本的使用其實就這樣 XD<br>然後放到專案的根目錄下就會自動被 Gitlab 偵測然後自動運行。</p><blockquote><p>關於 Pipline 等等就等之後有機會再跟大家分享拉 XD</p></blockquote><h3 id="SonarQube"><a href="#SonarQube" class="headerlink" title="SonarQube"></a>SonarQube</h3><p>前面已經裝好了，其實不需要再多做設定。<br>這邊簡單分享一下自製 Docker Image 的心得這樣。</p><p>因為只是單純的需要 Docker 環境，所以只要使用官方的 <code>java:8-jre-alpine</code> 版本就可以了！</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> java:<span class="number">8</span>-jre-alpine</span><br><span class="line"><span class="keyword">MAINTAINER</span> 蒼時弦也 docker@frost.tw</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> SONAR_SCANNER_VERSION <span class="number">2.6</span>.<span class="number">1</span></span><br><span class="line"><span class="keyword">ENV</span> SONAR_SCANNER_HOME /opt/sonar-scanner-$&#123;SONAR_SCANNER_VERSION&#125;</span><br><span class="line"><span class="keyword">ENV</span> SONAR_SCANNER_PACKAGE sonar-scanner-$&#123;SONAR_SCANNER_VERSION&#125;.zip</span><br><span class="line"><span class="keyword">ENV</span> HOME $&#123;SONAR_SCANNER_HOME&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /opt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apk update \</span></span><br><span class="line"><span class="bash">  &amp;&amp; apk add bash wget ca-certificates unzip \</span></span><br><span class="line"><span class="bash">  &amp;&amp; wget https://sonarsource.bintray.com/Distribution/sonar-scanner-cli/<span class="variable">$&#123;SONAR_SCANNER_PACKAGE&#125;</span> \</span></span><br><span class="line"><span class="bash">  &amp;&amp; unzip <span class="variable">$&#123;SONAR_SCANNER_PACKAGE&#125;</span> \</span></span><br><span class="line"><span class="bash">  &amp;&amp; rm <span class="variable">$&#123;SONAR_SCANNER_PACKAGE&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> addgroup sonar \</span></span><br><span class="line"><span class="bash">  &amp;&amp; adduser -D -s /usr/sbin/nologin -h <span class="variable">$&#123;SONAR_SCANNER_HOME&#125;</span> -G sonar sonar \</span></span><br><span class="line"><span class="bash">  &amp;&amp; chown -R sonar:sonar <span class="variable">$&#123;SONAR_SCANNER_HOME&#125;</span> \</span></span><br><span class="line"><span class="bash">  &amp;&amp; mkdir -p /data \</span></span><br><span class="line"><span class="bash">  &amp;&amp; chown -R sonar:sonar /data</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">USER</span> sonar</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /data</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> /data</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> entrypoint.sh /entrypoint.sh</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"/entrypoint.sh"</span>]</span></span><br></pre></td></tr></table></figure><p>基本上就只是把 Sonar Scanner 抓下來，然後放到指定的目錄。<br>不過真正困難的點就在額外的設定 <code>entrypoint.sh</code> 了！</p><p>如果是一般使用，直接將 <code>ENTRYPOINT</code> 設定成 Sonar Scanner 就可以。<br>但是會暴露在外部網路的環境，一定需要使用者驗證。</p><blockquote><p>Sonar Qube 如果開啟 <code>Force Authentication</code> 就一定要用帳號密碼或者 Token 才能透過 API 上傳需要分析的程式碼。</p></blockquote><p>所以我弄了一個 Shell Script 當 Entrypoint 來解決這個問題</p><figure class="highlight shell"><figcaption><span>entrypoint.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">VERSION=$&#123;CI_BUILD_TAG:-"$&#123;CI_BUILD_REF_NAME&#125;"&#125;</span><br><span class="line"></span><br><span class="line">OPTS="-Dsonar.projectVersion=$&#123;VERSION&#125; -Dsonar.gitlab.project_id=$&#123;CI_PROJECT_ID&#125; -Dsonar.gitlab.commit_sha=$&#123;CI_BUILD_REF&#125; -Dsonar.gitlab.ref_name=$&#123;CI_BUILD_REF_NAME&#125; -Dsonar.issuesReport.console.enable=true"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> TODO: Improve entrypoint to support gitlab-runner</span></span><br><span class="line">cd $&#123;CI_PROJECT_DIR&#125;</span><br><span class="line">if [[ ! -z $SONAR_TOKEN ]]; then</span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;SONAR_SCANNER_HOME&#125;/bin/sonar-scanner -Dsonar.login=<span class="variable">$&#123;SONAR_TOKEN&#125;</span> <span class="variable">$&#123;OPTS&#125;</span></span></span><br><span class="line">else</span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;SONAR_SCANNER_HOME&#125;/bin/sonar-scanner <span class="variable">$&#123;OPTS&#125;</span></span></span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>基本上很簡單，利用 Scanner 的 <code>-D</code> 補足缺少的參數，跟自動填入。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VERSION=$&#123;CI_BUILD_TAG:-"$&#123;CI_BUILD_REF_NAME&#125;"&#125;</span><br></pre></td></tr></table></figure><p>因為會需要給版本，但是照我的習慣會忘記是哪個版本，不如就自動用 Tag / Branch Name 來當版本 XD</p><blockquote><p>但是似乎會被蓋掉拉，所以有實用性有待商榷（但是這是必填項目）</p></blockquote><p>剩下的 <code>OPTS</code> 則是跟 Gitlab 整合的部分，目前還沒有成功。</p><blockquote><p>正常運作的話會自動到 Gitlab 當次 Commit 留言說有 Bad Semll 之類的 XD</p></blockquote><p>最後是 Token 了，因為不可能直接把 Token 寫在 <code>.gitlab-ci.yml</code> 當環境變數放進去，所以我是在 Gitlab 的專案設定中寫進去。</p><p>也許你會想說這樣做：</p><figure class="highlight yaml"><figcaption><span>.gitlab-ci.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sonar:</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="bullet">-Dsonar.logn=$&#123;SONAR_TOKEN&#125;</span></span><br></pre></td></tr></table></figure><p>但是前面有提到，因為是 Gitlab 自己的 Shell Script 所以不太可能這樣做。<br>所以就只好給個 Shell Script 來自己處理這個問題摟～ XD</p><blockquote><p>寫這篇文章時想到我好像可以設定 $PATH 然後直接跑 <code>sonar-scanner -Dsonar.login</code> 就好了！？</p></blockquote><p>最後，在專案目錄設定一下 Sonar 的設定檔，扣掉 Token 不適合放到 VCS 之外，其他都可以安心寫在裡面。</p><figure class="highlight plain"><figcaption><span>sonar-project.properties</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sonar.host.url=https://sonarqube.xxx.com.tw</span><br><span class="line"># must be unique in a given SonarQube instance</span><br><span class="line">sonar.projectKey=storemap:Android</span><br><span class="line"># this is the name displayed in the SonarQube UI</span><br><span class="line">sonar.projectName=StoreMap Android</span><br><span class="line"></span><br><span class="line"># Path is relative to the sonar-project.properties file. Replace &quot;\&quot; by &quot;/&quot; on Windows.</span><br><span class="line"># Since SonarQube 4.2, this property is optional if sonar.modules is set.</span><br><span class="line"># If not set, SonarQube starts looking for source code from the directory containing</span><br><span class="line"># the sonar-project.properties file.</span><br><span class="line">sonar.sources=app/src</span><br><span class="line"></span><br><span class="line"># Encoding of the source code. Default is default system encoding</span><br><span class="line">#sonar.sourceEncoding=UTF-8</span><br></pre></td></tr></table></figure><p>預設的 <code>sonar.host.url</code> 是 <code>https://localhost:9000</code> 為了要正確上傳，記得加上這行設定到對應的網址上。</p><h3 id="Android-SDK-amp-JUnit"><a href="#Android-SDK-amp-JUnit" class="headerlink" title="Android SDK &amp; JUnit"></a>Android SDK &amp; JUnit</h3><p>網路上 Google 了一下，都沒有滿意的 SDK （誤）所以只好自己包一份 XD</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> java:<span class="number">8</span>-jdk</span><br><span class="line"><span class="keyword">MAINTAINER</span> 蒼時弦也 docker@frost.tw</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> ANDROID_SDK_VERSION r24.<span class="number">4.1</span></span><br><span class="line"><span class="keyword">ENV</span> ANDROID_SDK_SOURCE https://dl.google.com/android/android-sdk_$&#123;ANDROID_SDK_VERSION&#125;-linux.tgz</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash">  apt-get update \</span></span><br><span class="line"><span class="bash">  &amp;&amp; apt-get install -y ca-certificates lib32stdc++6 lib32z1 lib32z1-dev \</span></span><br><span class="line"><span class="bash">  &amp;&amp; mkdir -p /opt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> curl -L <span class="variable">$&#123;ANDROID_SDK_SOURCE&#125;</span> | tar zxv -C /opt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> ANDROID_HOME /opt/android-sdk-linux</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> PATH $PATH:$ANDROID_HOME/tools</span><br><span class="line"><span class="keyword">ENV</span> PATH $PATH:$ANDROID_HOME/platform-tools</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash">  <span class="built_in">echo</span> <span class="string">"y"</span> | android update sdk -u -a --filter tools \</span></span><br><span class="line"><span class="bash">  &amp;&amp; <span class="built_in">echo</span> <span class="string">"y"</span> | android update sdk -u -a --filter platform-tools \</span></span><br><span class="line"><span class="bash">  &amp;&amp; <span class="built_in">echo</span> <span class="string">"y"</span> | android update sdk -u -a --filter extra-android-support \</span></span><br><span class="line"><span class="bash">  &amp;&amp; <span class="built_in">echo</span> <span class="string">"y"</span> | android update sdk -u -a --filter extra-android-m2repository \</span></span><br><span class="line"><span class="bash">  &amp;&amp; <span class="built_in">echo</span> <span class="string">"y"</span> | android update sdk -u -a --filter extra-google-google_play_services \</span></span><br><span class="line"><span class="bash">  &amp;&amp; <span class="built_in">echo</span> <span class="string">"y"</span> | android update sdk -u -a --filter extra-google-m2repository</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash">  <span class="built_in">echo</span> <span class="string">"y"</span> | android update sdk -u -a --filter android-23 \</span></span><br><span class="line"><span class="bash">  &amp;&amp; <span class="built_in">echo</span> <span class="string">"y"</span> | android update sdk -u -a --filter build-tools-23.0.2 \</span></span><br><span class="line"><span class="bash">  &amp;&amp; <span class="built_in">echo</span> <span class="string">"y"</span> | android update sdk -u -a --filter build-tools-23.0.1 \</span></span><br><span class="line"><span class="bash">  &amp;&amp; <span class="built_in">echo</span> <span class="string">"y"</span> | android update sdk -u -a --filter build-tools-23.0.0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash">  mkdir ~/.gradle \</span></span><br><span class="line"><span class="bash">	&amp;&amp; <span class="built_in">echo</span> <span class="string">"org.gradle.daemon=true"</span> &gt;&gt; ~/.gradle/gradle.properties \</span></span><br><span class="line"><span class="bash">	&amp;&amp; <span class="built_in">echo</span> <span class="string">"org.gradle.jvmargs=-Xmx2048m -XX:MaxPermSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8"</span> &gt;&gt; ~/.gradle/gradle.properties \</span></span><br><span class="line"><span class="bash">	&amp;&amp; <span class="built_in">echo</span> <span class="string">"org.gradle.parallel=true"</span> &gt;&gt; ~/.gradle/gradle.properties \</span></span><br><span class="line"><span class="bash">	&amp;&amp; <span class="built_in">echo</span> <span class="string">"org.gradle.configureondemand=true"</span> &gt;&gt; ~/.gradle/gradle.properties</span></span><br></pre></td></tr></table></figure><p>原本是想用 <code>alpine</code> 的版本，不過在跑的時候會碰到因為缺少 <code>lib32stdc++</code> 跟 <code>lib32z1</code> 這兩個套件而無法正常運作。<br>但是 Alpine 似乎沒有 <code>lib32z1</code> 只有 <code>zlib-dev</code> 可以用，總之因為出問題就只好放棄了 XD</p><p>目前用 API v23 開發，沒有要向下相容的需求就只先把 23 版的部分放進去。<br>至於上面一對 Support 部分裡面還包含了 Android Uint Test 的部分，所以都是得乖乖放進去（也包含了 Firebase 套件⋯⋯）</p><p>最後針對 Gradle 做一些額外設定，像是開啟 Parallel 之類的可以讓 Gradle 跑得比較快些。</p><hr><p>剩下的 Cache 就參考前面我的 Gitlab 設定檔摟</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">before_script:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">export</span> <span class="string">GRADLE_USER_HOME=`pwd`/.gradle</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">mkdir</span> <span class="bullet">-p</span> <span class="string">$GRADLE_USER_HOME</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">echo</span> <span class="string">"org.gradle.daemon=true"</span> <span class="string">&gt;&gt;</span> <span class="string">$GRADLE_USER_HOME/gradle.properties</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">echo</span> <span class="string">"org.gradle.jvmargs=-Xmx2048m -XX:MaxPermSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8"</span> <span class="string">&gt;&gt;</span> <span class="string">$GRADLE_USER_HOME/gradle.properties</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">echo</span> <span class="string">"org.gradle.parallel=true"</span> <span class="string">&gt;&gt;</span> <span class="string">$GRADLE_USER_HOME/gradle.properties</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">echo</span> <span class="string">"org.gradle.configureondemand=true"</span> <span class="string">&gt;&gt;</span> <span class="string">$GRADLE_USER_HOME/gradle.properties</span></span><br><span class="line"></span><br><span class="line"><span class="attr">cache:</span></span><br><span class="line"><span class="attr">  paths:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">.gradle/caches</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">.gradle/wrapper</span></span><br><span class="line"></span><br><span class="line"><span class="attr">junit:</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">elct9620/gitlab-android-junit</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">./gradlew</span> <span class="string">test</span></span><br></pre></td></tr></table></figure><p>這邊比較特別的是我將 Gradle 的目錄改到目前 Gitlab 運行的目錄。<br>前面有提到因為 Cache 只對當前目錄（專案目錄）有效果，所以必須這樣設定才能正確的快取到。</p><p>不過原本做的設定也會一併消失，所以要在寫入一次設定。</p><blockquote><p>Image 會叫 <code>gitlab-android-junit</code> 是因為我沒想到 Gradle 會裝好 JUnit 的關係，之後應該是會改名拉 XD</p></blockquote><hr><p>開始寫文章的時候離準備收假只剩下一個多小時，可能不是很詳細，請大家見諒。</p><footer class="article__footer"><div class="text-center"><div class="fb-share-button" data-href="https://blog.frost.tw/posts/2016/06/12/Working-with-Gitlab-CI-and-Sonarqube/" data-layout="button_count"></div></div><p align="center"><a href="https://ko-fi.com/J3J78093" target="_blank" rel="external nofollow noopener noreferrer"><img height="36" style="border:0;height:36px" src="https://az743702.vo.msecnd.net/cdn/kofi5.png?v=0" border="0" alt="Buy Me a Coffee at ko-fi.com"></a></p><iframe scrolling="no" frameborder="0" style="display:block;margin:0 auto;height:212px" src="https://button.like.co/in/embed/elct9620/button?referrer=https://blog.frost.tw/posts/2016/06/12/Working-with-Gitlab-CI-and-Sonarqube/"></iframe><ul class="article__tag-list"><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/Android/">Android</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/Gitlab/">Gitlab</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/心得/">心得</a></li></ul></footer></div></article><div class="adv"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2844969736316510" data-ad-slot="5530952976" data-ad-format="auto"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><section id="comment" class="comment-box"><h1 class="comment-box__title">留言</h1><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a rel="nofollow" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></div><footer id="footer"><div id="copyright">&copy;2013 <a href="https://plus.google.com/117236344655673213049?rel=author" target="_blank" rel="external nofollow noopener noreferrer">蒼時弦也</a>. All right reversed.</div></footer><script type="text/javascript">window.disqus_shortname="revo-skill-frost",function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+window.disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5TQLRN" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><script>!function(e,t,a,n,g){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var m=t.getElementsByTagName(a)[0],r=t.createElement(a);r.async=!0,r.src="//www.googletagmanager.com/gtm.js?id=GTM-5TQLRN",m.parentNode.insertBefore(r,m)}(window,document,"script","dataLayer")</script><script>window.fbAsyncInit=function(){FB.init({appId:"178355449110",xfbml:!0,version:"v2.12"}),FB.AppEvents.logPageView()},function(e,n,t){var o,s=e.getElementsByTagName(n)[0];e.getElementById(t)||((o=e.createElement(n)).id=t,o.src="https://connect.facebook.net/zh_TW/sdk.js",o.async=!0,s.parentNode.insertBefore(o,s))}(document,"script","facebook-jssdk")</script><script src="/js/app.js"></script><div class="loading"></div></body></html>