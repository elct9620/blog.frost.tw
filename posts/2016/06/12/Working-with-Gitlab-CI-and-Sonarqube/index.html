<!doctype html><html lang=zh-tw><head><title>使用 GitLab CI 整合 SonarQube - 弦而時習之</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="之前都在偷懶沒有寫網誌，剛好這次端午連假比較長。 所以想做測試跟實驗的部分都做完了，就來寫一篇關於 GitLab CI 整合的經驗分享。
文章中大致上會涵蓋這些部分：
 GitLab CI 基本使用 Rancher建置環境 SonarQube 基本使用 GitLab CI 整合環境  文章會以我在建構 CI 環境的過程中來講解，一些安裝跟 …"><meta name=created content="2016-06-12T00:00:00+0000"><meta name=modified content="2016-06-12T15:12:10+0000"><meta name=author content="蒼時弦也"><meta property="og:site_name" content="弦而時習之"><meta property="og:title" content="使用 GitLab CI 整合 SonarQube"><meta property="og:url" content="https://blog.frost.tw/posts/2016/06/12/Working-with-Gitlab-CI-and-Sonarqube/"><meta property="og:type" content="article"><meta name=theme-color content="#EFEFEF"><link href=https://blog.frost.tw/icon-512.png rel=icon><link rel=canonical href=https://blog.frost.tw/posts/2016/06/12/Working-with-Gitlab-CI-and-Sonarqube/><script type=application/ld+json>[{"@context":"https://schema.org","@type":"WebPage","headline":"使用 GitLab CI 整合 SonarQube","datePublished":"2016-06-12T00:00:00Z","dateModified":"2016-06-12T15:12:10Z","url":"https://blog.frost.tw/posts/2016/06/12/Working-with-Gitlab-CI-and-Sonarqube/","description":"之前都在偷懶沒有寫網誌，剛好這次端午連假比較長。 所以想做測試跟實驗的部分都做完了，就來寫一篇關於 GitLab CI 整合的經驗分享。\n文章中大致上會涵蓋這些部分：\n GitLab CI 基本使用 Rancher建置環境 SonarQube 基本使用 GitLab CI 整合環境  文章會以我在建構 CI 環境的過程中來講解，一些安裝跟 …\n","keywords":["GitLab","心得","Android"],"author":{"@type":"Person","name":"蒼時弦也"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.frost.tw/"},"publisher":{"@type":"Organization","name":"弦而時習之","url":"https://blog.frost.tw/"}},{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/blog.frost.tw\/","name":"弦而時習之","image":"http:\/\/blog.frost.tw\/icon-512.png"}},{"@type":"ListItem","position":2,"item":{"@id":"https:\/\/blog.frost.tw\/posts\/2016\/06\/12\/Working-with-Gitlab-CI-and-Sonarqube\/","name":"使用 GitLab CI 整合 SonarQube"}}]}]</script><link rel=stylesheet href=/css/styls.css><script async src=/js/turbolinks.min.js></script></head><body><div id=fb-root data-turbolinks-permanent></div><h1 id=sitename><a href=/ class="hide-text logo--icon align-center">弦而時習之</a></h1><aside id=slogan class="slogan align-center text-center"><h2 class=slogan__title>Aotokitsuruya</h2><p class=slogan__description>The Web is attracting me, so I start learning PHP, HTML, CSS and JavaScript. When I know about Ruby, I fall in love with it. Now, I working with my friend to design games using C++ and still learning web about Golang, Ruby and JavaScript. In the other side, I also be a designer, the reason why the web is attracted me.</p></aside><div id=wrapper><article class="post article"><header class=article__header><time datetime=2016-06-12T15:12:10+0000 class=article__time--header>Feb.12</time><h1 class=article__title>使用 GitLab CI 整合 SonarQube</h1></header><div class=article__entry><nav class=translation></nav><p>之前都在偷懶沒有寫網誌，剛好這次端午連假比較長。
所以想做測試跟實驗的部分都做完了，就來寫一篇關於 GitLab CI 整合的經驗分享。</p><p>文章中大致上會涵蓋這些部分：</p><ul><li>GitLab CI 基本使用</li><li>Rancher建置環境</li><li>SonarQube 基本使用</li><li>GitLab CI 整合環境</li></ul><p>文章會以我在建構 CI 環境的過程中來講解，一些安裝跟配置的部分會直接跳過。</p><h3 id=硬體環境>硬體環境</h3><p>因為我主要是幫老爸公司建構這個環境的，所以這些配置是基於一個很小的開發團隊（不足十人）的情況去設置的，如果團隊比較大或者有其他需求，不一定會適用。</p><p>這個環境會出現兩台機器，不過實際上使用的只有一台。</p><ul><li>Synology DS1512+</li><li>Server 等級 :: i7-3820 3.6GHz / 8G RAM</li></ul><p>目前裡面只有使用這兩台 Server 下面那台是自行組的，放在一個小機櫃這樣 XD</p><blockquote><p>內部網路環境用的是 1Gbps 的 Switch 這樣</p></blockquote><p>伺服器因為組了也有三四年，裡面用的是單顆 SSD 原本是 96GB 的前陣子換成 256GB 的 SSD，不過為了避免容量爆炸所以透過 NAS 設定了 ISCSI 給 Server 用，容量是 1TB 這樣。</p><blockquote><p>不過體驗到了 Docker Pull 的慢速，所以 ISCSI 只用在 Container 本身的資料保存。</p></blockquote><h3 id=軟體環境>軟體環境</h3><p>伺服器上用的是 Ubuntu 14.04 版本，裡面只安裝以下三個套件。</p><ul><li>Nginx - 做反向代理</li><li>Docker</li><li>Rancher - Container 管理</li></ul><p>所有的服務都是透過 Docker 架設，對外的 Web 介面則用 Nginx 導出。</p><blockquote><p>Production 不能這樣玩，像是 Database 會有效能貧頸等等問題。</p></blockquote><h3 id=開發環境>開發環境</h3><p>一張圖解釋 XD</p><p><img src=/images/working-gitlab-ci-with-sonarqube/rancher.png alt="Rancher 配置"></p><p>Fluentd 是拿來玩的，至於配置的話都是使用 <code>docker-compose.yml</code> 上傳設定來處理的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>postgresql</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>restart</span><span class=p>:</span><span class=w> </span>always<span class=w>
</span><span class=w>  </span><span class=k>image</span><span class=p>:</span><span class=w> </span>sameersbn/postgresql<span class=p>:</span><span class=m>9.4</span><span class=m>-18</span><span class=w>
</span><span class=w>  </span><span class=k>environment</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- DB_USER=gitlab<span class=w>
</span><span class=w>    </span>- DB_PASS=<span class=p>[</span>hidden<span class=p>]</span><span class=w>
</span><span class=w>    </span>- DB_NAME=gitlabhq_production<span class=w>
</span><span class=w>    </span>- DB_EXTENSION=pg_trgm<span class=w>
</span><span class=w>  </span><span class=k>volumes</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- /srv/gitlab/postgresql<span class=p>:</span>/var/lib/postgresql<span class=w>
</span><span class=w></span><span class=k>gitlab</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>restart</span><span class=p>:</span><span class=w> </span>always<span class=w>
</span><span class=w>  </span><span class=k>image</span><span class=p>:</span><span class=w> </span>sameersbn/gitlab<span class=p>:</span><span class=m>8.6</span><span class=m>.4</span><span class=w>
</span><span class=w>  </span><span class=k>links</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- redis<span class=p>:</span>redisio<span class=w>
</span><span class=w>    </span>- postgresql<span class=p>:</span>postgresql<span class=w>
</span><span class=w>  </span><span class=k>ports</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- <span class=s2>&#34;10080:80&#34;</span><span class=w>
</span><span class=w>    </span>- <span class=s2>&#34;10022:22&#34;</span><span class=w>
</span><span class=w>  </span><span class=k>environment</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- DEBUG=<span class=kc>false</span><span class=w>
</span><span class=w>    </span>- TZ=Asia/Taipei<span class=w>
</span><span class=w>    </span>- GITLAB_TIMEZONE=Taipei<span class=w>
</span><span class=w>
</span><span class=w>    </span>- GITLAB_SECRETS_DB_KEY_BASE=<span class=p>[</span>hidden<span class=p>]</span><span class=w>
</span><span class=w>
</span><span class=w>    </span>- GITLAB_HOST=localhost<span class=w>
</span><span class=w>    </span>- GITLAB_PORT=<span class=m>10080</span><span class=w>
</span><span class=w>    </span>- GITLAB_SSH_PORT=<span class=m>10022</span><span class=w>
</span><span class=w>    </span>- GITLAB_RELATIVE_URL_ROOT=<span class=w>
</span><span class=w>
</span><span class=w>    </span>- GITLAB_NOTIFY_ON_BROKEN_BUILDS=<span class=kc>true</span><span class=w>
</span><span class=w>    </span>- GITLAB_NOTIFY_PUSHER=<span class=kc>false</span><span class=w>
</span><span class=w>
</span><span class=w>    </span>- GITLAB_EMAIL=notifications@moho.com.tw<span class=w>
</span><span class=w>    </span>- GITLAB_EMAIL_REPLY_TO=noreply@moho.com.tw<span class=w>
</span><span class=w>    </span>- GITLAB_INCOMING_EMAIL_ADDRESS=gitlab@moho.com.tw<span class=w>
</span><span class=w>
</span><span class=w>    </span>- GITLAB_BACKUP_SCHEDULE=daily<span class=w>
</span><span class=w>    </span>- GITLAB_BACKUP_TIME=<span class=m>01</span><span class=p>:</span><span class=m>00</span><span class=w>
</span><span class=w>
</span><span class=w>    </span>- SMTP_ENABLED=<span class=kc>true</span><span class=w>
</span><span class=w>    </span>- SMTP_DOMAIN=moho.com.tw<span class=w>
</span><span class=w>    </span>- SMTP_HOST=<span class=m>192.168</span><span class=m>.100</span><span class=m>.230</span><span class=w>
</span><span class=w>    </span>- SMTP_PORT=<span class=m>587</span><span class=w>
</span><span class=w>    </span>- SMTP_USER=gitlab<span class=w>
</span><span class=w>    </span>- SMTP_PASS=<span class=p>[</span>hidden<span class=p>]</span><span class=w>
</span><span class=w>    </span>- SMTP_STARTTLS=<span class=kc>true</span><span class=w>
</span><span class=w>    </span>- SMTP_AUTHENTICATION=login<span class=w>
</span><span class=w>
</span><span class=w>    </span>- IMAP_ENABLED=<span class=kc>true</span><span class=w>
</span><span class=w>    </span>- IMAP_HOST=<span class=m>192.168</span><span class=m>.100</span><span class=m>.230</span><span class=w>
</span><span class=w>    </span>- IMAP_PORT=<span class=m>993</span><span class=w>
</span><span class=w>    </span>- IMAP_USER=gitlab<span class=w>
</span><span class=w>    </span>- IMAP_PASS=<span class=p>[</span>hidden<span class=p>]</span><span class=w>
</span><span class=w>    </span>- IMAP_SSL=<span class=kc>true</span><span class=w>
</span><span class=w>    </span>- IMAP_STARTTLS=<span class=kc>false</span><span class=w>
</span><span class=w>  </span><span class=k>volumes</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- /srv/gitlab/gitlab<span class=p>:</span>/home/git/data<span class=w>
</span><span class=w></span><span class=k>redis</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>restart</span><span class=p>:</span><span class=w> </span>always<span class=w>
</span><span class=w>  </span><span class=k>image</span><span class=p>:</span><span class=w> </span>sameersbn/redis<span class=p>:</span>latest<span class=w>
</span><span class=w>  </span><span class=k>volumes</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- /srv/gitlab/redis<span class=p>:</span>/var/lib/redis<span class=w>
</span></code></pre></td></tr></table></div></div><p>基本上沒什麼特別，就是照 Docker Image 的範例修改環境變數跟設定而已。</p><blockquote><p>用 Rancher 的好處是之後升級可以用 Upgrade 修改 Image 的版本 Tag 就能夠升級了～</p></blockquote><p>SonarQube 的部分也一樣</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>postgresql</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>restart</span><span class=p>:</span><span class=w> </span>always<span class=w>
</span><span class=w>  </span><span class=k>image</span><span class=p>:</span><span class=w> </span>sameersbn/postgresql<span class=p>:</span><span class=m>9.4</span><span class=m>-18</span><span class=w>
</span><span class=w>  </span><span class=k>environment</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- DB_USER=sonar<span class=w>
</span><span class=w>    </span>- DB_PASS=<span class=p>[</span>hidden<span class=p>]</span><span class=w>
</span><span class=w>    </span>- DB_NAME=sonar<span class=w>
</span><span class=w>    </span>- DB_EXTENSION=pg_trgm<span class=w>
</span><span class=w>  </span><span class=k>volumes</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- /srv/sonarqube/postgresql<span class=p>:</span>/var/lib/postgresql<span class=w>
</span><span class=w></span><span class=k>sonarqube</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>restart</span><span class=p>:</span><span class=w> </span>always<span class=w>
</span><span class=w>  </span><span class=k>image</span><span class=p>:</span><span class=w> </span>sonarqube<span class=w>
</span><span class=w>  </span><span class=k>links</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- postgresql<span class=p>:</span>postgresql<span class=w>
</span><span class=w>  </span><span class=k>ports</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- <span class=s2>&#34;10081:9000&#34;</span><span class=w>
</span><span class=w>  </span><span class=k>environment</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- SONARQUBE_JDBC_URL=jdbc<span class=p>:</span>postgresql<span class=p>:</span>//postgresql<span class=p>:</span><span class=m>5432</span>/sonar<span class=w>
</span><span class=w>    </span>- SONARQUBE_JDBC_PASSWORD=<span class=p>[</span>hidden<span class=p>]</span><span class=w>
</span><span class=w>  </span><span class=k>volumes</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- /srv/sonarqube/extensions<span class=p>:</span>/opt/sonarqube/extensions<span class=w>
</span></code></pre></td></tr></table></div></div><p>這樣一來就能跑起來了，至於像是 Nginx 的反向代理我就不另外敘述摟～～</p><h3 id=gitlab-ci-入門>GitLab CI 入門</h3><p>安裝部分就參考官方的<a href=https://gitlab.com/gitlab-org/gitlab-ci-multi-runner>文件</a>來安裝，基本上不難。
之後就是把它 Register 到 GitLab 上面，有趣的是他可以登記到多個 GitLab 而不限一個，我自己是開一個 Container 去跑，然後給權限讓他能在 Host 上面開新的 Container (Runner) 這樣。</p><p>那麼，先來講幾個關鍵的點吧 XD</p><h4 id=nat-問題>NAT 問題</h4><p>因為路由器設定的問題，所以在 Runner 去 Clone 專案的時候會有些障礙。</p><p>假設我的 GitLab Host 是 <code>gitlab.xxx.com.tw</code> 那麼網路設定大概是這樣。</p><p>LAN &mdash;-> NAT &mdash;&ndash;> WAN</p><p>不過 LAN 裡面又有不同的機器，而老爸公司用的是固定 IP （五組）所以我就透過 IP 去分要導去哪台。</p><p>59.x.x.49 &mdash;> NAS
59.x.x.50 &mdash;> Server</p><p>這是透過 Public IP 設定的，但是在 Server 裡面會變成</p><p>LAN IP &mdash;-> NAT &mdash;&ndash;> Server</p><p>結果 NAT 就不覺得 Server 裡面是走 59.x.x.50 進來的（崩潰）</p><p>所以只好對 GitLab Runner 動手腳 XD</p><blockquote><p>GitLab CI 的 Runner 有一個全域的設定檔，我們給他改造一下</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-toml data-lang=toml><span class=p>[</span><span class=p>[</span><span class=nx>runners</span><span class=p>]</span><span class=p>]</span>
  <span class=nx>name</span> <span class=p>=</span> <span class=s2>&#34;ruby-2.1-docker&#34;</span>
  <span class=nx>url</span> <span class=p>=</span> <span class=s2>&#34;https://CI/&#34;</span>
  <span class=nx>token</span> <span class=p>=</span> <span class=s2>&#34;TOKEN&#34;</span>
  <span class=nx>limit</span> <span class=p>=</span> <span class=mi>0</span>
  <span class=nx>executor</span> <span class=p>=</span> <span class=s2>&#34;docker&#34;</span>
  <span class=nx>builds_dir</span> <span class=p>=</span> <span class=s2>&#34;&#34;</span>
  <span class=nx>shell</span> <span class=p>=</span> <span class=s2>&#34;&#34;</span>
  <span class=nx>environment</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;ENV=value&#34;</span><span class=p>,</span> <span class=s2>&#34;LC_ALL=en_US.UTF-8&#34;</span><span class=p>]</span>
  <span class=nx>disable_verbose</span> <span class=p>=</span> <span class=kc>false</span>
</code></pre></td></tr></table></div></div><p>上面是設定為 Docker 模式的 Runner，我們現在要讓 Host 的 <code>gitlab.xxx.com.tw</code> 直接用 Host IP 而不是 Public IP 讓他跳過 NAT 的解析。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-toml data-lang=toml><span class=p>[</span><span class=nx>runners</span><span class=p>.</span><span class=nx>docker</span><span class=p>]</span>
  <span class=err>/</span><span class=err>/</span> <span class=nx>略</span>
  <span class=nx>extra_hosts</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;gitlab.xxx.com.tw:127.10.0.1&#34;</span><span class=p>]</span>
</code></pre></td></tr></table></div></div><p>在 <code>runners.docker</code> 的部分，可以直接告訴他 <code>/etc/hosts</code> 要新增哪幾筆資料。</p><h4 id=設定檔>設定檔</h4><p>接下來就是學 <code>.gitlab-ci.yml</code> 怎麼寫了，如果用過 Travis CI 之類的服務應該都是可以駕輕就熟拉 XD</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>before_script</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span>- export<span class=w> </span>GRADLE_USER_HOME=`pwd`/.gradle<span class=w>
</span><span class=w>  </span>- mkdir<span class=w> </span>-p<span class=w> </span>$GRADLE_USER_HOME<span class=w>
</span><span class=w>  </span>- echo<span class=w> </span><span class=s2>&#34;org.gradle.daemon=true&#34;</span><span class=w> </span>&gt;&gt;<span class=w> </span>$GRADLE_USER_HOME/gradle.properties<span class=w>
</span><span class=w>  </span>- echo<span class=w> </span><span class=s2>&#34;org.gradle.jvmargs=-Xmx2048m -XX:MaxPermSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8&#34;</span><span class=w> </span>&gt;&gt;<span class=w> </span>$GRADLE_USER_HOME/gradle.properties<span class=w>
</span><span class=w>  </span>- echo<span class=w> </span><span class=s2>&#34;org.gradle.parallel=true&#34;</span><span class=w> </span>&gt;&gt;<span class=w> </span>$GRADLE_USER_HOME/gradle.properties<span class=w>
</span><span class=w>  </span>- echo<span class=w> </span><span class=s2>&#34;org.gradle.configureondemand=true&#34;</span><span class=w> </span>&gt;&gt;<span class=w> </span>$GRADLE_USER_HOME/gradle.properties<span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>cache</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>paths</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- .gradle/caches<span class=w>
</span><span class=w>    </span>- .gradle/wrapper<span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>junit</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>image</span><span class=p>:</span><span class=w> </span>elct9620/gitlab-android-junit<span class=w>
</span><span class=w>  </span><span class=k>script</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- ./gradlew<span class=w> </span>test<span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>sonar</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>image</span><span class=p>:</span><span class=w> </span>elct9620/gitlab-sonar-scanner<span class=w>
</span><span class=w>  </span><span class=k>script</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- <span class=s2>&#34;/bin/true&#34;</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>先看一下我目前用的 GitLab CI 設定檔。</p><p>基本上分為兩種</p><ul><li>Job</li><li>Config</li></ul><p>如果是關鍵字，就會被分類成 Config 像是 <code>cache</code> <code>before_script</code> 這種，如果寫在 Job 外面就是 Global 的，寫在裡面就只對某個 Job 生效。</p><blockquote><p>因為這是 Java 專案，所以我讓所有的 Task 都支援 Gradle 的設定（SonarQube 怎麼上 Cache 還沒找到⋯⋯）</p></blockquote><p>至於該怎麼寫，大致上就是這樣的格式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=w>
</span><span class=w></span><span class=k>job</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>config</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- xxx<span class=w>
</span><span class=w>    </span>- xxx<span class=w>
</span></code></pre></td></tr></table></div></div><p>例如我要用 ruby-2.3 然後跑 rspec 並且快取 <code>cache</code> 目錄</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yml data-lang=yml><span class=k>rspec</span><span class=p>:</span><span class=w> </span><span class=c># 新增 RSpec 任務</span><span class=w>
</span><span class=w>  </span><span class=k>image</span><span class=p>:</span><span class=w> </span>ruby<span class=p>:</span><span class=m>2.3</span><span class=w> </span><span class=c># 設定 Docker Image 沒有則用預設值</span><span class=w>
</span><span class=w>  </span><span class=k>script</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- bundle<span class=w> </span>exec<span class=w> </span>rspec<span class=w> </span><span class=c># 執行指令</span><span class=w>
</span><span class=w>  </span><span class=k>cache</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span><span class=k>paths</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- cache<span class=w> </span><span class=c># 快取目錄</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>這邊基本上不難，但是要注意幾點</p><ul><li>Working Directory 是在 GitLab 設定的目錄</li><li>Script 跟 Entrypoint 不相容，他是真實一段 Shell Script 注入你的 Script</li><li>Cache 只在 Working Directory 中可以運作</li></ul><blockquote><p>關於 Cache 官方的 Issue 上面有人說如果是 <code>/root</code> 的形式，可以運作。但是 <code>/root/gradle</code> 就不行。</p></blockquote><hr><p>其他部分看文件就好了，最基本的使用其實就這樣 XD
然後放到專案的根目錄下就會自動被 GitLab 偵測然後自動運行。</p><blockquote><p>關於 Pipline 等等就等之後有機會再跟大家分享拉 XD</p></blockquote><h3 id=sonarqube>SonarQube</h3><p>前面已經裝好了，其實不需要再多做設定。
這邊簡單分享一下自製 Docker Image 的心得這樣。</p><p>因為只是單純的需要 Docker 環境，所以只要使用官方的 <code>java:8-jre-alpine</code> 版本就可以了！</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=k>FROM</span><span class=s> java:8-jre-alpine</span><span class=err>
</span><span class=err></span><span class=k>MAINTAINER</span><span class=s> 蒼時弦也 docker@frost.tw</span><span class=err>
</span><span class=err></span><span class=err>
</span><span class=err></span><span class=k>ENV</span> SONAR_SCANNER_VERSION 2.6.1<span class=err>
</span><span class=err></span><span class=k>ENV</span> SONAR_SCANNER_HOME /opt/sonar-scanner-<span class=si>${</span><span class=nv>SONAR_SCANNER_VERSION</span><span class=si>}</span><span class=err>
</span><span class=err></span><span class=k>ENV</span> SONAR_SCANNER_PACKAGE sonar-scanner-<span class=si>${</span><span class=nv>SONAR_SCANNER_VERSION</span><span class=si>}</span>.zip<span class=err>
</span><span class=err></span><span class=k>ENV</span> HOME <span class=si>${</span><span class=nv>SONAR_SCANNER_HOME</span><span class=si>}</span><span class=err>
</span><span class=err></span><span class=err>
</span><span class=err></span><span class=k>WORKDIR</span><span class=s> /opt</span><span class=err>
</span><span class=err></span><span class=err>
</span><span class=err></span><span class=k>RUN</span> apk update <span class=se>\
</span><span class=se></span>  <span class=o>&amp;&amp;</span> apk add bash wget ca-certificates unzip <span class=se>\
</span><span class=se></span>  <span class=o>&amp;&amp;</span> wget https://sonarsource.bintray.com/Distribution/sonar-scanner-cli/<span class=si>${</span><span class=nv>SONAR_SCANNER_PACKAGE</span><span class=si>}</span> <span class=se>\
</span><span class=se></span>  <span class=o>&amp;&amp;</span> unzip <span class=si>${</span><span class=nv>SONAR_SCANNER_PACKAGE</span><span class=si>}</span> <span class=se>\
</span><span class=se></span>  <span class=o>&amp;&amp;</span> rm <span class=si>${</span><span class=nv>SONAR_SCANNER_PACKAGE</span><span class=si>}</span><span class=err>
</span><span class=err></span><span class=err>
</span><span class=err></span><span class=k>RUN</span> addgroup sonar <span class=se>\
</span><span class=se></span>  <span class=o>&amp;&amp;</span> adduser -D -s /usr/sbin/nologin -h <span class=si>${</span><span class=nv>SONAR_SCANNER_HOME</span><span class=si>}</span> -G sonar sonar <span class=se>\
</span><span class=se></span>  <span class=o>&amp;&amp;</span> chown -R sonar:sonar <span class=si>${</span><span class=nv>SONAR_SCANNER_HOME</span><span class=si>}</span> <span class=se>\
</span><span class=se></span>  <span class=o>&amp;&amp;</span> mkdir -p /data <span class=se>\
</span><span class=se></span>  <span class=o>&amp;&amp;</span> chown -R sonar:sonar /data<span class=err>
</span><span class=err></span><span class=err>
</span><span class=err></span><span class=k>USER</span><span class=s> sonar</span><span class=err>
</span><span class=err></span><span class=k>WORKDIR</span><span class=s> /data</span><span class=err>
</span><span class=err></span><span class=err>
</span><span class=err></span><span class=k>VOLUME</span><span class=s> /data</span><span class=err>
</span><span class=err></span><span class=err>
</span><span class=err></span><span class=k>ADD</span> entrypoint.sh /entrypoint.sh<span class=err>
</span><span class=err></span><span class=err>
</span><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;/entrypoint.sh&#34;</span><span class=p>]</span><span class=err>
</span></code></pre></td></tr></table></div></div><p>基本上就只是把 Sonar Scanner 抓下來，然後放到指定的目錄。
不過真正困難的點就在額外的設定 <code>entrypoint.sh</code> 了！</p><p>如果是一般使用，直接將 <code>ENTRYPOINT</code> 設定成 Sonar Scanner 就可以。
但是會暴露在外部網路的環境，一定需要使用者驗證。</p><blockquote><p>Sonar Qube 如果開啟 <code>Force Authentication</code> 就一定要用帳號密碼或者 Token 才能透過 API 上傳需要分析的程式碼。</p></blockquote><p>所以我弄了一個 Shell Script 當 Entrypoint 來解決這個問題</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=cp>#!/bin/bash
</span><span class=cp></span>
<span class=nb>set</span> -e

<span class=nv>VERSION</span><span class=o>=</span><span class=si>${</span><span class=nv>CI_BUILD_TAG</span><span class=k>:-</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>CI_BUILD_REF_NAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=si>}</span>

<span class=nv>OPTS</span><span class=o>=</span><span class=s2>&#34;</span><span class=s2>-Dsonar.projectVersion=</span><span class=si>${</span><span class=nv>VERSION</span><span class=si>}</span><span class=s2> -Dsonar.gitlab.project_id=</span><span class=si>${</span><span class=nv>CI_PROJECT_ID</span><span class=si>}</span><span class=s2> -Dsonar.gitlab.commit_sha=</span><span class=si>${</span><span class=nv>CI_BUILD_REF</span><span class=si>}</span><span class=s2> -Dsonar.gitlab.ref_name=</span><span class=si>${</span><span class=nv>CI_BUILD_REF_NAME</span><span class=si>}</span><span class=s2> -Dsonar.issuesReport.console.enable=true</span><span class=s2>&#34;</span>

<span class=c1># TODO: Improve entrypoint to support gitlab-runner</span>
<span class=nb>cd</span> <span class=si>${</span><span class=nv>CI_PROJECT_DIR</span><span class=si>}</span>
<span class=k>if</span> <span class=o>[</span><span class=o>[</span> ! -z <span class=nv>$SONAR_TOKEN</span> <span class=o>]</span><span class=o>]</span><span class=p>;</span> <span class=k>then</span>
  <span class=si>${</span><span class=nv>SONAR_SCANNER_HOME</span><span class=si>}</span>/bin/sonar-scanner -Dsonar.login<span class=o>=</span><span class=si>${</span><span class=nv>SONAR_TOKEN</span><span class=si>}</span> <span class=si>${</span><span class=nv>OPTS</span><span class=si>}</span>
<span class=k>else</span>
  <span class=si>${</span><span class=nv>SONAR_SCANNER_HOME</span><span class=si>}</span>/bin/sonar-scanner <span class=si>${</span><span class=nv>OPTS</span><span class=si>}</span>
<span class=k>fi</span>
</code></pre></td></tr></table></div></div><p>基本上很簡單，利用 Scanner 的 <code>-D</code> 補足缺少的參數，跟自動填入。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=nv>VERSION</span><span class=o>=</span><span class=si>${</span><span class=nv>CI_BUILD_TAG</span><span class=k>:-</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>CI_BUILD_REF_NAME</span><span class=si>}</span><span class=s2>&#34;</span><span class=si>}</span>
</code></pre></td></tr></table></div></div><p>因為會需要給版本，但是照我的習慣會忘記是哪個版本，不如就自動用 Tag / Branch Name 來當版本 XD</p><blockquote><p>但是似乎會被蓋掉拉，所以有實用性有待商榷（但是這是必填項目）</p></blockquote><p>剩下的 <code>OPTS</code> 則是跟 GitLab 整合的部分，目前還沒有成功。</p><blockquote><p>正常運作的話會自動到 GitLab 當次 Commit 留言說有 Bad Semll 之類的 XD</p></blockquote><p>最後是 Token 了，因為不可能直接把 Token 寫在 <code>.gitlab-ci.yml</code> 當環境變數放進去，所以我是在 GitLab 的專案設定中寫進去。</p><p>也許你會想說這樣做：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>sonar</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>script</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- -Dsonar.logn=${SONAR_TOKEN}<span class=w>
</span></code></pre></td></tr></table></div></div><p>但是前面有提到，因為是 GitLab 自己的 Shell Script 所以不太可能這樣做。
所以就只好給個 Shell Script 來自己處理這個問題摟～ XD</p><blockquote><p>寫這篇文章時想到我好像可以設定 $PATH 然後直接跑 <code>sonar-scanner -Dsonar.login</code> 就好了！？</p></blockquote><p>最後，在專案目錄設定一下 Sonar 的設定檔，扣掉 Token 不適合放到 VCS 之外，其他都可以安心寫在裡面。</p><pre><code class=language-properties data-lang=properties>sonar.host.url=https://sonarqube.xxx.com.tw
# must be unique in a given SonarQube instance
sonar.projectKey=storemap:Android
# this is the name displayed in the SonarQube UI
sonar.projectName=StoreMap Android

# Path is relative to the sonar-project.properties file. Replace &quot;\&quot; by &quot;/&quot; on Windows.
# Since SonarQube 4.2, this property is optional if sonar.modules is set.
# If not set, SonarQube starts looking for source code from the directory containing
# the sonar-project.properties file.
sonar.sources=app/src

# Encoding of the source code. Default is default system encoding
#sonar.sourceEncoding=UTF-8
</code></pre><p>預設的 <code>sonar.host.url</code> 是 <code>https://localhost:9000</code> 為了要正確上傳，記得加上這行設定到對應的網址上。</p><h3 id=android-sdk--junit>Android SDK & JUnit</h3><p>網路上 Google 了一下，都沒有滿意的 SDK （誤）所以只好自己包一份 XD</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=k>FROM</span><span class=s> java:8-jdk</span><span class=err>
</span><span class=err></span><span class=k>MAINTAINER</span><span class=s> 蒼時弦也 docker@frost.tw</span><span class=err>
</span><span class=err></span><span class=err>
</span><span class=err></span><span class=k>ENV</span> ANDROID_SDK_VERSION r24.4.1<span class=err>
</span><span class=err></span><span class=k>ENV</span> ANDROID_SDK_SOURCE https://dl.google.com/android/android-sdk_<span class=si>${</span><span class=nv>ANDROID_SDK_VERSION</span><span class=si>}</span>-linux.tgz<span class=err>
</span><span class=err></span><span class=err>
</span><span class=err></span><span class=k>RUN</span>  apt-get update <span class=se>\
</span><span class=se></span>  <span class=o>&amp;&amp;</span> apt-get install -y ca-certificates lib32stdc++6 lib32z1 lib32z1-dev <span class=se>\
</span><span class=se></span>  <span class=o>&amp;&amp;</span> mkdir -p /opt<span class=err>
</span><span class=err></span><span class=err>
</span><span class=err></span><span class=k>RUN</span> curl -L <span class=si>${</span><span class=nv>ANDROID_SDK_SOURCE</span><span class=si>}</span> <span class=p>|</span> tar zxv -C /opt<span class=err>
</span><span class=err></span><span class=err>
</span><span class=err></span><span class=k>ENV</span> ANDROID_HOME /opt/android-sdk-linux<span class=err>
</span><span class=err></span><span class=err>
</span><span class=err></span><span class=k>ENV</span> PATH <span class=nv>$PATH</span>:<span class=nv>$ANDROID_HOME</span>/tools<span class=err>
</span><span class=err></span><span class=k>ENV</span> PATH <span class=nv>$PATH</span>:<span class=nv>$ANDROID_HOME</span>/platform-tools<span class=err>
</span><span class=err></span><span class=err>
</span><span class=err></span><span class=k>RUN</span>  <span class=nb>echo</span> <span class=s2>&#34;y&#34;</span> <span class=p>|</span> android update sdk -u -a --filter tools <span class=se>\
</span><span class=se></span>  <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;y&#34;</span> <span class=p>|</span> android update sdk -u -a --filter platform-tools <span class=se>\
</span><span class=se></span>  <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;y&#34;</span> <span class=p>|</span> android update sdk -u -a --filter extra-android-support <span class=se>\
</span><span class=se></span>  <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;y&#34;</span> <span class=p>|</span> android update sdk -u -a --filter extra-android-m2repository <span class=se>\
</span><span class=se></span>  <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;y&#34;</span> <span class=p>|</span> android update sdk -u -a --filter extra-google-google_play_services <span class=se>\
</span><span class=se></span>  <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;y&#34;</span> <span class=p>|</span> android update sdk -u -a --filter extra-google-m2repository<span class=err>
</span><span class=err></span><span class=err>
</span><span class=err></span><span class=k>RUN</span>  <span class=nb>echo</span> <span class=s2>&#34;y&#34;</span> <span class=p>|</span> android update sdk -u -a --filter android-23 <span class=se>\
</span><span class=se></span>  <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;y&#34;</span> <span class=p>|</span> android update sdk -u -a --filter build-tools-23.0.2 <span class=se>\
</span><span class=se></span>  <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;y&#34;</span> <span class=p>|</span> android update sdk -u -a --filter build-tools-23.0.1 <span class=se>\
</span><span class=se></span>  <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;y&#34;</span> <span class=p>|</span> android update sdk -u -a --filter build-tools-23.0.0<span class=err>
</span><span class=err></span><span class=err>
</span><span class=err></span><span class=k>RUN</span>  mkdir ~/.gradle <span class=se>\
</span><span class=se></span>	<span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;org.gradle.daemon=true&#34;</span> &gt;&gt; ~/.gradle/gradle.properties <span class=se>\
</span><span class=se></span>	<span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;org.gradle.jvmargs=-Xmx2048m -XX:MaxPermSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8&#34;</span> &gt;&gt; ~/.gradle/gradle.properties <span class=se>\
</span><span class=se></span>	<span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;org.gradle.parallel=true&#34;</span> &gt;&gt; ~/.gradle/gradle.properties <span class=se>\
</span><span class=se></span>	<span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;org.gradle.configureondemand=true&#34;</span> &gt;&gt; ~/.gradle/gradle.properties<span class=err>
</span></code></pre></td></tr></table></div></div><p>原本是想用 <code>alpine</code> 的版本，不過在跑的時候會碰到因為缺少 <code>lib32stdc++</code> 跟 <code>lib32z1</code> 這兩個套件而無法正常運作。
但是 Alpine 似乎沒有 <code>lib32z1</code> 只有 <code>zlib-dev</code> 可以用，總之因為出問題就只好放棄了 XD</p><p>目前用 API v23 開發，沒有要向下相容的需求就只先把 23 版的部分放進去。
至於上面一對 Support 部分裡面還包含了 Android Uint Test 的部分，所以都是得乖乖放進去（也包含了 Firebase 套件⋯⋯）</p><p>最後針對 Gradle 做一些額外設定，像是開啟 Parallel 之類的可以讓 Gradle 跑得比較快些。</p><hr><p>剩下的 Cache 就參考前面我的 GitLab 設定檔摟</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>before_script</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span>- export<span class=w> </span>GRADLE_USER_HOME=`pwd`/.gradle<span class=w>
</span><span class=w>  </span>- mkdir<span class=w> </span>-p<span class=w> </span>$GRADLE_USER_HOME<span class=w>
</span><span class=w>  </span>- echo<span class=w> </span><span class=s2>&#34;org.gradle.daemon=true&#34;</span><span class=w> </span>&gt;&gt;<span class=w> </span>$GRADLE_USER_HOME/gradle.properties<span class=w>
</span><span class=w>  </span>- echo<span class=w> </span><span class=s2>&#34;org.gradle.jvmargs=-Xmx2048m -XX:MaxPermSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8&#34;</span><span class=w> </span>&gt;&gt;<span class=w> </span>$GRADLE_USER_HOME/gradle.properties<span class=w>
</span><span class=w>  </span>- echo<span class=w> </span><span class=s2>&#34;org.gradle.parallel=true&#34;</span><span class=w> </span>&gt;&gt;<span class=w> </span>$GRADLE_USER_HOME/gradle.properties<span class=w>
</span><span class=w>  </span>- echo<span class=w> </span><span class=s2>&#34;org.gradle.configureondemand=true&#34;</span><span class=w> </span>&gt;&gt;<span class=w> </span>$GRADLE_USER_HOME/gradle.properties<span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>cache</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>paths</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- .gradle/caches<span class=w>
</span><span class=w>    </span>- .gradle/wrapper<span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>junit</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>  </span><span class=k>image</span><span class=p>:</span><span class=w> </span>elct9620/gitlab-android-junit<span class=w>
</span><span class=w>  </span><span class=k>script</span><span class=p>:</span><span class=w>
</span><span class=w></span><span class=w>    </span>- ./gradlew<span class=w> </span>test<span class=w>
</span></code></pre></td></tr></table></div></div><p>這邊比較特別的是我將 Gradle 的目錄改到目前 GitLab 運行的目錄。
前面有提到因為 Cache 只對當前目錄（專案目錄）有效果，所以必須這樣設定才能正確的快取到。</p><p>不過原本做的設定也會一併消失，所以要在寫入一次設定。</p><blockquote><p>Image 會叫 <code>gitlab-android-junit</code> 是因為我沒想到 Gradle 會裝好 JUnit 的關係，之後應該是會改名拉 XD</p></blockquote><hr><p>開始寫文章的時候離準備收假只剩下一個多小時，可能不是很詳細，請大家見諒。</p><footer class=article__footer><div class=text-center><div class=fb-share-button data-href="<%- page.permalink %>" data-layout=button_count></div></div><div class="text-center mt-1"><style>.bmc-button img{width:27px!important;margin-bottom:1px!important;box-shadow:none!important;border:none!important;vertical-align:middle!important}.bmc-button{line-height:36px!important;height:37px!important;text-decoration:none!important;display:inline-flex!important;color:#fff!important;background-color:#000!important;border-radius:3px!important;border:1px solid transparent!important;padding:1px 9px!important;font-size:22px!important;letter-spacing:.6px!important;box-shadow:0 1px 2px rgba(190,190,190,.5)!important;-webkit-box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;margin:0 auto!important;font-family:cookie,cursive!important;-webkit-box-sizing:border-box!important;box-sizing:border-box!important;-o-transition:.3s all linear!important;-webkit-transition:.3s all linear!important;-moz-transition:.3s all linear!important;-ms-transition:.3s all linear!important;transition:.3s all linear!important}.bmc-button:hover,.bmc-button:active,.bmc-button:focus{-webkit-box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;text-decoration:none!important;box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;opacity:.85!important;color:#fff!important}</style><link href="https://fonts.googleapis.com/css?family=Cookie" rel=stylesheet><a class=bmc-button target=_blank href=https://www.buymeacoffee.com/aotoki><img src=https://bmc-cdn.nyc3.digitaloceanspaces.com/BMC-button-images/BMC-btn-logo.svg alt="Buy me a Coffee"><span style=margin-left:5px>Buy me a Coffee</span></a></div><iframe scrolling=no frameborder=0 style="display:block;margin:0 auto;height:212px" src="https://button.like.co/in/embed/elct9620/button?referrer=<%- page.permalink %>"></iframe><ul class=article__tag-list><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/GitLab/>GitLab</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/%E5%BF%83%E5%BE%97/>心得</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/Android/>Android</a></li></ul></footer></div></article><div class=adv><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-2844969736316510 data-ad-slot=5530952976 data-ad-format=auto></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div><section id=comment class=comment-box><h1 class=comment-box__title>留言</h1><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"revo-skill-frost"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></section></div><footer id=footer><div id=copyright>&copy;2020 <a href="https://plus.google.com/117236344655673213049?rel=author" target=_blank>蒼時弦也</a>. All right reversed.</div></footer><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5TQLRN" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-5TQLRN');</script><script>window.fbAsyncInit=function(){FB.init({appId:'178355449110',xfbml:true,version:'v2.12'});FB.AppEvents.logPageView();};(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(d.getElementById(id)){return;}
js=d.createElement(s);js.id=id;js.src="https://connect.facebook.net/zh_TW/sdk.js";js.async=true
fjs.parentNode.insertBefore(js,fjs);}(document,'script','facebook-jssdk'));</script><script src=/js/app.min.e979702d4c2a76dd5e32acda7647b733e4959a8621df075338d00d2c6837e87a.js></script><div class=loading></div></body></html>