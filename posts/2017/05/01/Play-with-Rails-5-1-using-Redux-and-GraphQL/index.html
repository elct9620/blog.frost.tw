<!doctype html><html lang=zh-tw><head><title>用 Redux 跟 GraphQL 玩 Rails 5.1 - 弦而時習之</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="上週五在處理網址續費的時候，發現幫老爸公司管理的網址已經多到一個程度。所以就決定把手邊可以轉移的服務都往 Gandi 丟過去。畢竟粗略估算可以達到 Grid B 的費率（實際上只有九五折）不過考量到有 API 能夠管理，以及一些自動化的手段，雖然相對還是稍微貴了一點，但是省去後續不少麻煩確實是有利的。
也因為這樣，就打算以串 Gandi …
"><meta name=created content="2017-05-01T00:00:00+0000"><meta name=modified content="2017-05-01T23:09:40+0000"><meta name=author content="蒼時弦也"><meta property="og:site_name" content="弦而時習之"><meta property="og:title" content="用 Redux 跟 GraphQL 玩 Rails 5.1"><meta property="og:url" content="https://blog.frost.tw/posts/2017/05/01/Play-with-Rails-5-1-using-Redux-and-GraphQL/"><meta property="og:type" content="article"><meta name=theme-color content="#EFEFEF"><link href=https://blog.frost.tw/icon-512.png rel=icon><link rel=canonical href=https://blog.frost.tw/posts/2017/05/01/Play-with-Rails-5-1-using-Redux-and-GraphQL/><script type=application/ld+json>[{"@context":"https://schema.org","@type":"WebPage","headline":"用 Redux 跟 GraphQL 玩 Rails 5.1","datePublished":"2017-05-01T23:09:40Z","dateModified":"2017-05-01T23:09:40Z","url":"https://blog.frost.tw/posts/2017/05/01/Play-with-Rails-5-1-using-Redux-and-GraphQL/","description":"上週五在處理網址續費的時候，發現幫老爸公司管理的網址已經多到一個程度。所以就決定把手邊可以轉移的服務都往 Gandi 丟過去。畢竟粗略估算可以達到 Grid B 的費率（實際上只有九五折）不過考量到有 API 能夠管理，以及一些自動化的手段，雖然相對還是稍微貴了一點，但是省去後續不少麻煩確實是有利的。\n也因為這樣，就打算以串 Gandi …\n","keywords":["Rails","Redux","GraphQL"],"author":{"@type":"Person","name":"蒼時弦也"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.frost.tw/"},"publisher":{"@type":"Organization","name":"弦而時習之","url":"https://blog.frost.tw/"}},{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https://blog.frost.tw/","name":"弦而時習之","image":"http://blog.frost.tw/icon-512.png"}},{"@type":"ListItem","position":2,"item":{"@id":"https://blog.frost.tw/posts/2017/05/01/Play-with-Rails-5-1-using-Redux-and-GraphQL/","name":"用 Redux 跟 GraphQL 玩 Rails 5.1"}}]}]</script><script async src=/js/turbolinks.min.js></script></head><body><div id=fb-root data-turbolinks-permanent></div><h1 id=sitename><a href=/ class="hide-text logo--icon align-center">弦而時習之</a></h1><aside id=slogan class="slogan align-center text-center"><h2 class=slogan__title>Aotokitsuruya</h2><p class=slogan__description>The Web is attracting me, so I start learning PHP, HTML, CSS and JavaScript. When I know about Ruby, I fall in love with it. Now, I working with my friend to design games using C++ and still learning web about Golang, Ruby and JavaScript. In the other side, I also be a designer, the reason why the web is attracted me.</p></aside><div id=wrapper><article class="post article" role=article><header class=article__header><time datetime=2017-05-01T23:09:40+0000 class=article__time--header>May.01</time><h1 class=article__title>用 Redux 跟 GraphQL 玩 Rails 5.1</h1></header><div class=article__entry><nav class=translation></nav><p>上週五在處理網址續費的時候，發現幫老爸公司管理的網址已經多到一個程度。所以就決定把手邊可以轉移的服務都往 Gandi 丟過去。畢竟粗略估算可以達到 Grid B 的費率（實際上只有九五折）不過考量到有 API 能夠管理，以及一些自動化的手段，雖然相對還是稍微貴了一點，但是省去後續不少麻煩確實是有利的。</p><p>也因為這樣，就打算以串 Gandi 的 API 來練手一下，原本是想做完管理 Domain 的部分，不過沒想到在實作一些技術面上的東西花了不少時間，只做完簡單的價格查詢。</p><p>根據我的習慣，我通常會在新專案使用新的技術，這次是使用 Rails 5.1 支援 Webpack 的功能搭配上 Redux 和 GraphQL 來應用。我學 React 的時間是在 Redux 出來之前，所以一直都使用手刻 Flux 架構的方式去寫。</p><p>而 GraphQL 之前因為沒有成熟的 Ruby Gem 也一直沒有去碰，最近除了有相容 Rails 之外，也出現了透過 ActiveRecord 的 Association Reflect 去解決 GraphQL 會出現 N+1 問題的 Gem 讓我總算是下定決心去嘗試看看。</p><p>這個專案我自己的規劃是這樣的：</p><ul><li>Dashboard<ul><li>Domain Manager<ul><li>Auto Renew</li><li>DNS Zone<ul><li>CloudFlare Intergate</li></ul></li><li>DNSSEC</li></ul></li><li>SSL Manager<ul><li>Auto Renew</li><li>Auto Deploy</li></ul></li></ul></li><li>API<ul><li>GraphQL (Front-end)</li><li>RESTFul API (3rd-party)</li></ul></li></ul><p>大致上定位是基於 Gandi 給的 API 做自動化的管理，以及在一些服務上的部署可以有效率的處理（會整合 DevOps 之類的）</p><hr><p>不過既然要買網址，所以就需要先了解 Gandi 上的收費以及可以購買的網址。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ruby data-lang=ruby><span class=n>gem</span> <span class=s1>&#39;gandi&#39;</span>
</code></pre></td></tr></table></div></div><p>運氣不錯，已經有人將原本的 XMLRPC API 封裝成一個 Gem 可以用很簡單的方式來操作。</p><blockquote><p>如果像我一樣使用 Ruby 2.4 因為 XMLRPC 已經從 Core 移除，所要自行追加 <code>gem 'xmlrpc'</code> 來補齊功能。</p></blockquote><p>這個 Gem 的使用方法大致上如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ruby data-lang=ruby><span class=n>api</span> <span class=o>=</span> <span class=no>Gandi</span><span class=o>::</span><span class=no>Session</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=no>ENV</span><span class=o>[</span><span class=s1>&#39;GANDI_API_TOKEN&#39;</span><span class=o>]</span><span class=p>)</span>
<span class=n>api</span><span class=o>.</span><span class=n>domain</span><span class=o>.</span><span class=n>list</span> <span class=c1># 顯示帳號下所有的 Domain</span>
</code></pre></td></tr></table></div></div><p>不過對於 Rails 來說其實不容易使用，既然是第三方的 API 就先封裝成一個 Service 物件比較容易處理。
至於建立 API Client 實例的動作也可以封裝一下方便使用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ruby data-lang=ruby><span class=c1># frozen_string_literal: true</span>

<span class=c1># :nodoc:</span>
<span class=k>module</span> <span class=nn>Gandi</span>
  <span class=k>def</span> <span class=nc>self</span><span class=o>.</span><span class=nf>api</span>
    <span class=n>options</span> <span class=o>=</span> <span class=p>{}</span>
    <span class=n>options</span><span class=o>[</span><span class=ss>:env</span><span class=o>]</span> <span class=o>=</span> <span class=ss>:test</span> <span class=k>unless</span> <span class=no>Rails</span><span class=o>.</span><span class=n>env</span><span class=o>.</span><span class=n>production?</span>
    <span class=vi>@api</span> <span class=o>||=</span> <span class=no>Gandi</span><span class=o>::</span><span class=no>Session</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=no>Settings</span><span class=o>.</span><span class=n>gandi</span><span class=o>.</span><span class=n>token</span><span class=p>,</span> <span class=n>options</span><span class=p>)</span>
  <span class=k>end</span>
<span class=k>end</span>
</code></pre></td></tr></table></div></div><p>我習慣會使用 <code>SettingsLogic</code> 這個 Gem 來管理設定，這邊也可以將 <code>Settings.gandi.token</code> 替換成 <code>ENV['GANDI_API_TOKEN']</code> 之類的。</p><blockquote><p>因為 Gandi 有提供測試環境，所以在非 Production 時一律採用測試環境。</p></blockquote><p>接下來就是封裝 Gandi 的價格查詢（<code>Catalog</code>）成為一個 Service 供系統使用（可能是歐洲服務商的關係，API 相當慢，在本地端足存一份副本會好很多。）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ruby data-lang=ruby><span class=c1># frozen_string_literal: true</span>

<span class=k>module</span> <span class=nn>Domain</span>
  <span class=k>class</span> <span class=nc>PriceService</span>
    <span class=k>def</span> <span class=nf>initialize</span><span class=p>(</span><span class=n>currency</span> <span class=o>=</span> <span class=ss>:EUR</span><span class=p>,</span> <span class=n>grid</span> <span class=o>=</span> <span class=ss>:A</span><span class=p>)</span>
        <span class=vi>@currency</span> <span class=o>=</span> <span class=n>currency</span>
        <span class=vi>@grid</span> <span class=o>=</span> <span class=n>grid</span>
    <span class=k>end</span>

    <span class=k>def</span> <span class=nf>query</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
        <span class=n>query</span> <span class=o>=</span> <span class=p>{</span><span class=ss>product</span><span class=p>:</span> <span class=n>query</span><span class=o>.</span><span class=n>merge</span><span class=p>(</span><span class=ss>type</span><span class=p>:</span> <span class=ss>:domain</span><span class=p>)}</span>
        <span class=no>Gandi</span><span class=o>.</span><span class=n>api</span><span class=o>.</span><span class=n>catalog</span><span class=o>.</span><span class=n>list</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=vi>@currency</span><span class=p>,</span> <span class=vi>@grid</span><span class=p>)</span>
    <span class=k>end</span>

    <span class=k>def</span> <span class=nf>all</span>
        <span class=n>query</span><span class=p>({})</span>
    <span class=k>end</span>
  <span class=k>end</span>
<span class=k>end</span>
</code></pre></td></tr></table></div></div><p>基本上就是對原本的 Gandi 做簡單的封裝，現在透過 <code>Domain::PriceService.new.all</code> 就可以輕鬆存取到需要的價格資訊。
不過因為要匯入到本地的資料庫，回傳的資料結構並不是我所期望的狀況，所以就再做了一層封裝。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ruby data-lang=ruby><span class=c1># frozen_string_literal: true</span>

<span class=k>module</span> <span class=nn>Domain</span>
    <span class=k>class</span> <span class=nc>PriceService</span>
        <span class=k>class</span> <span class=nc>Result</span> <span class=o>&lt;</span> <span class=nb>Array</span>
            <span class=k>def</span> <span class=nf>to_domain</span>
                <span class=n>map</span> <span class=p>{</span> <span class=o>|</span><span class=n>item</span><span class=o>|</span> <span class=n>build_domain</span><span class=p>(</span><span class=n>item</span><span class=p>)</span> <span class=p>}</span>
            <span class=k>end</span>

            <span class=kp>private</span>

            <span class=k>def</span> <span class=nf>build_domain</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
                <span class=no>CatalogDomain</span><span class=o>.</span><span class=n>new</span><span class=p>(</span>
                    <span class=ss>description</span><span class=p>:</span> <span class=n>item</span><span class=o>.</span><span class=n>product</span><span class=o>.</span><span class=n>description</span><span class=p>,</span>
                    <span class=ss>action</span><span class=p>:</span> <span class=n>item</span><span class=o>.</span><span class=n>action</span><span class=o>.</span><span class=n>name</span><span class=o>.</span><span class=n>parameterize</span><span class=p>(</span><span class=ss>separator</span><span class=p>:</span> <span class=s1>&#39;_&#39;</span><span class=p>),</span>
                    <span class=ss>phase</span><span class=p>:</span> <span class=n>item</span><span class=o>.</span><span class=n>action</span><span class=o>&amp;.</span><span class=n>params</span><span class=o>&amp;.</span><span class=n>tld_phase</span><span class=p>,</span>
                    <span class=ss>price</span><span class=p>:</span> <span class=n>convert_to_price</span><span class=p>(</span><span class=n>item</span><span class=p>),</span>
                    <span class=ss>grid</span><span class=p>:</span> <span class=n>item</span><span class=o>.</span><span class=n>unit_price</span><span class=o>.</span><span class=n>first</span><span class=o>.</span><span class=n>grid</span>
                <span class=p>)</span>
            <span class=k>end</span>

            <span class=k>def</span> <span class=nf>convert_to_price</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
                <span class=no>Money</span><span class=o>.</span><span class=n>from_amout</span><span class=p>(</span>
                    <span class=n>item</span><span class=o>.</span><span class=n>unit_price</span><span class=o>.</span><span class=n>first</span><span class=o>.</span><span class=n>price</span><span class=p>,</span>
                    <span class=n>item</span><span class=o>.</span><span class=n>unit_price</span><span class=o>.</span><span class=n>first</span><span class=o>.</span><span class=n>currency</span>
                <span class=p>)</span>
            <span class=k>end</span>
        <span class=k>end</span>

        <span class=c1># 略</span>
        <span class=k>def</span> <span class=nf>query</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
            <span class=c1># ...</span>
            <span class=no>Result</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=no>Gandi</span><span class=o>.</span><span class=n>api</span><span class=o>.</span><span class=n>catalog</span><span class=o>.</span><span class=n>list</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=vi>@currency</span><span class=p>,</span> <span class=vi>@grid</span><span class=p>))</span>
        <span class=k>end</span>
    <span class=k>end</span>
<span class=k>end</span>
</code></pre></td></tr></table></div></div><p>如此一來，我就可以用 <code>Domain::PriceService.new.all.to_domain</code> 轉成對應的 Model 方便匯入的動作。</p><ul><li>Gandi 這個 Gem 已經用 Hashie 封裝過，所以可以透過類似物件的方式存取屬性</li><li>因為主要是使用的是台幣，但是也希望儲存不同幣種的價格所以使用了 <code>Money</code> Gem 的功能</li></ul><p>至於 Model 的部分就不多論敘，不過因為域名的資料現在有約 4000 筆，所以需要借助 <code>activerecord-import</code> 這個 Gem 做一次性的匯入，即使透過 Rails 的 Batch 功能也沒有辦法高效率的做匯入。</p><p>不過，在 Gandi 回傳的資料會有以下情況。</p><ul><li><code>action</code> 的差異：新增、轉入、續約等等</li><li><code>phase</code> 的差異：已上線、日升期等等（域名術語，日升期這類是給商標註冊者購買或者預先用高價保留域名用的）</li></ul><p>所以如果再沒有對這些欄位增加限制的話，就會碰到匯入時重複的問題而發生錯誤。</p><p>所以在寫 Migration 的時候要補上下面的索引來增加限制。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ruby data-lang=ruby><span class=n>add_index</span> <span class=o>[</span><span class=ss>:description</span><span class=p>,</span> <span class=ss>:action</span><span class=p>,</span> <span class=ss>:phase</span><span class=p>,</span> <span class=ss>:currency</span><span class=p>,</span> <span class=ss>:grid</span><span class=o>]</span><span class=p>,</span>
          <span class=nb>name</span><span class=p>:</span> <span class=ss>:catalog_domain_constriant</span><span class=p>,</span>
          <span class=ss>unique</span><span class=p>:</span> <span class=kp>true</span>
</code></pre></td></tr></table></div></div><p>要這樣做的理由，是因為 <code>activerecord-import</code> 支援 <code>ON CONFLICT</code> 的 SQL 語法，在 PostgreSQL 上可以在碰到重複的資料改為對特定欄位更新，而不是插入一筆資料。</p><p>於是就可以撰寫一個 Rake Task 來處理定期同步價格的任務。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ruby data-lang=ruby><span class=c1># frozen_string_literal: true</span>

<span class=n>namespace</span> <span class=ss>:domain</span> <span class=k>do</span>
  <span class=n>desc</span> <span class=s1>&#39;Load domain prices from Gandi&#39;</span>
  <span class=n>task</span> <span class=ss>:refresh</span><span class=p>,</span> <span class=o>[</span><span class=ss>:currency</span><span class=p>,</span> <span class=ss>:grid</span><span class=o>]</span> <span class=o>=&gt;</span> <span class=o>[</span><span class=ss>:environment</span><span class=o>]</span> <span class=k>do</span> <span class=o>|</span><span class=n>_</span><span class=p>,</span> <span class=n>args</span><span class=o>|</span>
    <span class=n>currency</span> <span class=o>=</span> <span class=n>args</span><span class=o>[</span><span class=ss>:currency</span><span class=o>]</span> <span class=o>||</span> <span class=ss>:EUR</span>
    <span class=n>grid</span> <span class=o>=</span> <span class=n>args</span><span class=o>[</span><span class=ss>:grid</span><span class=o>]</span> <span class=o>||</span> <span class=ss>:A</span>
    <span class=n>domains</span> <span class=o>=</span> <span class=no>Domain</span><span class=o>::</span><span class=no>PriceService</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>currency</span><span class=p>,</span> <span class=n>grid</span><span class=p>)</span><span class=o>.</span><span class=n>all</span><span class=o>.</span><span class=n>to_domain</span>
    <span class=no>CatalogDomain</span><span class=o>.</span><span class=n>import</span> <span class=n>domains</span><span class=p>,</span> <span class=ss>on_duplicate_key_update</span><span class=p>:</span> <span class=p>{</span>
      <span class=ss>conflict_target</span><span class=p>:</span> <span class=o>[</span><span class=ss>:description</span><span class=p>,</span> <span class=ss>:action</span><span class=p>,</span> <span class=ss>:phase</span><span class=p>,</span> <span class=ss>:grid</span><span class=p>,</span> <span class=ss>:currency</span><span class=o>]</span><span class=p>,</span>
      <span class=ss>columns</span><span class=p>:</span> <span class=o>[</span><span class=ss>:price</span><span class=o>]</span>
    <span class=p>}</span>
    <span class=nb>puts</span> <span class=s2>&#34;Total </span><span class=si>#{</span><span class=n>domains</span><span class=o>.</span><span class=n>size</span><span class=si>}</span><span class=s2> rows in </span><span class=si>#{</span><span class=n>currency</span><span class=si>}</span><span class=s2> loaded.&#34;</span>
  <span class=k>end</span>
<span class=k>end</span>
</code></pre></td></tr></table></div></div><p>透過 <code>on_duplicate_key_update</code> 的設定，就可以在碰到相同的資料時只更新價格，如此一來就可以利用 CronJob 來每天同步當日最新的價格資訊。</p><p>到此為止，就「域名資料」的部分就算是已經處理完畢了。</p><p>接下來對 GraphQL 設定，依照教學配置好之後，要先讓 GraphQL 可以支援顯示我們需要的資料。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ruby data-lang=ruby><span class=c1># frozen_string_literal: true</span>

<span class=no>Types</span><span class=o>::</span><span class=no>QueryType</span> <span class=o>=</span> <span class=no>GraphQL</span><span class=o>::</span><span class=no>ObjectType</span><span class=o>.</span><span class=n>define</span> <span class=k>do</span>
  <span class=nb>name</span> <span class=s1>&#39;Query&#39;</span>

  <span class=n>field</span> <span class=ss>:domains</span> <span class=k>do</span>
    <span class=n>type</span> <span class=n>types</span><span class=o>[</span><span class=no>Types</span><span class=o>::</span><span class=no>CatalogDomainType</span><span class=o>]</span>
    <span class=n>argument</span> <span class=ss>:tld</span><span class=p>,</span> <span class=n>types</span><span class=o>.</span><span class=n>String</span>
    <span class=n>resolve</span> <span class=o>-&gt;</span><span class=p>(</span><span class=n>obj</span><span class=p>,</span> <span class=n>args</span><span class=p>,</span> <span class=n>ctx</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>if</span> <span class=n>args</span><span class=o>[</span><span class=ss>:tld</span><span class=o>]</span>
        <span class=no>CatalogDomain</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=s1>&#39;description LIKE ?&#39;</span><span class=p>,</span> <span class=s2>&#34;%</span><span class=si>#{</span><span class=n>args</span><span class=o>[</span><span class=ss>:tld</span><span class=o>]</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
      <span class=k>else</span>
        <span class=no>CatalogDomain</span><span class=o>.</span><span class=n>all</span>
      <span class=k>end</span>
    <span class=p>}</span>
  <span class=k>end</span>
<span class=k>end</span>
</code></pre></td></tr></table></div></div><p>這邊先簡單的支援查詢域名的功能，先不討論透過幣種或者價格來查詢，先讓使用者可以查詢現有可以註冊的域名有哪些類型即可。</p><blockquote><p>至於 <code>CatalogDomainType</code> 只是單純的設定欄位而已，這邊就跳過不多做討論。</p></blockquote><p>另外似乎是因為資料蠻多的關係，連生成 JSON 都有點慢，所以這邊額外設定了 <code>oj</code> 這個 Gem 來加速（大約是十倍快）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ruby data-lang=ruby><span class=c1># frozen_string_literal: true</span>

<span class=no>Oj</span><span class=o>::</span><span class=no>Rails</span><span class=o>.</span><span class=n>set_encoder</span>
<span class=no>Oj</span><span class=o>::</span><span class=no>Rails</span><span class=o>.</span><span class=n>set_decoder</span>
<span class=no>Oj</span><span class=o>::</span><span class=no>Rails</span><span class=o>.</span><span class=n>optimize</span><span class=p>(</span><span class=nb>Array</span><span class=p>,</span> <span class=no>BigDecimal</span><span class=p>,</span> <span class=no>Hash</span><span class=p>,</span> <span class=no>Range</span><span class=p>,</span> <span class=no>Regexp</span><span class=p>,</span> <span class=no>Time</span><span class=p>)</span>
</code></pre></td></tr></table></div></div><p>到這邊，我們的 Backend 就全部完成處置，接下來就是要讓前端可以使用這些資料來呈現。</p><p>首先到原本的 Layout 上面追加 Webpack 的 JS 檔案。
（預設還是傳統的方式，所以要手動加上由 Webpack 生成的版本）</p><pre><code class=language-erb data-lang=erb>&lt;!-- 略 ---&gt;
    &lt;%= javascript_pack_tag    'application' %&gt;
&lt;/head&gt;
&lt;!-- 略 ---&gt;
</code></pre><p>接下來開啟 Rails 的 Webpack 伺服器（<code>./bin/webpack-dev-server</code>）之前使用 beta1 的時候還有 Watcher 的選項，不過正式版似乎去掉了，不過用 dev-server 效果基本上是相同的。</p><blockquote><p>要注意的是，強烈不建議 Webpack 跟原本的 Sprocket 混用，除了自己會搞混之外，原有的 ExecJS 也挺容易出錯的，統一寫在 <code>app/javascript/packs</code> 會是不錯的選擇。</p></blockquote><p>接下來安裝一下需要的套件。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>yarn add react redux react-redux react-dom redux-observable rxjs prop-types immutable redux-thunk
</code></pre></td></tr></table></div></div><blockquote><p>關於 UI 互動上，我偏向 RxJS 的解法，所以採用的是 <code>redux-observable</code> 的方式，至於 <code>redux-thunk</code> 因為不熟，大多教學都會裝一下，所以這邊單純跟風。</p></blockquote><p>首先，先來處理 Reducer 的部分，這邊直接利用 Immutable 的 <code>fromJS</code> 直接把資料轉換。不過筆數這麼多的情況下，其實是不建議這樣做的，不過暫時還沒有找到恰當的處理方式，所以就先這樣做。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=kr>import</span> <span class=p>{</span> <span class=nx>List</span><span class=p>,</span> <span class=nx>fromJS</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;immutable&#39;</span><span class=p>;</span>

<span class=kr>import</span> <span class=p>{</span>
  <span class=nx>QUERY_DOMAIN</span><span class=p>,</span>
  <span class=nx>RECEIVED_DOMAIN</span><span class=p>,</span>
<span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;../constriants&#39;</span><span class=p>;</span>

<span class=kr>const</span> <span class=nx>initState</span> <span class=o>=</span> <span class=nx>Map</span><span class=p>({</span>
  <span class=nx>fetching</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
  <span class=nx>domains</span><span class=o>:</span> <span class=nx>List</span><span class=p>([]),</span>
<span class=p>});</span>

<span class=kr>export</span> <span class=kr>const</span> <span class=nx>domainReducer</span> <span class=o>=</span> <span class=p>(</span><span class=nx>state</span> <span class=o>=</span> <span class=nx>initState</span><span class=p>,</span> <span class=nx>action</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
  <span class=k>switch</span> <span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>type</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>case</span> <span class=nx>START_REQUEST</span><span class=o>:</span> <span class=p>{</span>
      <span class=k>return</span> <span class=nx>state</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s1>&#39;fetching&#39;</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>case</span> <span class=nx>FINISHED_REQUEST</span><span class=o>:</span> <span class=p>{</span>
      <span class=k>return</span> <span class=nx>state</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s1>&#39;fetching&#39;</span><span class=p>,</span> <span class=kc>false</span><span class=p>)</span>
                  <span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s1>&#39;data&#39;</span><span class=p>,</span> <span class=nx>fromJS</span><span class=p>(</span><span class=nx>action</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>domains</span><span class=p>));</span>
    <span class=p>}</span>
    <span class=k>default</span><span class=o>:</span> <span class=p>{</span>
      <span class=k>return</span> <span class=nx>state</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>};</span>

<span class=kr>export</span> <span class=k>default</span> <span class=nx>domainReducer</span><span class=p>;</span>
</code></pre></td></tr></table></div></div><p>關於 <code>constriants</code> 就不多做說明，從以前的習慣就是會開一個目錄（或者檔案）把全部的 Action Type 統一塞在裡面管理，雖然說直接寫字串沒什麼問題，但是難免出錯，這種統一管理的方式倒是可以避免一些人為疏失。</p><p>接下來對 Action 做處理。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=kr>import</span> <span class=p>{</span> <span class=nx>ajax</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;rxjs/observable/dom/ajax&#39;</span><span class=p>;</span>
<span class=kr>import</span> <span class=s1>&#39;rxjs&#39;</span><span class=p>;</span>

<span class=kr>import</span> <span class=p>{</span>
  <span class=nx>QUERY_DOMAIN</span><span class=p>,</span>
  <span class=nx>RECEIVED_DOMAIN</span><span class=p>,</span>
<span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;../constriants&#39;</span><span class=p>;</span>

<span class=kr>const</span> <span class=nx>ENDPOINT</span> <span class=o>=</span> <span class=s1>&#39;/graphql&#39;</span><span class=p>;</span>

<span class=kr>export</span> <span class=kr>const</span> <span class=nx>queryDomain</span> <span class=o>=</span> <span class=nx>query</span> <span class=p>=&gt;</span> <span class=p>(</span>
  <span class=p>{</span>
    <span class=nx>type</span><span class=o>:</span> <span class=nx>QUERY_DOMAIN</span><span class=p>,</span>
    <span class=nx>payload</span><span class=o>:</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>({</span> <span class=nx>query</span> <span class=p>}),</span>
  <span class=p>}</span>
<span class=p>);</span>

<span class=kr>export</span> <span class=kr>const</span> <span class=nx>receivedDomain</span> <span class=o>=</span> <span class=nx>response</span> <span class=p>=&gt;</span> <span class=p>(</span>
  <span class=p>{</span>
    <span class=nx>type</span><span class=o>:</span> <span class=nx>RECEIVED_DOMAIN</span><span class=p>,</span>
    <span class=nx>response</span><span class=p>,</span>
  <span class=p>}</span>
<span class=p>);</span>

<span class=kr>export</span> <span class=kr>const</span> <span class=nx>queryDomainEpic</span> <span class=o>=</span> <span class=nx>action$</span> <span class=p>=&gt;</span> <span class=p>(</span>
  <span class=nx>action$</span><span class=p>.</span><span class=nx>ofType</span><span class=p>(</span><span class=nx>QUERY_DOMAIN</span><span class=p>)</span>
         <span class=p>.</span><span class=nx>debounceTime</span><span class=p>(</span><span class=mi>1000</span><span class=p>)</span>
         <span class=p>.</span><span class=nx>mergeMap</span><span class=p>(</span><span class=nx>action</span> <span class=p>=&gt;</span>
           <span class=nx>ajax</span><span class=p>({</span> <span class=nx>url</span><span class=o>:</span> <span class=nx>ENDPOINT</span><span class=p>,</span> <span class=nx>method</span><span class=o>:</span> <span class=s1>&#39;POST&#39;</span><span class=p>,</span> <span class=nx>headers</span><span class=o>:</span> <span class=p>{</span> <span class=s1>&#39;Content-Type&#39;</span><span class=o>:</span> <span class=s1>&#39;application/json&#39;</span> <span class=p>},</span> <span class=nx>body</span><span class=o>:</span> <span class=nx>action</span><span class=p>.</span><span class=nx>payload</span> <span class=p>})</span>
           <span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>result</span> <span class=p>=&gt;</span> <span class=nx>receivedDomain</span><span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>response</span><span class=p>)),</span>
         <span class=p>)</span>
<span class=p>);</span>
</code></pre></td></tr></table></div></div><p>基本上跟一般的 Redux 沒有太大的差別，比較特別的是以 <code>Epic</code> 結尾的這個動作，這個就是 <code>redux-observable</code> 所提供的特殊 Action 行為，可以把它視為 Action 的管理者。</p><p>裡面的實作則是透過 RxJS 所實現的，簡單說就是碰到 <code>QUERY_DOMAIN</code> 類型的動作，先等待 1000ms 確認沒有其他操作後，用「最後一次」的操作繼續，並且合併另一個動作（Ajax 查詢）繼續進行。</p><p>此時的 <code>QUERY_DOMAIN</code> 被觸發後，會再等待被合併的 Ajax 查詢完成後才一起回傳。而這個 Ajax 查詢則是我們要做的 GraphQL 查詢。</p><p>接下來把焦點放到查詢畫面的元件上，這邊我們只討論做 Dispatch 的這個動作。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js>  <span class=nx>componentDidMount</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>dispatch</span><span class=p>(</span><span class=nx>startRequest</span><span class=p>(</span><span class=s1>&#39;{domains { description, price, currency }}&#39;</span><span class=p>));</span>
  <span class=p>}</span>

  <span class=nx>onSearchChange</span><span class=p>()</span> <span class=p>{</span>
    <span class=kr>const</span> <span class=nx>tld</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>text</span><span class=p>.</span><span class=nx>input</span><span class=p>.</span><span class=nx>value</span><span class=p>;</span>
    <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>({</span> <span class=nx>search</span><span class=o>:</span> <span class=nx>tld</span> <span class=p>});</span>
    <span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>dispatch</span><span class=p>(</span>
      <span class=nx>startRequest</span><span class=p>(</span><span class=sb>`{domains(tld: &#34;</span><span class=si>${</span><span class=nx>tld</span><span class=si>}</span><span class=sb>&#34;) { description, price, currency }}`</span><span class=p>),</span>
    <span class=p>);</span>
  <span class=p>}</span>
</code></pre></td></tr></table></div></div><p>實際上也是很淺顯易懂的，在前面的 Action 中我們是採取直接將整個 GraphQL 傳入的方式，所以在觸發動作時也是直接將查詢寫到裡面。</p><blockquote><p>還不熟悉 Redux 綁定輸入框的方式，因為有點晚了所以直接用 <code>ref</code> 的做法做綁定。</p></blockquote><p>到這邊眼尖讀者可能會發現，我們並沒有去呼叫 <code>queryDomainEpic</code> 但是似乎卻自己運作起來了，這部分是 <code>redux-observable</code> 的特性，也就是說我們將呼叫實際動作的任務交給 <code>Epic</code> 來管理。</p><p>最後要統整一下所有的 <code>Epic</code> 整合到 Redux 裡面（跟 Reducers 類似）</p><pre><code>const epics = combineEpics(queryDomainEpic);
const epicMiddleware = createEpicMiddleware(epics);

const store = createStore(
    applyMiddleware(epicMiddleware),
    reducers
);
</code></pre><p>接下來就會正常運作了！</p><hr><p>其實這樣的進度大約花了快一天左右的時間，雖然中間有跑去設定 <code>pry</code> 跟打遊戲之類的，不過整體上來說要反覆的把 Redux 練熟之外，還要掌握 GraphQL 的應用，也是要花上不少時間在上面的。</p><p>不過學技術就是這樣，當原本的技術熟悉到一個程度後，做起來當然是非常熟練的。不過如果不願意花時間在新技術上，就會一直沒辦法便的熟練，雖然目前有遊戲跟很多坑的關係，其實也不太能練新技術。但是有機會的話，還是會想在各種專案上做一些嘗試，來看看自己到底能做到怎麼樣的效果。</p><p>這篇文章大多是省略了查文件就可以做到的部分，所以看起來挺簡單的。不過要查完文件後再踩雷之後做出來，倒也是一件不太容易的事情。不過 Rails 5.1 提供了 Webpack 環境以及一些好用的 Gem 倒是大大改善不少在這部分所浪費掉的時間。</p><p>雖然沒有如預期的完成到最基本可以購買域名，但是整體上來說倒是累積了不少經驗。</p><footer class=article__footer><div class=text-center><div class=fb-share-button data-href="<%- page.permalink %>" data-layout=button_count></div></div><div class="text-center mt-1"><style>.bmc-button img{width:27px!important;margin-bottom:1px!important;box-shadow:none!important;border:none!important;vertical-align:middle!important}.bmc-button{line-height:36px!important;height:37px!important;text-decoration:none!important;display:inline-flex!important;color:#fff!important;background-color:#000!important;border-radius:3px!important;border:1px solid transparent!important;padding:1px 9px!important;font-size:22px!important;letter-spacing:.6px!important;box-shadow:0 1px 2px rgba(190,190,190,.5)!important;-webkit-box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;margin:0 auto!important;font-family:cookie,cursive!important;-webkit-box-sizing:border-box!important;box-sizing:border-box!important;-o-transition:.3s all linear!important;-webkit-transition:.3s all linear!important;-moz-transition:.3s all linear!important;-ms-transition:.3s all linear!important;transition:.3s all linear!important}.bmc-button:hover,.bmc-button:active,.bmc-button:focus{-webkit-box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;text-decoration:none!important;box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;opacity:.85!important;color:#fff!important}</style><link href="https://fonts.googleapis.com/css?family=Cookie&display=swap" rel=stylesheet><a class=bmc-button target=_blank href=https://www.buymeacoffee.com/aotoki><img src=https://bmc-cdn.nyc3.digitaloceanspaces.com/BMC-button-images/BMC-btn-logo.svg rel=noreferrer alt="Buy me a Coffee"><span style=margin-left:5px>Buy me a Coffee</span></a></div><iframe title=LikeCoin scrolling=no frameborder=0 style="display:block;margin:0 auto;height:212px" src="https://button.like.co/in/embed/elct9620/button?referrer=<%- page.permalink %>"></iframe><ul class=article__tag-list><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/Rails/>Rails</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/Redux/>Redux</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/GraphQL/>GraphQL</a></li></ul></footer><aside class=related><header class=related__header><h3 class=related__title>相關文章</h3></header><ul><li class=related__item><a class=related__link href=/posts/2014/03/24/capistrano-to-vagrant-automated-deployment-experience/>Capistrano to Vagrant 自動部署心得</a></li><li class=related__item><a class=related__link href=/posts/2013/09/08/nitrousio-website-development-collaboration-platform/>Nitrous.io - 網站開發協作平台</a></li><li class=related__item><a class=related__link href=/posts/2014/08/31/rails-girls-4-event-impressions/>Rails Girls 4 活動感想</a></li><li class=related__item><a class=related__link href=/posts/2013/12/18/from-the-students-perspective-to-the-students-program-of-study-recommendations/>從學生的角度給學生學習程式的建議</a></li><li class=related__item><a class=related__link href=/posts/2013/11/03/vagrant-integrated-gitlab-with-capistrano-create-staging-environment-automatically-deployed/>用 Vagrant 整合 GitLab 與 Capistrano 做 Staging 環境自動部署</a></li></ul></aside></div></article><div class=subscribe><div id=mc_embed_signup><form action="https://frost.us4.list-manage.com/subscribe/post?u=dd3d68032c0510041f1302539&id=d2a668a8aa" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class=validate target=_blank novalidate><div id=mc_embed_signup_scroll><h1 class=subscribe__title>電子報</h2><div class=mc-field-group><input type=email name=EMAIL class="required email subscribe__input" id=mce-EMAIL placeholder=Email></div><div id=mce-responses class=clear><div class=response id=mce-error-response style=display:none></div><div class=response id=mce-success-response style=display:none></div></div><div style=position:absolute;left:-5000px aria-hidden=true><input type=text name=b_dd3d68032c0510041f1302539_d2a668a8aa tabindex=-1></div><div class=clear><input type=submit value=訂閱 name=subscribe id=mc-embedded-subscribe class="button subscribe__button"></div></div></form></div></div><div class=adv><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-2844969736316510 data-ad-slot=5530952976 data-ad-format=auto></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><section id=comment class=comment-box><h1 class=comment-box__title>留言</h1><div id=disqus_thread></div></div></section></div><footer id=footer><div id=copyright>&copy;2021 <a href="https://plus.google.com/117236344655673213049?rel=author" target=_blank rel=noreferrer>蒼時弦也</a>. All right reversed.</div></footer><link rel=stylesheet href=/css/styles.css><script src=/js/app.min.c2ee95eb1af6682877e13dd5ff8809b3eda43102f2446e2a2be672d7d7acfb08.js></script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5TQLRN" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><script>(function(b,d,e,a,g){b[a]=b[a]||[],b[a].push({'gtm.start':(new Date).getTime(),event:'gtm.js'});var f=d.getElementsByTagName(e)[0],c=d.createElement(e),h=a!='dataLayer'?'&l='+a:'';c.async=!0,c.src='//www.googletagmanager.com/gtm.js?id='+g+h,f.parentNode.insertBefore(c,f)})(window,document,'script','dataLayer','GTM-5TQLRN')</script><script>window.fbAsyncInit=function(){FB.init({appId:'178355449110',xfbml:!0,version:'v2.12'}),FB.AppEvents.logPageView()},function(b,c,d){var a,e=b.getElementsByTagName(c)[0];if(b.getElementById(d))return;a=b.createElement(c),a.id=d,a.src="https://connect.facebook.net/zh_TW/sdk.js",a.async=!0,a.defer=!0,e.parentNode.insertBefore(a,e)}(document,'script','facebook-jssdk')</script><div class=loading></div></body></html>