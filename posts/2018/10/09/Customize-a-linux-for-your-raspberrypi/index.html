<!doctype html><html lang=zh-tw><head><title>客製化你樹莓派上運行的 Linux - 弦而時習之</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="最近因為手邊有一個工作以外的專案需要搭配硬體做一些 IoT 類型的應用，雖然之前在五倍紅寶石開發的 Tamashii 系列應用已經足以應對在這個專案上開發所需的解決方案，但是依舊缺少了一些功能。
也就是我們過去並沒有考慮到的，如果裝置是交給一般使用者的狀況下，如何在透過網路的前提將裝置更新。
這是很多硬體都會有的功能， …"><meta name=created content="2018-10-09T00:00:00+0000"><meta name=modified content="2018-10-09T21:29:53+0000"><meta name=author content="蒼時弦也"><meta property="og:site_name" content="弦而時習之"><meta property="og:title" content="客製化你樹莓派上運行的 Linux"><meta property="og:url" content="https://blog.frost.tw/posts/2018/10/09/Customize-a-linux-for-your-raspberrypi/"><meta property="og:type" content="article"><meta property="og:image" content="https://blog.frost.tw/images/2018-10-09-customize-a-linux-for-your-raspberrypi/thumbnail.jpg"><meta name=theme-color content="#EFEFEF"><link href=https://blog.frost.tw/icon-512.png rel=icon><link rel=canonical href=https://blog.frost.tw/posts/2018/10/09/Customize-a-linux-for-your-raspberrypi/><script type=application/ld+json>[{"@context":"https://schema.org","@type":"WebPage","headline":"客製化你樹莓派上運行的 Linux","datePublished":"2018-10-09T21:29:53Z","dateModified":"2018-10-09T21:29:53Z","url":"https://blog.frost.tw/posts/2018/10/09/Customize-a-linux-for-your-raspberrypi/","description":"最近因為手邊有一個工作以外的專案需要搭配硬體做一些 IoT 類型的應用，雖然之前在五倍紅寶石開發的 Tamashii 系列應用已經足以應對在這個專案上開發所需的解決方案，但是依舊缺少了一些功能。\n也就是我們過去並沒有考慮到的，如果裝置是交給一般使用者的狀況下，如何在透過網路的前提將裝置更新。\n這是很多硬體都會有的功能， …\n","keywords":["物聯網","筆記","IoT","Linux","Ruby"],"image":"https://blog.frost.tw/images/2018-10-09-customize-a-linux-for-your-raspberrypi/thumbnail.jpg","author":{"@type":"Person","name":"蒼時弦也"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.frost.tw/"},"publisher":{"@type":"Organization","name":"弦而時習之","url":"https://blog.frost.tw/"}},{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https://blog.frost.tw/","name":"弦而時習之","image":"http://blog.frost.tw/icon-512.png"}},{"@type":"ListItem","position":2,"item":{"@id":"https://blog.frost.tw/posts/2018/10/09/Customize-a-linux-for-your-raspberrypi/","name":"客製化你樹莓派上運行的 Linux","image":"https://blog.frost.tw/images/2018-10-09-customize-a-linux-for-your-raspberrypi/thumbnail.jpg"}}]}]</script><script async src=/js/turbolinks.min.js></script></head><body><div id=fb-root data-turbolinks-permanent></div><h1 id=sitename><a href=/ class="hide-text logo--icon align-center">弦而時習之</a></h1><aside id=slogan class="slogan align-center text-center"><h2 class=slogan__title>Aotokitsuruya</h2><p class=slogan__description>The Web is attracting me, so I start learning PHP, HTML, CSS and JavaScript. When I know about Ruby, I fall in love with it. Now, I working with my friend to design games using C++ and still learning web about Golang, Ruby and JavaScript. In the other side, I also be a designer, the reason why the web is attracted me.</p></aside><div id=wrapper><article class="post article" role=article><header class=article__header><time datetime=2018-10-09T21:29:53+0000 class=article__time--header>Feb.09</time><h1 class=article__title>客製化你樹莓派上運行的 Linux</h1></header><div class=article__entry><nav class=translation></nav><p>最近因為手邊有一個工作以外的專案需要搭配硬體做一些 IoT 類型的應用，雖然之前在五倍紅寶石開發的 Tamashii 系列應用已經足以應對在這個專案上開發所需的解決方案，但是依舊缺少了一些功能。</p><p>也就是我們過去並沒有考慮到的，如果裝置是交給一般使用者的狀況下，如何在透過網路的前提將裝置更新。</p><p>這是很多硬體都會有的功能，但是就目前而言 Tamashii 並不支援。</p><p>經過幾天的調查，發現有一個 Open Source 的專案似乎符合條件。</p><h1 id=mender-的-ota-伺服器>Mender 的 OTA 伺服器</h1><p>這個開源專案叫做 <a href=https://mender.io/>Mender</a> 是透過好幾種程式語言組合而成，功能也很簡單。在預先製作好的 Linux 發行版本中寫入 Mender 伺服器的位置，只要在伺服器上「認證」這一台裝置，未來就能夠收到來自 Mender 伺服器所提供的更新。</p><p>而更新的方式基本上就是製作一份新的 Rootfs 提供給硬體裝置下載，並且嘗試將這個新的版本加入到現有硬體中，並且嘗試是否能夠正常的運行，如果失敗的話再將舊版的 Rootfs 載入。</p><p>也因此，要能夠使用 Mender 來發布 OTA (Over the Air）更新的話，就必須要能夠製作自己的 Linux 發行版本才可以。</p><h1 id=yocto-專案>Yocto 專案</h1><p>想要讓所有人都知道怎麼自己編譯完整的 Linux 作業系統是很困難的，從韌體、核心（Kernel）到各種開機所需要的套件庫（Library）等等，光是編譯的步驟就非常繁複，更何況還要配合使用不同開發版或者晶片的使用者。</p><p>所以 Mender 也採許了另一套開放原始碼的解決方案，叫做 Yocto 專案。這個專案跟另一個開源專案 OpenEmbedded 已經整合在一起，或者說能夠互通使用。</p><p>在 Yocto 之中，我們透過所謂的 Layer 的疊加就能夠製作出我們所需的 Linux 系統，而有很多硬體上所需要配合的韌體，也大多會有社群貢獻，因此在大部分的情況下都不太需要擔心。</p><blockquote><p>Mender 團隊也提供付費協助處理硬體整合上的問題，也許這是主要的收入之一？</p></blockquote><p>舉例來說，我想要製作一個能在 RaspberryPi 上面執行的 Linux 環境，就需要叫做 <code>meta-respberrypi</code> 這一個 Layer 來幫助我。</p><p>他會依賴於 <code>oe-core</code> 和幾個相關的 Layer 才能夠正確編譯（因為已經有的設定不用重複撰寫）</p><p>當我加入 <code>meta-raspberry</code> 之後，我在選擇編譯的機器類型時，就能夠用像是 <code>MACHINE=raspberrypi3</code> 這樣的模式告知我希望得到能在 Raspberry Pi 3 上執行的 Linux。</p><p>最棒的是，當我們完成這個動作之後，生成的 Linux 鏡像檔案燒入到 SD 卡中就能夠正常運行。</p><blockquote><p>以前嘗試過使用 Buildroot 來製作，但是失敗率非常高。</p></blockquote><p>簡單來說 Yocto 就是一堆社群貢獻預先撰寫好的建置腳本，因此我們只需要專注在自己需要預先加入這個 Linux 環境的部分，像是 Tamashii 或者 Ruby 的運行環境。</p><h1 id=初次嘗試>初次嘗試</h1><p>首先，我們需要可以運行的環境。這篇文章使用的是 CentOS 7 來進行示範，所需的相關套件可以參考 <a href=https://www.yoctoproject.org/docs/2.4/yocto-project-qs/yocto-project-qs.html#yp-resources>Yocto 官方文件</a>來配置，另外要注意的是目前較新版本是需要有 Python 3 的環境，但是 CentOS 7 還是使用 Python 2 需要自己配置。</p><h2 id=下載-poky>下載 Poky</h2><pre><code>git clone -b sumo git://git.yoctoproject.org/poky
</code></pre><p>Poky 類似於一個基礎的樣板，裡面將生成 Yocto 版本的 Linux 必要的相關檔案都放在裡面，我們可以基於這個資料夾來進行後續的設定跟配置。</p><blockquote><p>Yocto 每個版本都會有代號，目前最新的穩定版是 Sumo (2.5) 版</p></blockquote><h2 id=加入-mender>加入 Mender</h2><p>這篇文章會以 Mender 作為例子，這樣在成品階段的時候也比較好用 Mender 來體驗。</p><pre><code>cd poky
git clone -b sumo git://github.com/mendersoftware/meta-mender
</code></pre><p>如此一來，我們就可以在後續的階段使用由 Mender 所製作的 Layer 來提供 OTA 的功能。
不過在此之前，因為我們希望製作的是 Raspberry Pi 版本的 Linux 發行版本，所以還需要先把 Raspberry Pi 對應的 Layer 加入。</p><pre><code>git clone -b sumo git://git.yoctoproject.org/meta-raspberrypi
git clone -b sumo git://git.openembedded.org/meta-openembedded
</code></pre><h2 id=配置-layer>配置 Layer</h2><pre><code>source oe-init-build-env
</code></pre><p>因為 Yocto 已經提供好了各種設置，所以我們只需要透過上面的指令就能切換到對應的建置環境中。</p><blockquote><p>預設會產生一個 <code>build</code> 目錄，如果想要其他目錄的話也可以在後面指定。</p></blockquote><p>然後我們要告訴 Yocto 想要使用哪些 Layer 才能夠正常運作。</p><pre><code>bitbake-layers add-layer ../meta-mender/meta-mender-core
bitbake-layers add-layer ../meta-openembedded/meta-oe
bitbake-layers add-layer ../meta-raspberrypi
bitbake-layers add-layer ../meta-mender/meta-mender-raspberrypi
</code></pre><p>加入上述的 Layer 後，我們就可以產生一個能在 Raspberry Pi 上運行，以及透過 Mender 來做 OTA 更新的 Linux 發行版本。</p><p>不過礙於篇幅的關係，這次我們直接使用 Mender 提供的 Demo Layer 來加入客製化的內容。</p><blockquote><p>如果想加入自己編譯的程式、服務等等，是需要自己建立一個 Layer 來加入的，這樣也能對原有的 Layer 做擴充或者增加設定。</p></blockquote><pre><code>bitbake-layers add-layer ../meta-mender/meta-mender-demo
bitbake-layers add-layer ../meta-mender/meta-mender-raspberrypi
</code></pre><p>接下來，我們要對 <code>conf/local.conf</code> 進行設定，把伺服器位置等等設定值都加入到產生的 Linux 發行版本中，才能夠連接到正確的 Mender 伺服器。</p><pre><code class=language-conf data-lang=conf># 釋出的版本，需要不同才能被辨識出來
MENDER_ARTIFACT_NAME = &quot;release-1&quot;

INHERIT += &quot;mender-full&quot;

# 指定為 Raspberry Pi 3 是預設的目標
MACHINE ?= &quot;raspberrypi3&quot;

# 針對 Raspberry Pi 的額外設定
RPI_USE_U_BOOT = &quot;1&quot;
MENDER_PARTITION_ALIGNMENT = &quot;4194304&quot;
MENDER_BOOT_PART_SIZE_MB = &quot;40&quot;
IMAGE_INSTALL_append = &quot; kernel-image kernel-devicetree&quot;
IMAGE_FSTYPES_remove += &quot; rpi-sdimg&quot;

# 你的 Mender OTA 更新伺服器
MENDER_SERVER_URL = &quot;https://ota.tamashii.io&quot;

DISTRO_FEATURES_append = &quot; systemd&quot;
VIRTUAL-RUNTIME_init_manager = &quot;systemd&quot;
DISTRO_FEATURES_BACKFILL_CONSIDERED = &quot;sysvinit&quot;
VIRTUAL-RUNTIME_initscripts = &quot;&quot;

ARTIFACTIMG_FSTYPE = &quot;ext4&quot;

# Raspberry Pi WiFi 設定（Demo 才有開啟 WiFi 功能）
MENDER_DEMO_WIFI_SSID ?= &quot;ssid&quot;
MENDER_DEMO_WIFI_PASSKEY ?= &quot;password&quot;
</code></pre><h2 id=建置>建置</h2><pre><code>bitbake core-image-full-cmdline
</code></pre><p>執行這個指令後，大概會要花上數小時才會完成，這段時間可以睡覺或打個遊戲。</p><blockquote><p>開發階段我會推薦使用 <code>full-cmdline</code> 的版本，因為可以直接 SSH 到機器或者接上鍵盤除錯。</p></blockquote><p>確認跑起來都沒問題之後，就可以改為使用 <code>core-image-minimal</code> 製作出刪減掉除了開啟 Linux 以及自己加入的額外功能之外，所有不必要的檔案來盡可能的縮小檔案大小。</p><h1 id=後記>後記</h1><p>到這篇文章完成建置的段落，其實從頭到尾只花上數小時。不過目前還在測試如何讓有 C Extension 的 Ruby Gem 可以正常的被 Cross Compile 並且放進自訂的發行版本。</p><p>如果只是想單純的啟用 Ruby 的功能，直接在 <code>conf/local.conf</code> 裡面加上這行。</p><pre><code>IMAGE_INSTALL_append = &quot;ruby &quot;
</code></pre><p>在自訂的發行版本就可以使用 ruby 指令（目前預設是 2.5.0 版）</p><h1 id=總結>總結</h1><p>這篇文章其實只是很粗略的將 Yocto 可以做的事情介紹出來，實際上深入了解 <code>bitbake</code> 這套工具以及 Layer 機制後，就會發現還有很多東西可以做。</p><p>舉例來說能透過 <code>.bbclass</code> 定義一個範本（Ex. <code>rubygem.bbclass</code>）讓其他套件（<code>Package</code>）繼承使用，而除了 Layer 之外，底下還有細分了食譜（<code>Receipe</code>）和套件（<code>Package</code>）可以做很多變的調整。</p><p>或者透過 <code>.bbappend</code> 來對原本的套件修訂，像是目前正在製作的 Tamashii Linux 就是利用這種方法讓 Ruby Gem 的 Cross Compile 得以實現。</p><p>如果之後已經有成熟的 Tamashii Linux 案例，會在分享該如何在 Yocto 上面客製化以 Ruby 為基底的 IoT 裝置嵌入是系統。</p><footer class=article__footer><div class=text-center><div class=fb-share-button data-href="<%- page.permalink %>" data-layout=button_count></div></div><div class="text-center mt-1"><style>.bmc-button img{width:27px!important;margin-bottom:1px!important;box-shadow:none!important;border:none!important;vertical-align:middle!important}.bmc-button{line-height:36px!important;height:37px!important;text-decoration:none!important;display:inline-flex!important;color:#fff!important;background-color:#000!important;border-radius:3px!important;border:1px solid transparent!important;padding:1px 9px!important;font-size:22px!important;letter-spacing:.6px!important;box-shadow:0 1px 2px rgba(190,190,190,.5)!important;-webkit-box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;margin:0 auto!important;font-family:cookie,cursive!important;-webkit-box-sizing:border-box!important;box-sizing:border-box!important;-o-transition:.3s all linear!important;-webkit-transition:.3s all linear!important;-moz-transition:.3s all linear!important;-ms-transition:.3s all linear!important;transition:.3s all linear!important}.bmc-button:hover,.bmc-button:active,.bmc-button:focus{-webkit-box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;text-decoration:none!important;box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;opacity:.85!important;color:#fff!important}</style><link href="https://fonts.googleapis.com/css?family=Cookie&display=swap" rel=stylesheet><a class=bmc-button target=_blank href=https://www.buymeacoffee.com/aotoki><img src=https://bmc-cdn.nyc3.digitaloceanspaces.com/BMC-button-images/BMC-btn-logo.svg rel=noreferrer alt="Buy me a Coffee"><span style=margin-left:5px>Buy me a Coffee</span></a></div><iframe title=LikeCoin scrolling=no frameborder=0 style="display:block;margin:0 auto;height:212px" src="https://button.like.co/in/embed/elct9620/button?referrer=<%- page.permalink %>"></iframe><ul class=article__tag-list><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/%E7%89%A9%E8%81%AF%E7%B6%B2/>物聯網</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/%E7%AD%86%E8%A8%98/>筆記</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/IoT/>IoT</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/Linux/>Linux</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/Ruby/>Ruby</a></li></ul></footer><aside class=related><header class=related__header><h3 class=related__title>相關文章</h3></header><ul><li class=related__item><a class=related__link href=/posts/2018/01/09/How-ruby-raise-an-error/>Ruby 中該如何 Raise 一個錯誤</a></li><li class=related__item><a class=related__link href=/posts/2014/03/24/capistrano-to-vagrant-automated-deployment-experience/>Capistrano to Vagrant 自動部署心得</a></li><li class=related__item><a class=related__link href=/posts/2014/09/04/mruby-in-csharp-the-tragedy-of-rpg-maker-1/>MRuby in C# - 因 RPG Maker 的慘劇（一）</a></li><li class=related__item><a class=related__link href=/posts/2014/09/28/mruby-in-csharp-the-tragedy-of-rpg-maker-2/>MRuby in C# - 因 RPG Maker 的慘劇（二）</a></li><li class=related__item><a class=related__link href=/posts/2015/04/10/mruby-on-web/>mRuby on Web</a></li></ul></aside></div></article><div class=adv><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-2844969736316510 data-ad-slot=5530952976 data-ad-format=auto></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div><section id=comment class=comment-box><h1 class=comment-box__title>留言</h1><div id=disqus_thread></div></div></section></div><footer id=footer><div id=copyright>&copy;2020 <a href="https://plus.google.com/117236344655673213049?rel=author" target=_blank rel=noreferrer>蒼時弦也</a>. All right reversed.</div></footer><link rel=stylesheet href=/css/styls.css><script src=/js/app.min.6e03bcf752b31ab875459fbdd360c766632ead24687ffe499c4cf1f86e9fe489.js></script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5TQLRN" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-5TQLRN');</script><script>window.fbAsyncInit=function(){FB.init({appId:'178355449110',xfbml:true,version:'v2.12'});FB.AppEvents.logPageView();};(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(d.getElementById(id)){return;}
js=d.createElement(s);js.id=id;js.src="https://connect.facebook.net/zh_TW/sdk.js";js.async=true
js.defer=true
fjs.parentNode.insertBefore(js,fjs);}(document,'script','facebook-jssdk'));</script><div class=loading></div></body></html>