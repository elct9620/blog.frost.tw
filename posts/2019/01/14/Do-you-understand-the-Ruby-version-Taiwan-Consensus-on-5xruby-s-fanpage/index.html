<!DOCTYPE html>
<html lang="zh-TW" >
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>你看懂五倍紅寶石粉專上的 Ruby 版台灣共識了嗎？ | 弦而時習之</title>
  <meta name="theme-color" content="#EFEFEF">

  <meta name="author" content="蒼時弦也">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <meta name="description" content="最近「台灣共識」很熱門，公司的粉專也分享了 Ruby 版的台灣共識。 我們在公司內部的群組大家其實討論了蠻久，如果只是單純的去實作跟其他語言一樣的內容，不就沒有意義了嗎？ 我們之所以會選擇用 Ruby 來當作工作上的工具，就表示他有一些特別的地方吸引我們。 所以，上面用了哪些 Ruby 技巧讓我們一起來分析看看！">
<meta name="keywords" content="Ruby,筆記,台灣共識">
<meta property="og:type" content="article">
<meta property="og:title" content="你看懂五倍紅寶石粉專上的 Ruby 版台灣共識了嗎？">
<meta property="og:url" content="https://blog.frost.tw/posts/2019/01/14/Do-you-understand-the-Ruby-version-Taiwan-Consensus-on-5xruby-s-fanpage/">
<meta property="og:site_name" content="弦而時習之">
<meta property="og:description" content="最近「台灣共識」很熱門，公司的粉專也分享了 Ruby 版的台灣共識。 我們在公司內部的群組大家其實討論了蠻久，如果只是單純的去實作跟其他語言一樣的內容，不就沒有意義了嗎？ 我們之所以會選擇用 Ruby 來當作工作上的工具，就表示他有一些特別的地方吸引我們。 所以，上面用了哪些 Ruby 技巧讓我們一起來分析看看！">
<meta property="og:locale" content="zh-TW">
<meta property="og:image" content="https://blog.frost.tw/images/2019-01-14-do-you-understand-the-ruby-version-taiwan-consensus-on-5xruby-s-fanpage/thumbnail.jpg">
<meta property="og:updated_time" content="2019-06-22T02:47:31.595Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="你看懂五倍紅寶石粉專上的 Ruby 版台灣共識了嗎？">
<meta name="twitter:description" content="最近「台灣共識」很熱門，公司的粉專也分享了 Ruby 版的台灣共識。 我們在公司內部的群組大家其實討論了蠻久，如果只是單純的去實作跟其他語言一樣的內容，不就沒有意義了嗎？ 我們之所以會選擇用 Ruby 來當作工作上的工具，就表示他有一些特別的地方吸引我們。 所以，上面用了哪些 Ruby 技巧讓我們一起來分析看看！">
<meta name="twitter:image" content="https://blog.frost.tw/images/2019-01-14-do-you-understand-the-ruby-version-taiwan-consensus-on-5xruby-s-fanpage/thumbnail.jpg">
<link rel="publisher" href="https://plus.google.com/117236344655673213049">
<meta property="fb:app_id" content="178355449110">

  <meta property="fb:pages" content="180666522388">
  <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Blog",
    "name": "弦而時習之",
    "url": "https://blog.frost.tw",
    "image": "http://blog.frost.tw/icon-512.png",
    "description": "蒼時弦也的個人網誌，專注在前端、後端以及遊戲開發，大多使用 Ruby 和 Ruby on Rails 以及 Golang、JS 和 C 語言。",
    "sameAs": [
      "https://www.facebook.com/frost.tw/"
    ]
}
</script>
<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Person",
    "name": "蒼時弦也",
    "url": "https://blog.frost.tw",
    "sameAs": [
      "https://www.facebook.com/elct9620",
      "https://www.instagram.com/elct9620/",
      "https://twitter.com/elct9620",
      "https://plus.google.com/+%E8%92%BC%E6%99%82%E5%BC%A6%E4%B9%9F-plus",
      "https://www.linkedin.com/in/elct9620"
    ]
}
</script>


<script type="application/ld+json">
{
  "@context":"http://schema.org",
  "@type":"Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.frost.tw/posts/2019/01/14/Do-you-understand-the-Ruby-version-Taiwan-Consensus-on-5xruby-s-fanpage/"
  },
  "headline":"你看懂五倍紅寶石粉專上的 Ruby 版台灣共識了嗎？",
  "image": [
    
    "https://blog.frost.tw/images/2019-01-14-do-you-understand-the-ruby-version-taiwan-consensus-on-5xruby-s-fanpage/thumbnail.jpg",
    
    "http://blog.frost.tw/icon-512.png"
  ],
  "datePublished": "2019-01-14T14:00:39.000Z",
  "dateModified": "2019-06-22T02:47:31.595Z",
  "description":"最近「台灣共識」很熱門，公司的粉專也分享了 Ruby 版的台灣共識。我們在公司內部的群組大家其實討論了蠻久，如果只是單純的去實作跟其他語言一樣的內容，不就沒有意義了嗎？我們之所以會選擇用 Ruby 來當作工作上的工具，就表示他有一些特別的地方吸引我們。所以，上面用了哪些 Ruby 技巧讓我們一起來分析看看！",
  "author": {
    "@type": "Person",
    "name": "蒼時弦也"
  },
  "publisher": {
    "@type": "Organization",
    "name": "蒼時弦也",
    "logo": {
      "@type": "ImageObject",
      "url": "http://blog.forst.tw/logo-wide.png"
    }
  }
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
    "@type": "ListItem",
    "position": 1,
    "item": {
      "@id": "https://blog.frost.tw",
      "name": "弦而時習之 ",
      "image": "http://blog.frost.tw/icon-512.png"
    }
  },{
    "@type": "ListItem",
    "position": 2,
    "item": {
      "@id": "https://blog.frost.tw/posts/2019/01/14/Do-you-understand-the-Ruby-version-Taiwan-Consensus-on-5xruby-s-fanpage/",
      "name": "你看懂五倍紅寶石粉專上的 Ruby 版台灣共識了嗎？",
      "image": "https://blog.frost.tw/images/2019-01-14-do-you-understand-the-ruby-version-taiwan-consensus-on-5xruby-s-fanpage/thumbnail.jpg"
    }
  }]
}
</script>




  
  <link rel="canonical" href="https://blog.frost.tw/posts/2019/01/14/Do-you-understand-the-Ruby-version-Taiwan-Consensus-on-5xruby-s-fanpage/">
  
  <link href="/icon-512.png" rel="icon">
  <link rel="alternate" href="/feed.xml" title="弦而時習之" type="application/rss+xml">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <script async src="/js/turbolinks.js"></script>
</head>

  <body>
    <div id="fb-root" data-turbolinks-permanent></div>
    <header id="header">
      
<h1 id="sitename">
  <a href="/" class="hide-text logo--icon align-center">
  弦而時習之
  </a>
</h1>

<aside id="slogan" class="slogan align-center text-center">
  <h2 class="slogan__title">Aotokitsuruya</h2>
  <p class="slogan__description">The Web is attracting  me, so I start learning PHP, HTML, CSS and JavaScript. When I know about Ruby, I fall in love with it. Now, I working with my friend to design games using C++ and still learning web about Golang, Ruby and JavaScript. In the other side, I also be a designer, the reason why the web is attracted me.</p>
</aside>

    </header>
    <div id="wrapper">
      
<article class="post article">
  <header class="article__header">
    <time datetime="2019-01-14T14:00:39.000Z" class="article__time--header">
      Jan.14
    </time>
    
  
    <h1 class="article__title">你看懂五倍紅寶石粉專上的 Ruby 版台灣共識了嗎？</h1>
  


  </header>
  <div class="article__entry">
    
    <p>最近「台灣共識」很熱門，公司的粉專也分享了 Ruby 版的台灣共識。</p>
<p>我們在公司內部的群組大家其實討論了蠻久，如果只是單純的去實作跟其他語言一樣的內容，不就沒有意義了嗎？</p>
<p>我們之所以會選擇用 Ruby 來當作工作上的工具，就表示他有一些特別的地方吸引我們。</p>
<p>所以，上面用了哪些 Ruby 技巧讓我們一起來分析看看！</p>
<a id="more"></a>
<p>先來看一下原始的版本，這是一個可以實際執行的 Ruby 語法。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Consensus92</span><span class="params">(<span class="symbol">countries:</span>, <span class="symbol">system:</span>)</span></span></span><br><span class="line">  Module.new <span class="keyword">do</span></span><br><span class="line">    define_method <span class="string">'definition'</span> <span class="keyword">do</span></span><br><span class="line">      &#123; <span class="symbol">countries:</span> countries, <span class="symbol">system:</span> system &#125;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    define_method <span class="string">'build_consensus_with?'</span> <span class="keyword">do</span> <span class="params">|other|</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span> <span class="keyword">if</span> definition == other.definition</span><br><span class="line">      raise <span class="string">"This is not <span class="subst">#&#123;other&#125;</span> consensus"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Taiwan</span></span></span><br><span class="line">  extend Consensus92(<span class="symbol">countries:</span> <span class="number">2</span>, <span class="symbol">system:</span> <span class="number">2</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">China</span></span></span><br><span class="line">  extend Consensus92(<span class="symbol">countries:</span> <span class="number">1</span>, <span class="symbol">system:</span> <span class="number">2</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">China.build_consensus_with?(Taiwan)</span><br></pre></td></tr></table></figure>
<h2 id="include-與-extend"><a href="#include-與-extend" class="headerlink" title="include 與 extend"></a>include 與 extend</h2><p>大多數時候我們都是對 <code>include</code> 比較熟悉，因為它可以把一些方法切割到一個 Module 裡面，然後在物件中呼叫。</p>
<p>我們先來看一下這段程式碼：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Extension</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">echo</span></span></span><br><span class="line">    puts <span class="string">'ECHO'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span></span><br><span class="line">  <span class="keyword">include</span> Extension</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span></span><br><span class="line">  extend Extension</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">p A.ancestors</span><br><span class="line"><span class="comment"># =&gt; [A, Extension, Object, Kernel, BasicObject]</span></span><br><span class="line">A.new.echo</span><br><span class="line">p B.ancestors</span><br><span class="line"><span class="comment"># =&gt; [B, Object, Kernel, BasicObject]</span></span><br><span class="line">B.echo</span><br></pre></td></tr></table></figure>
<p>我們會發現在 <code>B</code> 上面的繼承上，是沒有 <code>Extension</code> 模組的，所以兩者的差異在哪邊呢？</p>
<blockquote>
<p>因為我們希望是 <code>China.build_consensus_with?(Taiwan)</code> 而不是 <code>China.new.build_consensus_with?(Taiwan.new)</code> 的寫法，才選擇用 <code>extend</code></p>
</blockquote>
<h3 id="線索一"><a href="#線索一" class="headerlink" title="線索一"></a>線索一</h3><p>調查了 Ruby 的文件會發現 <code>include</code> 屬於 <code>Module</code> 物件的行為，而 <code>extend</code> 則是屬於 <code>Object</code> 物件的行為。</p>
<p>簡單說就表示 <code>include</code> 只能作用在 <code>Class</code> 上，物件的實例是不行的，像是下面這樣：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A.new.<span class="keyword">include</span> Extension</span><br></pre></td></tr></table></figure>
<p>但是 <code>extend</code> 是屬於 <code>Object</code> 的行為，所以原本我們預期是這樣</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">B.new.extend Extension</span><br></pre></td></tr></table></figure>
<p>但是同時 Ruby 的所有東西都是物件的一種，所以同理可以證明 <code>Module</code> 也是一種物件（而 <code>Class</code> 物件繼承於 <code>Module</code>）所以下面的用法也會成立：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">B.extend Extension</span><br></pre></td></tr></table></figure>
<h3 id="線索二"><a href="#線索二" class="headerlink" title="線索二"></a>線索二</h3><p>根據 Ruby 文件提供的 <code>extend</code> 實作，大概是長這樣的，意外的很簡單。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> VALUE</span><br><span class="line">rb_obj_extend(<span class="keyword">int</span> argc, VALUE *argv, VALUE obj)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    ID id_extend_object, id_extended;</span><br><span class="line"></span><br><span class="line">    CONST_ID(id_extend_object, <span class="string">"extend_object"</span>);</span><br><span class="line">    CONST_ID(id_extended, <span class="string">"extended"</span>);</span><br><span class="line"></span><br><span class="line">    rb_check_arity(argc, <span class="number">1</span>, UNLIMITED_ARGUMENTS);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; argc; i++)</span><br><span class="line">        Check_Type(argv[i], T_MODULE);</span><br><span class="line">    <span class="keyword">while</span> (argc--) &#123;</span><br><span class="line">        rb_funcall(argv[argc], id_extend_object, <span class="number">1</span>, obj);</span><br><span class="line">        rb_funcall(argv[argc], id_extended, <span class="number">1</span>, obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>裡面其實就只是把 <code>extend</code> 傳入的 Module 都帶入，並且呼叫 <code>extended</code> 和 <code>extend_object</code> 兩個方法。</p>
<p>經過簡單的測試，像下面這樣的修改就能阻止 <code>extend</code> 複製方法。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Extension</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">extend_object</span><span class="params">(obj)</span></span></span><br><span class="line">    <span class="comment"># Do Nothing</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">echo</span></span></span><br><span class="line">    puts <span class="string">'ECHO'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span></span><br><span class="line">  extend Extension</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">B.echo</span><br><span class="line"><span class="comment"># =&gt; undefine method</span></span><br></pre></td></tr></table></figure>
<p>也就是說，在 <code>extend</code> 的行為下，我們會透過 <code>extend_object</code> 方法做某些處理後，才得以「複製」方法，而不是像 <code>include</code> 一樣把整個 Module 放入物件的繼承體系之中。</p>
<blockquote>
<p>因為文章篇幅限制，我們先不去追 <code>extend_object</code> 的源頭。</p>
</blockquote>
<h2 id="Consensus92-的用法"><a href="#Consensus92-的用法" class="headerlink" title="Consensus92 的用法"></a>Consensus92 的用法</h2><p>首先，大家可能會有點疑惑為什麼可以用 <code>extend Consensus92()</code> 這樣的寫法，我們先釐清一下「方法」和「常數」的差異。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Consensus92</span>;</span> <span class="keyword">end</span></span><br><span class="line">p Consensus92()</span><br><span class="line">p Consensus92 <span class="comment"># =&gt; uninitialized constant Consensus92</span></span><br></pre></td></tr></table></figure>
<p>從上面這段程式碼我們可以發現，實際上「方法」和「常數」的命名空間是不同的，也就是說他們兩者並不衝突可以並存。而 Ruby 在這個情況下是透過有沒有 <code>()</code> 來判斷到底是個方法，還是一個常數。</p>
<blockquote>
<p>這邊省略 Ruby 的 Keyword Arguments 解釋，這部分雖然不常見但還是屬於日常使用的一部分。</p>
</blockquote>
<p>那麼，為什麼 <code>Consensus92()</code> 的回傳結果可以被 <code>extend</code> 呢？</p>
<p>這個問題大家可能很快就猜到了，因為我們使用了「匿名模組」的技巧，雖然不確定是否真的有這個詞，不過大多數我們都用「匿名 XX」來稱呼一些沒有取名的定義，所以這邊也就這樣使用吧！</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Consensus92</span></span></span><br><span class="line">  Module.new; <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Taiwan</span></span></span><br><span class="line">  extend Consensus92</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>因為不論 <code>include</code> 還是 <code>extend</code> 都只會確認對象是不是一個 Module 所以在這邊我們「即時」產生一個新的 Module 是符合 Ruby 在運作上的判定，也因此會被視為合法的行為。</p>
<p>所以實際上我們在 <code>Taiwan</code> 和 <code>China</code> 擴充的模組是不一樣的，這樣在程式的意義上，剛好也跟「九二共識沒有共識」的意思重疊在一起，畢竟從一開始「拓展（extend）」的共識就是不同的。</p>
<blockquote>
<p>如果有在使用 Rails 的話，可能會注意到像是 <code>Association_User_CollectionProxy</code> 之類的類別名稱，其實就是運用這種技巧去動態產生的 Class 喔！</p>
</blockquote>
<h2 id="define-method-的理由"><a href="#define-method-的理由" class="headerlink" title="define_method 的理由"></a>define_method 的理由</h2><p>實際上，我們使用 <code>Module.new do; end</code> 和 <code>module Extension; end</code> 的效果是相同的，從下面的程式碼可以得到驗證：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">A = Module.new</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">echo</span></span></span><br><span class="line">    puts <span class="string">'ECHO'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span></span><br><span class="line">  extend A</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">B.echo</span><br></pre></td></tr></table></figure>
<p>既然這樣也會運作，那麼我們為什麼還需要用 <code>define_method</code> 呢？</p>
<p>這是因為我們希望達到類似 Closure 的技巧，看看下面這段程式就會注意到一個有趣的問題：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Consensus92</span><span class="params">(<span class="symbol">countries:</span>)</span></span></span><br><span class="line">  Module.new</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">definition</span></span></span><br><span class="line">      &#123; <span class="symbol">countries:</span> countries &#125;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Taiwan</span></span></span><br><span class="line">  extend Consensus(<span class="symbol">countries:</span> <span class="number">2</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">Taiwan.definition</span><br><span class="line"><span class="comment"># =&gt; undefine variable countries</span></span><br></pre></td></tr></table></figure>
<p>為什麼會這樣，因為對 <code>def</code> 來說 <code>countries</code> 已經是屬於在執行階段的一部分，所以我們在呼叫 <code>definition</code> 的時候才會嘗試去尋找 <code>countries</code> 這個東西，但是他已經無法被找到。</p>
<p>但是 <code>define_method</code> 就不太一樣了！</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Consensus92</span><span class="params">(<span class="symbol">countries:</span>)</span></span></span><br><span class="line">  Module.new <span class="keyword">do</span></span><br><span class="line">    define_method <span class="string">'definition'</span> <span class="keyword">do</span></span><br><span class="line">      &#123; <span class="symbol">countries:</span> countries &#125;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Taiwan</span></span></span><br><span class="line">  extend Consensus92(<span class="symbol">countries:</span> <span class="number">2</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>實際上 <code>define_method</code> 在被呼叫的當下，會被轉成像這樣的樣子</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">definition</span></span></span><br><span class="line">  &#123; <span class="symbol">countries:</span> <span class="number">2</span> &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>這是因為對於 <code>define_method</code> 所傳入的 Block 是用來定義方法的內容，但是因為我們是在呼叫一個方法，所以 <code>countries</code> 變數就被視為是處於 <code>Consensus92</code> 方法的環境下，而不是呼叫的當下。</p>
<blockquote>
<p>稍微有點難懂，不過是不是很像 Closure 的感覺呢？</p>
</blockquote>
<h2 id="總結"><a href="#總結" class="headerlink" title="總結"></a>總結</h2><p>這段程式碼其實算是有不少巧思在裡面，把程式碼換成中文讀起來意思也是很容易懂的。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> 九二共識<span class="params">(國家<span class="symbol">:</span>, 制度<span class="symbol">:</span>)</span></span></span><br><span class="line">  Module.new <span class="keyword">do</span></span><br><span class="line">    define_method <span class="string">'定義'</span> <span class="keyword">do</span></span><br><span class="line">      &#123; 國家: 國家, 制度: 制度 &#125;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    define_method <span class="string">'建立共識？'</span> <span class="keyword">do</span> <span class="params">|定義|</span></span><br><span class="line">      <span class="keyword">return</span> 是 如果 定義 == 對方.定義</span><br><span class="line">      raise <span class="string">"這不是<span class="subst">#&#123;other&#125;</span>共識"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> 台灣</span></span><br><span class="line">  擴充 九二共識(國家: <span class="number">2</span>, 制度: <span class="number">2</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> 中國</span></span><br><span class="line">  擴充 九二共識(國家: <span class="number">1</span>, 制度: <span class="number">2</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">中國.建立共識?（台灣）</span><br><span class="line"><span class="comment"># =&gt; 錯誤「這不是台灣共識」</span></span><br></pre></td></tr></table></figure>
<p>這也是 Ruby 在 DSL 表現優異上的原因之一，我們可以透過許多動態定義或者語法上的特殊技巧，製作出非常接近我們習慣的語言跟用法。</p>
<p>這篇文章提到關於 Ruby 類別上的應用，可以參考之前寫過的<a href="https://blog.frost.tw/posts/2017/10/22/The-ruby-s-class-is-free-Part-1/">自由的 Ruby 類別</a>來了解背後的機制。</p>

    
    <footer class="article__footer">
      
        <div class="text-center">
          <div class="fb-share-button" data-href="https://blog.frost.tw/posts/2019/01/14/Do-you-understand-the-Ruby-version-Taiwan-Consensus-on-5xruby-s-fanpage/" data-layout="button_count">
          </div>
        </div>
        <p align="center">
          <a href="https://ko-fi.com/J3J78093" target="_blank">
            <img height="36" style="border:0px;height:36px;" src="https://az743702.vo.msecnd.net/cdn/kofi5.png?v=0" border="0" alt="Buy Me a Coffee at ko-fi.com">
          </a>
        </p>
        <iframe scrolling="no" frameborder="0" style="display: block; margin: 0 auto; height: 212px;" src="https://button.like.co/in/embed/elct9620/button?referrer=https://blog.frost.tw/posts/2019/01/14/Do-you-understand-the-Ruby-version-Taiwan-Consensus-on-5xruby-s-fanpage/"></iframe>
        
          <ul class="article__tag-list"><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/Ruby/">Ruby</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/台灣共識/">台灣共識</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/筆記/">筆記</a></li></ul>
        
      
    </footer>
  </div>
</article>


  
    <div class="adv">
      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      <!-- 網誌_文末廣告 (Hexo) -->
      <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2844969736316510" data-ad-slot="5530952976" data-ad-format="auto"></ins>
      <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
  

  
<section id="comment" class="comment-box">
  <h1 class="comment-box__title">留言</h1>

  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>






    </div>
    <footer id="footer">
      <div id="copyright">
  &copy;2013 <a href="https://plus.google.com/117236344655673213049?rel=author" target="_blank">蒼時弦也</a>. All right reversed.
</div>

    </footer>
    

  <script type="text/javascript">
  window.disqus_shortname = 'revo-skill-frost';

  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + window.disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }());
  
  </script>

  
  <!-- Google Tag Manager -->
  <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5TQLRN" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-5TQLRN');</script>
  <!-- End Google Tag Manager -->
  

  <script>
    window.fbAsyncInit = function() {
      FB.init({
        appId      : '178355449110',
        xfbml      : true,
        version    : 'v2.12'
      });

      FB.AppEvents.logPageView();

    };

    (function(d, s, id){
       var js, fjs = d.getElementsByTagName(s)[0];
       if (d.getElementById(id)) {return;}
       js = d.createElement(s); js.id = id;
       js.src = "https://connect.facebook.net/zh_TW/sdk.js";
       js.async = true
       fjs.parentNode.insertBefore(js, fjs);
     }(document, 'script', 'facebook-jssdk'));
  </script>

  <script src="/js/app.js"></script>


    <div class="loading"></div>
  </body>
</html>
