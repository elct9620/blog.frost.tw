<!DOCTYPE html><html lang="zh-TW"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><title>我在 Ruby 埋了一個陷阱 - Signal 的應用 | 弦而時習之</title><meta name="theme-color" content="#EFEFEF"><meta name="author" content="蒼時弦也"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="description" content="在 Ruby 之中，其實隱藏了很多非常實用的標準函式庫，而 Signal 就是其中一個。 我們在寫 Ruby 大多數時候都是 Ruby on Rails 框架的應用，但是你們有想過當我們在一些 Gem 運行的時候，使用 Ctrl + C 為什麼不會出現錯誤嗎？ 例如我們常常用到的 irb 和 pry 為什麼按下 Ctrl + C 的時候不是直接中斷，卻還能繼續運作？"><meta name="keywords" content="心得,Ruby,作業系統,Daemon"><meta property="og:type" content="article"><meta property="og:title" content="我在 Ruby 埋了一個陷阱 - Signal 的應用"><meta property="og:url" content="https://blog.frost.tw/posts/2019/03/12/I-make-a-trap-in-the-Ruby-the-usage-of-Signal/"><meta property="og:site_name" content="弦而時習之"><meta property="og:description" content="在 Ruby 之中，其實隱藏了很多非常實用的標準函式庫，而 Signal 就是其中一個。 我們在寫 Ruby 大多數時候都是 Ruby on Rails 框架的應用，但是你們有想過當我們在一些 Gem 運行的時候，使用 Ctrl + C 為什麼不會出現錯誤嗎？ 例如我們常常用到的 irb 和 pry 為什麼按下 Ctrl + C 的時候不是直接中斷，卻還能繼續運作？"><meta property="og:locale" content="zh-TW"><meta property="og:image" content="https://blog.frost.tw/images/2019-03-12-i-make-a-trap-in-the-ruby-the-usage-of-signal/thumbnail.jpg"><meta property="og:updated_time" content="2019-06-22T02:47:31.597Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="我在 Ruby 埋了一個陷阱 - Signal 的應用"><meta name="twitter:description" content="在 Ruby 之中，其實隱藏了很多非常實用的標準函式庫，而 Signal 就是其中一個。 我們在寫 Ruby 大多數時候都是 Ruby on Rails 框架的應用，但是你們有想過當我們在一些 Gem 運行的時候，使用 Ctrl + C 為什麼不會出現錯誤嗎？ 例如我們常常用到的 irb 和 pry 為什麼按下 Ctrl + C 的時候不是直接中斷，卻還能繼續運作？"><meta name="twitter:image" content="https://blog.frost.tw/images/2019-03-12-i-make-a-trap-in-the-ruby-the-usage-of-signal/thumbnail.jpg"><link rel="publisher" href="https://plus.google.com/117236344655673213049"><meta property="fb:app_id" content="178355449110"><meta property="fb:pages" content="180666522388"><script type="application/ld+json">[
{
    "@context": "http://schema.org",
    "@type": "Blog",
    "name": "弦而時習之",
    "url": "https://blog.frost.tw",
    "image": "http://blog.frost.tw/icon-512.png",
    "description": "蒼時弦也的個人網誌，專注在前端、後端以及遊戲開發，大多使用 Ruby 和 Ruby on Rails 以及 Golang、JS 和 C 語言。",
    "sameAs": [
      "https://www.facebook.com/frost.tw/"
    ]
},
{
    "@context": "http://schema.org",
    "@type": "Person",
    "name": "蒼時弦也",
    "url": "https://blog.frost.tw",
    "sameAs": [
      "https://www.facebook.com/elct9620",
      "https://www.instagram.com/elct9620/",
      "https://twitter.com/elct9620",
      "https://plus.google.com/+%E8%92%BC%E6%99%82%E5%BC%A6%E4%B9%9F-plus",
      "https://www.linkedin.com/in/elct9620"
    ]
},
{
  "@context":"http://schema.org",
  "@type":"BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.frost.tw/posts/2019/03/12/I-make-a-trap-in-the-Ruby-the-usage-of-Signal/"
  },
  "headline":"我在 Ruby 埋了一個陷阱 - Signal 的應用",
  "image": [
    
    "https://blog.frost.tw/images/2019-03-12-i-make-a-trap-in-the-ruby-the-usage-of-signal/thumbnail.jpg",
    
    "http://blog.frost.tw/icon-512.png"
  ],
  "thumbnailUrl": "https://blog.frost.tw/images/2019-03-12-i-make-a-trap-in-the-ruby-the-usage-of-signal/thumbnail.jpg", 
  "datePublished": "2019-03-12T13:29:15.000Z",
  "dateModified": "2019-06-22T02:47:31.597Z",
  "description":"在 Ruby 之中，其實隱藏了很多非常實用的標準函式庫，而 Signal 就是其中一個。我們在寫 Ruby 大多數時候都是 Ruby on Rails 框架的應用，但是你們有想過當我們在一些 Gem 運行的時候，使用 Ctrl + C 為什麼不會出現錯誤嗎？例如我們常常用到的 irb 和 pry 為什麼按下 Ctrl + C 的時候不是直接中斷，卻還能繼續運作？",
  "author": {
    "@type": "Person",
    "name": "蒼時弦也"
  },
  "publisher": {
    "@type": "Organization",
    "name": "蒼時弦也",
    "logo": {
      "@type": "ImageObject",
      "url": "http://blog.forst.tw/logo-wide.png"
    }
  }
},
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
    "@type": "ListItem",
    "position": 1,
    "item": {
      "@id": "https://blog.frost.tw",
      "name": "弦而時習之 ",
      "image": "http://blog.frost.tw/icon-512.png"
    }
  },{
    "@type": "ListItem",
    "position": 2,
    "item": {
      "@id": "https://blog.frost.tw/posts/2019/03/12/I-make-a-trap-in-the-Ruby-the-usage-of-Signal/",
      "name": "我在 Ruby 埋了一個陷阱 - Signal 的應用",
      "image": "https://blog.frost.tw/images/2019-03-12-i-make-a-trap-in-the-ruby-the-usage-of-signal/thumbnail.jpg"
    }
  }]
}

]</script><link rel="canonical" href="https://blog.frost.tw/posts/2019/03/12/I-make-a-trap-in-the-Ruby-the-usage-of-Signal/"><link href="/icon-512.png" rel="icon"><link rel="alternate" href="/feed.xml" title="弦而時習之" type="application/rss+xml"><!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--><link rel="stylesheet" href="/css/style.css" media="screen" type="text/css"><script async src="/js/turbolinks.js"></script></head><body><div id="fb-root" data-turbolinks-permanent></div><header id="header"><h1 id="sitename"><a href="/" class="hide-text logo--icon align-center">弦而時習之</a></h1><aside id="slogan" class="slogan align-center text-center"><h2 class="slogan__title">Aotokitsuruya</h2><p class="slogan__description">The Web is attracting me, so I start learning PHP, HTML, CSS and JavaScript. When I know about Ruby, I fall in love with it. Now, I working with my friend to design games using C++ and still learning web about Golang, Ruby and JavaScript. In the other side, I also be a designer, the reason why the web is attracted me.</p></aside></header><div id="wrapper"><article class="post article"><header class="article__header"><time datetime="2019-03-12T13:29:15.000Z" class="article__time--header">Mar.12</time><h1 class="article__title">我在 Ruby 埋了一個陷阱 - Signal 的應用</h1></header><div class="article__entry"><p>在 Ruby 之中，其實隱藏了很多非常實用的標準函式庫，而 Signal 就是其中一個。</p><p>我們在寫 Ruby 大多數時候都是 Ruby on Rails 框架的應用，但是你們有想過當我們在一些 Gem 運行的時候，使用 Ctrl + C 為什麼不會出現錯誤嗎？</p><p>例如我們常常用到的 <code>irb</code> 和 <code>pry</code> 為什麼按下 Ctrl + C 的時候不是直接中斷，卻還能繼續運作？</p><a id="more"></a><h2 id="常駐程式"><a href="#常駐程式" class="headerlink" title="常駐程式"></a>常駐程式</h2><p>一般來說我們很少會用 Ruby 寫一個常駐程式（Daemon）不過有時候我們希望持續的抓資料或者監聽一個 Socket 的時候，還是會需要用到類似下面這樣的實作。</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line">loop <span class="keyword">do</span></span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>當我們跑起來之後，用 Ctrl + C 去中斷的話，就會出現類似下面的錯誤訊息。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">        2: from loop.rb:3:in `&lt;main&gt;&apos;</span><br><span class="line">        1: from loop.rb:3:in `loop&apos;</span><br><span class="line">loop.rb:5:in `block in &lt;main&gt;&apos;: Interrupt</span><br></pre></td></tr></table></figure><p>這是因為我們的程式在未預期的狀況下被「中斷（Interrupt）」的關係。</p><h2 id="Signal"><a href="#Signal" class="headerlink" title="Signal"></a>Signal</h2><p>在很多 Unix 作業系統中，我們可以對任一一個執行中的程式（Process）發送一個 Signal 來告訴這個程式該做什麼。</p><p>也因此，我們可以從<a href="https://zh.wikipedia.org/wiki/Unix%E4%BF%A1%E5%8F%B7" target="_blank" rel="external nofollow noopener noreferrer">維基百科</a>的解說其實可以了解到，平常我們很習慣的 Ctrl + C 其實就是發送訊號的動作，而這個訊號剛好就是 SIGINT （中斷訊號）</p><p>另一方面，我們的程式卡住又無法關閉的時候，也會使用 <code>kill</code> 指令來強致終止程式，其實也是對程式發送訊號的一種形式。</p><p>像是我想要終止 PID 1000 的程式，可以像這樣下指令。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -int 1000</span><br></pre></td></tr></table></figure><p>如此一來就可以發送一個 SIGINT 給 PID 1000 的程式。</p><p>由此可見，有很多我們平常在使用的東西都有支援接收訊號，例如 Nginx 的<a href="https://nginx.org/en/docs/control.html" target="_blank" rel="external nofollow noopener noreferrer">文件</a>就有說明哪些訊號可以做哪些事情。</p><p>像是 <code>SIGHUP</code> 可以讓 Nginx 重新讀取設定檔，也就是 <code>nginx -s reload</code> 的指令（雖然大多數時候我們可能都會直接重開 Nginx 吧⋯⋯）</p><p>有了這些概念後，我們就可以用 Ruby 提供的 Signal 來做一些應用。</p><h2 id="Graceful-Shutdown"><a href="#Graceful-Shutdown" class="headerlink" title="Graceful Shutdown"></a>Graceful Shutdown</h2><p>當我們在執行一個迴圈處理事情的時候，如果遇到中斷的情況，很有可能會沒有把事情做完。</p><p>例如我們嘗試插入三筆資料到資料庫，到第二筆的時候就被中斷，那麼就會損失第三筆資料，而且下次重新執行的時候就會有錯誤的結果。</p><blockquote><p>這個情況實務上應該是要善用資料庫的 Transaction （交易）功能，來確保該做的事情都完成後一起 Commit （確認）</p></blockquote><p>所以，要避免一些「不應該直接被中斷」的情況，我們就可以善用 <code>Signal.trap</code> 這個方法。</p><p>稍微改良一下文章一開始的無限迴圈，變成像這樣：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line">running = <span class="literal">true</span></span><br><span class="line">Signal.trap(<span class="symbol">:INT</span>) &#123; running = <span class="literal">false</span> &#125;</span><br><span class="line"></span><br><span class="line">loop <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">break</span> <span class="keyword">unless</span> running</span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>按下 Ctrl + C 就不會有任何錯誤，因為對 Ruby 來說他還是確實的執行完畢一個迴圈才停止，而不是跑到一半就被直接中斷。</p><h2 id="小結"><a href="#小結" class="headerlink" title="小結"></a>小結</h2><p>這算是一個超級冷知識吧，不過大多數的程式語言其實都有提供這樣的機制。而且這個功能其實也很好用，例如我們可以做一個 Ctrl + C 兩次才離開的功能。</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">try_exit = <span class="number">0</span></span><br><span class="line">Signal.trap(<span class="symbol">:INT</span>) <span class="keyword">do</span></span><br><span class="line">  try_exit += <span class="number">1</span></span><br><span class="line">  puts <span class="string">"Are you sure exit? Press Ctrl + C Again"</span> <span class="keyword">if</span> try_exit == <span class="number">1</span></span><br><span class="line">  running = <span class="literal">true</span> <span class="keyword">if</span> try_exit == <span class="number">2</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">loop <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">break</span> <span class="keyword">if</span> try_exit == <span class="number">2</span></span><br><span class="line">  <span class="comment"># ...</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>如此一來，我們就可以有效的避免程式意外中斷。</p><blockquote><p>剩下要擔心的大概就是停電或者被強制中開機的狀況了吧⋯⋯</p></blockquote><p>另外 Ruby 還有一個叫做 <code>at_exit</code> 的方法，之後機會可以來和 Signal 比較一下使用情境上的差異。</p><footer class="article__footer"><div class="text-center"><div class="fb-share-button" data-href="https://blog.frost.tw/posts/2019/03/12/I-make-a-trap-in-the-Ruby-the-usage-of-Signal/" data-layout="button_count"></div></div><p align="center"><a href="https://ko-fi.com/J3J78093" target="_blank" rel="external nofollow noopener noreferrer"><img height="36" style="border:0;height:36px" src="https://az743702.vo.msecnd.net/cdn/kofi5.png?v=0" border="0" alt="Buy Me a Coffee at ko-fi.com"></a></p><iframe scrolling="no" frameborder="0" style="display:block;margin:0 auto;height:212px" src="https://button.like.co/in/embed/elct9620/button?referrer=https://blog.frost.tw/posts/2019/03/12/I-make-a-trap-in-the-Ruby-the-usage-of-Signal/"></iframe><ul class="article__tag-list"><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/Daemon/">Daemon</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/Ruby/">Ruby</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/作業系統/">作業系統</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/心得/">心得</a></li></ul></footer></div></article><div class="adv"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2844969736316510" data-ad-slot="5530952976" data-ad-format="auto"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><section id="comment" class="comment-box"><h1 class="comment-box__title">留言</h1><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a rel="nofollow" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></div><footer id="footer"><div id="copyright">&copy;2013 <a href="https://plus.google.com/117236344655673213049?rel=author" target="_blank" rel="external nofollow noopener noreferrer">蒼時弦也</a>. All right reversed.</div></footer><script type="text/javascript">window.disqus_shortname="revo-skill-frost",function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+window.disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5TQLRN" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><script>!function(e,t,a,n,g){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var m=t.getElementsByTagName(a)[0],r=t.createElement(a);r.async=!0,r.src="//www.googletagmanager.com/gtm.js?id=GTM-5TQLRN",m.parentNode.insertBefore(r,m)}(window,document,"script","dataLayer")</script><script>window.fbAsyncInit=function(){FB.init({appId:"178355449110",xfbml:!0,version:"v2.12"}),FB.AppEvents.logPageView()},function(e,n,t){var o,s=e.getElementsByTagName(n)[0];e.getElementById(t)||((o=e.createElement(n)).id=t,o.src="https://connect.facebook.net/zh_TW/sdk.js",o.async=!0,s.parentNode.insertBefore(o,s))}(document,"script","facebook-jssdk")</script><script src="/js/app.js"></script><div class="loading"></div></body></html>