<!doctype html><html lang=zh-tw><head><title>COSCUP 2019 - 演講後談復活的頁遊 - Unlight （二） - 弦而時習之</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="寫完上篇後就開始員工旅遊、鐵人賽（從讀遊戲原始碼學做連線遊戲）反而一直都沒有時間把下篇寫完，離 COSCUP 都已經過了一個多月自己都忘記還剩什麼沒有寫在文章裡面。
中間在鐵人賽的部分花了一些時間把目前理解到關於 Unlight 的一些基本設計整理出來，後面則是實作。至於近期也已經開始在搭建 HTML5 版本的底層設計，還有 mruby …"><meta name=created content="2019-10-20T00:00:00+0000"><meta name=modified content="2019-10-20T17:09:31+0000"><meta name=author content="蒼時弦也"><meta property="og:site_name" content="弦而時習之"><meta property="og:title" content="COSCUP 2019 - 演講後談復活的頁遊 - Unlight （二）"><meta property="og:url" content="https://blog.frost.tw/posts/2019/10/20/COSCUP-2019-Talk-about-the-browser-game-Unlight-which-I-revived-it-Part-2/"><meta property="og:type" content="article"><meta property="og:image" content="https://blog.frost.tw/images/2019-09-03-coscup-2019-talk-about-the-browser-game-unlight-which-i-revived-it/screenshot.png"><meta name=theme-color content="#EFEFEF"><link href=https://blog.frost.tw/icon-512.png rel=icon><link rel=canonical href=https://blog.frost.tw/posts/2019/10/20/COSCUP-2019-Talk-about-the-browser-game-Unlight-which-I-revived-it-Part-2/><script type=application/ld+json>[{"@context":"https://schema.org","@type":"WebPage","headline":"COSCUP 2019 - 演講後談復活的頁遊 - Unlight （二）","datePublished":"2019-10-20T17:09:31Z","dateModified":"2019-10-20T17:09:31Z","url":"https://blog.frost.tw/posts/2019/10/20/COSCUP-2019-Talk-about-the-browser-game-Unlight-which-I-revived-it-Part-2/","description":"寫完上篇後就開始員工旅遊、鐵人賽（從讀遊戲原始碼學做連線遊戲）反而一直都沒有時間把下篇寫完，離 COSCUP 都已經過了一個多月自己都忘記還剩什麼沒有寫在文章裡面。\n中間在鐵人賽的部分花了一些時間把目前理解到關於 Unlight 的一些基本設計整理出來，後面則是實作。至於近期也已經開始在搭建 HTML5 版本的底層設計，還有 mruby …\n","keywords":["COSCUP","Game","Ruby","Golang","HTML5","JavaScript","DevOps","Docker","Unlight"],"image":"https://blog.frost.tw/images/2019-09-03-coscup-2019-talk-about-the-browser-game-unlight-which-i-revived-it/screenshot.png","author":{"@type":"Person","name":"蒼時弦也"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.frost.tw/"},"publisher":{"@type":"Organization","name":"弦而時習之","url":"https://blog.frost.tw/"}},{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https://blog.frost.tw/","name":"弦而時習之","image":"http://blog.frost.tw/icon-512.png"}},{"@type":"ListItem","position":2,"item":{"@id":"https://blog.frost.tw/posts/2019/10/20/COSCUP-2019-Talk-about-the-browser-game-Unlight-which-I-revived-it-Part-2/","name":"COSCUP 2019 - 演講後談復活的頁遊 - Unlight （二）","image":"https://blog.frost.tw/images/2019-09-03-coscup-2019-talk-about-the-browser-game-unlight-which-i-revived-it/screenshot.png"}}]}]</script><link rel=stylesheet href=/css/styls.css><script async src=/js/turbolinks.min.js></script></head><body><div id=fb-root data-turbolinks-permanent></div><h1 id=sitename><a href=/ class="hide-text logo--icon align-center">弦而時習之</a></h1><aside id=slogan class="slogan align-center text-center"><h2 class=slogan__title>Aotokitsuruya</h2><p class=slogan__description>The Web is attracting me, so I start learning PHP, HTML, CSS and JavaScript. When I know about Ruby, I fall in love with it. Now, I working with my friend to design games using C++ and still learning web about Golang, Ruby and JavaScript. In the other side, I also be a designer, the reason why the web is attracted me.</p></aside><div id=wrapper><article class="post article" role=article><header class=article__header><time datetime=2019-10-20T17:09:31+0000 class=article__time--header role=time>Feb.20</time><h1 class=article__title>COSCUP 2019 - 演講後談復活的頁遊 - Unlight （二）</h1></header><div class=article__entry><nav class=translation></nav><p>寫完<a href=https://blog.frost.tw/posts/2019/09/03/COSCUP-2019-Talk-about-the-browser-game-Unlight-which-I-revived-it/>上篇</a>後就開始員工旅遊、鐵人賽（<a href=https://ithelp.ithome.com.tw/users/20065771/ironman/2734>從讀遊戲原始碼學做連線遊戲</a>）反而一直都沒有時間把下篇寫完，離 COSCUP 都已經過了一個多月自己都忘記還剩什麼沒有寫在文章裡面。</p><p>中間在鐵人賽的部分花了一些時間把目前理解到關於 Unlight 的一些基本設計整理出來，後面則是實作。至於近期也已經開始在搭建 HTML5 版本的底層設計，還有 mruby 的<a href=https://github.com/elct9620/mruby.wasm>整合</a>（因為想提供 Mod 功能到遊戲中）等等東西都在進行中，十一月還要飛日本一趟參加 <a href=https://2019.rubyworld-conf.org/en/>Ruby World Conference</a>，可以說是完全都閒不下來。</p><p>總之，讓我們在來看看 COSCUP 這場演講的後續吧 XD</p><h2 id=營運>營運</h2><p>前面基本上已經把整個遊戲能緊急處理的都做過一遍了，因此後需要繼續的明顯就是要怎麼讓遊戲可以持續的運作。最初基本上都是用看 Log 的方式在觀察玩家，連上線人數都要開一個 SSH 連線到伺服器刷 Log 來看，很明顯是不太 OK 的做法。</p><p>因此就開始評估有什麼解法比較適合，因為大量的改動不熟悉的程式碼（遊戲量很大）是一件危險很高的事情，尤其是雖然專案看起來有測試但是卻完全找不到。</p><p>所以最後決定的做法就是在某些特定檔案做小規模的修改，先以「增加監控」能力為主，因此我們先做的就是讓上線人數可以到 CloudWatch 上面被看到，至少能統計 DAU (Daily Active User) 來評估遊戲是否該做調整之類的。</p><p>解決方案也是簡單粗暴，因為只有 Auth Server 在連上的狀態遊戲才能正常遊玩，因此直接對 Auth Server 吐線上玩家統計 Log 的地方用同樣的方式 Hack 出一個定時把資料吐回 CloudWatch 的功能。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ruby data-lang=ruby>                          <span class=no>EM</span><span class=o>::</span><span class=no>PeriodicTimer</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=mi>60</span><span class=p>,</span> <span class=nb>proc</span> <span class=p>{</span>
                            <span class=k>begin</span>
                              <span class=no>SERVER_LOG</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;AuthServer: [cloud_watch:] updated online number&#34;</span><span class=p>)</span>
                              <span class=no>CLOUD_WATCH</span><span class=o>.</span><span class=n>put_metric_data</span><span class=p>({</span>
                                <span class=ss>namespace</span><span class=p>:</span> <span class=s1>&#39;Unlight&#39;</span><span class=p>,</span>
                                <span class=ss>metric_data</span><span class=p>:</span> <span class=o>[</span><span class=p>{</span>
                                  <span class=ss>metric_name</span><span class=p>:</span> <span class=s1>&#39;OnlineNumber&#39;</span><span class=p>,</span>
                                  <span class=ss>dimensions</span><span class=p>:</span> <span class=o>[</span>
                                    <span class=p>{</span>
                                      <span class=nb>name</span><span class=p>:</span> <span class=s1>&#39;Hostname&#39;</span><span class=p>,</span>
                                      <span class=ss>value</span><span class=p>:</span> <span class=no>ENV</span><span class=o>[</span><span class=s1>&#39;SERVER_NAME&#39;</span><span class=o>]</span> <span class=o>||</span> <span class=s1>&#39;unlight.app&#39;</span>
                                    <span class=p>}</span>
                                  <span class=o>]</span><span class=p>,</span>
                                  <span class=ss>timestamp</span><span class=p>:</span> <span class=no>Time</span><span class=o>.</span><span class=n>now</span><span class=p>,</span>
                                  <span class=ss>value</span><span class=p>:</span> <span class=no>AuthServer</span><span class=o>.</span><span class=n>class_variable_get</span><span class=p>(</span><span class=ss>:@@online_list</span><span class=p>)</span><span class=o>.</span><span class=n>size</span><span class=p>,</span>
                                  <span class=ss>unit</span><span class=p>:</span> <span class=s1>&#39;Count&#39;</span>
                                <span class=p>}</span><span class=o>]</span>
                              <span class=p>})</span>
                            <span class=k>rescue</span> <span class=o>=&gt;</span><span class=n>e</span>
                              <span class=no>SERVER_LOG</span><span class=o>.</span><span class=n>fatal</span><span class=p>(</span><span class=s2>&#34;AuthServer: [cloud_watch:] fatal error </span><span class=si>#{</span><span class=n>e</span><span class=si>}</span><span class=s2>:</span><span class=si>#{</span><span class=n>e</span><span class=o>.</span><span class=n>backtrace</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
                            <span class=k>end</span>
                          <span class=p>})</span>
</code></pre></td></tr></table></div></div><p>除此之外我們也盡量使用像是 Google Analytics 等工具追蹤一些我們額外掛上去的功能，不過受限於 Flash 很多東西還是追不到的狀態。</p><h2 id=客製化>客製化</h2><p>不過想要加額外的東西是會影響到我們目前在 <a href=https://github.com/open-unlight/legacy-unlight-docker>GitHub</a> 公開的版本，這個版本是基於 CPA 釋出的原始碼建構並且修正一些有問題的小地方。如果去調整的話會造成所有人都需要跟我們使用一樣的架構。</p><p>但是這很明顯不應該出現在一個 Open Source 專案上，從設計的角度看也應該提供選擇才對，所以最後的作法就是增加一個 <code>customize</code> 目錄來放這些客製化的東西。</p><p>在 Docker 的建置過程中，我們可以使用多次 <code>ADD</code> 來加入檔案，如果是重複的檔案就會被覆蓋掉，利用這樣的特性就可以做到類似這樣的客製化調整。</p><pre><code>原始 Gemfile -&gt; 自訂 Gemfile -&gt; 原始檔案 -&gt; 自訂檔案
</code></pre><p>如此一來最後整合出來的專案就會是被客製化修改過的，利用這樣的特性我們就把 CloudWatch 的線上玩家監控，還有遊戲中透過 API 方式開放的課金道具商店給實作出來。</p><h2 id=rack>Rack</h2><p>不過在 Unlight 這樣的 TCP 專案上要怎麼擴充出 API 呢？因為本質上他還是一個 Ruby 專案，因此我們只需要時做一個符合 Rack 介面的標準就可以任意讓 Web Server 啟動他跑起來。實際上在這方面 Unlight 做得還算不錯，整體專案上分為幾個大區塊</p><ul><li><code>model/</code> - 資料相關，通常會連接資料庫</li><li><code>controller/</code> 邏輯相關，遊戲的運作本體</li><li>其他大多是輔助的工具，還有比較特殊的是遊戲規則定義（Rule 目錄）</li></ul><p>因為操作的部分已經被封裝到 Model 裡面，像是「發放給玩家一個道具」這樣的動作是封裝好的，因此我們可以在 API 透過這樣的方式直接發放道具給玩家。</p><blockquote><p>在 Controller 裡面會是「檢查玩家是否符合條件，然後發放道具」的組合動作。</p></blockquote><h2 id=客服>客服</h2><p>這段基本上很難做，我們後來的作法就是搭配各種工具。像是 <a href=https://help.unlight.com.tw/hc/zh-tw>Zendesk</a> 這類工具來提供玩家回報問題的地方，網頁右下角直接會有能回報錯誤的按鈕可以查詢 FAQ 或者回報問題。</p><p>內部的話則是用 Discord 和 Asana 等工具溝通跟討論下一階段更新要做什麼、有什麼事情要優先處理等等。</p><blockquote><p>幫助按鈕後來改左邊，因為我們加上了 Discord Widget 讓玩家可以透過 Chatbot 在我們的玩家群組裡面發言而不需要登入或者註冊。</p></blockquote><h2 id=html5>HTML5</h2><p>最後是 HTML5 改版，考慮到只有 WebSocket 可以使用的情況下勢必要去改伺服器來實現 WebSocket 不然就無法使用。不過運氣不錯的是這件事情剛好因為 Unlight 是使用 EventMachine 來處理 TCP 連線的，因此我把 WebSocket 套件加上去之後做一些簡單的修改，就勉強可以使用 WebSocket 來作為伺服器。</p><blockquote><p>Ruby 目前的 WebSocket Gem 是基於 EventMachine 開發的，因此在連線處理上幾乎沒有太大的變化。</p></blockquote><p>不過還是缺失了不少功能，演講當時基本上就簡單分享了一下 WebSocket 的機制跟目前的進度。寫這篇文章的時候已經透過 Electron.js 製作桌機版讓 Flash 續命時間增加了一定程度，又發現能夠直接透過 Node.js 做 TCP 連線，因此目前的主力已經先轉移到將 HTML5 Client 開發出來後先直接使用原有伺服器來運行，等到 Client 穩定後再去修改伺服器的作法。</p><p>在這之前，因為 Unlight 的指令是很用 Byte 去組合而成的結構在 JavaScript 上也很難處理。因此又開了一個 <a href=https://github.com/open-unlight/go-ul>Go UL</a> 的專案想利用 Golang 來解析，在轉換成 WebAssembly 整合到 JavaScript 上面來改善這方面的處理問題（SPR 的密碼加密計算用 Golang 也會比 JavaScript 容易處理，畢竟 BigInt 在 JavaScript 上也需要額外的支援）</p><h2 id=後記>後記</h2><p>這場演講基本上算是一個過程上的紀錄，在短短一到兩週內的時間怎麼去讓一款遊戲可以運行、營運，以及我們是怎樣慢慢的改造跟重構一個古老的遊戲專案讓他變得容易維護。</p><p>不過實際上當時評估如果要繼續做下去的話，絕對是花上一兩年都跑不到的大工程，雖然不知道能堅持到什麼時候但至少每一個階段都能發現有趣的東西，應該是還可以繼續在努力很久。反而是關於 IP 上的問題，也就是遊戲的內容本身因為並沒有實際的完全開放，反而讓未來改版完畢後遊戲想要進入新的階段變得非常受限⋯⋯</p><p>不過也因為這款遊戲，讓我自己在遊戲開發上有很多不確定的東西有了一個大概知道能怎麼做的方案，以及很多新的想法可以嘗試。</p><p>那麼，就請大家期待在不久的未來我們重新開發過的 Unlight 會是怎樣的面貌了 XD</p><footer class=article__footer><div class=text-center><div class=fb-share-button data-href="<%- page.permalink %>" data-layout=button_count></div></div><div class="text-center mt-1"><style>.bmc-button img{width:27px!important;margin-bottom:1px!important;box-shadow:none!important;border:none!important;vertical-align:middle!important}.bmc-button{line-height:36px!important;height:37px!important;text-decoration:none!important;display:inline-flex!important;color:#fff!important;background-color:#000!important;border-radius:3px!important;border:1px solid transparent!important;padding:1px 9px!important;font-size:22px!important;letter-spacing:.6px!important;box-shadow:0 1px 2px rgba(190,190,190,.5)!important;-webkit-box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;margin:0 auto!important;font-family:cookie,cursive!important;-webkit-box-sizing:border-box!important;box-sizing:border-box!important;-o-transition:.3s all linear!important;-webkit-transition:.3s all linear!important;-moz-transition:.3s all linear!important;-ms-transition:.3s all linear!important;transition:.3s all linear!important}.bmc-button:hover,.bmc-button:active,.bmc-button:focus{-webkit-box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;text-decoration:none!important;box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;opacity:.85!important;color:#fff!important}</style><link href="https://fonts.googleapis.com/css?family=Cookie" rel=stylesheet><a class=bmc-button target=_blank href=https://www.buymeacoffee.com/aotoki><img src=https://bmc-cdn.nyc3.digitaloceanspaces.com/BMC-button-images/BMC-btn-logo.svg alt="Buy me a Coffee"><span style=margin-left:5px>Buy me a Coffee</span></a></div><iframe scrolling=no frameborder=0 style="display:block;margin:0 auto;height:212px" src="https://button.like.co/in/embed/elct9620/button?referrer=<%- page.permalink %>"></iframe><ul class=article__tag-list><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/COSCUP/>COSCUP</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/Game/>Game</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/Ruby/>Ruby</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/Golang/>Golang</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/HTML5/>HTML5</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/JavaScript/>JavaScript</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/DevOps/>DevOps</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/Docker/>Docker</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/Unlight/>Unlight</a></li></ul></footer><aside class=related><header class=related__header><h3 class=related__title>相關文章</h3></header><ul><li class=related__item><a class=related__link href=/posts/2019/09/03/COSCUP-2019-Talk-about-the-browser-game-Unlight-which-I-revived-it/>COSCUP 2019 - 演講後談復活的頁遊 - Unlight （一）</a></li><li class=related__item><a class=related__link href=/posts/2019/08/04/Fast-review-the-Unlight-game-s-source-code/>快速閱讀頁遊 Unlight 開源後的原始碼</a></li><li class=related__item><a class=related__link href=/posts/2019/07/09/Build-a-simple-uptime-status-page-use-CloudFlare-Workers/>用 CloudFlare Workers 製作簡單的 Uptime Status 頁面</a></li><li class=related__item><a class=related__link href=/posts/2019/03/20/The-zero-configure-dockerfile-for-rails/>如何在沒有任何設定下產生 Rails 的 Docker Image</a></li><li class=related__item><a class=related__link href=/posts/2013/08/05/coscup-2-13-lighting-talk-additional/>COSCUP 2013 - Lighting Talk 補充</a></li></ul></aside></div></article><div class=adv><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-2844969736316510 data-ad-slot=5530952976 data-ad-format=auto></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div><section id=comment class=comment-box><h1 class=comment-box__title>留言</h1><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"revo-skill-frost"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></section></div><footer id=footer><div id=copyright>&copy;2020 <a href="https://plus.google.com/117236344655673213049?rel=author" target=_blank rel=noreferrer>蒼時弦也</a>. All right reversed.</div></footer><script src=/js/app.min.4b4fad1b2ae959091673cb811c0b1b88781c8a49c7b1bf1a3a3ff449f4be31ac.js></script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5TQLRN" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-5TQLRN');</script><script>window.fbAsyncInit=function(){FB.init({appId:'178355449110',xfbml:true,version:'v2.12'});FB.AppEvents.logPageView();};(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(d.getElementById(id)){return;}
js=d.createElement(s);js.id=id;js.src="https://connect.facebook.net/zh_TW/sdk.js";js.async=true
js.defer=true
fjs.parentNode.insertBefore(js,fjs);}(document,'script','facebook-jssdk'));</script><div class=loading></div></body></html>