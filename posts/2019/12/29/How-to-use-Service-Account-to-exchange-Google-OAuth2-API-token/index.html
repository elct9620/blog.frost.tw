<!doctype html><html lang=zh-tw><head><title>如何透過 Service Account 來取得 Google API 的 OAuth2 Token - 弦而時習之</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="前陣子在嘗試一些比較少見的 Google API 時發現，在 Google 提供的 Ruby Gem 裡面並不支援這個 API 的實作，這表示需要自己去想辦法解決如何去呼叫這個 API 的問題。
不過呼叫 API 需要 Access Token 才能夠使用，以往我們都是依靠第三方套件或者 Google 官方提供的 Gem 直接呼叫，似乎很 …"><meta name=created content="2019-12-29T00:00:00+0000"><meta name=modified content="2019-12-29T20:43:04+0000"><meta name=author content="蒼時弦也"><meta property="og:site_name" content="弦而時習之"><meta property="og:title" content="如何透過 Service Account 來取得 Google API 的 OAuth2 Token"><meta property="og:url" content="https://blog.frost.tw/posts/2019/12/29/How-to-use-Service-Account-to-exchange-Google-OAuth2-API-token/"><meta property="og:type" content="article"><meta property="og:image" content="https://blog.frost.tw/images/2019-12-29-how-to-use-service-account-to-exchange-google-oauth2-api-token/thumbnail.jpg"><meta name=theme-color content="#EFEFEF"><link href=https://blog.frost.tw/icon-512.png rel=icon><link rel=canonical href=https://blog.frost.tw/posts/2019/12/29/How-to-use-Service-Account-to-exchange-Google-OAuth2-API-token/><script type=application/ld+json>[{"@context":"https://schema.org","@type":"WebPage","headline":"如何透過 Service Account 來取得 Google API 的 OAuth2 Token","datePublished":"2019-12-29T00:00:00Z","dateModified":"2019-12-29T20:43:04Z","url":"https://blog.frost.tw/posts/2019/12/29/How-to-use-Service-Account-to-exchange-Google-OAuth2-API-token/","description":"前陣子在嘗試一些比較少見的 Google API 時發現，在 Google 提供的 Ruby Gem 裡面並不支援這個 API 的實作，這表示需要自己去想辦法解決如何去呼叫這個 API 的問題。\n不過呼叫 API 需要 Access Token 才能夠使用，以往我們都是依靠第三方套件或者 Google 官方提供的 Gem 直接呼叫，似乎很 …\n","keywords":["JWT","OAuth2","Service Account","Ruby","API","Google"],"image":"https://blog.frost.tw/images/2019-12-29-how-to-use-service-account-to-exchange-google-oauth2-api-token/thumbnail.jpg","author":{"@type":"Person","name":"蒼時弦也"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.frost.tw/"},"publisher":{"@type":"Organization","name":"弦而時習之","url":"https://blog.frost.tw/"}},{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/blog.frost.tw\/","name":"弦而時習之","image":"http:\/\/blog.frost.tw\/icon-512.png"}},{"@type":"ListItem","position":2,"item":{"@id":"https:\/\/blog.frost.tw\/posts\/2019\/12\/29\/How-to-use-Service-Account-to-exchange-Google-OAuth2-API-token\/","name":"如何透過 Service Account 來取得 Google API 的 OAuth2 Token","image":"https:\/\/blog.frost.tw\/images\/2019-12-29-how-to-use-service-account-to-exchange-google-oauth2-api-token\/thumbnail.jpg"}}]}]</script><link rel=stylesheet href=/css/styls.css><script async src=/js/turbolinks.min.js></script></head><body><div id=fb-root data-turbolinks-permanent></div><h1 id=sitename><a href=/ class="hide-text logo--icon align-center">弦而時習之</a></h1><aside id=slogan class="slogan align-center text-center"><h2 class=slogan__title>Aotokitsuruya</h2><p class=slogan__description>The Web is attracting me, so I start learning PHP, HTML, CSS and JavaScript. When I know about Ruby, I fall in love with it. Now, I working with my friend to design games using C++ and still learning web about Golang, Ruby and JavaScript. In the other side, I also be a designer, the reason why the web is attracted me.</p></aside><div id=wrapper><article class="post article"><header class=article__header><time datetime=2019-12-29T20:43:04+0000 class=article__time--header>Feb.29</time><h1 class=article__title>如何透過 Service Account 來取得 Google API 的 OAuth2 Token</h1></header><div class=article__entry><nav class=translation></nav><p>前陣子在嘗試一些比較少見的 Google API 時發現，在 Google 提供的 Ruby Gem 裡面並不支援這個 API 的實作，這表示需要自己去想辦法解決如何去呼叫這個 API 的問題。</p><p>不過呼叫 API 需要 Access Token 才能夠使用，以往我們都是依靠第三方套件或者 Google 官方提供的 Gem 直接呼叫，似乎很少去直接實作客戶端。另一方面我們對 OAuth2 的認識大多是做 SSO（Single Sign On）而非這種伺服器對伺服器的呼叫。</p><p>以 Google 這種規模的公司，如果是直接使用一般 OAuth2 的伺服器對伺服器的作法似乎也不太適合，而 Google 提供的解決方案就是 Service Account 了！</p><h2 id=jwt>JWT</h2><p>自從前端成為一個專門的專業並且逐漸完善、複雜，這中間出現了一個叫做 JWT（JSON Web Token）的應用，現在很多網站應該也都採用 JWT 來作為 API 的 Token。畢竟使用 JSON 記錄使用者的基本資訊，就能夠透過驗證 JWT 的可靠來確認是否為信任的認證伺服器發出，再根據 JSON 上的資訊就可以免去一次查詢使用者跟權限的操作，對比較複雜或者比較大的系統來說就能節省下不少時間。</p><p>在 Google API 的 Servie Account 認證流程就是透過 JWT 來完成的，不過事情並沒有我們想像中那麼簡單生成一個 JWT 就可以直接呼叫。</p><h2 id=grant-code>Grant Code</h2><p>回到正題，如果我們去看 Google 的<a href=https://developers.google.com/identity/protocols/OAuth2ServiceAccount>文件</a>會發現我們前面提到的 JWT 其實是用來產生 Grant Code 的作用，而不是直接用來產生 Access Token 的（文件後面有說有例外，不過一般來說都是需要再跑一次流程）</p><p>也就是說，我們在整個流程中是這樣的步驟：</p><ol><li>使用 Service Account 生成 JWT (Grant Code)</li><li>在伺服端走 OAuth2 流程用 Grant Code 換取 Access Token</li><li>透過 Access Token 呼叫 Google API</li></ol><p>至於生成的 JWT 中基本上只需要指定 Issuer 和 Scope 並且用正確的 Private Key 做簽章，就能夠順利通過 OAuth2 驗證獲取 Access Token。</p><h2 id=實作>實作</h2><p>前面兩段的敘述感覺有點複雜，不過我們直接實際實作一次就非常容易理解，可能還比我們平常使用的 OAuth2 流程容易不少。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ruby data-lang=ruby><span class=c1># frozen_string_literal: true</span>

<span class=nb>require</span> <span class=s1>&#39;bundler/inline&#39;</span>

<span class=n>gemfile</span> <span class=k>do</span>
  <span class=n>source</span> <span class=s1>&#39;https://rubygems.org&#39;</span>

  <span class=n>gem</span> <span class=s1>&#39;jwt&#39;</span>
<span class=k>end</span>

<span class=nb>require</span> <span class=s1>&#39;json&#39;</span>
<span class=nb>require</span> <span class=s1>&#39;openssl&#39;</span>
<span class=nb>require</span> <span class=s1>&#39;net/http&#39;</span>
</code></pre></td></tr></table></div></div><p>這次我們直接使用單個 Ruby 檔案來實作，整個流程非常簡單而且不複雜唯一需要的就是 JWT 的套件。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ruby data-lang=ruby><span class=n>service_account</span> <span class=o>=</span> <span class=no>JSON</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=no>File</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=s1>&#39;./service_account.json&#39;</span><span class=p>)</span><span class=p>)</span>
<span class=n>privkey</span> <span class=o>=</span> <span class=no>OpenSSL</span><span class=o>::</span><span class=no>PKey</span><span class=o>::</span><span class=no>RSA</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>service_account</span><span class=o>[</span><span class=s1>&#39;private_key&#39;</span><span class=o>]</span><span class=p>)</span>
<span class=n>payload</span> <span class=o>=</span> <span class=p>{</span>
  <span class=ss>iss</span><span class=p>:</span> <span class=n>service_account</span><span class=o>[</span><span class=s1>&#39;client_email&#39;</span><span class=o>]</span><span class=p>,</span>
  <span class=ss>scope</span><span class=p>:</span> <span class=s1>&#39;https://www.googleapis.com/auth/wallet_object.issuer&#39;</span><span class=p>,</span>
  <span class=ss>aud</span><span class=p>:</span> <span class=s1>&#39;https://oauth2.googleapis.com/token&#39;</span><span class=p>,</span>
  <span class=ss>exp</span><span class=p>:</span> <span class=no>Time</span><span class=o>.</span><span class=n>now</span><span class=o>.</span><span class=n>to_i</span> <span class=o>+</span> <span class=mi>60</span><span class=o></span><span class=p>,</span>
  <span class=ss>iat</span><span class=p>:</span> <span class=no>Time</span><span class=o>.</span><span class=n>now</span><span class=o>.</span><span class=n>to_i</span>
<span class=p>}</span>

<span class=n>token</span> <span class=o>=</span> <span class=no>JWT</span><span class=o>.</span><span class=n>encode</span> <span class=n>payload</span><span class=p>,</span> <span class=n>privkey</span><span class=p>,</span> <span class=s1>&#39;RS256&#39;</span>
</code></pre></td></tr></table></div></div><p>接下來我們把 Service Account 的內容讀取進來產生 JWT，一般我們會選擇 JSON 格式來抓取。之前可能會有點疑惑就是為什麼還會提供 p12 的檔案格式，從這個步驟我們大概就可以猜出來原因。</p><p>在這個 JWT 裡面，我們需要 Service Account 裡面的 Client Email 和 Private Key 兩個資訊，剛好對應的就是我們在 Google API 上面開設的 Service Account 的 Email 以及 p12 這個檔案，安全性上在 Google 的處理中也是用非對稱加密的方式來做，因此我們會拿到一個 Private Key 用來產生這些 Token。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-ruby data-lang=ruby><span class=n>uri</span> <span class=o>=</span> <span class=no>URI</span><span class=p>(</span><span class=s1>&#39;https://oauth2.googleapis.com/token&#39;</span><span class=p>)</span>
<span class=n>req</span> <span class=o>=</span> <span class=no>Net</span><span class=o>::</span><span class=no>HTTP</span><span class=o>::</span><span class=no>Post</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>uri</span><span class=p>)</span>
<span class=n>req</span><span class=o>[</span><span class=s1>&#39;Content-Type&#39;</span><span class=o>]</span> <span class=o>=</span> <span class=s1>&#39;application/x-www-form-urlencoded&#39;</span>
<span class=n>req</span><span class=o>.</span><span class=n>body</span> <span class=o>=</span> <span class=no>URI</span><span class=o>.</span><span class=n>encode_www_form</span><span class=p>(</span>
  <span class=ss>grant_type</span><span class=p>:</span> <span class=s1>&#39;urn:ietf:params:oauth:grant-type:jwt-bearer&#39;</span><span class=p>,</span>
  <span class=ss>assertion</span><span class=p>:</span> <span class=n>token</span>
<span class=p>)</span>

<span class=n>res</span> <span class=o>=</span> <span class=no>Net</span><span class=o>::</span><span class=no>HTTP</span><span class=o>.</span><span class=n>start</span><span class=p>(</span><span class=n>uri</span><span class=o>.</span><span class=n>host</span><span class=p>,</span> <span class=n>uri</span><span class=o>.</span><span class=n>port</span><span class=p>,</span> <span class=ss>use_ssl</span><span class=p>:</span> <span class=kp>true</span><span class=p>)</span> <span class=k>do</span> <span class=o>|</span><span class=n>http</span><span class=o>|</span>
  <span class=n>http</span><span class=o>.</span><span class=n>request</span> <span class=n>req</span>
<span class=k>end</span>

<span class=n>access_token</span> <span class=o>=</span> <span class=no>JSON</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=n>res</span><span class=o>.</span><span class=n>body</span><span class=p>)</span><span class=o>[</span><span class=s1>&#39;access_token&#39;</span><span class=o>]</span>
</code></pre></td></tr></table></div></div><p>最後就是對 Google 的 OAuth2 API 發出一個請求來換取 Access Token 的請求，接下來我們就能利用這個 Access Token 去存取我們希望存取的資源。</p><blockquote><p>雖然沒有測試過，但是在 Service Account 開設時沒有授權的權限，即使 Scope 有指定也是拿不到對應的授權的。</p></blockquote><h2 id=firebase>Firebase</h2><p>看到這個用法，我另外一個聯想到的就是 Firebase 的 <a href=https://firebase.google.com/docs/auth/admin/create-custom-tokens#create_custom_tokens_using_a_third-party_jwt_library>Custom Token</a> 機制，我們一樣會先跟 Firebase 請求一個 Service Account 用來生成這個 Token。</p><p>產生的 JWT 的設置幾乎跟前面提到的方式差不多，只是內容改為針對 Firebase 做出了一些調整。</p><h2 id=總結>總結</h2><p>其實整體來說並不複雜，不過會想寫這篇文章是因為之前雖然看過 Firebase 的使用方式卻沒有多想。這次透過 Google API 串接了解到在 JWT 和 OAuth2 的搭配應用上還能有這樣的變化，算是非常直得學習的一個方式。</p><p>相較於我們直接將 JWT 作為 Access Token 的使用方式，這種方式在某種層面上來說提供了我們在一些額外應用場景的新選擇，就我自己目前能想到的就有像是 API 服務、IoT 裝置等等，不過前陣子有稍微查了一下是否有其他專案有這樣的應用方式，資料似乎還不多。</p><p>不過至少未來設計服務的時候可以多一種方式來提供 API 串接的選項，畢竟以 Service Account 方式的管理似乎是比原本對每個客戶端都開設 Application 還簡單了一些（或者內部隱含的還是做了 Application 的註冊）</p><footer class=article__footer><div class=text-center><div class=fb-share-button data-href="<%- page.permalink %>" data-layout=button_count></div></div><div class="text-center mt-1"><style>.bmc-button img{width:27px!important;margin-bottom:1px!important;box-shadow:none!important;border:none!important;vertical-align:middle!important}.bmc-button{line-height:36px!important;height:37px!important;text-decoration:none!important;display:inline-flex!important;color:#fff!important;background-color:#000!important;border-radius:3px!important;border:1px solid transparent!important;padding:1px 9px!important;font-size:22px!important;letter-spacing:.6px!important;box-shadow:0 1px 2px rgba(190,190,190,.5)!important;-webkit-box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;margin:0 auto!important;font-family:cookie,cursive!important;-webkit-box-sizing:border-box!important;box-sizing:border-box!important;-o-transition:.3s all linear!important;-webkit-transition:.3s all linear!important;-moz-transition:.3s all linear!important;-ms-transition:.3s all linear!important;transition:.3s all linear!important}.bmc-button:hover,.bmc-button:active,.bmc-button:focus{-webkit-box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;text-decoration:none!important;box-shadow:0 1px 2px 2px rgba(190,190,190,.5)!important;opacity:.85!important;color:#fff!important}</style><link href="https://fonts.googleapis.com/css?family=Cookie" rel=stylesheet><a class=bmc-button target=_blank href=https://www.buymeacoffee.com/aotoki><img src=https://bmc-cdn.nyc3.digitaloceanspaces.com/BMC-button-images/BMC-btn-logo.svg alt="Buy me a Coffee"><span style=margin-left:5px>Buy me a Coffee</span></a></div><iframe scrolling=no frameborder=0 style="display:block;margin:0 auto;height:212px" src="https://button.like.co/in/embed/elct9620/button?referrer=<%- page.permalink %>"></iframe><ul class=article__tag-list><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/JWT/>JWT</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/OAuth2/>OAuth2</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/Ruby/>Ruby</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/API/>API</a></li><li class=article__tag-list-item><a class=article__tag-list-link href=https://blog.frost.tw/tags/Google/>Google</a></li></ul></footer></div></article><div class=adv><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-2844969736316510 data-ad-slot=5530952976 data-ad-format=auto></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div><section id=comment class=comment-box><h1 class=comment-box__title>留言</h1><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"revo-skill-frost"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></section></div><footer id=footer><div id=copyright>&copy;2020 <a href="https://plus.google.com/117236344655673213049?rel=author" target=_blank rel=noreferrer>蒼時弦也</a>. All right reversed.</div></footer><script src=/js/app.min.e979702d4c2a76dd5e32acda7647b733e4959a8621df075338d00d2c6837e87a.js></script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5TQLRN" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-5TQLRN');</script><script>window.fbAsyncInit=function(){FB.init({appId:'178355449110',xfbml:true,version:'v2.12'});FB.AppEvents.logPageView();};(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(d.getElementById(id)){return;}
js=d.createElement(s);js.id=id;js.src="https://connect.facebook.net/zh_TW/sdk.js";js.async=true
js.defer=true
fjs.parentNode.insertBefore(js,fjs);}(document,'script','facebook-jssdk'));</script><div class=loading></div></body></html>