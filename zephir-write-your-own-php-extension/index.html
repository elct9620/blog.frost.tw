<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  
  <title>用 Zephir 寫自己的 PHP Extension | 弦而時習之</title>
  <meta name="theme-color" content="#EFEFEF">

  <meta name="author" content="蒼時弦也">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1">

  <meta name="description" content="前一篇文章說到了 Zephir 於是這篇就要來研究一下摟～ 關於這篇文章，會做以下幾件事情：  安裝 &amp;amp; 設定 寫一個簡易的 Router 改寫成 Zephir 版本 安裝 Extension 以及測試  那麼，廢話不多說，馬上開始吧！">
<meta name="keywords" content="PHP,C,Zephir,網站開發">
<meta property="og:type" content="article">
<meta property="og:title" content="用 Zephir 寫自己的 PHP Extension">
<meta property="og:url" content="https://blog.frost.tw/zephir-write-your-own-php-extension/">
<meta property="og:site_name" content="弦而時習之">
<meta property="og:description" content="前一篇文章說到了 Zephir 於是這篇就要來研究一下摟～ 關於這篇文章，會做以下幾件事情：  安裝 &amp;amp; 設定 寫一個簡易的 Router 改寫成 Zephir 版本 安裝 Extension 以及測試  那麼，廢話不多說，馬上開始吧！">
<meta property="og:locale" content="zh-TW">
<meta property="og:image" content="http://blog.frost.tw/icon-512.png">
<meta property="og:updated_time" content="2017-07-02T17:07:07.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="用 Zephir 寫自己的 PHP Extension">
<meta name="twitter:description" content="前一篇文章說到了 Zephir 於是這篇就要來研究一下摟～ 關於這篇文章，會做以下幾件事情：  安裝 &amp;amp; 設定 寫一個簡易的 Router 改寫成 Zephir 版本 安裝 Extension 以及測試  那麼，廢話不多說，馬上開始吧！">
<meta name="twitter:image" content="http://blog.frost.tw/icon-512.png">
<link rel="publisher" href="https://plus.google.com/117236344655673213049">
<meta property="fb:app_id" content="178355449110">

  <meta property="fb:pages" content="180666522388" />
  <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Blog",
    "name": "弦而時習之",
    "url": "https://blog.frost.tw",
    "image": "http://blog.frost.tw/icon-512.png",
    "description": "蒼時弦也的個人網誌，專注在前端、後端以及遊戲開發，大多使用 Ruby 和 Ruby on Rails 以及 Golang、JS 和 C 語言。",
    "sameAs": [
      "https://www.facebook.com/frost.tw/"
    ]
}
</script>
<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Person",
    "name": "蒼時弦也",
    "url": "https://blog.frost.tw",
    "sameAs": [
      "https://www.facebook.com/elct9620",
      "https://www.instagram.com/elct9620/",
      "https://twitter.com/elct9620",
      "https://plus.google.com/+%E8%92%BC%E6%99%82%E5%BC%A6%E4%B9%9F-plus",
      "https://www.linkedin.com/in/elct9620"
    ]
}
</script>


<script type="application/ld+json">
{
  "@context":"http://schema.org",
  "@type":"Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.frost.tw/zephir-write-your-own-php-extension/"
  },
  "headline":"用 Zephir 寫自己的 PHP Extension",
  "image": [
    
    "http://blog.frost.tw/icon-512.png"
  ],
  "datePublished": "2013-10-05T07:30:00.000Z",
  "dateModified": "2017-07-02T17:07:07.000Z",
  "description":"前一篇文章說到了 Zephir 於是這篇就要來研究一下摟～關於這篇文章，會做以下幾件事情：安裝 &amp; 設定寫一個簡易的 Router改寫成 Zephir 版本安裝 Extension 以及測試那麼，廢話不多說，馬上開始吧！",
  "author": {
    "@type": "Person",
    "name": "蒼時弦也"
  },
  "publisher": {
    "@type": "Organization",
    "name": "蒼時弦也",
    "logo": {
      "@type": "ImageObject",
      "url": "http://blog.forst.tw/logo-wide.png"
    }
  }
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
    "@type": "ListItem",
    "position": 1,
    "item": {
      "@id": "https://blog.frost.tw",
      "name": "弦而時習之 ",
      "image": "http://blog.frost.tw/icon-512.png"
    }
  },{
    "@type": "ListItem",
    "position": 2,
    "item": {
      "@id": "https://blog.frost.tw/zephir-write-your-own-php-extension/",
      "name": "用 Zephir 寫自己的 PHP Extension",
      "image": "http://blog.frost.tw/icon-512.png"
    }
  }]
}
</script>




  
  <link rel="canonical" href="https://blog.frost.tw/zephir-write-your-own-php-extension/" />
  
  <link href="/icon-512.png" rel="icon">
  <link rel="alternate" href="/feed.xml" title="弦而時習之" type="application/rss+xml">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <script async src="/js/turbolinks.js"></script>
</head>

  <body>
    <div id="fb-root" data-turbolinks-permanent></div>
    <header id="header">
      
<h1 id="sitename">
  <a href="/" class="hide-text logo--icon align-center">
  弦而時習之
  </a>
</h1>

<aside id="slogan" class="slogan align-center text-center">
  <h2 class="slogan__title">Aotokitsuruya</h2>
  <p class="slogan__description">The Web is attracting  me, so I start learning PHP, HTML, CSS and JavaScript. When I know about Ruby, I fall in love with it. Now, I working with my friend to design games using C++ and still learning web about Golang, Ruby and JavaScript. In the other side, I also be a designer, the reason why the web is attracted me.</p>
</aside>

    </header>
    <div id="wrapper">
      
<article class="post article">
  <header class="article__header">
    <time datetime="2013-10-05T07:30:00.000Z" class="article__time--header">
      Oct.05
    </time>
    
  
    <h1 class="article__title">用 Zephir 寫自己的 PHP Extension</h1>
  


  </header>
  <div class="article__entry">
    
    <p>前一篇文章說到了 <a href="http://zephir-lang.com/" target="_blank" rel="noopener">Zephir</a> 於是這篇就要來研究一下摟～</p>
<p>關於這篇文章，會做以下幾件事情：</p>
<ul>
<li>安裝 &amp; 設定</li>
<li>寫一個簡易的 Router</li>
<li>改寫成 Zephir 版本</li>
<li>安裝 Extension 以及測試</li>
</ul>
<p>那麼，廢話不多說，馬上開始吧！</p>
<a id="more"></a>
<p>因為我習慣使用 Mac 所以是用 Mac 的方式安裝，不過 Zephir 並沒有表明支援 Mac 使用上需要多加小心。<br>如果你懶得安裝或者希望使用 Linux 環境，可以考慮使用 <strong>阿土伯</strong> 大大在 PHPConf 2013 時 Demo 用的 Vagrant Box - <a href="https://Github.com/racklin/phalcon-dev-box" target="_blank" rel="noopener">Phalcon Dev Box</a> 裡面已經配置好 Zephir 可以直接使用。</p>
<h3 id="安裝"><a href="#安裝" class="headerlink" title="安裝"></a>安裝</h3><p>首先，我們要安裝相依套件。</p>
<blockquote>
<p>brew install re2c<br>brew install json-c</p>
</blockquote>
<p>不過 re2c 似乎在安裝 XCode 時已經有了，而且我系統內的版本還比 Homebrew 的還新（基本上跳出有安裝過之類的訊息就不用再次安裝了⋯⋯）</p>
<p>因為 Zephir 似乎沒有單一個執行檔的功能，因此我個人是習慣放到 <code>~/.tools</code> 資料夾裡面，與一般工具區分開來。</p>
<blockquote>
<p>cd ~/.tools<br>git clone <a href="https://Github.com/phalcon/zephir" target="_blank" rel="noopener">https://Github.com/phalcon/zephir</a><br>cd zephir</p>
</blockquote>
<p>因為 Mac 中沒有 /opt/local/lib 這個目錄，我們要編輯 install 這個檔案。<br>把 <code>-L/opt/local/lib</code> 這段刪除（讓編譯時不要在這個目錄找相關的 Library）</p>
<p>修改後的 install 裡面的 gcc 指令大概會長這樣</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -Wl,-rpath /usr/<span class="built_in">local</span>/lib -I/usr/<span class="built_in">local</span>/lib -L/usr/<span class="built_in">local</span>/lib -g3 parser.c scanner.c -ljson -ljson-c -o ../bin/zephir-parser</span><br></pre></td></tr></table></figure>
<p>之後執行 install 即可</p>
<blockquote>
<p>./install</p>
</blockquote>
<p>接著可以修改 <code>~/.bashrc</code> 或者相關檔案，加入以下這行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:~/.tools/zephir/bin</span><br></pre></td></tr></table></figure>
<p>重開 Terminal 或者輸入 <code>source ~/.bashrc</code> 之後，就可以直接使用 zephir 指令了！</p>
<h3 id="寫一個簡單的-Router"><a href="#寫一個簡單的-Router" class="headerlink" title="寫一個簡單的 Router"></a>寫一個簡單的 Router</h3><p>為了可以觀察到改變，我們先來用 PHP 做一個簡單的 Router 測試。<br>基本上就是會將 <code>http://localhost/myApp/index</code> 轉成 <code>$controller = new MyApp(); $controller-&gt;index()</code> 的語法。</p>
<p>這邊基本上就不多敘述實作，以下是這次範例用的 Router 原始碼。</p>
<figure class="highlight php"><figcaption><span>Router.PHP</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?PHP</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyRouter</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span> </span>&#123;</span><br><span class="line">true<span class="keyword">protected</span> $basePath = <span class="string">""</span>;</span><br><span class="line">  <span class="keyword">protected</span> $currentPath = <span class="string">""</span>;</span><br><span class="line">  <span class="keyword">protected</span> $defaultMethod = <span class="string">""</span>;</span><br><span class="line">  <span class="keyword">public</span> $notFound = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($basePath = <span class="string">""</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;basePath = $basePath;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;defaultMethod = <span class="string">"index"</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Dispatch</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * Create class instance and call method</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    $parseURI = <span class="keyword">$this</span>-&gt;parseURI();</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;basePath) &amp;&amp; <span class="keyword">$this</span>-&gt;basePath == $parseURI[<span class="number">0</span>]) &#123;</span><br><span class="line">      $parseURI = array_slice($parseURI, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $class = <span class="keyword">null</span>;</span><br><span class="line">    $method = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($parseURI[<span class="number">0</span>])) &#123;</span><br><span class="line">      $class = $parseURI[<span class="number">0</span>];</span><br><span class="line">      $class = ucwords($class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($parseURI[<span class="number">1</span>])) &#123;</span><br><span class="line">      $method = $parseURI[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(is_null($class) || !class_exists($class)) &#123;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;error(<span class="number">404</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $classInstance = <span class="keyword">new</span> $class;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(is_null($method)) &#123;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;callMethod($classInstance, <span class="keyword">$this</span>-&gt;defaultMethod);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;callMethod($classInstance, $method);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Call Method</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> object $class</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> string $method</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">callMethod</span><span class="params">($class, $method)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(is_callable(<span class="keyword">array</span>($class, $method))) &#123;</span><br><span class="line">      call_user_func(<span class="keyword">array</span>($class, $method));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;error(<span class="number">404</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Error</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> int $code</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">error</span><span class="params">($code = <span class="number">500</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>($code == <span class="number">404</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span>(is_callable(<span class="keyword">$this</span>-&gt;notFound)) &#123;</span><br><span class="line">        call_user_func(<span class="keyword">$this</span>-&gt;notFound);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"404 Not Found"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"Error &#123;$code&#125;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Parse URI</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * Analytic URL and turn into class and method</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * return array [$class, $method]</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseURI</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    $currentURI = $_SERVER[<span class="string">'REQUEST_URI'</span>];</span><br><span class="line">    $pattern = <span class="string">"/\/([a-z][a-z0-9-]*)/i"</span>;</span><br><span class="line"></span><br><span class="line">    $matches = <span class="keyword">array</span>();</span><br><span class="line">    preg_match_all($pattern, $currentURI, $matches);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> array_slice($matches, <span class="number">1</span>)[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用方式（index.PHP 為例）</p>
<figure class="highlight php"><figcaption><span>index.PHP</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?PHP</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span>(<span class="string">"Router.PHP"</span>);</span><br><span class="line"><span class="comment">// require some class for dispath</span></span><br><span class="line"></span><br><span class="line">$router = <span class="keyword">new</span> MyRouter\Router();</span><br><span class="line">$router-&gt;dispatch();</span><br></pre></td></tr></table></figure>
<p>另外還需要一個 Rewrite Rule 來轉換（這邊使用 Laravel 的 .htaccess）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;IFModule mod_rewrite.c&gt;</span><br><span class="line">  Options -MultiViews</span><br><span class="line">  RewriteEngine On</span><br><span class="line"></span><br><span class="line">  RewriteCond %&#123;REQUEST_FILENAME&#125; !-d</span><br><span class="line">  RewriteCond %&#123;REQUEST_FILENAME&#125; !-f</span><br><span class="line">  RewriteRule ^ index.PHP [L]</span><br><span class="line">&lt;/IfModule&gt;</span><br></pre></td></tr></table></figure></p>
<p>基本上會運作後，就來改寫成 Zephir 的版本吧！</p>
<h3 id="改寫為-Zephir-版本"><a href="#改寫為-Zephir-版本" class="headerlink" title="改寫為 Zephir 版本"></a>改寫為 Zephir 版本</h3><p>雖然基本上都和 PHP 類似，不過仍有不少 <a href="http://zephir-lang.com/language.html" target="_blank" rel="noopener">Syntax</a> 上的差異，建議大家先稍微讀過（不會很難，比新學語言簡單多了！）</p>
<p>一開始要初始化專案，我先建立一個 myExtension 放置我的 PHP Extension 專案，然後這邊建立一個 MyRouter 的專案。</p>
<blockquote>
<p>mkdir -p ~/myExtension/MyRouter<br>cd ~/myExtension/MyRouter<br>zephir init</p>
</blockquote>
<p>完成後，目錄下應該會多出一些檔案。</p>
<ul>
<li>config.json - 設定檔，裡面應該會寫著 namepsace 是什麼</li>
<li>ext/ - 最後生成的 PHP Extension 會在這個資料夾找到</li>
<li>myrouter/ - 放置 .zep 檔案的目錄（類似 PSR-0 的 Class 目錄規則，不過都是小寫）</li>
</ul>
<p>接著把剛剛的 Router.PHP 複製進去，重新命名為 router.zep 然後著手改寫。</p>
<p>以下有不少地雷（我找 Syntax, Compile Error 超久，都用註解說明）</p>
<figure class="highlight zep"><figcaption><span>myrouter/router.zep</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">MyRouter</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span> </span>&#123;</span><br><span class="line">true<span class="comment">// 單純去掉 $ 即可（雖然有 $ 似乎不會被當成錯誤）</span></span><br><span class="line">  <span class="keyword">protected</span> basePath = <span class="string">""</span>;</span><br><span class="line">  <span class="keyword">protected</span> currentPath = <span class="string">""</span>;</span><br><span class="line">  <span class="keyword">protected</span> defaultMethod = <span class="string">""</span>;</span><br><span class="line">  <span class="keyword">public</span> notFound = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string basePath = null)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> this-&gt;basePath = basePath; <span class="comment">// 所有 Assign 的動作都要用 let</span></span><br><span class="line">    <span class="keyword">let</span> this-&gt;defaultMethod = <span class="string">"index"</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Dispatch</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * Create class instance and call method</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> parseURI; <span class="comment">// 像是 Array 之類的都分類在 Dynamic Variable 裡面，用 var 賦值（分不清楚用 var 比較保險）</span></span><br><span class="line">    <span class="keyword">let</span> parseURI = []; <span class="comment">// 做這個動作讓他判定為 Array (官方 Blog 有另一種做法，沒測試過)</span></span><br><span class="line">    <span class="keyword">let</span> parseURI = this-&gt;parseURI(); <span class="comment">// 從 parseURI 方法取得分析好的 Array</span></span><br><span class="line">    <span class="keyword">if</span> !<span class="keyword">empty</span>(this-&gt;basePath) &amp;&amp; this-&gt;basePath == parseURI[<span class="number">0</span>] &#123;</span><br><span class="line">      <span class="keyword">let</span> parseURI = array_slice(parseURI, <span class="number">1</span>); <span class="comment">// 所有 PHP 的 Function / Class 基本上都可以直接取用</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> className;</span><br><span class="line">    <span class="keyword">var</span> method;</span><br><span class="line">    <span class="keyword">var</span> value; <span class="comment">// 下面會用 fetch 來替代 isset (官方部落格表示必須這樣用) 所以要先定義變數給他用</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> className = <span class="keyword">null</span>; <span class="comment">// 給予初始值，如果沒有做這個動作後面的 is_null() 檢查都會讓變成 PHP Process 直接死掉</span></span><br><span class="line">    <span class="comment">// --- 以下為推測，因為碰到問題點在這，但是詳細關係有待釐清 ---</span></span><br><span class="line">    <span class="comment">// 關於這部分 阿土伯大大 也給出解釋，因為底層還是 C 所以離開 Scope 記憶體清除，就會 segfault</span></span><br><span class="line">    <span class="comment">// 關於 Segmentation fault (segfault) 因為沒有碰過，所以暫時先搜集資料，代理解後在分享詳細的資訊</span></span><br><span class="line">    <span class="keyword">let</span> method = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> fetch value, parseURI[<span class="number">0</span>] &#123; <span class="comment">// 這個寫法跟 isset 效果相同，這邊比較不一樣</span></span><br><span class="line">      <span class="keyword">let</span> className = value;</span><br><span class="line">      <span class="keyword">let</span> className = ucwords(className);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> fetch value, parseURI[<span class="number">1</span>] &#123;</span><br><span class="line">      <span class="keyword">let</span> method = parseURI[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> is_null(className) || !class_exists(className) &#123;</span><br><span class="line">      this-&gt;error(<span class="number">404</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">truetrue<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 這邊是因為 PHP 可以用 new $someClass; 的方式產生新物件（物件名稱用變數代替）</span></span><br><span class="line"><span class="comment">     * 但是 Zephir 會把你的變數當成 Class Name 所以無法正常產生，那麼就藉由 class_alias 方法處理</span></span><br><span class="line"><span class="comment">     * class_alias 要傳入兩個參數（字串）第一個是原始類別，第二個是他的匿名類別名稱</span></span><br><span class="line"><span class="comment">     * 所以透過這個方法，所有 Router 傳入的 Class Name 都被轉成統一的 ProxyClass 來產生實例使用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// class_alias(className, "ProxyClass"); // 注意，字串一律使用雙引號，單引號被視為 char</span></span><br><span class="line">    <span class="keyword">var</span> classInstance;</span><br><span class="line">    <span class="comment">//let classInstance = new ProxyClass;</span></span><br><span class="line">truetrue<span class="keyword">var</span> classInstance = create_instance(className); <span class="comment">// 阿土伯大大提供了正確的用法，也不會被編譯器警告了！</span></span><br><span class="line">    <span class="comment">// create_instance_params(className, params) 是有參數的用法</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> method == <span class="keyword">null</span> &#123;</span><br><span class="line">      this-&gt;callMethod(classInstance, this-&gt;defaultMethod);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    this-&gt;callMethod(classInstance, method);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Call Method</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> object $class</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> string $method</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">callMethod</span><span class="params">(var instance, string method)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> is_callable([instance, method]) &#123; <span class="comment">// 用 [] 直接產生 Array 是被接受的（也許是跟進 PHP 5.4 的新功能）</span></span><br><span class="line">      call_user_func([instance, method]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      this-&gt;error(<span class="number">404</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Error</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> int $code</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">error</span><span class="params">(int code = <span class="number">500</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(code == <span class="number">404</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span>(is_callable(this-&gt;notFound)) &#123;</span><br><span class="line">        call_user_func(this-&gt;notFound);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"404 Not Found"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"Error &#123;code&#125;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Parse URI</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * Analytic URL and turn into class and method</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * return array [$class, $method]</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseURI</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> currentURI;</span><br><span class="line">    <span class="keyword">let</span> currentURI = _SERVER[<span class="string">"REQUEST_URI"</span>];</span><br><span class="line">    <span class="keyword">var</span> pattern = <span class="string">"@/([a-z][a-z0-9-]*)@i"</span>; <span class="comment">// 這邊用 \/ 去脫跳不知道為什麼會出錯，只好改用其他界定符號</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> matches;</span><br><span class="line">    <span class="keyword">let</span> matches = [];</span><br><span class="line">    preg_match_all(pattern, currentURI, matches);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> schema;</span><br><span class="line">    <span class="keyword">let</span> schema = array_slice(matches, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> schema[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完成之後，在目錄下執行指令</p>
<blockquote>
<p>zephir [compile]</p>
</blockquote>
<p>compile 可以省略，但是我似乎找不到 help 的 command 來看支援什麼，目前已知 init 和 compile 兩個（遠望）</p>
<h3 id="安裝與測試"><a href="#安裝與測試" class="headerlink" title="安裝與測試"></a>安裝與測試</h3><p>因為我平常使用 <a href="https://Github.com/c9s/PHPbrew" target="_blank" rel="noopener">PHPBrew</a> 來建構 PHP 的測試環境，因此以下範例是複製到 PHPBrew 的 Extension 目錄。</p>
<blockquote>
<p>sudo cp ext/modules/myrouter.so ~/path/to/your/PHP/extensions/<br>PHPbrew ext enable myrouter<br>sudo apachectl graceful</p>
</blockquote>
<p>PHPBrew 提供很方便的 command 來啓用 extension 基本上就是到 PHP.ini 加上 <code>extension=myrouter.so</code> 就能使用了！</p>
<p>最後，我們重新修改 <code>index.PHP</code> 來改用 Extension</p>
<figure class="highlight php"><figcaption><span>index.PHP</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?PHP</span></span><br><span class="line">$router = <span class="keyword">new</span> MyRouter\Router();</span><br><span class="line">$router-&gt;dispatch();</span><br></pre></td></tr></table></figure>
<p>重新打開後，如果正常運作就是成功了！</p>
<p>註：上文都沒有產生任何 Router 可以讀取到的 Class 大家可以自己嘗試加入，以下為範例程式碼</p>
<p><a href="http://localhost/app/home" target="_blank" rel="noopener">http://localhost/app/home</a></p>
<figure class="highlight php"><figcaption><span>index.PHP</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?PHP</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line">true<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  	<span class="keyword">echo</span> <span class="string">"Hello, this index"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">home</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  	<span class="keyword">echo</span> <span class="string">"Hello, you should see this when open /app/home"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$router = <span class="keyword">new</span> MyRouter\Router();</span><br><span class="line">$router-&gt;dispatch();</span><br></pre></td></tr></table></figure>
<hr>
<p>那麼，用 Zephir 可以做些什麼呢？</p>
<ul>
<li>改善原本程式的效能瓶頸（可能是在無法改變語言的狀況下）</li>
<li>商業使用（加密程式碼）</li>
<li>在極端的環境下使用（記憶體不足之類的情況）</li>
<li>純粹好玩</li>
<li>開發一套大型 PHP 框架，嘗試改變些什麼 ( Phalcon )</li>
<li>其它也許你能想到的⋯⋯</li>
</ul>
<p>至少我認為 PHP 藉此開拓了一條新道路，而 Phaclon 團隊的 Zephir 我想一定能夠改變很多東西。</p>
<p>目前我推薦他人學習 PHP 的理由，我會用這兩個：</p>
<ul>
<li>容易取得運行環境、較少權限需求問題</li>
<li>容易入門學習，建構成就感</li>
</ul>
<p>多了 Zephir 我想還可以加上一個「簡單寫超高速 PHP 網站」之類的吧 XDD<br>（寫許用來寫 PHP Rebot 非常好用啊，高效的機器人，用來分析資料是非常方便的！）</p>

    
    <footer class="article__footer">
      
        <div class="text-center">
          <div class="fb-share-button"
               data-href="https://blog.frost.tw/zephir-write-your-own-php-extension/"
               data-layout="button_count">
          </div>
        </div>
        <p align="center">
          <a href='https://ko-fi.com/J3J78093' target='_blank'>
            <img height='36' style='border:0px;height:36px;' src='https://az743702.vo.msecnd.net/cdn/kofi5.png?v=0' border='0' alt='Buy Me a Coffee at ko-fi.com' />
          </a>
        </p>
        <iframe scrolling="no" frameborder="0" style="display: block; margin: 0 auto; height: 212px;" src="https://button.like.co/in/embed/elct9620/button?referrer=https://blog.frost.tw/zephir-write-your-own-php-extension/"></iframe>
        
          <ul class="article__tag-list"><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/C/">C</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/PHP/">PHP</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/Zephir/">Zephir</a></li><li class="article__tag-list-item"><a class="article__tag-list-link" href="/tags/網站開發/">網站開發</a></li></ul>
        
      
    </footer>
  </div>
</article>


  
    <div class="adv">
      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
      <!-- 網誌_文末廣告 (Hexo) -->
      <ins class="adsbygoogle"
      style="display:block"
      data-ad-client="ca-pub-2844969736316510"
      data-ad-slot="5530952976"
      data-ad-format="auto"></ins>
      <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
  

  
<section id="comment" class="comment-box">
  <h1 class="comment-box__title">留言</h1>

  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></noscript>
  </div>
</section>






    </div>
    <footer id="footer">
      <div id="copyright">
  &copy;2013 <a href="https://plus.google.com/117236344655673213049?rel=author" target="_blank">蒼時弦也</a>. All right reversed.
</div>

    </footer>
    

  
  <script type="text/javascript">
  var disqus_shortname = 'revo-skill-frost';

  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }());
  </script>
  

  
  <!-- Google Tag Manager -->
  <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5TQLRN"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-5TQLRN');</script>
  <!-- End Google Tag Manager -->
  

  <script>
    window.fbAsyncInit = function() {
      FB.init({
        appId      : '178355449110',
        xfbml      : true,
        version    : 'v2.12'
      });

      FB.AppEvents.logPageView();

    };

    (function(d, s, id){
       var js, fjs = d.getElementsByTagName(s)[0];
       if (d.getElementById(id)) {return;}
       js = d.createElement(s); js.id = id;
       js.src = "https://connect.facebook.net/zh_TW/sdk.js";
       fjs.parentNode.insertBefore(js, fjs);
     }(document, 'script', 'facebook-jssdk'));
  </script>

  <script src="/js/app.js"></script>


    <div class="loading"></div>
  </body>
</html>
